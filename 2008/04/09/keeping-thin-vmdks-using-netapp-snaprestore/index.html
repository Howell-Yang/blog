<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Keeping Thin VMDKs Using NetApp SnapRestore - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Keeping Thin VMDKs Using NetApp SnapRestore - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Keeping Thin VMDKs Using NetApp SnapRestore - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2008/04/09/keeping-thin-vmdks-using-netapp-snaprestore/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Keeping Thin VMDKs Using NetApp SnapRestore</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 99 May 9099 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;659 words (estimated 4 minutes to read)</span>
  <p>A short while ago, I discussed that VMDKs on NFS may start out thin provisioned, but will <a href="/2008/03/31/only-thin-provisioned-in-the-beginning/">lose that thin provisioned status over time</a>. Operations like cloning and Storage VMotion will cause these thin provisioned disks to become thick (fully provisioned) disks, and you lose one of the benefits of running VMware on NFS.</p>
<p>Fortunately, if you&rsquo;re running a NetApp storage system as your NFS server, you can preserve the thin provisioned status of these VMDKs by leveraging NetApp&rsquo;s single file SnapRestore functionality. This article describes how that works.</p>
<p>There&rsquo;s a couple of caveats here:</p>
<ol>
<li>
<p>This technique only helps with making new VMs from an existing VM. SnapRestore won&rsquo;t help preserve thin provisioned status after a Storage VMotion operation.</p>
</li>
<li>
<p>This isn&rsquo;t integrated with VirtualCenter, so you won&rsquo;t be able to take advantage of VirtualCenter&rsquo;s integration with Sysprep and such.</p>
</li>
</ol>
<p>As a result of #2 above, then, you&rsquo;ll need to first prepare your source VM by running Sysprep inside the VM (assuming it is a Windows-based VM) and then allowing Sysprep to shut down the VM. Once that&rsquo;s accomplished, then you can proceed.</p>
<p>The first step is to take a snapshot of the volume containing the already prepared VM:</p>
<pre><code>snap create &lt;vol-name&gt; &lt;snapshot-name&gt;
</code></pre>
<p>Next, create a new VM in VirtualCenter, but <strong><em>do not create a virtual disk for the VM.</em></strong> This will create the VM configuration and associated files and the directory on the NFS datastore.</p>
<p>Third, run a SnapRestore operation to restore both the .vmdk file and the -flat.vmdk files. You have to restore both in order for this to work; keep in mind that the .vmdk file is just a header file and the -flat.vmdk is the actual disk file. The commands would look something like this:</p>
<pre><code>snap restore -t file -s &lt;snapshot-name&gt; -r &lt;new filename and path&gt; &lt;original filename and path&gt;
</code></pre>
<p>As an example, let&rsquo;s say you had a VM named template01 and you wanted to clone the disks for template01 to a new VM called newvm01, and these are stored on a volume called nfsvol. After you&rsquo;ve run Sysprep on template01, taken the Snapshot and called it base_snapshot, and created newvm01 without a virtual disk, you&rsquo;d run this command:</p>
<pre><code>snap restore -t file -s base_snapshot -r /vol/nfsvol/newvm01/newvm01.vmdk /vol/nfsvol/template01/template01.vmdk
</code></pre>
<p>That would restore the .vmdk (header) file; then you&rsquo;d restore the actual virtual disk file:</p>
<pre><code>snap restore -t file -s base_snapshot -r /vol/nfsvol/newvm01/newvm01-flat.vmdk /vol/nfsvol/template01/template01-flat.vmdk
</code></pre>
<p>Once this process is complete&mdash;and it may take some time depending upon the size of the files being restored&mdash;you should see both the <code>.vmdk</code> and the <code>-flat.vmdk</code> files listed in the Datastore Browser.</p>
<p>&ldquo;But wait a minute, Scott,&rdquo; you say. &ldquo;The -flat.vmdk no longer looks thin provisioned. You lied! This process doesn&rsquo;t work.&rdquo;</p>
<p>Indeed, it will look like it is no longer thin provisioned. Trust me; there&rsquo;s one more step and then all will make sense. If you log into the ESX Server and open the <code>.vmdk</code> file in vi, you&rsquo;ll see that it references the <em>old file name</em> of the <code>-flat.vmdk</code>. Edit that to reflect the new, restored file name, save your changes, and go back to the Datastore Broswer again. Refresh the display, and all should be well.</p>
<p>Why does the Datastore Browser work that way? Beats me. You&rsquo;ll also find that running an <code>ls -la</code> on an NFS datastore from the Service Console will show you <code>-flat.vmdk</code> files that appear to be thick provisioned. The <em>only</em> way I&rsquo;ve found to see if they are thin provisioned is to use the Datastore Browser. It&rsquo;s a VMware thing, I suppose.</p>
<p>The last and final step is to edit the settings for the VM you created earlier and add the new virtual disk to that VM. Then you can boot up that VM and proceed with whatever customization steps, if any, are needed.</p>
<p>In the near future I plan to test another possible method of preserving the VMDK&rsquo;s thin provisioned status, a method that is storage agnostic. Look for details of that testing here.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/esx">ESX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/netapp">NetApp</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nfs">NFS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/snapshots">Snapshots</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/storage">Storage</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2008/04/04/virtualization-short-take-5/">Virtualization Short Take #5</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2008/04/11/ad-integration-tip-dealing-with-more-than-1000-users/">AD Integration Tip: Dealing With More Than 1,000 Users</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2008%2f04%2f09%2fkeeping-thin-vmdks-using-netapp-snaprestore%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2008%2f04%2f09%2fkeeping-thin-vmdks-using-netapp-snaprestore%2f&text=Keeping%20Thin%20VMDKs%20Using%20NetApp%20SnapRestore" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2008%2f04%2f09%2fkeeping-thin-vmdks-using-netapp-snaprestore%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2007/10/08/vm-file-level-recovery-with-netapp-snapshots/">VM File-Level Recovery with NetApp Snapshots</a> <span class="post-date-list">89 May 8088</span></li><li><a href="/2007/10/08/full-vm-recovery-with-netapp-snapshots/">Full VM Recovery with NetApp Snapshots</a> <span class="post-date-list">89 May 8088</span></li><li><a href="/2006/12/30/recovering-data-inside-vms-using-netapp-snapshots/">Recovering Data Inside VMs Using NetApp Snapshots</a> <span class="post-date-list">309 May 303030</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
