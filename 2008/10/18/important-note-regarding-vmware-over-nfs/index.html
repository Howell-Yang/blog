<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Important Note Regarding VMware over NFS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Important Note Regarding VMware over NFS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Important Note Regarding VMware over NFS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2008/10/18/important-note-regarding-vmware-over-nfs/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Important Note Regarding VMware over NFS</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 189 May 181818 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/rant">Rant</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;604 words (estimated 3 minutes to read)</span>
  <p>We ran into an interesting set of problems at work this week, all of them related to running virtual machines on VMware ESX over NetApp NFS. While we haven&rsquo;t yet determined the root cause for all of the problem, we did uncover the root cause for one of the issues, and additional testing seems to indicate that one of the other problems may also be suffering from the same condition.</p>
<p>The problem seems to lie within some (now outdated) recommendations by NetApp for using NFS with VMware ESX. As late as June of this year, NetApp was recommending&mdash;via TR-3428, &ldquo;NetApp and VMware Virtual Infrastructure 3 Storage Best Practices&rdquo;&ndash;that users disable NFS locking on the storage system by setting the NFS.Lock.Disable setting to 1. Version 4.0 of TR-3428 was the version published in June of this year, and it still contained this recommendation.</p>
<p>As I understand it, this recommendation stemmed from a bug that existed in VMware ESX that caused long delays when removing VMware snapshots. As a workaround, NetApp recommended setting the NFS.Lock.Disable setting. Supposedly, VMware has fixed that bug with <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1005807">this patch</a>, and the current version of TR-3428 (version 4.2, published in September 2008 and available <a href="http://www.netapp.com/us/library/technical-reports/tr-3428.html">from NetApp&rsquo;s web site</a>) no longer contains the recommendation to set NFS.Lock.Disable.</p>
<p>Unfortunately, customers who followed (then current) best practices may have set this value, and in so doing may have exposed themselves to a &ldquo;split brain&rdquo; scenario in which a VM is simultaneously registered and running on multiple VMware ESX hosts. Users may be particularly at risk if they also run VMware HA and have not protected themselves against isolation response (<a href="/tags/vmwareha/">these articles</a> are tagged &lsquo;VMwareHA&rsquo; and will provide more information on isolation response). We&rsquo;ve had one large customer be affected by this problem, and another large customer who is having problems that we believe are related to this same issue.</p>
<p>There are a couple of important things to note:</p>
<ul>
<li>
<p>This is not a NetApp problem, but rather the result of a recommendation from NetApp. At that time, it was believed that this setting was necessary.</p>
</li>
<li>
<p>In most cases VMs affected by this split-brain scenario will get corrupted and must be rebuilt or restored from backup.</p>
</li>
</ul>
<p>We&rsquo;re not the only ones who have seen this behavior, either:</p>
<p><a href="http://thezendiary.blogspot.com/2008/08/vmware-and-nfs-on-netapp-filers.html">VMware and NFS on NetApp Filers</a></p>
<p><a href="http://vmwaretips.com/wp/?p=48">NFS Datastores and what was their BIG issue&hellip;</a></p>
<p>The key takeaway from this is the following:</p>
<ul>
<li>
<p>If you haven&rsquo;t yet applied ESX350-200808401-BG, you should apply it. Don&rsquo;t wait. Now.</p>
</li>
<li>
<p>If you did follow NetApp&rsquo;s recommendations and set NFS.Lock.Disable, then review the instructions below (credit to <a href="http://vmwaretips.com/wp/">Rick Scherer</a> and several others, thank you!) to remedy the situation.</p>
</li>
</ul>
<p>The instructions you should follow to restore NFS locking are here (these instructions include applying the patch):</p>
<ol>
<li>
<p>Download patch ESX350-200808401-BG</p>
</li>
<li>
<p>Identify an ESX server against which you will apply the patch</p>
</li>
<li>
<p>Use VMotion and migrate the running VMs to other VMware ESX nodes</p>
</li>
<li>
<p>Install this patch on the selected VMware ESX server</p>
</li>
<li>
<p>In the Advanced Configuration settings ensure that NFS file locking is enabled with NFS.Lock.Disable=0 (you can also use the esxcfg-advcfg command to set this value)</p>
</li>
<li>
<p>Edit the <code>/etc/vmware/config</code> file and add the line <code>prefvmx.ConsolidateDeleteNFSLocks = &quot;TRUE&quot;</code>.</p>
</li>
<li>
<p>Save the changes to the file and reboot the VMware ESX host</p>
</li>
<li>
<p>Use VMotion to move VMs back to patched/NFS lock enabled/prefvmx enabled host</p>
</li>
<li>
<p>Repeat the steps above on each host in the cluster</p>
</li>
</ol>
<p>So, again, if you haven&rsquo;t applied ESX350-200808401-BG, please do so as quickly as possible, and then ensure that NFS locking is enabled. If you&rsquo;ve previously disabled NFS locking, then follow the steps above to restore NFS locking and protect yourself against this possible split-brain scenario.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nas">NAS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/netapp">NetApp</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nfs">NFS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/storage">Storage</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2008/10/16/a-couple-of-product-announcements/">A Couple of Product Announcements</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2008/10/20/kodiak-continues-to-develop/">Kodiak Continues to Develop</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2008%2f10%2f18%2fimportant-note-regarding-vmware-over-nfs%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2008%2f10%2f18%2fimportant-note-regarding-vmware-over-nfs%2f&text=Important%20Note%20Regarding%20VMware%20over%20NFS" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2008%2f10%2f18%2fimportant-note-regarding-vmware-over-nfs%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2008/08/14/storage-protocol-performance-whitepaper-from-netapp/">Storage Protocol Performance Whitepaper from NetApp</a> <span class="post-date-list">149 May 141414</span></li><li><a href="/2008/02/28/i-love-it-but-its-not-available/">I Love It, But It&#39;s Not Available</a> <span class="post-date-list">289 May 282828</span></li><li><a href="/2007/10/08/full-vm-recovery-with-netapp-snapshots/">Full VM Recovery with NetApp Snapshots</a> <span class="post-date-list">89 May 8088</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
