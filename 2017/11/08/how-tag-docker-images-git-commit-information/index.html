<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>How to Tag Docker Images with Git Commit Information - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="How to Tag Docker Images with Git Commit Information - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="How to Tag Docker Images with Git Commit Information - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2017/11/08/how-tag-docker-images-git-commit-information/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">How to Tag Docker Images with Git Commit Information</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 89 May 8088 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;793 words (estimated 4 minutes to read)</span>
  <p>I&rsquo;ve recently been working on a very simple Flask application that can be used as a demo application in containerized environments (here&rsquo;s <a href="https://github.com/scottslowe/flask-web-svc">the GitHub repo</a>). It&rsquo;s nothing special, but it&rsquo;s been useful for me as a learning exercise&mdash;both from a Docker image creation perspective as well as getting some additional Python knowledge. Along the way, I wanted to be able to track versions of the Docker image (and the <code>Dockerfile</code> used to create those images), and link those versions back to specific Git commits in the source repository. In this article, I&rsquo;ll share a way I&rsquo;ve found to tag Docker images with Git commit information.</p>
<p>Before I proceed any further, I&rsquo;ll provide the disclaimer that this information isn&rsquo;t unique; I&rsquo;m building on the work of others. Other articles sharing similar information include <a href="http://container-solutions.com/tagging-docker-images-the-right-way/">this one</a>; no doubt there are countless more I haven&rsquo;t yet seen. I&rsquo;m presenting this information here simply to show one way (not the only way) of including Git commit information with a Docker image.</p>
<p>Getting the necessary information from Git is actually far easier than one might think. This variation of the <code>git log</code> command will print only the full hash of the last commit to the repository:</p>
<pre><code>git log -1 --format=%H
</code></pre>
<p>If you prefer the shortened commit hash (which is what I use currently), then just change the <code>%H</code> to <code>%h</code>, like this:</p>
<pre><code>git log -1 --format=%h
</code></pre>
<p>Getting the information <em>out</em> of Git is only half the puzzle, though; the other half is getting it <em>into</em> the Docker image. The answer lies in some changes to the <code>Dockerfile</code> and the use of an additional command-line flag when building the image.</p>
<p>First, you&rsquo;ll need to add lines like this to your <code>Dockerfile</code>:</p>
<pre><code>ARG GIT_COMMIT=unspecified
LABEL git_commit=$GIT_COMMIT
</code></pre>
<p>The first line defines a build-time argument, and the use of <code>=unspecified</code> means that if the built-time argument is omitted or not supplied, it will default to the value of &ldquo;unspecified&rdquo;. The second line takes the information from the argument and adds it as a label on the image.</p>
<p>With the <code>Dockerfile</code> prepared to leverage Git commit information, all that&rsquo;s necessary is to build the image with the <code>--build-arg</code> flag, like this (here I&rsquo;m showing the command I&rsquo;d use to build the &ldquo;flask-web-svc&rdquo; image for the Flask application I&rsquo;ve been building):</p>
<pre><code>docker build -t flask-local-build --build-arg GIT_COMMIT=$(git log -1 --format=%h) .
</code></pre>
<p>Here I&rsquo;m using Bash command substitution to take the output of <code>git log -1 --format=%h</code> and supply it to <code>docker build</code> as the GIT_COMMIT argument (i.e., what the <code>Dockerfile</code> is expecting). This command assumes that you&rsquo;re building the Docker image from the latest Git commit; if this isn&rsquo;t the case, then you&rsquo;ll need to modify your command. As I mentioned earlier, if you omit the <code>--build-arg</code> parameter, then the label will be assigned with the default value of &ldquo;unspecified&rdquo;.</p>
<p>When you build the image this way, you can then see the Git commit attached to the image as a label using this command:</p>
<pre><code>docker inspect flask-local-build | jq '.[].ContainerConfig.Labels'
</code></pre>
<p>Note I&rsquo;m using the incredibly-useful <code>jq</code> tool here. (If you&rsquo;re not familiar with <code>jq</code>, check out <a href="/2015/11/11/handy-cli-tool-json/">my introductory post</a>.)</p>
<p>Assuming that the build was successful and the container operates as expected/desired, then you can tag the image and push it to a registry:</p>
<pre><code>docker tag flask-local-build slowe/flask-web-svc:0.3
docker push slowe/flask-web-svc:0.3
</code></pre>
<p>I also create a GitHub release corresponding to the Git commit used to build an image, so I can easily correlate a particular version of the Docker image with the appropriate commit in the repository. This makes it easier to quickly jump to the <code>Dockerfile</code> for each version of the Docker image. So, for example, when I release version 0.3 of the Docker image (which I recently did), I also have <a href="https://github.com/scottslowe/flask-web-svc/releases/tag/v0.3">a matching v0.3 release in GitHub</a> that points to the specific Git commit from which version 0.3 of the Docker image is built. This allows me&mdash;and anyone else consuming my Docker image&mdash;to have full traceability from a particular version of a Docker image all the way back to the specific Git commit from which that Docker image was built.</p>
<p>I imagine there are probably better/more efficient ways of doing what I&rsquo;ve done here; feel free to <a href="https://twitter.com/scott_lowe">hit me up on Twitter</a> to help me improve. Thanks for reading!</p>
<p><strong>UPDATE:</strong> Michael Gasch also pointed out that <code>git rev-parse HEAD</code> will return the full (long) commit hash from the last commit, so this is another way to get the information from Git. Given the nature of Git, no doubt there are countless more!</p>
<p><strong>UPDATE 2020-06-29:</strong> A reader contacted me via Twitter to point out at the Open Containers Initiative has a list of suggested image tags/annotations, including one for the Git commit hash (it&rsquo;s &ldquo;org.opencontainers.image.revision&rdquo;). See <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md">this page</a> for more information and details. Thanks, Hans!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/python">Python</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2017/11/07/deep-dive-into-container-images-in-kolla/">Deep Dive into Container Images in Kolla</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2017/11/10/technology-short-take-90/">Technology Short Take 90</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2017%2f11%2f08%2fhow-tag-docker-images-git-commit-information%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f11%2f08%2fhow-tag-docker-images-git-commit-information%2f&text=How%20to%20Tag%20Docker%20Images%20with%20Git%20Commit%20Information" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f11%2f08%2fhow-tag-docker-images-git-commit-information%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/11/07/deep-dive-into-container-images-in-kolla/">Deep Dive into Container Images in Kolla</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2017/10/27/technology-short-take-89/">Technology Short Take 89</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2017/08/25/technology-short-take-86/">Technology Short Take 86</a> <span class="post-date-list">259 May 252525</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
