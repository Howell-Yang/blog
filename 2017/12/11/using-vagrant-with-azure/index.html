<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using Vagrant with Azure - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using Vagrant with Azure - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using Vagrant with Azure - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2017/12/11/using-vagrant-with-azure/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using Vagrant with Azure</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 119 May 111111 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1111 words (estimated 6 minutes to read)</span>
  <p>In this post, I&rsquo;ll describe how to use <a href="https://www.vagrantup.com">Vagrant</a> with <a href="https://azure.microsoft.com/">Azure</a>. You can consider this article an extension of some of my earlier Vagrant articles; namely, the posts on <a href="/2016/09/15/using-vagrant-with-aws/">using Vagrant with AWS</a> and <a href="/2015/09/28/using-vagrant-with-openstack/">using Vagrant with OpenStack</a>. The theme across all these posts is examining how one might use Vagrant to simplify/streamline the consumption of resources from a provider using the familiar Vagrant workflow.</p>
<p>If you aren&rsquo;t already familiar with Vagrant, I&rsquo;d highly recommend first taking a look at my <a href="/2014/09/12/a-quick-introduction-to-vagrant/">introduction to Vagrant</a>, which provides an overview of the tool and how it&rsquo;s used.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Naturally, you&rsquo;ll need to first ensure that you have Vagrant installed. This is really well-documented already, so I won&rsquo;t go over it here. Next, you&rsquo;ll need to install the Azure provider for Vagrant, which you can handle using this command:</p>
<pre><code>vagrant plugin install vagrant-azure
</code></pre>
<p>You&rsquo;ll also (generally) want to have the Azure CLI installed. (You&rsquo;ll need it for a one-time configuration task I&rsquo;ll mention shortly.) I&rsquo;ve published a couple posts on installing the Azure CLI; see <a href="/2017/08/13/manually-installing-azure-cli-fedora-25/">here</a> or <a href="/2017/12/07/installing-azure-cli-fedora-27/">here</a>.</p>
<p>Once you&rsquo;ve installed the <code>vagrant-azure</code> plugin and the Azure CLI, you&rsquo;ll next need to install a box that Vagrant can use. Here, the use of Vagrant with Azure is different than the use of Vagrant with a provider like <a href="https://www.virtualbox.org">VirtualBox</a> or <a href="http://www.vmware.com/products/fusion.html">VMware Fusion</a>/<a href="http://www.vmware.com/products/workstation.html">VMware Workstation</a>. Like when using Vagrant with AWS, when you&rsquo;re using Vagrant with Azure the box is a &ldquo;dummy box&rdquo; that doesn&rsquo;t really do anything; instead, you&rsquo;re relying on Azure VM images. You can install a &ldquo;dummy box&rdquo; for Azure with this command:</p>
<pre><code>vagrant box add azure-dummy https://github.com/azure/vagrant-azure/raw/v2.0/dummy.box --provider azure
</code></pre>
<p>You&rsquo;ll then reference this &ldquo;dummy box&rdquo; in your <code>Vagrantfile</code>, as I&rsquo;ll illustrate shortly.</p>
<p>The last and final step is to create an Azure Active Directory (AD) service principal for Vagrant to use when connecting to Azure. This command will create a service principal for you to use with Vagrant:</p>
<pre><code>az ad sp create-for-rbac
</code></pre>
<p>Make note of the values returned in the command&rsquo;s JSON response; you&rsquo;ll need them later. You&rsquo;ll also want to know your Azure subscription ID, which you can obtain by running <code>az account list --query '[?isDefault].id' -o tsv</code>. <em>(Note: as pointed out by reader Jochen Schissler, the command listed above creates an entity with Contributor permissions at the Subscription level. For some folks, this isn&rsquo;t possible/acceptable due to security policies. It is perfectly fine to create a service principal and grant permissions at the resource group level, although it must still have Contributor permissions.)</em></p>
<p>Now that you&rsquo;ve installed Vagrant, installed the <code>vagrant-azure</code> plugin, downloaded the dummy Azure box, and have created the Azure AD service principal, you&rsquo;re ready to start spawning some Azure VMs with Vagrant.</p>
<h2 id="launching-azure-vms-via-vagrant">Launching Azure VMs via Vagrant</h2>
<p>When I use Vagrant, I prefer to keep the Vagrant configuration (stored in the file named <code>Vagrantfile</code>) as clean as possible, and separate details into a separate data file (typically using YAML). I outlined this approach <a href="/2014/10/22/multi-machine-vagrant-with-yaml/">here</a> and <a href="/2016/01/14/improved-way-yaml-vagrant/">here</a>. For the purposes of this post, however, I&rsquo;ll just embed the details directly into the Vagrant configuration to make it easier to understand. I have examples of using a YAML data file with Vagrant and Azure in the &ldquo;Additional Resources&rdquo; section below.</p>
<p>Here&rsquo;s a snippet of a <code>Vagrantfile</code> you could use to spin up Azure VMs using Vagrant:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Require the Azure provider plugin</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;vagrant-azure&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create and configure the Azure VMs</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#e6db74">&#39;2&#39;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Use dummy Azure box</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;azure-dummy&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Specify SSH key</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>ssh<span style="color:#f92672">.</span>private_key_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~/.ssh/id_rsa&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Configure the Azure provider</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;azure&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>az, override<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Pull Azure AD service principal information from environment variables</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>tenant_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;AZURE_TENANT_ID&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>client_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;AZURE_CLIENT_ID&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>client_secret <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;AZURE_CLIENT_SECRET&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>subscription_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;AZURE_SUBSCRIPTION_ID&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Specify VM parameters</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>vm_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;aztest&#39;</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>vm_size <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Standard_B1s&#39;</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>vm_image_urn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Canonical:UbuntuServer:16.04-LTS:latest&#39;</span>
</span></span><span style="display:flex;"><span>    az<span style="color:#f92672">.</span>resource_group_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;vagrant&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span> <span style="color:#75715e"># config.vm.provider &#39;azure&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span> <span style="color:#75715e"># Vagrant.configure</span>
</span></span></code></pre></div><p>Naturally, this is a very generic configuration, so you&rsquo;d need to supply the specific details you want use. In particular, you&rsquo;d need to supply the following details:</p>
<ul>
<li>The SSH keypair you want to use (via the <code>config.ssh.private_key_path</code> setting)</li>
<li>The Azure VM size you&rsquo;d like to use (via the <code>az.vm_size</code> setting)</li>
<li>The Azure VM image you want to use (via the <code>az.vm_image_urn</code> setting)</li>
<li>The name of the Azure resource group you&rsquo;d like to use (via the <code>az.resource_group_name</code> setting)</li>
</ul>
<p>Also, you&rsquo;ll note that the <code>Vagrantfile</code> assumes you&rsquo;ve set some environment variables that will allow Vagrant to communicate with Azure. These values are taken from the JSON output of creating the Azure AD service principal:</p>
<ul>
<li>The <code>AZURE_TENANT_ID</code> maps to the &ldquo;tenant&rdquo; key of the JSON output</li>
<li>The <code>AZURE_CLIENT_ID</code> maps to the &ldquo;appID&rdquo; key of the JSON output</li>
<li>The <code>AZURE_CLIENT_SECRET</code> maps to the &ldquo;password&rdquo; key of the JSON output</li>
<li>The <code>AZURE_SUBSCRIPTION_ID</code> is your Azure subscription ID, as shown when running <code>az account show</code></li>
</ul>
<p>Set these environment variables (you can use the <code>export</code> command) before running <code>vagrant up</code>, or you&rsquo;ll get an error.</p>
<p>With the right configuration details in place, simply run <code>vagrant up</code> from the same directory where the Vagrant configuration (in <code>Vagrantfile</code>) is stored. Vagrant will communicate with Azure (using the values in the corresponding environment variables) and create/launch the Azure VMs per the details provided.</p>
<p>Once the instances are up, the &ldquo;standard&rdquo; Vagrant workflow applies:</p>
<ul>
<li>Use <code>vagrant ssh &lt;name&gt;</code> to log into one of the VMs.</li>
<li>Use <code>vagrant provision</code> to apply any provisioning instructions (i.e., to copy files across or run a configuration management tool).</li>
<li>Use <code>vagrant destroy</code> to kill/terminate the VMs.</li>
</ul>
<p>One nice aspect of using Vagrant with Azure in this way is that you get the same workflow and commands to work with Azure VMs as you do with AWS instances, VirtualBox VMs, or VMware Fusion/Workstation VMs.</p>
<h2 id="why-use-vagrant-with-azure">Why Use Vagrant with Azure?</h2>
<p>As I stated in my post on using Vagrant with AWS, using Vagrant with Azure in this fashion is a great fit for the creation/destruction of temporary environments used for testing, software development, etc. However, in situations where you are creating more &ldquo;permanent&rdquo; infrastructure&mdash;such as deploying production applications onto Azure&mdash;then I would say that Vagrant is <em>not</em> the right fit. In those cases, using a tool like <a href="https://www.terraform.io/">Terraform</a> (see <a href="/2015/11/25/intro-to-terraform/">my introductory post</a>) would be a better fit.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>To help make using Vagrant with Azure easier, I&rsquo;ve created a couple learning environments that are part of <a href="https://github.com/scottslowe/learning-tools">my GitHub &ldquo;learning-tools&rdquo; repository</a>. Specifically, see the <code>vagrant/azure</code> directory for a sample Vagrant configuration that uses an external YAML data file for instance details.</p>
<p>Additionally, see the documentation for <a href="https://github.com/Azure/vagrant-azure">the <code>vagrant-azure</code> plugin on GitHub</a> for more information.</p>
<p><strong>UPDATE 5 Jul 2019:</strong> See the added text regarding the creation of a service principal and the permissions needed. Thanks to reader Jochen Schissler for the added information and feedback!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/azure">Azure</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2017/12/08/technology-short-take-91/">Technology Short Take 91</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2017/12/13/installing-vmware-horizon-client-fedora-27/">Installing the VMware Horizon Client on Fedora 27</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2017%2f12%2f11%2fusing-vagrant-with-azure%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f12%2f11%2fusing-vagrant-with-azure%2f&text=Using%20Vagrant%20with%20Azure" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f12%2f11%2fusing-vagrant-with-azure%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/12/07/installing-azure-cli-fedora-27/">Installing the Azure CLI on Fedora 27</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2017/12/06/using-vagrant-with-libvirt-on-fedora/">Using Vagrant with Libvirt on Fedora 27</a> <span class="post-date-list">69 May 6066</span></li><li><a href="/2017/10/31/strange-error-with-azure-cli/">Strange Error with the Azure CLI</a> <span class="post-date-list">319 May 313131</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
