<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Liveblog: Creating Effective Images - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Liveblog: Creating Effective Images - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Liveblog: Creating Effective Images - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2017/04/18/creating-effective-images/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Liveblog: Creating Effective Images</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 189 May 181818 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/liveblog">Liveblog</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1179 words (estimated 6 minutes to read)</span>
  <p>This is a liveblog for the DockerCon 2017 session titled &ldquo;Creating Effective Images.&rdquo; The speaker is Abby Fuller, a Senior Technical Evangelist with Amazon Web Services. Abby is a former operations engineer who was an early consumer of Amazon&rsquo;s Elastic Container Service (ECS), and some of her learnings came about the &ldquo;hard way.&rdquo; This session is from the &ldquo;Using Docker&rdquo; track.</p>
<p>Fuller starts with reviewing the agenda, and shares that she&rsquo;s intent on providing some practical tips that attendees can put to work immediately.</p>
<p>The first topic that Fuller tackles is the topic of container layers. A Docker container is made up of the read-only layers from the image itself, and a read/write layer at &ldquo;the top&rdquo; of the layers. Why do we care? Fewer layers means a smaller image, and smaller images means faster builds and faster deploys. (You may also see a reduced attack surface.)</p>
<p>The differences in making smaller images is important, Fuller explains, because the frequency of deployments is increasing (more deployments happening more quickly), and more containers are being deployed (sometimes at the behest of a CI/CD pipeline). This can result in significant amounts of disk space being consumed unnecessarily.</p>
<p>Some high-level tips for reducing the number of layers:</p>
<ul>
<li>Use shared base images where possible.</li>
<li>Limit the data written to the ocntainer layer.</li>
</ul>
<p>(Fuller advanced the presentation before I was able to capture the last two bullets from that list.)</p>
<p>In general, Fuller advises to use the cache whenever you can; it&rsquo;s a small step but it can save lots of time when building container images. She advises attendees to review the information available in the community on maximizing the use of cache (no specific resources provided or recommended).</p>
<p>Fuller starts with an example <code>Dockerfile</code> that is pretty &ldquo;standard&rdquo; for many images&mdash;it&rsquo;s based on the official Ubuntu image, running an <code>apt-get</code> to install a few packages, running <code>pip</code> to some Python modules, and then running an application. So how can we optimize this starting point?</p>
<p>The first step is to optimize the base image (specified on the <code>FROM</code> line). Simply by switching from Ubuntu to Alpine can save more than 350 MB of disk space (458 MB for Ubuntu versus 87 MB for Alpine). More examples include Debian coming in at 123 MB (compared to 458 MB for Ubuntu) or Fedora coming in at 230 MB (compared to 458 MB for Ubuntu). Pay attention to the base image selected&mdash;it may be beneficial to use a minimal base image, but there may also be specific use cases for a &ldquo;full base OS&rdquo;. Fuller specifically mentions compliance or security as potential times when selecting a full base OS may be beneficial.</p>
<p>(Aside: Fuller also mentions ease of development as a use case for a full base OS; it strikes me that the use of multi-stage builds in Docker may provide a situation where you can use a full base OS for the initial build environments and a more minimal OS for the runtime environment.)</p>
<p>Choosing a more appropriate base image may also streamline the build process in other ways as well (perhaps you don&rsquo;t need to install some packages because the necessary files or libraries are already there).</p>
<p>Next, Fuller talks about how cache invalidations can affect image size. You can change the order of operations in the <code>Dockerfile</code> and use the <code>ONBUILD</code> keyword to help reduce image size. (Personally, I need to do some additional research to better understand these tips.)</p>
<p>Fuller now shifts to providing some recommendations for building Windows images for Docker. She points out the <code>ConvertTo-Dockerfile</code> PowerShell command to convert Windows images or VHD files into Docker containers. She also mentions to pay attention (still) to the base image; Windows Server Nano <em>may</em> be a better choice for images unless you know you need a full base OS. Another &ldquo;gotcha&rdquo; is that you should <em>not</em> use MSI packages to install applications on Windows. This is because MSI installations are not space-efficient. More Windows tips will be provided tomorrow (Wednesday) in a separate session on using containers on Windows.</p>
<p>Fuller transitions back to Linux now and takes a closer look at optimizing a <code>Dockerfile</code>. She shares several tips, such as using <code>&amp;&amp;</code> to combine commands into a single layer (which can reduce overall image size) and use the <code>--no-install-recommends</code> to tell the package manager <em>not</em> to install recommended packages (this is in an Ubuntu/Debian context; you&rsquo;d need to find the equivalent for environments that use <code>yum</code> or <code>dnf</code>). You can also build your own custom base container, which allows you to very tightly control what is or is not included in the base image (which can, in turn, help you optimize the size of the derived images).</p>
<p>Other optimizations to <code>RUN</code> commands include cleaning out package manager &ldquo;leftovers&rdquo; in the same layer (just appending some flavor of an <code>rm</code> command with an <code>&amp;&amp;</code> at the end of the package installation steps).</p>
<p>Switching users also creates a layer. Switch users (with the <code>USER</code> command in the <code>Dockerfile</code>) where needed, but don&rsquo;t switch users needlessly. Extensive use of the <code>USER</code> command may indicate a need to break into separate images or separate containers.</p>
<p>Fuller points out that you should &ldquo;clean up after yourself&rdquo; by removing large files (or other unnecessary cruft) once its purpose has been served. Again, this is handled by prudent use of <code>&amp;&amp; rm</code> in the <code>Dockerfile</code> to remove files when they are no longer needed.</p>
<p>When possible, it may make sense to use a language-specific base image, although there are times to use larger (more full-featured) base images. Fuller talks about using a separate image to build an artifact (like when using Go), then use a separate image for the runtime. (It seems to me this is another place where multi-stage builds would help.)</p>
<p>Judiciously use the <code>.dockerignore</code> file to ignore files that do not belong in a Docker container. In particular, Fuller calls out the debug log for Node.js, which can be egregiously large and should definitely be ignored.</p>
<p>Fuller now starts talking about multi-stage builds. In the &ldquo;build-time&rdquo; environment, use the <code>AS</code> keyword on the <code>FROM</code> line to specify the name of the build image; then, the <code>COPY</code> command in a second <code>Dockerfile</code> to specify the name of the build image and copy what&rsquo;s needed out of it.</p>
<p>Fuller mentions the Docker Security Scan service to identify security vulnerabilities in Docker images (including &ldquo;official&rdquo; images). Use it. Don&rsquo;t trust anyone, says Fuller.</p>
<p>Other optimizations include <code>docker image prune</code> to prune dangling images (images that are no longer needed by any other images). <code>docker system prune</code> goes a step further to remove unused volumes. Proper use of both of these commands helps you be a good Docker citizen and avoid getting woken up at 2am.</p>
<p>Of course, there are additional optimizations. Fuller doesn&rsquo;t explicitly call out LinuxKit, but mentions RancherOS, unikernels, and other highly minimal images.</p>
<p>Some key takeaways:</p>
<ul>
<li>Share layers where possible.</li>
<li>Choose or build your own base wisely.</li>
<li>Not all languages should build the same.</li>
<li>Keep it simple, avoid extras.</li>
</ul>
<p>And with that, Fuller wraps up the session.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/dockercon2017">DockerCon2017</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2017/04/18/dockercon-2017-day-1-keynote/">Liveblog: DockerCon 2017 Day 1 Keynote</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2017/04/18/black-belt-cilium/">Liveblog: Cilium for Network and Application Security with BPF and XDP</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2017%2f04%2f18%2fcreating-effective-images%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f04%2f18%2fcreating-effective-images%2f&text=Liveblog%3a%20Creating%20Effective%20Images" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f04%2f18%2fcreating-effective-images%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/04/18/black-belt-cilium/">Liveblog: Cilium for Network and Application Security with BPF and XDP</a> <span class="post-date-list">189 May 181818</span></li><li><a href="/2017/04/18/dockercon-2017-day-1-keynote/">Liveblog: DockerCon 2017 Day 1 Keynote</a> <span class="post-date-list">189 May 181818</span></li><li><a href="/2017/02/06/spousetivities-at-dockercon-2017/">Spousetivities at DockerCon 2017</a> <span class="post-date-list">69 May 6066</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
