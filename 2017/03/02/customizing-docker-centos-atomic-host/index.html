<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Customizing Docker Engine on CentOS Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Customizing Docker Engine on CentOS Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Customizing Docker Engine on CentOS Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2017/03/02/customizing-docker-centos-atomic-host/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Customizing Docker Engine on CentOS Atomic Host</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 29 May 2022 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;702 words (estimated 4 minutes to read)</span>
  <p>I&rsquo;ve been spending some time recently with CentOS Atomic Host, the container-optimized version of CentOS (part of <a href="https://www.projectatomic.io/">Project Atomic</a>). By default, the <a href="https://www.docker.com/">Docker Engine</a> on CentOS Atomic Host listens only to a local UNIX socket, and is not accessible over the network. While CentOS has its own particular way of configuring the Docker Engine, I wanted to see if I could&mdash;in a very &ldquo;systemd-like&rdquo; fashion&mdash;make Docker Engine on CentOS listen on a network socket as well as a local UNIX socket. So, I set out with an instance of CentOS Atomic Host and <a href="https://docs.docker.com/engine/admin/systemd/">the Docker systemd docs</a> to see what I could do.</p>
<p>The default configuration of Docker Engine on CentOS Atomic Host uses a systemd unit file that references an external environment file; specifically, it references values set in <code>/etc/sysconfig/docker</code>, as you can see from this snippet of the <code>docker.service</code> unit file:</p>
<pre tabindex="0"><code>ExecStart=/usr/bin/dockerd-current \
          --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current \
          --default-runtime=docker-runc \
          --exec-opt native.cgroupdriver=systemd \
          --userland-proxy-path=/usr/libexec/docker/docker-proxy-current \
          $OPTIONS \
          $DOCKER_STORAGE_OPTIONS \
          $DOCKER_NETWORK_OPTIONS \
          $ADD_REGISTRY \
          $BLOCK_REGISTRY \
          $INSECURE_REGISTRY
</code></pre><p>The <code>$OPTIONS</code> variable, along with the other variables at the end of the ExecStart line, are defined in <code>/etc/sysconfig/docker</code>. That value, by default, looks like this:</p>
<pre tabindex="0"><code>OPTIONS=&#39;--selinux-enabled --log-driver=journald --signature-verification=false&#39;
</code></pre><p>I <em>could</em>, therefore, simply modify <code>/etc/sysconfig/docker</code> to make it listen on a network socket. However, I wanted to stretch my knowledge and try to do this in a &ldquo;systemd-friendly&rdquo; fashion; in other words, I wanted to more fully take advantage of systemd&rsquo;s functionality and architecture. Exploring <a href="https://www.freedesktop.org/wiki/Software/systemd/">the systemd documentation</a>, Docker&rsquo;s systemd docs, and building upon what I&rsquo;ve seen in other distributions, I came up a three-pronged approach.</p>
<p>First, I&rsquo;d use a systemd socket file for the local UNIX socket. This systemd socket file looks like this:</p>
<pre tabindex="0"><code>[Unit]
Description=UNIX Socket for the Docker API
PartOf=docker.service

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
</code></pre><p>Next, I&rsquo;d use a second systemd socket file to listen on a TCP port (the default non-SSL port of 2375). This socket file looks like this:</p>
<pre tabindex="0"><code>[Unit]
Description=TCP Socket for the Docker API

[Socket]
ListenStream=2375
BindIPv6Only=both
Service=docker.service

[Install]
WantedBy=sockets.target
</code></pre><p>Third and finally, I&rsquo;d use a systemd drop-in to modify the default systemd unit for the Docker Engine <em>without</em> having to modify the default unit file. This drop-in looks like this:</p>
<pre tabindex="0"><code>[Service]
ExecStart=
ExecStart=/usr/bin/dockerd-current -H fd:// \
          --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current \
          --default-runtime=docker-runc \
          --exec-opt native.cgroupdriver=systemd \
          --userland-proxy-path=/usr/libexec/docker/docker-proxy-current \
          $OPTIONS \
          $DOCKER_STORAGE_OPTIONS \
          $DOCKER_NETWORK_OPTIONS \
          $ADD_REGISTRY \
          $BLOCK_REGISTRY \
          $INSECURE_REGISTRY
</code></pre><p>This systemd drop-in modifies the value of the &ldquo;ExecStart&rdquo; line from the default unit file. First, it clears the value; then, it provides its own value. If you look carefully, you&rsquo;ll see that the <em>only</em> change to the ExecStart line from the original is the addition of <code>-H fd://</code>, which tells the Docker Engine to listen to a file descriptor. Where does this file descriptor come from? The systemd socket files, which will pass the descriptor for the socket&mdash;either the local UNIX socket or the network socket&mdash;to the Docker Engine.</p>
<p>This solution means I don&rsquo;t have to edit the default Docker Engine systemd unit and I don&rsquo;t have to edit the <code>/etc/sysconfig/docker</code> file.</p>
<p>To put these files in place, I followed these steps:</p>
<ol>
<li>First, stop the Docker Engine service.</li>
<li>Next, copy the socket files into place. They&rsquo;ll go into <code>/etc/systemd/system</code>.</li>
<li>Copy the systemd drop-in into place. This will go into the <code>/etc/systemd/system/docker.service.d</code> directory, which may need to be created (it probably won&rsquo;t already exist).</li>
<li>Run <code>systemctl daemon-reload</code> to reload the systemd unit files.</li>
<li>Create a &ldquo;docker&rdquo; group (this is needed by the UNIX socket).</li>
<li>Start the Docker sockets.</li>
<li>Start the Docker Engine service.</li>
</ol>
<p>After completing this process, you&rsquo;ll be able to communicate with this instance of Docker Engine <em>either</em> locally (via the UNIX socket) or remotely (via the TCP port).</p>
<p>Although I haven&rsquo;t tested it yet, this process should be reasonably easy to replicate via <a href="https://cloud-init.io/">cloud-init</a>, meaning you could use this process to customize CentOS Atomic Host instances in an OpenStack cloud or running on a public cloud like AWS.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>To experiment with this sort of thing yourself, I&rsquo;ve added some content to <a href="https://github.com/scottslowe/learning-tools/">my GitHub &ldquo;learning-tools&rdquo; repository</a> specifically addressing this topic. Look in the <code>centos-atomic/docker-tcp</code> directory (or the <code>centos-atomic/docker-tcp-ansible</code> directory if you want Ansible support) for a Vagrant environment that models what I&rsquo;ve described in this post.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/centos">CentOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2017/03/01/linux-migration-other-users-stories-pt1/">The Linux Migration: Other Users&#39; Stories, Part 1</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2017/03/03/technology-short-take-79/">Technology Short Take #79</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2017%2f03%2f02%2fcustomizing-docker-centos-atomic-host%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f03%2f02%2fcustomizing-docker-centos-atomic-host%2f&text=Customizing%20Docker%20Engine%20on%20CentOS%20Atomic%20Host" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f03%2f02%2fcustomizing-docker-centos-atomic-host%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/02/17/technology-short-take-78/">Technology Short Take #78</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2017/01/19/technology-short-take-76/">Technology Short Take #76</a> <span class="post-date-list">199 May 191919</span></li><li><a href="/2016/12/09/technology-short-take-74/">Technology Short Take #74</a> <span class="post-date-list">99 May 9099</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
