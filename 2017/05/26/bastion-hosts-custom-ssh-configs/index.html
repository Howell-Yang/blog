<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Bastion Hosts and Custom SSH Configurations - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Bastion Hosts and Custom SSH Configurations - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Bastion Hosts and Custom SSH Configurations - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2017/05/26/bastion-hosts-custom-ssh-configs/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Bastion Hosts and Custom SSH Configurations</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 269 May 262626 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;880 words (estimated 5 minutes to read)</span>
  <p>The idea of an SSH bastion host is something I discussed <a href="/2015/11/21/using-ssh-bastion-host/">here</a> about 18 months ago. For the most part, it&rsquo;s a pretty simple concept (yes, things can get quite complex in some situations, but I think these are largely corner cases). For the last few months, though, I&rsquo;ve been trying to use an SSH bastion host and failing, and I could not figure out <em>why</em> it wouldn&rsquo;t work. The answer, it turns out, lies in custom SSH configurations.</p>
<p>In my introduction on using SSH bastion hosts (linked above)&mdash;or in just about any tutorial out there on using SSH bastion hosts&mdash;brief mention is made of adding configuration information to SSH to use the bastion host. Borrowing from my original post, if you had an instance named &ldquo;private1&rdquo; that you wanted to access via a bastion named &ldquo;bastion&rdquo;, the SSH configuration information might look like this:</p>
<pre><code>Host private1
  IdentityFile ~/.ssh/rsa_private_key
  ProxyCommand ssh user@bastion -W %h:%p

Host bastion
  IdentityFile ~/.ssh/rsa_private_key
</code></pre>
<p>Normally, that information would go into <code>~/.ssh/config</code>, which is the default SSH configuration file.</p>
<p>In my case, I only allow public key authentication to &ldquo;trusted&rdquo; systems (I vaguely recall an article I read a while ago about a potential concern regarding the key exchange, though I can&rsquo;t find that article now). So, in my <code>~/.ssh/config</code> file, I allow public key authentication only for specific hosts but not for all hosts. I do that using a configuration that looks something like this (IP addresses and SSH keys have been changed to protect the innocent):</p>
<pre><code>Host 192.168.100.*
  PubkeyAuthentication yes
  IdentityFile ~/.ssh/path_to_rsa_private_key

Host 127.0.0.1
  PubkeyAuthentication yes

Host *
  PubkeyAuthentication no
</code></pre>
<p>In this case, SSH public key authentication is allowed to my home subnet and to localhost (this is necessary for <a href="https://www.vagrantup.com/">Vagrant</a> to work as expected when using <a href="https://www.virtualbox.org/">VirtualBox</a>, by the way), but it is <em>not</em> permitted for all other hosts. Call me paranoid.</p>
<p>By now you&rsquo;re probably thinking, &ldquo;Duly noted, Scott is a bit wacko, but what does this have to do with bastion hosts?&rdquo;</p>
<p>Fair question! I have one more thing to discuss, then I&rsquo;ll come to the crux of the matter. To work around my default SSH configuration, I often employ a custom SSH configuration for a project. For example, I might be working with <a href="https://www.terraform.io/">Terraform</a> and creating a bunch of instances in AWS. I won&rsquo;t necessarily know the IP addresses up front, and instead of cluttering up the main SSH configuration file in <code>~/.ssh/config</code> I&rsquo;ll create a custom SSH configuration just for that project. For example, the custom SSH configuration might look like this:</p>
<pre><code>Host *
  PubkeyAuthentication yes
  User ec2-user
  IdentityFile /path/to/project/specific/ssh/key/file
</code></pre>
<p>I&rsquo;ll then reference this specific configuration file (using the <code>-F &lt;file&gt;</code> parameter) when connecting to the instances, like this:</p>
<pre><code>ssh -F ssh.cfg &lt;IP address of instance&gt;
</code></pre>
<p>This works marvelously well, except in those instances when I forget to add the <code>-F</code> parameter and bang my head on the desk wondering why SSH won&rsquo;t connect.</p>
<p>OK, I&rsquo;m finally getting to my point (really). Let&rsquo;s suppose I&rsquo;m working on a project where I&rsquo;m turning up instances in AWS (or Google or Azure, the cloud provider doesn&rsquo;t really matter) and I&rsquo;d like to use a bastion host. I&rsquo;ll create a custom SSH configuration to enable public key authentication and define the bastion host, like this:</p>
<pre><code>Host private1
  IdentityFile /path/to/project/SSH/key
  ProxyCommand ssh bastion -W %h:%p

Host bastion
  IdentityFile /path/to/project/SSH/key

Host *
  PubkeyAuthentication yes
</code></pre>
<p>Looks good, right? I should just be able to run <code>ssh -F ssh.cfg private1</code> and be connected to my private cloud instance via the bastion host using the specified SSH key (which I injected into the cloud instance using <code>cloud-init</code> or the equivalent).</p>
<p><em>It won&rsquo;t work.</em></p>
<p>Why? In retrospect, it&rsquo;s an obvious reason, but it took me quite a while to find it. The secret lies in the <code>ProxyCommand</code> line, which <em>must also reference your custom SSH configuration.</em> SSH is just doing what it&rsquo;s told&mdash;you try to connect to &ldquo;private1&rdquo; and it runs the command you told it to run. Unfortunately, the command you told it to run uses the system&rsquo;s <em>default</em> SSH configuration, which (in my case) doesn&rsquo;t allow public key authentication. As a result, it fails. The fix is to modify the custom configuration to look like this instead:</p>
<pre><code>Host private1
  IdentityFile /path/to/project/SSH/key
  ProxyCommand ssh -F ssh.cfg bastion -W %h:%p

Host bastion
  IdentityFile /path/to/project/SSH/key

Host *
  PubkeyAuthentication yes
</code></pre>
<p>With this custom configuration in place (and assuming a default configuration like mine that disallows public key authentication by default), then you&rsquo;re able to run <code>ssh -F ssh.cfg private1</code> and you&rsquo;ll be connected to the private cloud instance via the bastion, authenticated using the specified key pair. (Clearly, I&rsquo;ve glossed over details like resolving host names, so you&rsquo;d need to ensure your instances have DNS entries or use <code>Host</code> directives in your custom SSH configuration).</p>
<p>The key takeaway: if you&rsquo;re using custom SSH configurations with SSH bastion hosts, then&mdash;depending on your setup&mdash;you may need to make sure your <code>ProxyCommand</code> setting <em>also</em> references the custom configuration.</p>
<p><strong>UPDATE:</strong> Several folks have contacted me regarding the SSH key exchange, and how the private key never actually leaves the client. I&rsquo;ve updated the post accordingly. I&rsquo;ll keep looking for the original article that sparked my concern over limiting public key authentication, and if I find it I&rsquo;ll add the link here. Thanks for the feedback!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ssh">SSH</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2017/05/26/technology-short-take-83/">Technology Short Take 83</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2017/06/01/centos-atomic-host-customization-using-cloud-init/">CentOS Atomic Host Customization Using cloud-init</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2017%2f05%2f26%2fbastion-hosts-custom-ssh-configs%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f05%2f26%2fbastion-hosts-custom-ssh-configs%2f&text=Bastion%20Hosts%20and%20Custom%20SSH%20Configurations" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2017%2f05%2f26%2fbastion-hosts-custom-ssh-configs%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/02/03/technology-short-take-77/">Technology Short Take #77</a> <span class="post-date-list">39 May 3033</span></li><li><a href="/2016/09/13/ssh-bastion-host-follow-up/">A Follow Up on SSH Bastion Hosts</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2015/11/21/using-ssh-bastion-host/">Using an SSH Bastion Host</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
