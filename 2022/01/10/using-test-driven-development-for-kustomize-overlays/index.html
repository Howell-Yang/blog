<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using Test-Driven Development for Kustomize Overlays - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using Test-Driven Development for Kustomize Overlays - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using Test-Driven Development for Kustomize Overlays - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2022/01/10/using-test-driven-development-for-kustomize-overlays/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using Test-Driven Development for Kustomize Overlays</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 109 May 101010 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1645 words (estimated 8 minutes to read)</span>
  <p>I am by no means a developer (not by a long shot!), but I have been learning lots of development-related things over the last several years and trying to incorporate those into my workflows. One of these is the idea of <em>test-driven development</em> (see <a href="https://en.wikipedia.org/wiki/Test-driven_development">Wikipedia</a> for a definition and some additional information), in which one writes tests to validate functionality before writing the code to implement said functionality (pardon the paraphrasing). In this post, I&rsquo;ll discuss how to use <a href="https://www.conftest.dev/"><code>conftest</code></a> to (loosely) implement test-driven development for <a href="https://kubernetes-sigs.github.io/kustomize/">Kustomize</a> overlays.</p>
<p>If you&rsquo;re unfamiliar with Kustomize, then <a href="/2019/09/13/an-introduction-to-kustomize/">this introductory article I wrote</a> will probably be useful.</p>
<p>For the discussion around using the principles of test-driven development for Kustomize overlays, I&rsquo;ll pull in a recent post I did on <a href="/2021/10/21/creating-reusable-kuma-installation-yaml/">creating reusable YAML for installing Kuma</a>. In that post, I pointed out four changes that needed to be made to the output of <code>kumactl install control-plane</code> to make it reusable:</p>
<ol>
<li>Remove the <code>caBundle</code> value for all webhooks.</li>
<li>Annotate all webhooks so that cert-manager will inject the correct <code>caBundle</code> value.</li>
<li>Add a volume and volume mount to the &ldquo;kuma-control-plane&rdquo; Deployment.</li>
<li>Change one of the environment variables for the &ldquo;kuma-control-plane&rdquo; Deployment to reference the volume added in step 3.</li>
</ol>
<p>Since I know what specific changes I need to see in the original YAML, I <em>should</em> be able to write some sort of test that tells me if that change has been made or not. I can run the test against the original YAML, knowing that it will fail, before writing the necessary Kustomize patches to make the change. Then I can test again to verify if the Kustomize patches worked as expected or anticipated.</p>
<p>This is where <code>conftest</code> comes in. The <code>conftest</code> command-line utility uses the Rego policy language from <a href="https://www.openpolicyagent.org/">Open Policy Agent</a>, and is intended to allow users to do exactly what I&rsquo;m trying to do. Specifically, it allows me to run a series of tests against YAML manifests to ensure that the test conditions (whatever those may be) are satisfied. The &ldquo;test conditions&rdquo; here are that the necessary changes have been made in order to make the installation YAML reusable.</p>
<p>I&rsquo;ll start with the first change (removing the <code>caBundle</code> value). Here&rsquo;s a Rego stanza that will test for the presence of a <code>caBundle</code> value (I&rsquo;ll explain the code below):</p>
<pre tabindex="0"><code>warn[msg] {
    input.kind == &#34;ValidatingWebhookConfiguration&#34;
    some i; input.webhooks[i].clientConfig.caBundle
    msg = &#34;caBundle value not removed for a validating webhook&#34;
}
</code></pre><p>Before moving on to the other tests, let&rsquo;s break this one down a bit:</p>
<ul>
<li>The <code>warn[msg]</code> header tells <code>conftest</code> to warn with the supplied message if the following conditions are true. The conditions within the curly braces act as a logical AND; all of them must be true in order to cause <code>conftest</code> to warn with the supplied message.</li>
<li>The first line checks to see if <code>input.kind</code> is equal to ValidatingWebhookConfiguration. The input here is whatever YAML being fed to <code>conftest</code>, so <code>input.kind</code> refers to the top-level <code>kind</code> object in the input YAML.</li>
<li>The second line is Rego&rsquo;s form of iteration. Rego will essentially iterate over all the webhooks in the input YAML and look for the presence of <code>clientConfig.caBundle</code> in each webhook. If it finds at least one webhook with <code>clientConfig.caBundle</code> present, then this condition is true.</li>
<li>The last line in the curly braces sets the message to be displayed by <code>conftest</code> if all the conditions are true.</li>
</ul>
<p>I can place this test into a file, which <code>conftest</code> expects to be in a subfolder named &ldquo;policy&rdquo;, and then pipe the output of <code>kumactl install control-plane</code> through it like this:</p>
<pre><code>kumactl install control-plane | conftest test -
</code></pre>
<p>This will produce a warning, of course, but that&rsquo;s exactly what we wanted&mdash;we want to the test to indicate that the <code>caBundle</code> hasn&rsquo;t been removed.</p>
<p>The test above checked for the <code>caBundle</code> value for validating webhooks; this slightly modified version does the same thing for mutating webhooks:</p>
<pre tabindex="0"><code>warn[msg] {
    input.kind == &#34;MutatingWebhookConfiguration&#34;
    some i; input.webhooks[i].clientConfig.caBundle
    msg = &#34;caBundle value not removed for a validating webhook&#34;
}
</code></pre><p>Let&rsquo;s look at another change and how we can test for it. What about change #4 from above&mdash;changing an environment variable being passed to the &ldquo;kuma-control-plane&rdquo; Deployment? Here&rsquo;s a Rego test for that:</p>
<pre tabindex="0"><code>warn[msg] {
    input.kind == &#34;Deployment&#34;
    env := input.spec.template.spec.containers[0].env[_]
    env.name == &#34;KUMA_RUNTIME_KUBERNETES_INJECTOR_CA_CERT_FILE&#34;
    not env.value == &#34;/var/run/secrets/kuma.io/ca-cert/ca.crt&#34;
    msg = &#34;KUMA_RUNTIME_KUBERNETES_INJECTOR_CA_CERT_FILE is not set correctly&#34;
}
</code></pre><p>The syntax here is a bit different, so let&rsquo;s discuss it before moving on:</p>
<ul>
<li>The header and the first line inside the braces are similar/the same as what I explained above in the previous example.</li>
<li>The second line in the braces creates a new variable, called <code>env</code>, and assigns it the contents of the <code>env</code> array of values under <code>spec.template.spec.container[0]</code> (i.e., the first container defined in the Deployment). The <code>env[_]</code> syntax is like another form of iteration, allowing Rego to perform the next two checks on all the contents of the array of values.</li>
<li>The next two lines check for a) an entry whose <code>name</code> field is set to KUMA_RUNTIME_KUBERNETES_INJECTOR_CA_CERT_FILE <em>and</em> b) whose <code>value</code> field is NOT set to the specified path. Recall that conditions within the braces are like a logical AND, so specifying both of these conditions allows the test to find instances where the environment variable is defined incorrectly (i.e., with a different value than what is expected/desired).</li>
<li>The test closes out with setting the message <code>conftest</code> will display if all the conditions are true.</li>
</ul>
<p>The test for change #2 is reasonably straightforward:</p>
<pre tabindex="0"><code>warn[msg] {
    input.apiVersion == &#34;admissionregistration.k8s.io/v1&#34;
    not input.metadata.annotations[&#34;cert-manager.io/inject-ca-from&#34;]
    msg = &#34;cert-manager CA injection annotation missing from a webhook&#34;
}
</code></pre><p>The only notable syntax note here is how Rego would reference the name of the annotation, which is &ldquo;cert-manager.io/inject-ca-from&rdquo;. If a field name contains only letters or numbers, then the <code>input.metadata.annotations</code> syntax (separating each field with a period) is sufficient. When a field contains something other than letters and numbers, then you need to move to the <code>input.metadata.annotations[&quot;cert-manager.io/inject-ca-from&quot;]</code> syntax, where the field name is referenced in brackets and quotes.</p>
<p>Finally, I can write the tests for the last change: adding a volume and mounting it to a path in the container. This change is a bit more complex. In this case, the tests need to flag three different conditions:</p>
<ol>
<li>If the volume isn&rsquo;t present</li>
<li>If the volume is present, but configured to point to the wrong entity (it&rsquo;s supposed to point to a specific Secret)</li>
<li>If the volume isn&rsquo;t mounted to the correct path in the container</li>
</ol>
<p>As you might expect, then, I need three tests. In this case, I&rsquo;m going to use a slightly different syntax that allows me to define a condition and then reference it later in a rule. First, let&rsquo;s set up the condition:</p>
<pre tabindex="0"><code>general_ca_vol_present = true {
    input.kind == &#34;Deployment&#34;
    vols := input.spec.template.spec.volumes[_]
    vols.name == &#34;general-ca-crt&#34;
}
</code></pre><p>By now, this syntax should look pretty familiar to you, with the exception of the header. This defines a condition&mdash;a subroutine or function, if you will&mdash;called <code>general_ca_vol_present</code>. This function checks to ensure that the volume does exist in the YAML manifest. I&rsquo;ll reference this in a rule in just a moment.</p>
<p><code>&lt;aside&gt;</code>One side note here: a peculiarity of Rego is that I can&rsquo;t test if the volume <em>doesn&rsquo;t exist.</em> If you check for <code>not vols.name == &quot;general-ca-crt&quot;</code>, this check is true because there <em>are</em> other volumes whose name is not &ldquo;general-ca-crt&rdquo;. This may require to you write your tests slightly differently than you might expect at first.<code>&lt;/aside&gt;</code></p>
<p>Next, a custom function to see if the volume is configured incorrectly (it doesn&rsquo;t point to the correct Secret):</p>
<pre tabindex="0"><code>general_ca_vol_incorrect = true {
    input.kind == &#34;Deployment&#34;
    vols := input.spec.template.spec.volumes[_]
    vols.name == &#34;general-ca-crt&#34;
    not vols.secret.secretName == &#34;kuma-root-ca&#34;
}
</code></pre><p>Finally, a function to check to see if it is mounted into the container correctly:</p>
<pre tabindex="0"><code>general_ca_crt_volume_mounted = true {
    input.kind == &#34;Deployment&#34;
    mounts := input.spec.template.spec.containers[0].volumeMounts[_]
    mounts.mountPath == &#34;/var/run/secrets/kuma.io/ca-cert&#34;
    mounts.name == &#34;general-ca-crt&#34;
    mounts.readOnly == true
}
</code></pre><p>With the functions defined, I can now write the rules:</p>
<pre tabindex="0"><code>warn[msg] {
    input.kind == &#34;Deployment&#34;
    not general_ca_vol_present
    msg = &#34;Additional volume not defined for CA of custom TLS certificate&#34;
}

warn[msg] {
    input.kind == &#34;Deployment&#34;
    general_ca_vol_incorrect
    msg = &#34;Additional volume for CA of custom TLS certificate not configured correctly&#34;
}

warn[msg] {
    input.kind == &#34;Deployment&#34;
    not general_ca_crt_volume_mounted
    msg = &#34;Additional volume for CA of custom TLS certificate not mounted or incorrectly mounted in container&#34;
}
</code></pre><p>With all the tests in place, running <code>kumactl install control-plane | conftest test -</code> will generate warnings, as expected. From here, I can start to write Kustomize configurations that will make the necessary changes, and run them back through the tests like this (this command assumes the Kustomize configuration is in a directory named &ldquo;kuma&rdquo; under the current directory):</p>
<pre><code>kustomize build kuma | conftest test -
</code></pre>
<p>When <code>conftest</code> finally reports zero warnings, I&rsquo;ll know my Kustomize configuration is making the changes I coded in my tests. Bam&mdash;I&rsquo;ve just used the principles behind test-driven development in the creation of a Kustomize configuration.</p>
<p>In this particular case, a sample Kustomize configuration that modifies the base YAML output by <code>kumactl install control-plane</code> is found in <a href="https://github.com/scottslowe/kuma-declarative-install">this GitHub repository</a>. I&rsquo;ve also added a Rego file with all the tests described in this post to the repository; it&rsquo;s found in the &ldquo;policy&rdquo; directory. You can use <code>conftest</code> to verify the sample Kustomize configuration using the Rego file in the &ldquo;policy&rdquo; directory.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>As mentioned above, <a href="https://github.com/scottslowe/kuma-declarative-install">this GitHub repository</a>&mdash;which was created to accompany the original <a href="/2021/10/21/creating-reusable-kuma-installation-yaml/">reusable Kuma installation YAML blog post</a>&mdash;has both a sample Kustomize configuation <em>and</em> a Rego policy file you can use with <code>conftest</code>. Feel free to take a closer look at either or both, or use them as the basis for something of your own.</p>
<p>If you have any questions, feel free to reach out to <a href="https://twitter.com/scott_lowe">me on Twitter</a>. I&rsquo;d be happy to help, if I&rsquo;m able. For help with Rego, OPA, or <code>conftest</code>, you can also check out <a href="https://openpolicyagent.slack.com">the Open Policy Agent Slack community</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kustomize">Kustomize</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/opa">OPA</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/yaml">YAML</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/12/31/technology-short-take-150/">Technology Short Take 150</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2022/01/12/getting-certificate-details-from-hashicorp-vault/">Getting Certificate Details from HashiCorp Vault</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2022%2f01%2f10%2fusing-test-driven-development-for-kustomize-overlays%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2022%2f01%2f10%2fusing-test-driven-development-for-kustomize-overlays%2f&text=Using%20Test-Driven%20Development%20for%20Kustomize%20Overlays" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2022%2f01%2f10%2fusing-test-driven-development-for-kustomize-overlays%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2021/10/21/creating-reusable-kuma-installation-yaml/">Creating Reusable Kuma Installation YAML</a> <span class="post-date-list">219 May 212121</span></li><li><a href="/2021/10/11/kustomize-transformer-configurations-for-cluster-api-v1beta1/">Kustomize Transformer Configurations for Cluster API v1beta1</a> <span class="post-date-list">119 May 111111</span></li><li><a href="/2020/03/17/kustomize-transformer-configuration-cluster-api-v1alpha3/">Kustomize Transformer Configurations for Cluster API v1alpha3</a> <span class="post-date-list">179 May 171717</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
