<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using cert-manager with Kuma for mTLS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using cert-manager with Kuma for mTLS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using cert-manager with Kuma for mTLS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2022/02/17/using-cert-manager-with-kuma-mtls/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using cert-manager with Kuma for mTLS</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 179 May 171717 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1187 words (estimated 6 minutes to read)</span>
  <p>When configuring mutual TLS (mTLS) on <a href="https://kuma.io/">the open source Kuma service mesh</a>, users have a couple of different options. They can use a &ldquo;builtin&rdquo; certificate authority (CA), in which Kuma itself will generate a CA certificate and key for use in creating service-specific mTLS certificates. Users also have the option of using a &ldquo;provided&rdquo; CA, in which they must supply a CA certificate and key for Kuma to use when creating service-specific mTLS certificates. Both of these options are described <a href="https://kuma.io/docs/1.4.x/policies/mutual-tls/">on this page in the Kuma documentation</a>. In this post, I&rsquo;d like to explore the use of <a href="https://cert-manager.io/">cert-manager</a> as a &ldquo;provided&rdquo; CA for mTLS on Kuma.</p>
<p>Currently, Kuma lacks direct integration with cert-manager, so the process is a bit more manual than I&rsquo;d prefer. If direct cert-manager integration is something you&rsquo;d find useful, please consider opening an issue to that effect on <a href="https://github.com/kumahq/kuma/">the Kuma GitHub repository</a>.</p>
<p>Assuming you have cert-manager installed already, the process for using cert-manager as the CA for a &ldquo;provided&rdquo; CA mTLS backend looks like this:</p>
<ol>
<li>Define the root CA in cert-manager.</li>
<li>Prepare the secrets for Kuma.</li>
<li>Configure the Kuma <code>mesh</code> object for mTLS.</li>
</ol>
<p>I know these steps are really too high level to be useful on their own, so I&rsquo;ll step through them in a bit more detail in the sections below.</p>
<h2 id="define-the-mtls-root-ca">Define the mTLS Root CA</h2>
<p>If you&rsquo;ve browsed <a href="https://cert-manager.io/docs/">the cert-manager documentation</a>, you&rsquo;ve probably seen that there are a variety of ways to set up an Issuer (a means of issuing Certificate objects managed by cert-manager). In this example, I&rsquo;ll just use a SelfSigned issuer, although you could use a different method. (To be honest, though, if you were going to go down the CA route you might as well just use the CA certificate and key with Kuma directly.)</p>
<p>To create a SelfSigned issuer, this piece of YAML would work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cert-manager.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">selfsigned-issuer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selfSigned</span>: {}
</span></span></code></pre></div><p>Then use that SelfSigned issuer to issue a root CA for Kuma to use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cert-manager.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Certificate</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kuma-mtls-root-ca</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kuma-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">isCA</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">commonName</span>: <span style="color:#ae81ff">kuma-mtls-root-ca</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">kuma-mtls-root-ca</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">duration</span>: <span style="color:#ae81ff">43800h</span> <span style="color:#75715e"># 5 years</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">renewBefore</span>: <span style="color:#ae81ff">720h</span> <span style="color:#75715e"># 30d</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">privateKey</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">algorithm</span>: <span style="color:#ae81ff">RSA</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">encoding</span>: <span style="color:#ae81ff">PKCS1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usages</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">digital signature</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">key encipherment</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">cert sign</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">issuerRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">selfsigned-issuer</span> <span style="color:#75715e"># References self-signed ClusterIssuer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cert-manager.io</span>
</span></span></code></pre></div><p>Once this is applied to the cluster where cert-manager is running (which doesn&rsquo;t necessarily need to be the cluster where Kuma will be installed, as you&rsquo;ll see in a moment), then cert-manager will create not only the Certificate resource but <em>also</em> a corresponding Secret that contains the certificate and the private key (the name of that Secret is controlled by the <code>spec.secretName</code> field above). You&rsquo;ll use that secret for the next step, which is preparing the secrets for Kuma.</p>
<h2 id="preparing-secrets-for-kuma">Preparing Secrets for Kuma</h2>
<p>It would be nice if Kuma could just use/read the Secret created by cert-manager directly, but that functionality doesn&rsquo;t currently exist. As a result, we&rsquo;ll need to take the Kubernetes Secret created by cert-manager and turn it into something that Kuma can leverage.</p>
<p>To do this, you&rsquo;ll need to make two mesh-scoped Kuma secrets (see <a href="https://kuma.io/docs/1.4.x/security/secrets/">the Kuma secrets documentation</a>). On Kubernetes, these will be Kubernetes Secrets, but labeled for a specific mesh and tagged as a specific type.</p>
<p>This example template shows what a mesh-scoped Kuma secret would look like on Kubernetes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample-secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kuma-system</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kuma.io/mesh</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#ae81ff">blah</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">system.kuma.io/secret</span>
</span></span></code></pre></div><p>The label (<code>kuma.io/mesh: default</code>), the type (<code>system.kuma.io/secret</code>), and the namespace (<code>kuma-system</code>) mark this as a mesh-scoped Kuma secret. How do you take the Kubernetes Secret generated by cert-manager and turn it into one of these?</p>
<p>Well, you <em>could</em> export the contents of the Kubernetes Secret created by cert-manager (using <code>kubectl get secret &lt;name&gt; -jsonpath='{.data.tls\.crt}'</code>, piping that through <code>base64</code> to decode it, and then redirecting to a file), and then use the file to create a new mesh-scoped Kuma secret using the template above, making sure to re-encode the file contents with <code>base64</code> alone the way. However, there&rsquo;s no real need to have the CA certificate and key in a file on the disk, and there&rsquo;s no real sense in decoding and then re-encoding the Secret&rsquo;s contents. Is there a better way?</p>
<p>In fact, there is. Using <code>yq</code> (here&rsquo;s <a href="https://github.com/mikefarah/yq">the GitHub repository</a> for it), you can do what you need with a single command (I&rsquo;ll break this command down in a moment):</p>
<pre><code>yq e &quot;.data.value = \
\&quot;$(kubectl -n kuma-system get secret kuma-mtls-root-ca \
-jsonpath='{.data.tls\.crt}')\&quot; secret-template.yaml | \
yq e '.metadata.name = &quot;mtls-root-certificate&quot;' -
</code></pre>
<p>That&rsquo;s a doozy! What&rsquo;s happening here? You&rsquo;re using <code>yq</code> to modify the values of a couple of fields; there&rsquo;s two iterations of <code>yq</code>, each modifying a different field. The first iteration of <code>yq</code> modifies the <code>.data.value</code> field, making its value equal to the output of the <code>kubectl get secret</code> command (which is the base64-encoded CA certificate in the Secret created by cert-manager). <code>yq</code> expects double quotes around the value being assigned to the field, but double quotes are needed to do the command substitution so the &ldquo;inner quotes&rdquo; are backslash-escaped. The second iteration of <code>yq</code> modifies the <code>.metadata.name</code> field to be equal to &ldquo;mtls-root-certificate&rdquo;. Since there&rsquo;s no command substitution in this iteration, you&rsquo;re using single quotes around the <code>yq</code> operation and unescaped double quotes around the value.</p>
<p>The end result looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mtls-root-certificate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kuma-system</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kuma.io/mesh</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#ae81ff">LS0tLS1CRUdJTiBDRVJUSUZJ...</span> <span style="color:#75715e"># Base64-encoded contents</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">system.kuma.io/secret</span>
</span></span></code></pre></div><p>Just add one final pipe (pipe it into <code>kubectl apply -f -</code>) to the command above and you&rsquo;re good to go.</p>
<p>Repeat for the key:</p>
<pre><code>yq e &quot;.data.value = \
\&quot;$(kubectl -n kuma-system get secret kuma-mtls-root-ca \
-jsonpath='{.data.tls\.key}')\&quot; secret-template.yaml | \
yq e '.metadata.name = &quot;mtls-root-key&quot;' - | \
kubectl apply -f -
</code></pre>
<p>You&rsquo;re now ready for the final step, which is configuring the Kuma mesh for mTLS.</p>
<h2 id="configuring-the-mesh-for-mtls">Configuring the Mesh for mTLS</h2>
<p>Fortunately, this step is pretty straightforward. Working from the example found in <a href="https://kuma.io/docs/1.4.x/policies/mutual-tls/">the Kuma mTLS documentation</a> for a &ldquo;provided&rdquo; backend, something like this would work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kuma.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Mesh</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mtls</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabledBackend</span>: <span style="color:#ae81ff">cert-manager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">backends</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cert-manager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">provided</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dpCert</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">rotation</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">expiration</span>: <span style="color:#ae81ff">1d</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">conf</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cert</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secret</span>: <span style="color:#ae81ff">mtls-root-certificate</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secret</span>: <span style="color:#ae81ff">mtls-root-key</span>
</span></span></code></pre></div><p>The backend name is entirely subjective, of course, but the names of the secrets referenced by <code>spec.conf.cert.secret</code> and <code>spec.conf.key.secret</code> must match the names of the mesh-scoped Kuma secrets you created in the previous section.</p>
<p>And that&rsquo;s it! Once this configuration is in place, Kuma will use the CA certificate issued by cert-manager (which you then translated into a pair of mesh-scoped Kuma secrets) to automatically issue and sign the mTLS certificates used by the data plane proxies. (You could use the Envoy admin API to see more details on these certificates, but that&rsquo;s a different post for a different day.)</p>
<p>If you have any questions about this, or about Kuma in general, feel free to hit me up. You can find me in <a href="https://kuma-mesh.slack.com">the Kuma community Slack</a>, or hit <a href="https://twitter.com/scott_lowe">me on Twitter</a>. My DMs are open and I&rsquo;d be happy to help if I&rsquo;m able.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/encryption">Encryption</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kuma">Kuma</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2022/01/21/follow-up-bootstrapping-servers-ansible/">Follow Up: Bootstrapping Servers into Ansible</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2022/02/28/technology-short-take-152/">Technology Short Take 152</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2022%2f02%2f17%2fusing-cert-manager-with-kuma-mtls%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2022%2f02%2f17%2fusing-cert-manager-with-kuma-mtls%2f&text=Using%20cert-manager%20with%20Kuma%20for%20mTLS" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2022%2f02%2f17%2fusing-cert-manager-with-kuma-mtls%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2021/10/21/creating-reusable-kuma-installation-yaml/">Creating Reusable Kuma Installation YAML</a> <span class="post-date-list">219 May 212121</span></li><li><a href="/2021/07/16/technology-short-take-142/">Technology Short Take 142</a> <span class="post-date-list">169 May 161616</span></li><li><a href="/2020/06/19/technology-short-take-128/">Technology Short Take 128</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
