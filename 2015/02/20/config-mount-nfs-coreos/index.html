<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Enabling and Mounting NFS on CoreOS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Enabling and Mounting NFS on CoreOS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Enabling and Mounting NFS on CoreOS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/02/20/config-mount-nfs-coreos/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Enabling and Mounting NFS on CoreOS</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 209 May 202020 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;628 words (estimated 3 minutes to read)</span>
  <p>I&rsquo;ve written about <a href="https://coreos.com">CoreOS</a> a fair amount (see <a href="/2014/08/01/a-quick-introduction-to-coreos/">here</a>, <a href="/2014/08/18/coreos-continued-etcd/">here</a>, and <a href="/2014/08/20/coreos-continued-fleet-and-docker/">here</a>), but one of the things that is both good and bad about CoreOS is the automatic update mechanism. It&rsquo;s good because you know your systems will stay up to date, but it&rsquo;s bad if you haven&rsquo;t taken the time to properly address how automatic updates will affect your environment (for example, you&rsquo;ve manually started some <a href="http://www.docker.com">Docker</a> containers instead of using <a href="http://freedesktop.org/wiki/Software/systemd/">systemd</a> unit files&mdash;when the CoreOS system reboots after an update, your Docker containers will no longer be running). Re-architecting your environment to fully account for this change in architecture and behavior is a larger discussion than can be addressed in a single blog post, but in this post I want to at least tackle one small part of the discussion: separating your persistent data. In this post, I&rsquo;ll show you how to mount an NFS share on a CoreOS instance deployed on <a href="http://www.openstack.org">OpenStack</a> (or any cloud that leverages cloud-init).</p>
<p>Now, you could probably go into your CoreOS instance and manually make these changes, but that&rsquo;s still thinking the old way. In addition to thinking about keeping persistent data separate, we (data center/cloud architects) also need to think about how we can keep configuration separate from instantiation. We <em>don&rsquo;t want</em> configuration details tied into an instance of CoreOS; we want that configuration applied automatically. This is why I&rsquo;m using cloud-init to make these changes&mdash;this allows you to just re-deploy your CoreOS instances and they&rsquo;ll pick up the new configuration.</p>
<p>CoreOS has some pretty good <a href="https://coreos.com/docs/">documentation</a>, but as I set out to figure out how to mount an NFS share from a CoreOS instance there were a few missing details. This post, while focused on <a href="http://www.gluster.org">GlusterFS</a>, gave me the missing details I needed. It turns out that two pieces are required to make this work:</p>
<ol>
<li>Creating an NFS environment file that enables the rpc-statd daemon to start.</li>
<li>Creating a systemd mount unit file to mount the NFS share.</li>
</ol>
<p>Fortunately, both of these tasks are easily handled via cloud-init. Here is a sample cloud-config file, written in YAML, that you could pass to CoreOS via cloud-init, that will take care of both the configuration tasks listed above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#cloud-config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">write-files</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/etc/conf.d/nfs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">permissions</span>: <span style="color:#e6db74">&#39;0644&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      </span>      <span style="color:#ae81ff">OPTS_RPC_MOUNTD=&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">coreos</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">units</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">rpc-statd.service</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">start</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enable</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mnt-data.mount</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">start</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Mount]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        What=nfshost.domain.com:/vol2/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Where=/mnt/data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Type=nfs</span>        
</span></span></code></pre></div><p>Let&rsquo;s walk through this real quick:</p>
<ul>
<li>The <code>write-files</code> section creates the NFS environment file that is needed to allow the rpc-statd daemon to start.</li>
<li>In the <code>units</code> section, the first portion enables and starts the rpc-statd service, which is stopped and disabled by default.</li>
<li>The second part of the <code>units</code> section creates a systemd mount unit file. This unit file specifies the remote host and share that should be mounted as well as the location on the local filesystem where it should be mounted. (Obviously, you&rsquo;d need to edit the YAML listed above to specify the correct NFS host and correct filesystem location.)</li>
</ul>
<p>If you were deploying a CoreOS instance on OpenStack, you&rsquo;d simply take the YAML code listed above (with your site-specific details, of course) and paste that into the &ldquo;Post-Creation&rdquo; section of the Launch Instance wizard (or you&rsquo;d supply it via the command-line to the <code>nova</code> client). If you&rsquo;re deploying CoreOS via Vagrant (as I described <a href="/2015/02/05/vagrant-coreos-etcd-fleet-docker/">here</a>), you&rsquo;d include this content in the <code>user-data</code> file that is referenced by the <code>Vagrantfile</code>. In both cases, it&rsquo;s cloud-init that will take this information and automatically configure CoreOS appropriately upon deployment. Naturally, you could also combine this information with other cloud-init directives to configure etcd, fleet, Docker, etc.</p>
<p>I know this doesn&rsquo;t seem too complicated (and it isn&rsquo;t, to be honest), but I hope that this information will be useful to someone out there.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nfs">NFS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/storage">Storage</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/openstack">OpenStack</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/coreos">CoreOS</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/02/18/presentations-markdown-deckset/">Presentations in Markdown Using Deckset</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/02/28/experimenting-docker-registrator-consul/">Experimenting with Docker, Registrator, and Consul</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f20%2fconfig-mount-nfs-coreos%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f20%2fconfig-mount-nfs-coreos%2f&text=Enabling%20and%20Mounting%20NFS%20on%20CoreOS" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f20%2fconfig-mount-nfs-coreos%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/02/05/vagrant-coreos-etcd-fleet-docker/">Using Vagrant with CoreOS, etcd, fleet, and Docker</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2014/11/07/technology-short-take-46/">Technology Short Take #46</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2014/10/08/technology-short-take-45/">Technology Short Take #45</a> <span class="post-date-list">89 May 8088</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
