<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Experimenting with Docker, Registrator, and Consul - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Experimenting with Docker, Registrator, and Consul - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Experimenting with Docker, Registrator, and Consul - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/02/28/experimenting-docker-registrator-consul/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Experimenting with Docker, Registrator, and Consul</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 289 May 282828 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/information">Information</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;543 words (estimated 3 minutes to read)</span>
  <p>Over the last few days, I&rsquo;ve been experimenting with <a href="https://www.docker.com">Docker</a>, <a href="https://github.com/gliderlabs/registrator">Registrator</a>, and <a href="https://www.consul.io">Consul</a> in an effort to explore some of the challenges involved in building a robust containerized infrastructure. While I haven&rsquo;t finished fully exploring the idea (and documenting what I&rsquo;ve learned), I did discover one interesting&mdash;and unexpected&mdash;interaction.</p>
<p>Here&rsquo;s a quick overview of my testing environment:</p>
<ul>
<li>I used two OpenStack Heat templates to spin up two clusters of 5 instances each.</li>
<li>The first cluster is a set of <a href="https://coreos.com">CoreOS Linux</a> instances, customized via cloud-init to <em>not</em> run etcd. These instances are attached to a <a href="https://www.vmware.com/products/nsx/">VMware NSX</a>-powered logical network using IP addresses from the 10.1.1.0/24 subnet.</li>
<li>On each CoreOS Linux instance, I have Registrator running as a Docker container and listening to the Docker socket (thus listening to Docker events).</li>
<li>The second cluster is a set of Ubuntu 14.04 instances running Consul. These instances are connected to an NSX-powered logical network using IP addresses from the 10.1.2.0/24 subnet.</li>
<li>The two logical networks are connected by a logical router and thus have full connectivity.</li>
</ul>
<p>Registrator, if you&rsquo;re not already familiar with it, is a service registry tool that listens to the Docker socket and registers/de-registers containers with a backend registry service (like Consul). This makes it an essential part of a dynamic containerized infrastructure, as service registration and service discovery are key challenges that must be addressed.</p>
<p>Based on some earlier testing, what I <em>expected</em> to happen in this environment was this:</p>
<ol>
<li>I would fire up a Docker container on one of the CoreOS instances.</li>
<li>Registrator running on that instance detects the new container and registers it with Consul (via one of the instances running Consul). The IP address registered with Consul would be the IP address of the CoreOS instance where the container is running (something from 10.1.1.0/24).</li>
<li>Services/applications/users could then discover (and access) the Docker container via the CoreOS instance&rsquo;s IP address by querying Consul (either via HTTP API or via DNS).</li>
</ol>
<p>However, what I found <em>actually</em> happened was this:</p>
<ol>
<li>A new Docker container is launched on one of the CoreOS instances.</li>
<li>Registrator detects the new container and registers it with Consul. However, because Consul is running on a separate node, the IP address that gets registered <em>is the IP address of the Consul node itself</em>, not the CoreOS host instance.</li>
<li>Services/applications/users attempting to discover the new service think it resides on the Consul node (something on 10.1.2.0/24), when in reality it is running on a CoreOS instance.</li>
</ol>
<p>I did not expect this behavior. From what I&rsquo;ve been able to find (see <a href="https://github.com/gliderlabs/registrator/issues/59">this issue</a>) this is expected behavior from Consul, and the only fix is to run Consul as a Docker container itself (a so-called &ldquo;sidecar&rdquo; container) on every host where Registrator is running. This is the configuration I used in my first round of testing, and thus why I was caught off-guard by the incorrect registration behavior in the new environment. In the next iteration of the testing environment, I&rsquo;ll run Consul as a sidecar container, although I need to deal with bootstrapping the Consul cluster in an environment where CoreOS instances will automatically reboot due to system updates.</p>
<p>I still have more testing to do (and more learning to do), and I&rsquo;ll continue to share the results of my testing/learning here.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/dns">DNS</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/02/20/config-mount-nfs-coreos/">Enabling and Mounting NFS on CoreOS</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/03/06/running-own-docker-swarm-cluster/">Running a Small Docker Swarm Cluster</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f28%2fexperimenting-docker-registrator-consul%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f28%2fexperimenting-docker-registrator-consul%2f&text=Experimenting%20with%20Docker%2c%20Registrator%2c%20and%20Consul" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f28%2fexperimenting-docker-registrator-consul%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/02/10/technology-short-take-48/">Technology Short Take #48</a> <span class="post-date-list">109 May 101010</span></li><li><a href="/2014/11/07/technology-short-take-46/">Technology Short Take #46</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2014/10/08/technology-short-take-45/">Technology Short Take #45</a> <span class="post-date-list">89 May 8088</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
