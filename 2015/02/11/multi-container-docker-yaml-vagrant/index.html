<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Multi-Container Docker with YAML and Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Multi-Container Docker with YAML and Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Multi-Container Docker with YAML and Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/02/11/multi-container-docker-yaml-vagrant/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Multi-Container Docker with YAML and Vagrant</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 119 May 111111 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1077 words (estimated 6 minutes to read)</span>
  <p>In this post, I&rsquo;ll provide an example of using YAML to create a multi-container Docker environment in Vagrant. I made a brief mention of this technique in my earlier post talking about <a href="/2015/02/10/using-docker-with-vagrant/">how to use Docker with Vagrant</a>, but wanted to provide an example. For me, I know that examples are often quite helpful when I&rsquo;m learning something new. Since one of my primary goals here is to help enable others to learn these technologies, I figured an example would be helpful. So, to that end, here&rsquo;s an example that I hope will help others.</p>
<p>As is becoming my custom, you can find resources to help you replicate this environment on your own laptop/desktop/whatever via <a href="https://github.com/scottslowe/learning-tools">my &ldquo;learning-tools&rdquo; GitHub repository</a>.</p>
<p>Before I get into the details, I want to just very quickly recap some information from my earlier post on using Docker with Vagrant:</p>
<ul>
<li>Vagrant has a built-in Docker provider (present since version 1.6).</li>
<li>Unless running on Linux, Vagrant will (by default) spin up an instance of a boot2docker VM on which to host the Docker containers. If you decide to modify this behavior (see the earlier post for full details), you&rsquo;ll end up with a second <code>Vagrantfile</code> that manages the host VM.</li>
<li>Vagrant also has a Docker provisioner that is capable of installing Docker onto a host VM.</li>
<li>As with all other Vagrant projects, there will be a main <code>Vagrantfile</code> that controls the specific Docker containers Vagrant will instantiate on the host VM.</li>
</ul>
<p>All of this was covered in my earlier post, so refer back there for more details.</p>
<p>In this post, I&rsquo;ll re-use the same <code>Vagrantfile</code> for the host VM, which tells Vagrant to use an Ubuntu 14.04 base box instead of the default boot2docker box. For the sake of completeness, here&rsquo;s that host VM <code>Vagrantfile</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Specify Vagrant version and Vagrant API version</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>require_version <span style="color:#e6db74">&#34;&gt;= 1.6.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create and configure the VM(s)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Assign a friendly name to this host VM</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;docker-host&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Skip checking for an updated Vagrant box</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box_check_update <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Always use Vagrant&#39;s default insecure key</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>ssh<span style="color:#f92672">.</span>insert_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Spin up a &#34;host box&#34; for use with the Docker provider</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># and then provision it with Docker</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;slowe/ubuntu-trusty-x64&#34;</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provision <span style="color:#e6db74">&#34;docker&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Disable synced folders (prevents an NFS error on &#34;vagrant up&#34;)</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>synced_folder <span style="color:#e6db74">&#34;.&#34;</span>, <span style="color:#e6db74">&#34;/vagrant&#34;</span>, <span style="color:#e6db74">disabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This <code>Vagrantfile</code> is pretty simple, and I&rsquo;ve added comments to help explain each command present. As in my earlier post, I&rsquo;ve stored this file in a <code>host</code> subdirectory off the main project directory.</p>
<p>The real meat of this post, though, is the use of a separate YAML file to provide the details on the Docker containers that Vagrant should create. This is a technique I&rsquo;ve used elsewhere (see <a href="/2014/10/22/multi-machine-vagrant-with-yaml/">here</a> for an example). In this particular case, I&rsquo;ve used a file named <code>containers.yml</code>, the contents of which look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>: [<span style="color:#e6db74">&#39;80:80&#39;</span>, <span style="color:#e6db74">&#39;443:443&#39;</span>]
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>: [<span style="color:#e6db74">&#39;6379:6379&#39;</span>]
</span></span></code></pre></div><p>As you can see, the YAML file specifies two containers, and for each container three properties are provided: a user-friendly name, the specific Docker image to use, and the network ports that should be exposed. If you wanted to create more containers, you&rsquo;d simply edit this YAML file to define these properties for additional containers. Note that these containers are all getting instantiated on the same host VM, so be mindful of port conflicts when exposing ports.</p>
<p>The main <code>Vagrantfile</code>, which Vagrant will use to create Docker containers on the host VM, now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Specify Vagrant version and Vagrant API version</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>require_version <span style="color:#e6db74">&#34;&gt;= 1.6.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;VAGRANT_DEFAULT_PROVIDER&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;docker&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Require &#39;yaml&#39; module</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;yaml&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read details of containers to be created from YAML file</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Be sure to edit &#39;containers.yml&#39; to provide container details</span>
</span></span><span style="display:flex;"><span>containers <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#e6db74">&#39;containers.yml&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create and configure the Docker container(s)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Perform one-time configuration of Docker provider to specify</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># location of Vagrantfile for host VM; comment out this section</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># to use default boot2docker box</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#34;docker&#34;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>docker<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    docker<span style="color:#f92672">.</span>vagrant_vagrantfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;host/Vagrantfile&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Iterate through the entries in the YAML file</span>
</span></span><span style="display:flex;"><span>  containers<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>container<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define container<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>cntnr<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Disable synced folders for the Docker container</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># (prevents an NFS error on &#34;vagrant up&#34;)</span>
</span></span><span style="display:flex;"><span>      cntnr<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>synced_folder <span style="color:#e6db74">&#34;.&#34;</span>, <span style="color:#e6db74">&#34;/vagrant&#34;</span>, <span style="color:#e6db74">disabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure the Docker provider for Vagrant</span>
</span></span><span style="display:flex;"><span>      cntnr<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#34;docker&#34;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>docker<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Specify the Docker image to use, pull value from YAML file</span>
</span></span><span style="display:flex;"><span>        docker<span style="color:#f92672">.</span>image <span style="color:#f92672">=</span> container<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;image&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Specify port mappings, pull value from YAML file</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If omitted, no ports are mapped!</span>
</span></span><span style="display:flex;"><span>        docker<span style="color:#f92672">.</span>ports <span style="color:#f92672">=</span> container<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;ports&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Specify a friendly name for the Docker container, pull from YAML file</span>
</span></span><span style="display:flex;"><span>        docker<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> container<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Again, I&rsquo;ve tried to heavily comment the <code>Vagrantfile</code> so that it&rsquo;s easy for others to follow along and figure out what the various commands do. At a high-level, this <code>Vagrantfile</code> does the following:</p>
<ul>
<li>Reads in the specified YAML file using the Ruby YAML module; the contents of the YAML file are now found in an array named &ldquo;containers&rdquo;.</li>
<li>Configures the Docker provider to use the specified host VM. This only needs to be done once, so it&rsquo;s found outside the loop that creates the containers.</li>
<li>Iterates through the array of containers, creating a Docker container for each one specified in the YAML file.</li>
</ul>
<p>When you run <code>vagrant up</code> in the main project directory, Vagrant will&mdash;if needed&mdash;instantiate the host VM (using the user-specified box) and provision Docker to that host VM, then turn up the list of containers as specified in the YAML file. The host VM just runs on the default private network that Vagrant uses, so if your virtualization platform provides connectivity to VMs on that network (<a href="http://www.vmware.com/products/fusion/">VMware Fusion</a> does for sure, I think <a href="http://www.virtualbox.org/">VirtualBox</a> might too) then you can try connecting to the host VM&rsquo;s IP address on a specified port to demonstrate that the Docker containers are running.</p>
<p>Similarly, you could use <code>vagrant global-status</code> to get the ID for the host VM, then use <code>vagrant ssh &lt;VM ID&gt;</code> to connect to the host VM to run commands like <code>docker images</code> or <code>docker ps</code>.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>As I mentioned earlier, sample <code>Vagrantfiles</code> and supporting documentation to replicate this setup in your own environment can be found in <a href="https://github.com/scottslowe/learning-tools">my &ldquo;learning-tools&rdquo; GitHub repository</a>. Just look in the &ldquo;vagrant-docker-yaml&rdquo; subdirectory.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/fusion">Fusion</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/yaml">YAML</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/02/10/using-docker-with-vagrant/">Using Docker with Vagrant</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/02/17/quick-thought-mesos-dns/">A Quick Thought About Mesos-DNS</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f11%2fmulti-container-docker-yaml-vagrant%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f11%2fmulti-container-docker-yaml-vagrant%2f&text=Multi-Container%20Docker%20with%20YAML%20and%20Vagrant" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f02%2f11%2fmulti-container-docker-yaml-vagrant%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/02/10/using-docker-with-vagrant/">Using Docker with Vagrant</a> <span class="post-date-list">109 May 101010</span></li><li><a href="/2015/02/05/vagrant-coreos-etcd-fleet-docker/">Using Vagrant with CoreOS, etcd, fleet, and Docker</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2015/02/03/first-git-now-vagrant/">First Git, now Vagrant</a> <span class="post-date-list">39 May 3033</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
