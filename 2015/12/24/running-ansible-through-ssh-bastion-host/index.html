<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Running Ansible Through an SSH Bastion Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Running Ansible Through an SSH Bastion Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Running Ansible Through an SSH Bastion Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/12/24/running-ansible-through-ssh-bastion-host/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Running Ansible Through an SSH Bastion Host</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 249 May 242424 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1057 words (estimated 5 minutes to read)</span>
  <p>This post will expand on some previous posts&mdash;one showing you <a href="/2015/11/21/using-ssh-bastion-host/">how to set up and use an SSH bastion host</a> and a second <a href="/2015/12/04/use-case-ssh-bastion-host/">describing one use case for an SSH bastion host</a>&mdash;to show how the popular configuration management tool <a href="http://www.ansible.com/">Ansible</a> can be used through an SSH bastion host.</p>
<p>The configuration/setup required to run Ansible through an SSH bastion host is actually reasonably straightforward, but I saw a <em>lot</em> of incomplete articles out there as I was working through this myself. My hope is to supplement the existing articles, as well as the Ansible documentation, to make this sort of configuration easier for others to embrace and understand.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>There are two key concepts involved here that you&rsquo;ll want to be sure you understand before you proceed:</p>
<ol>
<li>You&rsquo;ll want to make sure you&rsquo;re comfortable with <a href="/2015/11/21/using-ssh-bastion-host/">using an SSH bastion host</a>. If you don&rsquo;t understand how this works or how to set it up, I recommend you spend some time on this topic first, as it&rsquo;s crucial to how Ansible will behave/function. <a href="http://dotfiles.tnetconsulting.net/articles/2015/0506/empowering-openssh.html">This article</a> by Grant Taylor has some good information.</li>
<li>Spend some time making sure you know how to <a href="/2015/12/11/using-ssh-multiplexing/">use SSH multiplexing</a>. This is useful for Ansible in general, but it&rsquo;s even more critical in situations where you&rsquo;re using a bastion host.</li>
</ol>
<p>Once you&rsquo;re comfortable with these areas, you&rsquo;re ready to proceed with setting up Ansible to work through an SSH bastion host.</p>
<h2 id="configuration">Configuration</h2>
<p>There are two primary pieces involved:</p>
<ol>
<li>An Ansible-specific SSH configuration file that defines the SSH bastion host and other parameters. Using an Ansible-specific SSH configuration file keeps your own SSH configuration file (typically found in <code>~/.ssh/config</code>) &ldquo;clean,&rdquo; and facilitates better source code control.</li>
<li>Entries in the Ansible configuration file that pull in the custom SSH configuration file.</li>
</ol>
<p>Let&rsquo;s look at each of these independently.</p>
<h3 id="custom-ssh-configuration-file">Custom SSH Configuration File</h3>
<p>This is pretty straightforward, and something that I&rsquo;ve already discussed in my earlier posts on using an SSH bastion host and using SSH multiplexing. What you&rsquo;ll need to do here is a) define the hosts that should be accessed via the bastion host; and b) define how SSH will connect to the bastion host.</p>
<p>Here&rsquo;s a sample SSH configuration file. I&rsquo;ll break down some of the various settings found here below.</p>
<pre tabindex="0"><code>Host 10.10.10.*
  ProxyCommand ssh -W %h:%p bastion.example.com
  IdentityFile ~/.ssh/private_key.pem

Host bastion.example.com
  Hostname bastion.example.com
  User ubuntu
  IdentityFile ~/.ssh/private_key.pem
  ControlMaster auto
  ControlPath ~/.ssh/ansible-%r@%h:%p
  ControlPersist 5m
</code></pre><p>What does this configuration file do? Here&rsquo;s a quick rundown:</p>
<ul>
<li>The <code>Host 10.10.10.*</code> line indicates that <em>all</em> hosts in that subnet will use the settings defined in that block; specifically, all hosts will be accessed using the <code>ProxyCommand</code> setting and connect via <code>bastion.example.com</code> using the specified private key.</li>
<li>The <code>Host bastion.example.com</code> combines settings for acting as an SSH bastion host with settings for using SSH multiplexing (the <code>ControlMaster</code>, <code>ControlPath</code>, and <code>ControlPersist</code> settings).</li>
</ul>
<p>You can store this file wherever you like, but make note of where the file is stored as you&rsquo;ll need that for the next step: configuring Ansible to use the custom SSH settings.</p>
<h3 id="ansible-configuration">Ansible Configuration</h3>
<p>This custom SSH configuration file is useless without explicitly telling Ansible to use these settings when connecting to Ansible-managed hosts. This is accomplished by creating (or modifying) <code>ansible.cfg</code> and adding the following setings:</p>
<pre tabindex="0"><code>[ssh_connection]
ssh_args = -F ./ssh.cfg -o ControlMaster=auto -o ControlPersist=30m
control_path = ~/.ssh/ansible-%%r@%%h:%%p
</code></pre><p>This is an area where I found a lot of incorrect and/or incomplete information. A number of articles failed to note that these settings need to be in the <code>[ssh_connection]</code> portion of <code>ansible.cfg</code>; based on my testing, it won&rsquo;t work properly unless the settings are in the right section.</p>
<p>The <code>-F</code> parameter is where you&rsquo;ll provide the path (full/absolute or relative) to the custom SSH configuration file you created earlier. To simplify being able to keep all these files in source control, I prefer to place <code>ansible.cfg</code> in the current directory with my playbooks, inventory, roles, and host/group variables. I also prefer to keep the custom SSH configuration file here, which is why you see <code>-F ./ssh.cfg</code> in the example text above. Obviously, you&rsquo;ll want to tailor this to your specific environment.</p>
<p>Once you have these two pieces of configuration in place, you&rsquo;ll be able to run Ansible ad-hoc commands and/or Ansible playbooks against remote hosts via the SSH bastion host. Note that you&rsquo;ll still need entries in the Ansible inventory file for these remote hosts; the use of an SSH bastion host does not change that requirement.</p>
<p>For example, let&rsquo;s say I wanted to run the playbook <code>hypervisors.yml</code> against one of the remote servers using the sample values/configuration I&rsquo;ve shown in this article. I could run something like this:</p>
<pre><code>ansible-playbook hypervisors.yml --limit 10.10.10.23
</code></pre>
<p>This would run the <code>hypervisors.yml</code> playbook against <em>only</em> the host 10.10.10.23, which would need to have an entry in the inventory. (Note that I didn&rsquo;t specify an inventory file; this is because I typically use <code>ansible.cfg</code> to tell Ansible to look in the current directory for the inventory file.) The connection to 10.10.10.23 would occur via the SSH bastion host named &ldquo;bastion.example.com&rdquo; using the specified private key and specified user account, and would leverage SSH multiplexing to speed up the SSH connections and Ansible transactions occurring over those connections.</p>
<p>To again remind you why this might be useful, consider the ability to use Ansible as a configuration management tool against cloud instances that are not externally accessible (perhaps they exist inside an OpenStack Neutron tenant network or a private AWS VPC without Internet access). In this case, being able to use a bastion host to run Ansible against such hosts prevents you from needing to burn public/floating IP addresses or exposing hosts to external traffic when it really isn&rsquo;t absolutely necessary.</p>
<h2 id="other-resources">Other Resources</h2>
<p><a href="http://blog.dualspark.com/ansible/configuration-management/aws/ssh/2014/12/19/ansible-tower-ssh-agent-forwarding.html">This article</a> has information on setting up Ansible Tower for the use of an SSH bastion host. Also, <a href="https://gist.github.com/seansawyer/8fe009e67f7e01344328">this GitHub gist</a> has much of the same information as this article, so you may find it helpful in combination with this article or others.</p>
<p>If you have any questions or want more information, <a href="https://twitter.com/scott_lowe">hit me up on Twitter</a> and I&rsquo;ll do my best to help you out.</p>
<p><strong>UPDATE 14 Sep 2016:</strong> I&rsquo;ve removed the information on SSH agent forwarding from this article, as it is not required when using an SSH bastion host.</p>
<p><strong>UPDATE 17 Aug 2017:</strong> In Ansible 2, you&rsquo;re able to do this &ldquo;natively&rdquo; in Ansible; see <a href="https://docs.ansible.com/ansible/latest/faq.html#how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to">this entry in the FAQ</a>.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ansible">Ansible</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ssh">SSH</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/12/18/technology-short-take-58/">Technology Short Take #58</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/12/28/next-gen-network-engineering-skills/">Next-Generation Network Engineering Skills</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f24%2frunning-ansible-through-ssh-bastion-host%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f24%2frunning-ansible-through-ssh-bastion-host%2f&text=Running%20Ansible%20Through%20an%20SSH%20Bastion%20Host" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f24%2frunning-ansible-through-ssh-bastion-host%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/12/11/using-ssh-multiplexing/">Using SSH Multiplexing</a> <span class="post-date-list">119 May 111111</span></li><li><a href="/2015/11/23/bootstrapping-cloud-instances-ansible/">Bootstrapping Cloud Instances into Ansible</a> <span class="post-date-list">239 May 232323</span></li><li><a href="/2015/11/21/using-ssh-bastion-host/">Using an SSH Bastion Host</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
