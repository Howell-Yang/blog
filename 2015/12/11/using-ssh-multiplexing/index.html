<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using SSH Multiplexing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using SSH Multiplexing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using SSH Multiplexing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/12/11/using-ssh-multiplexing/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using SSH Multiplexing</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 119 May 111111 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1034 words (estimated 5 minutes to read)</span>
  <p>In this post, I&rsquo;m going to discuss how to configure and use SSH multiplexing. This is yet another aspect of Secure Shell (SSH), the &ldquo;Swiss Army knife&rdquo; for administering and managing Linux (and other UNIX-like) workloads.</p>
<p>Generally speaking, multiplexing is the ability to carry multiple signals over a single connection (see <a href="https://en.wikipedia.org/wiki/Multiplexing">this Wikipedia article</a> for a more in-depth discussion). Similarly, SSH multiplexing is the ability to carry multiple SSH sessions over a single TCP connection. <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">This Wikibook article</a> goes into more detail on SSH multiplexing; in particular, I would call your attention to the table under the &ldquo;Advantages of Multiplexing&rdquo; to better understand the idea of multiple SSH sessions with a single TCP connection.</p>
<p>One of the primary advantages of using SSH multiplexing is that it speeds up certain operations that rely on or occur over SSH. For example, let&rsquo;s say that you&rsquo;re using SSH to regularly execute a command on a remote host. Without multiplexing, every time that command is executed your SSH client must establish a new TCP connection and a new SSH session with the remote host. With multiplexing, you can configure SSH to establish a single TCP connection that is kept alive for a specific period of time, and SSH sessions are established over that connection. As pointed out in <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">the Wikibooks article</a> (see the measurements just before the &ldquo;Setting up Multiplexing&rdquo; section), this can result in speed increases that can add up when repeatedly running commands against remote SSH hosts.</p>
<p>I see a couple of use cases, then, emerging for the use of SSH multiplexing:</p>
<ul>
<li><em>When running commands remotely on an SSH host:</em> I mentioned this in the previous paragraph, but note that this isn&rsquo;t just about instances where you&rsquo;re using <code>ssh user@host some-command</code> to execute a command, but it also applies to applications that operate over SSH (<a href="http://www.ansible.com/">Ansible</a> is a great example).</li>
<li><em>When using an SSH bastion host:</em> I discussed the use of an SSH bastion host in <a href="/2015/11/21/using-ssh-bastion-host/">an earlier post</a> (as well as <a href="/2015/12/04/use-case-ssh-bastion-host/">one potential use case</a>). When using an SSH bastion host, multiple SSH sessions are channeled through the bastion, making it a natural use case for multiplexing.</li>
</ul>
<p>Now that I&rsquo;ve established a bit of a foundation for SSH multiplexing and why it might be useful, let&rsquo;s look at how it is configured. The configuration is actually really straightforward. Here&rsquo;s a sample configuration that enables SSH multiplexing for a specific host:</p>
<pre><code>Host demo-server.domain.com
  ControlPath ~/.ssh/cm-%r@%h:%p
  ControlMaster auto
  ControlPersist 10m
</code></pre>
<p>This is a fairly standard SSH configuration block, but let&rsquo;s break it down a bit:</p>
<ul>
<li>The <code>Host</code> keyword starts the SSH configuration block and specifies the name (or pattern of names, as you can use globbing expressions like <code>*.domain.com</code> here) to which the configuration entries will apply. In this case, it&rsquo;s a specific server.</li>
<li>The <code>ControlPath</code> entry specifies where to store the &ldquo;control socket&rdquo; for the multiplexed connections. In this case, <code>%r</code> refers to the remote login name, <code>%h</code> refers to the target host name, and <code>%p</code> refers to the destination port. Including this information in the control socket name helps SSH separate control sockets for connections to different hosts.</li>
<li>The <code>ControlMaster</code> setting is what activates multiplexing. With the <code>auto</code> setting, SSH will try to use a master connection if one exists, but if one doesn&rsquo;t exist it will create a new one (this is probably the most flexible approach, but you can refer to <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/ssh_config.5?query=ssh%5fconfig&amp;arch=i386">ssh-config(5)</a> for more details on the other settings).</li>
<li>Finally, the <code>ControlPersist</code> setting keeps the master connection alive for the specified period of time after it has remained idle (no connections). After that time, the master connection will be closed. In this example, we&rsquo;ve specified that the master connection should remain open for 10 minutes after becoming idle. Subsequent SSH sessions made while the master connection is open will leverage the master connection and will reset the idle timer.</li>
</ul>
<p>With this sort of configuration, no extra effort is required on your part, as the user, to take advantage of SSH multiplexing. You&rsquo;ll establish your master connection when you connect to the remote server for the very first time (using a standard <code>ssh user@host</code> sort of command). That creates the master connection, and that master connection will remain open for 10 minutes (or whatever you&rsquo;ve specified for <code>ControlPersist</code>). When you connect again (still using the standard <code>ssh user@host</code> command) while the master connection is still open, SSH will automatically leverage the master connection.</p>
<p>I mentioned earlier that one use case for SSH multiplexing was in conjunction with an SSH bastion host. For example, consider this SSH configuration:</p>
<pre><code>Host bastion
  Hostname server.example.com
  ForwardAgent yes
  ControlPath ~/.ssh/cm-%r@%h:%p
  ControlMaster auto
  ControlPersist 10m

Host 172.16.*
  ProxyCommand ssh user@bastion -W %h:%p
</code></pre>
<p>In this case, the first time you connect to an SSH host in the 172.16.* address space, SSH will establish a master connection to the bastion host (<code>server.example.com</code>, in this case). The connection to the private server will be proxied through the bastion host. When you connect to a second SSH host in the 172.16.* address space, the <em>existing</em> master connection to the bastion host is leveraged, and a new SSH session is established with the second private server. The same goes for <em>all</em> subsequent SSH sessions to servers in the private address space that are being proxied through the bastion host&mdash;they all share the same master connection to the bastion. Naturally, this can make connecting to the private servers through the bastion faster than it would be otherwise without SSH multiplexing.</p>
<p>Note that some older versions of OpenSSH may have had some issues with combining <code>ProxyCommand</code> and <code>ControlMaster</code>, so make sure you do some testing. I tested with relatively recent versions of OpenSSH (OpenSSH 6.9p1 on OS X 10.11.2 and OpenSSH 6.6.1p1 on Ubuntu 14.04 LTS) and was not able to reproduce any issues. Your mileage may vary, of course.</p>
<p>I hope you&rsquo;ve found this article helpful. If you have any questions, I would love to chat with you <a href="https://twitter.com/scott_lowe">on Twitter</a>. Thanks for reading!</p>
<p><strong>UPDATE:</strong> Jake Robinson pointed out to me on Twitter that OpenSSH 5.1 added a <code>MaxSessions</code> parameter to <code>sshd_config</code>. The default value is 10, meaning that at most 10 multiplexed connections are allowed. See <a href="http://www.openssh.com/txt/release-5.1">the OpenSSH 5.1 release notes</a> for full details. Thanks Jake!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ssh">SSH</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/12/04/use-case-ssh-bastion-host/">One Use Case for an SSH Bastion Host</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/12/11/technology-short-take-57/">Technology Short Take #57</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f11%2fusing-ssh-multiplexing%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f11%2fusing-ssh-multiplexing%2f&text=Using%20SSH%20Multiplexing" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f12%2f11%2fusing-ssh-multiplexing%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/11/21/using-ssh-bastion-host/">Using an SSH Bastion Host</a> <span class="post-date-list">219 May 212121</span></li><li><a href="/2013/08/21/accessing-vnc-consoles-of-kvm-guests-via-ssh/">Accessing VNC Consoles of KVM Guests via SSH</a> <span class="post-date-list">219 May 212121</span></li><li><a href="/2015/12/04/use-case-ssh-bastion-host/">One Use Case for an SSH Bastion Host</a> <span class="post-date-list">49 May 4044</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
