<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>VLAN Trunking with Cumulus Linux - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="VLAN Trunking with Cumulus Linux - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="VLAN Trunking with Cumulus Linux - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2015/06/25/vlan-trunking-cumulus-linux/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">VLAN Trunking with Cumulus Linux</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 259 May 252525 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;755 words (estimated 4 minutes to read)</span>
  <p>Following up on <a href="/2015/06/01/cumulus-networking-concepts/">my earlier post on Cumulus Linux networking concepts</a>, I wanted to build on that information with a guide on configuring VLAN trunking. This would be useful in a number of different scenarios: supporting multiple (VLAN-backed) port groups on <a href="http://www.vmware.com/products/vsphere/">vSphere</a> hosts, or connecting an <a href="http://openvswitch.org">Open vSwitch (OVS)</a> bridge on a KVM or Xen hypervisor to multiple VLANs. You might also need to use a VLAN trunking configuration to connect a Cumulus Linux-powered switch to another switch.</p>
<p>For this configuration, I&rsquo;m going to use the new <em>VLAN-aware</em> bridging functionality introduced in Cumulus Linux 2.5. There are two pieces involved in making this work:</p>
<ol>
<li>The configuration for VLAN-aware bridge itself</li>
<li>The configuration for the individual port(s)</li>
</ol>
<p>Let&rsquo;s look at each of these pieces individually.</p>
<h2 id="the-vlan-aware-bridge">The VLAN-Aware Bridge</h2>
<p>In order to provide layer 2 (switched) connectivity between front-panel ports on a Cumulus Linux-powered switch, the ports have to be part of a bridge. In this case, we&rsquo;ll create a <em>VLAN-aware</em> bridge, which simplifies the configuration (in my opinion). It&rsquo;s a bit less &ldquo;true&rdquo; to the Linux way of doing things, but simpler.</p>
<p>Owing to its Debian roots, you&rsquo;ll configure the bridge by either adding a stanza to <code>/etc/network/interfaces</code> or by placing a configuration file in <code>/etc/network/interfaces.d</code>. I tend to prefer the latter approach, and here&rsquo;s a sample file that illustrates how to create and configure the bridge:</p>
<pre tabindex="0"><code>auto bridge
iface bridge
  bridge-vlan-aware yes
  bridge-ports swp1 swp3 swp4 swp5 swp8 swp10 swp16s1
  bridge-vids 3 4 6-10
  bridge-pvid 1
  bridge-stp on
  mstpctl-treeprio 20480
</code></pre><p>Here&rsquo;s a brief description of the configuration parameters illustrated here:</p>
<ul>
<li>The <code>bridge-vlan-aware</code> statement is what makes the bridge &ldquo;VLAN-aware&rdquo;, naturally. You should have only a single VLAN-aware bridge per switch.</li>
<li>The <code>bridge-ports</code> statement lists the front panel ports that are part of this bridge. Note that you could also use <code>bridge-ports glob</code>, which would allow you to specify a range of ports instead of listing them individually. The use of <code>bridge-ports glob</code> to include all the front panel ports in single VLAN-aware bridge is probably the typical way one would configure the switch.</li>
<li>One quick side note regarding ports: the &ldquo;swp16s1&rdquo; listed above represents a 40GbE port that is being divided into four 10GbE ports via a breakout cable.</li>
<li>The <code>bridge-pvid</code> statement specifies the native (untagged) VLAN. If the native VLAN is 1, this statement isn&rsquo;t required.</li>
<li><code>bridge-vids</code> declares the VLANs for the bridge (in this case, VLANs 3, 4, and 6 through 10).</li>
<li>STP (RSTP, specifically) is activated on this bridge using the <code>bridge-stp on</code> statement.</li>
<li>Finally, the <code>mstpctl-treeprio</code> statement sets the bridge tree root priority (must be a multiple of 4096).</li>
</ul>
<p>By default, ports that are included in a bridge (via the <code>bridge-ports</code> statement) will inherit the VLAN IDs defined on the bridge (via the <code>bridge-pvid</code> and <code>bridge-vids</code> statements). However, it may be necessary to modify the behavior/configuration of individual ports within the bridge, so continue to the next section for more information.</p>
<h2 id="individual-port-configuration">Individual Port Configuration</h2>
<p>If you don&rsquo;t specify otherwise, ports included in a VLAN-aware bridge will automatically be VLAN trunks, carrying tagged traffic for all the VLANs specified for the bridge (the native VLAN will, of course, be untagged). By modifying the configuration of individual ports within the bridge, you can change the native VLAN for that port as well as prune VLANs (limit the VLANs carried on the trunk).</p>
<p>As before, both of these tasks are handled by making modifications to the appropriate configuration stanza in <code>/etc/network/interfaces</code> or modifications to the appropriate file in <code>/etc/network/interfaces.d/</code>:</p>
<ul>
<li>To change the native VLAN for that specific port, add a <code>bridge-pvid</code> statement to that port&rsquo;s configuration file.</li>
<li>To prune (limit) VLANs on a trunk, add a <code>bridge-vids</code> statement to that port&rsquo;s configuration file/stanza that lists the VLAN IDs that are allowed across that port.</li>
</ul>
<p>For example, if a port that is a member of the bridge described earlier needed to use a different native VLAN, you&rsquo;d need to add <code>bridge-pvid 2</code> (or whatever value is needed) to the configuration file/stanza for that particular port. Similarly, if you needed to prune (limit) VLANs on a port that was a member of the example bridge described earlier in this post, you&rsquo;d add <code>bridge-vids 4 6 8</code> to that port&rsquo;s configuration file/stanza (which would only allow tagged traffic on VLANs 4, 6, and 8 to traverse that port).</p>
<p>And that&rsquo;s it!</p>
<p>Hopefully this was somewhat helpful. I have more posts queued up, so please stay tuned. In the meantime, feel free to contact me via Twitter if you have any questions about this article. Thanks for reading!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vlan">VLAN</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cumulus">Cumulus</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2015/06/24/dockercon-vendor-briefings/">DockerCon Vendor Briefings</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2015/06/30/fix-for-ubuntu-caching-network-configuration/">A Fix for Ubuntu Apparently Caching Network Configuration</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2015%2f06%2f25%2fvlan-trunking-cumulus-linux%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f06%2f25%2fvlan-trunking-cumulus-linux%2f&text=VLAN%20Trunking%20with%20Cumulus%20Linux" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2015%2f06%2f25%2fvlan-trunking-cumulus-linux%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/06/01/cumulus-networking-concepts/">Some Cumulus Linux Networking Concepts</a> <span class="post-date-list">19 May 1011</span></li><li><a href="/2015/03/10/technology-short-take-49/">Technology Short Take #49</a> <span class="post-date-list">109 May 101010</span></li><li><a href="/2014/11/21/removing-ovs-configuration-settings/">Removing OVS Configuration Settings</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
