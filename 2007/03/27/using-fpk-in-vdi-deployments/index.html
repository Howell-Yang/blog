<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using FPK in VDI Deployments - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using FPK in VDI Deployments - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using FPK in VDI Deployments - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2007/03/27/using-fpk-in-vdi-deployments/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using FPK in VDI Deployments</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 279 May 272727 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1019 words (estimated 5 minutes to read)</span>
  <p>Many <a href="http://www.vmware.com/">VMware</a> <a href="http://www.vmware.com/solutions/desktop/vdi.html">Virtual Desktop Infrastructure</a> (VDI) deployments will likely be environments where the virtual desktops will be the only desktops that the user ever logs into. Environments like outsourced development (developers use hosted desktops so that the source code never leaves the company&rsquo;s equipment) and call centers are two examples that come to mind. A recent project in which I was involved, though, was a bit different: the customer wanted to use hosted desktops to provide access to a specific application (an application which was very data-intensive), but all other applications would be run from traditional &ldquo;fat&rdquo; PCs. Users would be logged in to both a traditional PC as well as a hosted desktop session, typically at the same time.</p>
<p>The customer couldn&rsquo;t use more mainstream server-based computing solutions such as <a href="http://www.citrix.com/English/ps2/products/product.asp?contentID=186&amp;ntref=hp_nav_US">Citrix Presentation Server</a> or <a href="http://www.microsoft.com/windowsserver2003/technologies/terminalservices/default.mspx">Microsoft Windows Terminal Services</a> because the application wasn&rsquo;t supported in those environments. It had to be a desktop environment. To complicate the matter, the business needs of the organization dictated that users logging into these hosted desktops needed to have some of their settings travel with them (sort of like roaming profiles), but&mdash;and here&rsquo;s the catch&ndash;<em>only when logging in to a hosted desktop session.</em> The settings the user configured inside the hosted desktop session should move between hosted desktops, but should not affect their traditional PC login.</p>
<p>That&rsquo;s right: the saved settings should only apply when they were logging in to a hosted desktop session, not a regular desktop session. That meant we couldn&rsquo;t use roaming profiles to these settings travel between hosted desktops, since that attribute is set on a per-user account basis in Active Directory and would affect logons to both traditional PCs as well as hosted virtual desktops. Now things start to get interesting.</p>
<p>Fortunately, a tool designed for multi-user environments such as Citrix and Terminal Services was able to save the day. That tool, the <a href="http://portal.loginconsultants.nl/forum/index.php?board=16;action=display;threadid=1144">Flex Profile Kit</a> (FPK), allows administrators to selectively save portions of a user&rsquo;s profile to a simple file, which can then be reapplied at next logon. Using a configuration file and a small executable, we can define groups of settings that should be saved to a file. That file is stored on a central file share, and then copied back down and re-applied when the user next logs in again. Using this functionality, we can mimic the effect of a roaming profile without having to modify any user objects in Active Directory (and thus limiting the impact to hosted desktops only).</p>
<p>In the following sections I discuss some of the specific challenges we faced when using FPK for this project.</p>
<h2 id="mandatory-profiles">Mandatory Profiles</h2>
<p>Normally, an FPK deployment requires the use of mandatory profiles. Otherwise, the FPK is unable to fully configure the environment to account for &ldquo;deleted&rdquo; or &ldquo;removed&rdquo; settings, such as a drive mapping that no longer exists or a printer that has been uninstalled. The only way I can describe this is to say that the FPK only stores the settings that should be saved; it doesn&rsquo;t store settings that should be removed or overwritten. As a result, changes in the user&rsquo;s profile that result in the removal of data from the Registry or file system&mdash;such as disconnecting a mapped network drive&mdash;don&rsquo;t get captured and continue to show up in future sessions. Mandatory profiles fix that because <em>nothing</em> gets saved to the base profile, so only what&rsquo;s in the FPK saved settings will get applied.</p>
<p>However, we couldn&rsquo;t assign mandatory profiles in this case because mandatory profiles are also roaming profiles, and we were under strict mandate that the hosted desktops and the physical desktops were not to affect one another. Try as I may, I couldn&rsquo;t think of any way to assign roaming profiles without those settings also affecting logons to physical systems.</p>
<p>We were finally able to circumvent that problem by using REG.EXE, from one of the Windows Resource Kits, to delete the Registry keys associated with the values that were being stored by FPK. At logoff, the logoff script would use FPK to store the values in the user&rsquo;s profile, then REG.EXE would &ldquo;clean&rdquo; those values out of the user&rsquo;s profile. When the user logged in again, he or she would receive only the values stored by the FPK.</p>
<h2 id="running-fpk-at-logonlogoff">Running FPK at Logon/Logoff</h2>
<p>Again, due to the fact that we could not allow the hosted desktops to share settings with the physical desktops, we also couldn&rsquo;t run FPK through the user&rsquo;s regular login script (again, the attribute is specified via Active Directory and would affect logons to both physical and hosted desktops). This means we needed a way to run FPK at logon and logoff, but only for hosted desktops. Fortunately, this challenge was fairly easy to overcome: use a Group Policy object (GPO) on the OU where the hosted desktop computer accounts are found, enable loopback processing, and set the logon/logoff scripts there.</p>
<p>For those that aren&rsquo;t familiar with loopback processing, here&rsquo;s what it is (in a nutshell). Normally, Active Directory would process the computer settings portion of a GPO based on the location of the computer object in Active Directory, and apply the user settings portion of a GPO based on the user&rsquo;s location in AD. However, in some cases, we might want to apply user settings based on the <em>computer&rsquo;s</em> location, such as when a user is logging into a particular machine or particular type of machine. This situation is a prime example of just such a case. We want user settings applied only when the user logs into a hosted desktop, so we include the user settings in a GPO that is linked the OU where the computer accounts for the hosted desktops reside and enable loopback processing (in &ldquo;Replace&rdquo; mode, in this instance). Then, those user settings will only apply when the user logs into one of those systems, and not any other systems. Problem solved.</p>
<p>If you are currently considering a VDI project, I&rsquo;d encourage you to have a look at FPK. You may find it useful, as I did.</p>
<p><strong>UPDATE:</strong> Michael Roth of <a href="http://www.thincomputing.net/">thincomputing.net</a> has provided an <a href="http://www.loginconsultants.com/index.php?option=com_docman&amp;task=doc_details&amp;gid=1&amp;Itemid=62">updated URL for the FPK</a>.  Thanks, Michael!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/esx">ESX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vdi">VDI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/windows">Windows</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2007/03/23/vdi-and-leostream-connection-broker/">VDI and Leostream Connection Broker</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2007/03/27/new-vmotion-boundary/">New VMotion Boundary</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2007%2f03%2f27%2fusing-fpk-in-vdi-deployments%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f03%2f27%2fusing-fpk-in-vdi-deployments%2f&text=Using%20FPK%20in%20VDI%20Deployments" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f03%2f27%2fusing-fpk-in-vdi-deployments%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2007/02/27/return-of-the-old-microsoft/">Return of the Old Microsoft</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2006/12/28/personal-computing-as-a-collection-of-vms/">Personal Computing as a Collection of VMs?</a> <span class="post-date-list">289 May 282828</span></li><li><a href="/2006/12/05/the-future-of-the-os/">The Future of the OS</a> <span class="post-date-list">59 May 5055</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
