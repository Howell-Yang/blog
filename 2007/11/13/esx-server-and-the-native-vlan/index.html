<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>ESX Server and the Native VLAN - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="ESX Server and the Native VLAN - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="ESX Server and the Native VLAN - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2007/11/13/esx-server-and-the-native-vlan/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">ESX Server and the Native VLAN</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 139 May 131313 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;867 words (estimated 5 minutes to read)</span>
  <p>It was December 2006 when I first published this article on <a href="/2006/12/04/esx-server-nic-teaming-and-vlan-trunking/">using NIC teams and VLANs with ESX Server</a>. As you can see in the &ldquo;Top Posts&rdquo; section in the sidebar, that article has since claimed the top position in the most popular post here on this blog. Note that &ldquo;most popular&rdquo; does not translate into &ldquo;most commented&rdquo;; that distinction falls to one of the Linux-AD integration articles, although I not sure <a href="/2006/08/08/linux-active-directory-and-windows-server-2003-r2-revisited/">which</a> <a href="/2007/01/15/linux-ad-integration-version-4/">one</a> right at the moment.</p>
<p>In that previous article, I demonstrated the use of a &ldquo;dummy VLAN&rdquo; which was set as the native VLAN for the VLAN trunk, like so:</p>
<pre><code>s3(config)#int gi0/23  
s3(config-if)#switchport trunk encapsulation dot1q  
s3(config-if)#switchport trunk allowed vlan all  
s3(config-if)#switchport mode trunk  
s3(config-if)#switchport trunk native vlan 4094
</code></pre>
<p>The idea behind the dummy VLAN was this: because ESX Server needed&mdash;or so I thought&mdash;all the traffic to be tagged as it came across the VLAN trunk, creating a VLAN that is never used and setting it as the native VLAN solves our problem. Remember that the native VLAN is the VLAN whose traffic <em>is not</em> tagged as it travels across the trunk into ESX Server or another physical switch.</p>
<p>It turns out that I was actually mistaken&mdash;sort of. It&rsquo;s true that the native VLAN won&rsquo;t get tagged, yes; however, it&rsquo;s not true that ESX Server requires all the traffic to be tagged. What was missing in my configuration was, quite simply, a port group that was intended to receive untagged traffic.</p>
<p>Configuring ESX Server to support VLANs involves the creation of one or more port groups configured with matching VLAN IDs. If a port group has a VLAN ID, it will essentially only accept traffic tagged with that VLAN ID. Traffic not tagged with that VLAN ID, or untagged traffic, will be ignored. So, if you create a series of port groups on a vSwitch for your various VLANs but neglect to create a port group that does not have a VLAN ID specified, untagged traffic will be ignored because there are no port groups configured to receive untagged traffic.</p>
<p>If, on the other hand, you create a series of port groups for your various VLANs <em>and</em> you create a port group that does not have a VLAN ID specified, then both tagged and untagged traffic will be handled correctly:</p>
<ul>
<li>
<p>Tagged traffic with a VLAN ID matching one of the configured port groups will be sent to that port group</p>
</li>
<li>
<p>Tagged traffic with a VLAN ID not matching any configured port group will be ignored</p>
</li>
<li>
<p>Untagged traffic will be directed to the port group that does not have a VLAN ID configured</p>
</li>
</ul>
<p>Now, it is true that VMware&rsquo;s best practices documents (sorry, I don&rsquo;t have a link for them at the moment) recommend that users avoid the use of the native VLAN, and one of the CCIEs in my office indicated that it is also considered a networking best practice to avoid the use of VLAN 1, the default native VLAN on Cisco equipment, for anything other than switch management traffic. With those things in mind, it may not be an issue for many deployments.</p>
<p>Except&hellip;</p>
<p>&hellip;when using automated scripts to build and install ESX Server. You see, after ESX Server is installed, then specifying a VLAN ID on the Service Console port group is no big deal and it will work just fine, as I described earlier. <em>Before</em> ESX Server is installed, though, there is no VLAN support and no way to specify a VLAN ID. Hence, installations that need to download and install from a FTP server or an NFS mount will fail, because the system won&rsquo;t have any network connectivity. (Everyone understands why, right? If you don&rsquo;t, go back and read the earlier paragraphs again.)</p>
<p>What&rsquo;s the fix here? We come back, full circle, to the idea of the default VLAN and untagged traffic. While the system won&rsquo;t accept any tagged traffic during the install process, it will happily accept untagged traffic during the installation. Therefore, if you set the native VLAN to be the VLAN to which the Service Console should be connected once the installation is complete, then everything should work just fine.</p>
<p>Don&rsquo;t believe me? From the &ldquo;Show Me&rdquo; state? Perform this quick test yourself:</p>
<ol>
<li>
<p>On a test ESX Server, configure the Service Console port group with a VLAN ID of 0. The <code>esxcfg-vswitch</code> command is handy for this.</p>
</li>
<li>
<p>Set the switch port to which the Service Console is physically connected to use a native VLAN different than the VLAN the Service Console was previously using. A VLAN with DHCP present is ideal, as you&rsquo;ll see with the next step.</p>
</li>
<li>
<p>Using the <code>dhclient</code> command, try to obtain a DHCP lease. You should get a DHCP lease for whatever subnet matches the default VLAN.</p>
</li>
<li>
<p>Repeat steps 2 and 3 and you should see the DHCP lease follow the native VLAN configuration, i.e., whatever VLAN is set to native will be the VLAN that issues a DHCP address to your Service Console.</p>
</li>
</ol>
<p>Hopefully, this helps clear up some of the misunderstanding and confusion around the use of VLANs, VLAN trunks, port groups, and the native&mdash;or untagged&mdash;VLAN. Feel free to hit me up in the comments if you have any questions!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/esx">ESX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vlan">VLAN</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2007/11/13/second-vdi-article-published/">Second VDI Article Published</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2007/11/13/performance-in-linux-ad-integration-scenarios/">Performance in Linux-AD Integration Scenarios</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2007%2f11%2f13%2fesx-server-and-the-native-vlan%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f11%2f13%2fesx-server-and-the-native-vlan%2f&text=ESX%20Server%20and%20the%20Native%20VLAN" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f11%2f13%2fesx-server-and-the-native-vlan%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2006/12/04/esx-server-nic-teaming-and-vlan-trunking/">ESX Server, NIC Teaming, and VLAN Trunking</a> <span class="post-date-list">49 May 4044</span></li><li><a href="/2006/04/17/vlans-and-port-groups/">VLANs and Port Groups</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2007/09/13/vmworld-2007-top-support-issues-session/">VMworld 2007 Top Support Issues Session</a> <span class="post-date-list">139 May 131313</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
