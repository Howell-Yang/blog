<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Full VM Recovery with NetApp Snapshots - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Full VM Recovery with NetApp Snapshots - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Full VM Recovery with NetApp Snapshots - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2007/10/08/full-vm-recovery-with-netapp-snapshots/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Full VM Recovery with NetApp Snapshots</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 89 May 8088 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;679 words (estimated 4 minutes to read)</span>
  <p>I guess I&rsquo;m on a bit of a NetApp kick this week. After discussing (or perhaps revisiting) the idea of recovering files inside VMs using NetApp Snapshots (first <a href="/2006/12/30/recovering-data-inside-vms-using-netapp-snapshots/">here late last year</a>, then again <a href="/2007/10/08/vm-file-level-recovery-with-netapp-snapshots/">here</a>), I wanted to take a closer look at full VM recovery using NetApp Snapshots.</p>
<p>First of all, it should go without saying that you should never use any of the procedures I&rsquo;m describing here without first testing them yourself. While they worked fine for me, they may not work fine for you. Don&rsquo;t just assume they will! Do the due diligence and test it in your environment first; you&rsquo;ll be glad you did.</p>
<p>Second, before using NetApp Snapshots to recover VM data (file-level or full VM), be sure you are getting good, consistent Snapshots. The <a href="http://www.netapp.com/library/tr/">Network Appliance Technical Reports Library</a> has a number of excellent articles on this subject; I&rsquo;ll defer you there for more information.</p>
<p>I&rsquo;ll break this article into two sections, one for block-level storage (I&rsquo;m using iSCSI, but the process should be almost identical for Fibre Channel) and one for NAS/NFS. Please note that I&rsquo;m not focusing so much on the specific steps that are required as I am on general concepts and any gotchas that may arise during the process.</p>
<h2 id="full-vm-recovery-using-block-storage">Full VM Recovery using Block Storage</h2>
<p>To recover a full VM using block-level storage, a number of steps have to be taken:</p>
<ol>
<li>
<p>Create a LUN clone (or a FlexClone) of the original LUN based on a Snapshot.</p>
</li>
<li>
<p>Enable resignaturing on the ESX host(s) that will need to see the cloned LUN.</p>
</li>
<li>
<p>Mount the cloned LUN(s) on the ESX host(s) and copy the appropriate VM files from the clone to the production LUN.</p>
</li>
</ol>
<p>For the first two steps, I&rsquo;ll refer you back to one of my first articles on VMware data recovery with Snapshots, which has more information on the necessary commands and settings.</p>
<p>For the third step, you&rsquo;ll need to login to the Service Console (typically via SSH) and copy the desired VM(s)&ndash;and all their files&mdash;from the cloned datastore to the production datastore, overwriting whatever is in the destination (you typically wouldn&rsquo;t need to recover a full VM unless the production VM was hosed, right?). Once the file(s) have been copied back over to the production datastore, dismount the cloned datastore and destroy it.</p>
<p>You should now be able to boot up your VM at the state it was in at the time of the Snapshot used to recover it. Unless the Snapshot was a cold Snapshot (taken while the VM was powered off), the VM will perform a file system check (chkdsk or fsck) when it boots up.</p>
<h2 id="full-vm-recovery-using-nfs">Full VM Recovery using NFS</h2>
<p>The procedure for recovering full VMs when using NFS is even easier:</p>
<ol>
<li>
<p>Using an NFS client, mount the NFS export and navigate to the hidden &ldquo;.snapshot&rdquo; directory.</p>
</li>
<li>
<p>In the &ldquo;.snapshot&rdquo; directory, find the Snapshot from which you wish to recover the VM.</p>
</li>
<li>
<p>Copy that VM&rsquo;s files (the entire folder) out of the &ldquo;.snapshot&rdquo; directory into the production filesystem, replacing the current contents (again, this assumes that what&rsquo;s in the production filesystem is no good, else why would you be recovering a full VM?).</p>
</li>
<li>
<p>Unmount the NFS export from your NFS client.</p>
</li>
</ol>
<p>The recovered VM should now boot and be back to the point in time at which the Snapshot was taken. Again, unless the Snapshot was a cold Snapshot, the VM will likely perform a file system check upon boot. This is normal and not unexpected.</p>
<p>I suppose you could even do this second procedure from a CIFS client, assuming that CIFS and NFS were both configured on the storage system and an appropriate CIFS share existed. (Please note that I&rsquo;ve never tried this, so I can&rsquo;t tell you what the results might be.) In that case, use the &ldquo;~snapshot&rdquo; directory instead of &ldquo;.snapshot&rdquo;.</p>
<p>And that&rsquo;s it&mdash;there you have two ways of recovering entire VMs using Network Appliance Snapshots. As always, feel free to hit me up in the comments with any questions, thoughts, corrections, or rants (just keep the rants on-topic, please!). Thanks for reading!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/esx">ESX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/iscsi">iSCSI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nas">NAS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/netapp">NetApp</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nfs">NFS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/san">SAN</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/storage">Storage</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2007/10/06/various-odds-and-ends/">Various Odds and Ends</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2007/10/08/vm-file-level-recovery-with-netapp-snapshots/">VM File-Level Recovery with NetApp Snapshots</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2007%2f10%2f08%2ffull-vm-recovery-with-netapp-snapshots%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f10%2f08%2ffull-vm-recovery-with-netapp-snapshots%2f&text=Full%20VM%20Recovery%20with%20NetApp%20Snapshots" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f10%2f08%2ffull-vm-recovery-with-netapp-snapshots%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2007/09/13/vmworld-2007-ip-based-storage-sessions/">VMworld 2007 IP-Based Storage Sessions</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2006/07/10/iscsi-and-esx-server-3/">iSCSI and ESX Server 3</a> <span class="post-date-list">109 May 101010</span></li><li><a href="/2006/12/30/recovering-data-inside-vms-using-netapp-snapshots/">Recovering Data Inside VMs Using NetApp Snapshots</a> <span class="post-date-list">309 May 303030</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
