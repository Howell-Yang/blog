<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Linux-AD Integration with Windows Server 2008 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Linux-AD Integration with Windows Server 2008 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Linux-AD Integration with Windows Server 2008 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2007/07/09/linux-ad-integration-with-windows-server-2008/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Linux-AD Integration with Windows Server 2008</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 99 May 9099 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1771 words (estimated 9 minutes to read)</span>
  <p>In the event that your organization is considering a migration later this year (or next?) to <a href="http://www.microsoft.com/windowsserver2008/default.mspx">Windows Server 2008</a> (formerly &ldquo;Longhorn&rdquo;), here are some instructions for integrating Linux login requests against Active Directory on Windows Server 2008. These instructions are based on <a href="/2007/01/15/linux-ad-integration-version-4/">Linux-AD Integration, Version 4</a> and utilize Kerberos, LDAP, and Samba.</p>
<p>When this process is complete, AD users can be enabled for use on Linux systems on the network and login to those Linux systems using the same username and password as throughout the rest of Active Directory.</p>
<p>If you are looking for information on using Linux with a previous version of Windows before Windows Server 2008, please refer back to my <a href="/2007/01/15/active-directory-integration-index/">AD integration index</a> and select the appropriate article. The only significant changes in the process involve the mapping of the LDAP attributes; otherwise, the procedure is very similar between the two versions of Windows.</p>
<h2 id="preparing-active-directory-one-time">Preparing Active Directory (One-Time)</h2>
<p>The process of installing and configuring Windows Server 2008 is beyond the scope of this article (although I may touch on that in the near future in a separate article). Therefore, I won&rsquo;t provide detailed instructions on how to perform some of these tasks, but instead provide a high-level overview.</p>
<h3 id="enable-editingdisplay-of-unix-attributes">Enable Editing/Display of UNIX Attributes</h3>
<p>In order to store UNIX attributes in Active Directory, the schema must be extended. To extend the schema, first install Active Directory (add the Active Directory Domain Services role to an installed server, then use the Active Directory Installation Wizard to setup Active Directory) and then add the &ldquo;Identity Management for UNIX&rdquo; role service (this can be done in Server Manager).</p>
<p>Once that role service has been installed, then the AD schema now includes a partially RFC 2307-compliant set of UNIX attributes, such as UID, UID number, GID number, login shell, etc. (Note that it may be that these attributes are already included in the schema for Windows Server 2008; I did not check the schema before installing the Identity Management for UNIX role service. With <a href="http://www.microsoft.com/windowsserver/default.mspx">Windows Server 2003 R2</a>, the schema was present at the time of installation, but the attributes were not visible until installing the UNIX identity services.)</p>
<p>At this point a new tab labeled &ldquo;UNIX Attributes&rdquo; will appear in the properties dialog box for users and groups in Active Directory. You&rsquo;ll use this tab to edit the UNIX-specific attributes that are required for logins to Linux-based systems.</p>
<h3 id="create-an-ldap-bind-account">Create an LDAP Bind Account</h3>
<p>You&rsquo;ll also need to create an account in Active Directory that will be used to bind to Active Directory for LDAP queries. This account does <em>not</em> need any special privileges; in fact, making the account a member of Domain Guests and <em>not</em> a member of Domain Users is perfectly fine. This helps minimize any potential security risks as a result of this account. Just be sure that you know the account&rsquo;s user principal name (UPN) and password.</p>
<h2 id="prepare-active-directory-each-user">Prepare Active Directory (Each User)</h2>
<p>Each Active Directory account that will authenticate via Linux must be configured with a UID and other UNIX attributes. This is accomplished via the new &ldquo;UNIX Attributes&rdquo; tab on the properties dialog box of a user account.</p>
<p>After all the user accounts have been configured, then we are ready to configure Active Directory objects for each of the Linux server(s) that we&rsquo;ll be integrating with AD.</p>
<h2 id="prepare-active-directory-each-server">Prepare Active Directory (Each Server)</h2>
<p>Prior to using Samba to join Linux computers to Active Directory and generate a keytab automatically, we had to use the <code>ktpass.exe</code> utility on Windows to generate a keytab. Due to some current <a href="/2007/07/09/samba-and-windows-server-2008-interoperability/">Samba-Windows Server 2008 interoperability issues</a>, we can&rsquo;t use Samba. That means we&rsquo;ll be back to using <code>ktpass.exe</code> to map service principals onto accounts in Active Directory. Unfortunately, you&rsquo;ll need to first disable User Account Control (UAC) on your server, since <a href="/2007/07/09/uac-and-ktpassexe/">UAC interferes with <code>ktpass.exe</code></a>. (Nice, huh?)</p>
<p>Once you&rsquo;ve disabled UAC (and rebooted your server), then you can map the service principal names (SPNs) using the following procedure. First, create a compute account (or a user account; either will work) with the name of the Linux server.</p>
<p>Next, use the following command to map the needed SPN onto this account (backslashes indicate line continuation):</p>
<pre><code>ktpass.exe -princ HOST/server.fqdn@REALM.COM \  
-mapuser DOMAIN\AccountName$ -crypto all \  
-pass Password123 -ptype KRB5_NT_PRINCIPAL \  
-out filename.keytab
</code></pre>
<p>Finally, copy the file generated by this command (<code>filename.keytab</code>) to the Linux server (using SCP or SFTP is a good option) and merge it with the existing keytab (if it exists) using <code>ktutil</code>. If there is no existing keytab, simply copy the file to <code>/etc/krb5.keytab</code> and you should be good to go.</p>
<p>Now that Active Directory has computer objects (and, more importantly, SPNs) for the Linux servers and the AD users have been enabled for UNIX (by populating the UNIX attributes), we&rsquo;re ready to start configuring the Linux server(s) directly.</p>
<h2 id="prepare-each-linux-server">Prepare Each Linux Server</h2>
<p>Follow the steps below to configure the Linux server for authentication against Active Directory. (Note that this configuration was tested on a system running CentOS&mdash;a variation of Red Hat Enterprise Linux&mdash;version 4.3.)</p>
<ol>
<li>
<p>Edit the <code>/etc/hosts</code> file and ensure that the server&rsquo;s fully-qualified domain name is listed first after its IP address.</p>
</li>
<li>
<p>Make sure that the appropriate Kerberos libraries, OpenLDAP, pam_krb5, and nss_ldap are installed. If they are not installed, install them.</p>
</li>
<li>
<p>Be sure that time is being properly synchronized between Active Directory and the Linux server in question. Kerberos requires time synchronization. Configure the NTP daemon if necessary.</p>
</li>
<li>
<p>Edit the <code>/etc/krb5.conf</code> file to look something like <a href="https://gist.github.com/scottslowe/67a3f8c36270c7e6376b">this</a>, substituting your actual host names and domain names where appropriate.</p>
</li>
<li>
<p>Edit the <code>/etc/ldap.conf</code> file to look something like <a href="https://gist.github.com/scottslowe/7ad13c8839a546b760df">this</a>, substituting the appropriate host names, domain names, account names, and distinguished names (DNs) where appropriate.</p>
</li>
<li>
<p>Configure PAM (this varies according to Linux distributions) to use pam_krb5 for authentication. Many modern distributions use a stacking mechanism whereby one file can be modified and those changes will applied to all the various PAM-aware services. For example, in Red Hat-based distributions, the system-auth file is referenced by most other PAM-aware services. Click <a href="https://gist.github.com/scottslowe/0e47e27dd5e515963daf">here</a> to see a properly edited <code>/etc/pam.d/system-auth</code> file taken from CentOS 4.4.</p>
</li>
<li>
<p>Edit the <code>/etc/nsswitch.conf file</code> to include &ldquo;ldap&rdquo; as a lookup source for passwd, shadow, and groups.</p>
</li>
</ol>
<p>At this point we are now ready to test our configuration and, if successful, to perform the final step: to join the Linux server to Active Directory for authentication.</p>
<h2 id="test-the-configuration">Test the Configuration</h2>
<p>To test the Kerberos authentication, use the <code>kinit</code> command, as in <code>kinit &lt;AD username&gt;@&lt;AD domain DNS name&gt;</code>. This should return no errors. A <code>klist</code> at that point should then show that you have retrieved a TGT (ticket granting ticket) from the AD domain controller. If this fails, go back and troubleshoot the Kerberos configuration. In particular, if you are seeing references to failed TGT validation, check to make sure that both your Linux servers and AD domain controllers have reverse lookup (PTR) records in DNS and that the Linux server&rsquo;s <code>/etc/hosts</code> file listed the FQDN of the server first instead of just the nodename.</p>
<p>&lt;aside&gt;Some readers and some other articles have suggested the use of the AD domain DNS name in the <code>/etc/krb5.conf</code> file instead of an AD domain controller specifically; I recommend against this. First, I believe it may contribute to TGT validation errors; second, it is possible to list multiple KDCs (AD DCs) in the configuration. Since the only major reason to use the AD domain DNS name instead of the DNS name of one or more DCs would be fault tolerance, then it doesn&rsquo;t really gain anything.&lt;/aside&gt;</p>
<p>To test the LDAP lookups, use the <code>getent</code> command, as in <code>getent passwd &lt;AD username&gt;</code>. This should return a listing of the account information from Active Directory. If this does not work, users will <em>not</em> be able to login, even if Kerberos is working fine. If you run into errors or failures here, go back and double-check the LDAP configuration. One common source of errors is the name of the LDAP bind account, so be sure that is correct.</p>
<p>At this point, SSH logins to the Linux system using an account present in Active Directory (one which has had its UNIX attributes specified properly) should be successful. This will be true as long as you used the <code>ktpass.exe</code> command earlier to map the SPN onto the computer object in Active Directory. Even if you <em>didn&rsquo;t</em> copy the keytab over to the Linux server, logins will work. Why? Because the PAM Kerberos configuration, by default, does not require a client keytab, and does not attempt to validate the tickets granted by the TGT. This means that as long as the SPN(s) are mapped to the accounts in AD, the keytab is not necessarily required.</p>
<p>(Note, however, that not using a keytab and/or not requiring a keytab does leave the Linux server open to potentially spoofed Kerberos tickets from a fake KDC. In addition, &ldquo;native&rdquo; Kerberos authentication&mdash;i.e., using a Kerberos ticket to authenticate instead of typing in a password&mdash;won&rsquo;t work without a keytab.)</p>
<h2 id="deal-with-home-directories">Deal with Home Directories</h2>
<p>Unlike Windows systems, home directories are required on Linux-based systems. As a result, we <em>must</em> provide home directories for each AD user that will log in to a Linux-based system. We basically have three options here:</p>
<ul>
<li>
<p>Manually create home directories and set ownership/permissions properly before users will be able to log in.</p>
</li>
<li>
<p>Use the pam_mkhomedir.so PAM module to automatically create local home directories &ldquo;on the fly&rdquo; as users log in. To do this, you would add an entry for pam_mkhomedir.so in the session portion of the PAM configuration file.</p>
</li>
<li>
<p>Use the automounter to automatically mount home directories from a network server. This process is fairly complicated (too involved to include the information here), so I&rsquo;ll refer you to this article on <a href="/2006/11/21/greater-ad-integration-via-nfs-and-automounts/">using NFS and automounts for home directories</a>. This has the added benefit of providing a foundation for unified home directories across both Windows and Linux systems.</p>
</li>
</ul>
<p>Once you&rsquo;ve settled on and implemented a system for dealing with home directories, you are finished! UNIX-enabled users in Active Directory can now login to Linux-based systems with their Active Directory username and password.</p>
<p>What&rsquo;s not addressed in this article? Password management. In this configuration, users will most likely <em>not</em> be able to change their password from the Linux servers and have that change properly reflected in Active Directory. In addition, &ldquo;native&rdquo; Kerberos authentication using Kerberos tickets won&rsquo;t work unless the keytab is present. In my testing, I ran into a number of issues with the keytab and TGT validation, but I&rsquo;m not sure if those are errors in my process or the result of the beta status of Windows Server 2008.</p>
<p>I welcome your corrections, additions, or suggestions in the comments below.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/activedirectory">ActiveDirectory</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/centos">CentOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/interoperability">Interoperability</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kerberos">Kerberos</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ldap">LDAP</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/samba">Samba</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/windows">Windows</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2007/07/09/samba-and-windows-server-2008-interoperability/">Samba and Windows Server 2008 Interoperability</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2007/07/09/uac-and-ktpassexe/">UAC and ktpass.exe</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2007%2f07%2f09%2flinux-ad-integration-with-windows-server-2008%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f07%2f09%2flinux-ad-integration-with-windows-server-2008%2f&text=Linux-AD%20Integration%20with%20Windows%20Server%202008" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2007%2f07%2f09%2flinux-ad-integration-with-windows-server-2008%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2007/03/22/sled-integration-into-active-directory/">SLED Integration into Active Directory</a> <span class="post-date-list">229 May 222222</span></li><li><a href="/2007/01/15/linux-ad-integration-version-4/">Linux-AD Integration, Version 4</a> <span class="post-date-list">159 May 151515</span></li><li><a href="/2007/01/15/active-directory-integration-index/">Active Directory Integration Index</a> <span class="post-date-list">159 May 151515</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
