<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Creating Tagged Subnets Across AWS AZs Using Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Creating Tagged Subnets Across AWS AZs Using Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Creating Tagged Subnets Across AWS AZs Using Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2019/08/21/creating-tagged-subnets-across-aws-azs-using-pulumi/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Creating Tagged Subnets Across AWS AZs Using Pulumi</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 219 May 212121 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;999 words (estimated 5 minutes to read)</span>
  <p>As I mentioned back in May in <a href="/2019/05/05/a-sandbox-for-learning-pulumi/">this post on creating a sandbox for learning Pulumi</a>, I&rsquo;ve started using <a href="https://www.pulumi.com/">Pulumi</a> more and more of my infrastructure-as-code needs. I did switch from JavaScript to TypeScript (which I know compiles to JavaScript on the back-end, but the strong typing helps a new programmer like me). Recently I had a need to create some resources in AWS using Pulumi, and&mdash;for reasons I&rsquo;ll explain shortly&mdash;many of the &ldquo;canned&rdquo; Pulumi examples didn&rsquo;t cut it for my use case. In this post, I&rsquo;ll share how I created tagged subnets across AWS availability zones (AZs) using Pulumi.</p>
<p>In this particular case, I was using Pulumi to create all the infrastructure necessary to spin up an AWS-integrated <a href="https://kubernetes.io/">Kubernetes</a> cluster. That included a new VPC, subnets in the different AZs for that region, an Internet gateway, route tables and route table associations, security groups, an ELB for the control plane, and EC2 instances. As I&rsquo;ve outlined in my latest post on <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">setting up an AWS-integrated Kubernetes 1.15 cluster using <code>kubeadm</code></a>, these resources on AWS require specific AWS tags to be assigned in order for the AWS cloud provider to work.</p>
<p>As I started working on this, I found examples of Pulumi TypeScript code that could do <em>part</em> of what I needed, but not all of it:</p>
<ul>
<li>If you&rsquo;re using the <code>awsx</code> module with Pulumi (part of their &ldquo;Crosswalk&rdquo; stuff) <a href="https://www.pulumi.com/docs/reference/crosswalk/aws/vpc/">to create a VPC</a>, it can handle creating subnets across multiple AZs automatically for you. Users have the ability to fine-tune some of the settings, but&mdash;here&rsquo;s the kicker&mdash;tags you specify at the VPC level don&rsquo;t get propagated. (There&rsquo;s <a href="https://github.com/pulumi/pulumi-awsx/issues/383">an issue</a> open for this.)</li>
<li>If you build it all manually, then you also have to manually deal with figuring out how many AZs are in a region, and how to loop through the AZs to create subnets in each one (which is stuff the <code>awsx</code> module handles for you).</li>
</ul>
<p>Since I needed the tags&mdash;the AWS cloud provider for Kubernetes won&rsquo;t work otherwise&mdash;I set out to take the second path (building it all out manually). I&rsquo;m going to share the TypeScript code I used&mdash;and am still using&mdash;so that others who may find themselves in the same boat have an example upon which to base their code.</p>
<p>(I&rsquo;m a relative newcomer to TypeScript, so be gentle!)</p>
<p>First, I needed to figure out how many AZs were in the given region. This snippet of code returned both the list of AZ names as well as the total number of AZs in the region:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rawAzInfo</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">getAvailabilityZones</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;available&#34;</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">azNames</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">string</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">rawAzInfo</span>.<span style="color:#a6e22e">names</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">numberOfAZs</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">azNames</span>.<span style="color:#a6e22e">length</span>;
</span></span></code></pre></div><p>I gathered both the list of AZ names as well as the overall count because in the snippet of code for creating subnets, I&rsquo;ll need the AZ names.</p>
<p>Next, I created a VPC (this part is straightforward and reasonably well-documented):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">vpc</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">Vpc</span>(<span style="color:#e6db74">&#34;k8s-vpc&#34;</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cidrBlock</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;10.1.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enableDnsHostnames</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enableDnsSupport</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tags</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;k8s-vpc&#34;</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#a6e22e">k8sTagName</span>]<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shared&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The one part here that wasn&rsquo;t immediately obvious to me was the <code>[k8sTagName]</code> syntax for referencing a variable named <code>k8sTagName</code>. This allow me to declare the tag (i.e., &ldquo;kubernetes.io/cluster/cluster-name&rdquo;) once in a variable instead of multiple times in the code.</p>
<p>Now we get to the more interesting stuff&mdash;iterating through the list of AZs to create a subnet in each. After stumbling around for a bit, I finally arrived here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">subnets</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numberOfAZs</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">subnetAddr</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">netAddr</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.1.&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">cidrSubnet</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">netAddr</span>.<span style="color:#a6e22e">concat</span>(String(<span style="color:#a6e22e">subnetAddr</span>), <span style="color:#e6db74">&#34;.0/20&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">subnets</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">Subnet</span>(<span style="color:#e6db74">`subnet-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">availabilityZone</span>: <span style="color:#66d9ef">azNames</span>[<span style="color:#a6e22e">i</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cidrBlock</span>: <span style="color:#66d9ef">cidrSubnet</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mapPublicIpOnLaunch</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">vpcId</span>: <span style="color:#66d9ef">vpc.id</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tags</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`subnet-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>            [<span style="color:#a6e22e">k8sTagName</span>]<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;shared&#34;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>So what does this code do?</p>
<ol>
<li>First, it creates an array to hold the <code>aws.ec2.Subnet</code> objects I&rsquo;m going to create in the loop.</li>
<li>Next, it jumps into a <code>for</code> loop that iterates over the total number of AZs in the region (hence why I collected that value earlier).</li>
<li>For each iteration, the code calculates a subnet address (as a multiple of 16), and then combines that subnet address with the network address and CIDR mask. Thus, the CIDR block for the first subnet is &ldquo;10.1.0.0/20&rdquo;, the second is &ldquo;10.1.16.0/20&rdquo;, and so on.</li>
<li>Finally, for each iteration, the <code>push</code> method adds (&ldquo;pushes&rdquo;) a new <code>aws.ec2.Subnet</code> object into the array with the appropriate properties (the VPC ID for the VPC created earlier, the calculated CIDR block, any other settings, and the necessary tags). Note the <code>subnet-${i+1}</code> syntax to calculate names like &ldquo;subnet-1&rdquo;, &ldquo;subnet-2&rdquo;, etc.</li>
</ol>
<p>After this, the majority of the rest of the code is pretty straightforward (I won&rsquo;t go into detail in this post since <a href="https://github.com/pulumi/examples">the examples</a> and <a href="https://www.pulumi.com/docs/reference/pkg/">Pulumi API reference</a> pretty much capture most everything needed):</p>
<ul>
<li>Create an Internet gateway in the VPC and tag it.</li>
<li>Create a route table for the Internet gateway and tag it.</li>
<li>Use a similar array and <code>for</code> loop construct to iterate across the subnets and associate each subnet (referenceable by <code>subnets[i]</code>, assuming <code>i</code> is the loop variable) with the route table.</li>
</ul>
<p>At this point, Pulumi has now created a VPC, subnets in each AZ, an Internet gateway, a route table to point to the Internet gateway, and a route table association linking each subnet to the route table. All you need now are security groups and EC2 instances, and you&rsquo;re off to the races! All of the things that <em>can</em> be tagged <em>are</em> tagged, which means infrastructure provisioned with this code is ready for use with Kubernetes.</p>
<p>It&rsquo;s more than fair to say that some of this is just me learning TypeScript; I can&rsquo;t dispute that at all. If I&rsquo;m searching for resources on how to do something, though, that&rsquo;s probably a reasonable indicator that other folks are also looking for resources and examples, and why I wanted to publish this post.</p>
<p>I hope that this information is useful to someone; feel free to <a href="https://twitter.com/scott_lowe">hit me up on Twitter</a> if you have any questions, comments, corrections, or suggestions.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/pulumi">Pulumi</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/typescript">TypeScript</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2019/08/15/reconstructing-the-join-command-for-kubeadm/">Reconstructing the Join Command for Kubeadm</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2019/08/23/technology-short-take-118/">Technology Short Take 118</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2019%2f08%2f21%2fcreating-tagged-subnets-across-aws-azs-using-pulumi%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f08%2f21%2fcreating-tagged-subnets-across-aws-azs-using-pulumi%2f&text=Creating%20Tagged%20Subnets%20Across%20AWS%20AZs%20Using%20Pulumi" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f08%2f21%2fcreating-tagged-subnets-across-aws-azs-using-pulumi%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2019/05/05/a-sandbox-for-learning-pulumi/">A Sandbox for Learning Pulumi</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">Setting up an AWS-Integrated Kubernetes 1.15 Cluster with Kubeadm</a> <span class="post-date-list">149 May 141414</span></li><li><a href="/2019/06/21/technology-short-take-115/">Technology Short Take 115</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
