<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Calculating the CA Certificate Hash for Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Calculating the CA Certificate Hash for Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Calculating the CA Certificate Hash for Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2019/07/12/calculating-ca-certificate-hash-for-kubeadm/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Calculating the CA Certificate Hash for Kubeadm</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 129 May 121212 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;564 words (estimated 3 minutes to read)</span>
  <p>When using <code>kubeadm</code> to set up a new <a href="https://kubernetes.io/">Kubernetes</a> cluster, the output of the <code>kubeadm init</code> command that sets up the control plane for the first time contains some important information on joining additional nodes to the cluster. One piece of information in there that (until now) I hadn&rsquo;t figured out how to replicate was the CA certificate hash. (Primarily I hadn&rsquo;t figured it out because I hadn&rsquo;t tried.) In this post, I&rsquo;ll share how to calculate the CA certificate hash for <code>kubeadm</code> to use when joining additional nodes to an existing cluster.</p>
<p>When looking to figure this out, I first started with the <code>kubeadm</code> documentation. My searches led me <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/">here</a>, which states:</p>
<blockquote>
<p>The hash is calculated over the bytes of the Subject Public Key Info (SPKI) object (as in RFC7469). This value is available in the output of “kubeadm init” or can be calculated using standard tools.</p>
</blockquote>
<p>That&rsquo;s useful information, but what are the &ldquo;standard tools&rdquo; being referenced? I knew that a lot of work had been put into <code>kubeadm init phase</code> (for breaking down the <code>kubeadm init</code> workflow), but a quick review of that documentation didn&rsquo;t reveal anything. Reviewing <a href="https://tools.ietf.org/html/rfc7469">the referenced RFC</a> also didn&rsquo;t provide any suggestions on how the hash might be calculated. I&rsquo;d messed around with <code>openssl x509</code> with Kubernetes before (see <a href="/2018/06/12/examining-x509-certificates-embedded-in-kubeconfig-files/">this post</a> or <a href="/2018/08/20/troubleshooting-tls-certificates/">this post</a>), so how about some trial-and-error?</p>
<p>Starting with what I knew, I started with decoding the certificate using <code>openssl</code>. After reading some <code>openssl</code> man pages, I arrived at this command to extract <em>only</em> the public key of the certificate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -in /etc/kubernetes/pki/ca.crt -pubkey -noout
</span></span></code></pre></div><p>(Side note: the use of <code>-noout</code> threw me for a bit; it says &ldquo;No output, just status&rdquo;, but what it really means is don&rsquo;t output anything more than what I&rsquo;ve already told you to output with <code>-pubkey</code> or other flags.)</p>
<p>From there it was experimenting with <code>openssl dgst</code> to see if I could get results that matched against some known CA certificate hashes I&rsquo;d captured for clusters I&rsquo;d built. I wasn&rsquo;t having much success until I stumbled on <a href="https://stackoverflow.com/questions/36163093/how-do-we-generate-a-base64-encoded-sha256-hash-of-subjectpublickeyinfo-of-an-x">this Stack Overflow post</a>, which pointed me in the direction of <code>openssl pkey</code>. That was the missing link I needed.</p>
<p>So, the final command is this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509 -in /etc/kubernetes/pki/ca.crt -pubkey -noout |
</span></span><span style="display:flex;"><span>openssl pkey -pubin -outform DER |
</span></span><span style="display:flex;"><span>openssl dgst -sha256
</span></span></code></pre></div><p>I shared this with my team members (sharing is caring!), and my teammate Naadir Jeewan promptly responded with an <a href="https://www.ansible.com/">Ansible</a> filter to perform the same task. This is helpful when <code>openssl</code> isn&rsquo;t present on the system where you need to calculate the hash. Naadir&rsquo;s Ansible filter is found <a href="https://gist.github.com/randomvariable/e4c43f89afec52fec0dbef6c08621249">here</a> (great work, Naadir!).</p>
<p>There you have it. Next time you find yourself needing to calculate the CA certificate hash to use with <code>kubeadm</code>, you now have two ways of getting there (either using <code>openssl</code> or using Naadir&rsquo;s Ansible filter).</p>
<p>If you have any questions, don&rsquo;t hesitate <a href="https://twitter.com/scott_lowe">to reach out to me on Twitter</a>. Thanks!</p>
<p><strong>UPDATE:</strong> Apparently, I overlooked a portion of <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/">the official documentation for <code>kubeadm join</code></a>, which <em>does</em> provide a mechanism for using <code>openssl</code> to calculate the CA cert hash. I checked the documentation back to version 1.15, and the information is there. (No idea how I missed this!) See the section titled &ldquo;Token-based discovery with CA pinning&rdquo; for another <code>openssl</code> command you can use to calculate the CA cert hash. Thanks to Dan Webster for pointing this out!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ansible">Ansible</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/encryption">Encryption</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubeadm">Kubeadm</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2019/07/07/building-jsonnet-from-source/">Building Jsonnet from Source</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2019/07/17/spousetivities-at-vmworld-2019/">Spousevitivities at VMworld 2019</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f12%2fcalculating-ca-certificate-hash-for-kubeadm%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f12%2fcalculating-ca-certificate-hash-for-kubeadm%2f&text=Calculating%20the%20CA%20Certificate%20Hash%20for%20Kubeadm" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f12%2fcalculating-ca-certificate-hash-for-kubeadm%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">More on Setting up etcd with Kubeadm</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2018/10/05/technology-short-take-105/">Technology Short Take 105</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">Bootstrapping an etcd Cluster with TLS using Kubeadm</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
