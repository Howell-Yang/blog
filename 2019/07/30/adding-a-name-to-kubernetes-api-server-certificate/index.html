<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Adding a Name to the Kubernetes API Server Certificate - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Adding a Name to the Kubernetes API Server Certificate - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Adding a Name to the Kubernetes API Server Certificate - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2019/07/30/adding-a-name-to-kubernetes-api-server-certificate/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Adding a Name to the Kubernetes API Server Certificate</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 309 May 303030 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1373 words (estimated 7 minutes to read)</span>
  <p>In this post, I&rsquo;m going to walk you through how to add a name (specifically, a Subject Alternative Name) to the TLS certificate used by the Kubernetes API server. This process of updating the certificate to include a name that wasn&rsquo;t included could find use for a few different scenarios. A couple of situations come to mind, such as adding a load balancer in front of the control plane, or using a new or different URL/hostname used to access the API server (both situations taking place <em>after</em> the cluster was bootstrapped).</p>
<p>This process does assume that the cluster was bootstrapped using <code>kubeadm</code>. This could&rsquo;ve been a simple <code>kubeadm init</code> with no customization, or it could&rsquo;ve been using a configuration file to modify the behavior of <code>kubeadm</code> when bootstrapping the cluster. This process also assumes your Kubernetes cluster is using the default certificate authority (CA) created by <code>kubeadm</code> when bootstrapping a cluster. Finally, this process assumes you are using a non-HA (single control plane node) configuration.</p>
<p>Before getting into the details of how to update the certificate, I&rsquo;d like to first provide a bit of background on why this is important.</p>
<h2 id="background">Background</h2>
<p>The Kubernetes API server uses digital certificates to both encrypt traffic to/from the API server as well as to authenticate connections to the API server. As such, if you try to connect to the API server using a command-line client like <code>kubectl</code> and you use a hostname or IP address that isn&rsquo;t included in the certificate&rsquo;s list of Subject Alternative Names (SANs), you&rsquo;ll get an error indicating that the certificate isn&rsquo;t valid for the specified IP address or hostname. To fix that, you need to update the certificate so that the list of SANs includes any and all IP addresses or hostnames that you will use to access the API server.</p>
<h2 id="updating-the-api-servers-certificate">Updating the API Server&rsquo;s Certificate</h2>
<p>Because the cluster was bootstrapped using <code>kubeadm</code>, you can use <code>kubeadm</code> to update the API server&rsquo;s certificate to include additional names in the list of SANs.</p>
<p>To do this, you&rsquo;ll first need a <code>kubeadm</code> configuration file. If you used a configuration file to bootstrap the cluster, you can use that file as your starting point. If you didn&rsquo;t use a configuration file&mdash;perhaps you just did a quick <code>kubeadm init</code> to quickly get a cluster&mdash;then you can pull the <code>kubeadm</code> configuration from the cluster to create a configuration file you can use. <code>kubeadm</code> writes its configuration into a ConfigMap named &ldquo;kubeadm-config&rdquo; found in the &ldquo;kube-system&rdquo; namespace.</p>
<p>To pull the <code>kubeadm</code> configuration from the cluster into an external file, run this command:</p>
<pre><code>kubectl -n kube-system get configmap kubeadm-config -o jsonpath='{.data.ClusterConfiguration}' &gt; kubeadm.yaml
</code></pre>
<p>This creates a file named <code>kubeadm.yaml</code>, the contents of which may look something like this (the file from your cluster may have different values):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization-mode</span>: <span style="color:#ae81ff">Node,RBAC</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeoutForControlPlane</span>: <span style="color:#ae81ff">4m0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">certificatesDir</span>: <span style="color:#ae81ff">/etc/kubernetes/pki</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterName</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlaneEndpoint</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controllerManager</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">dns</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">CoreDNS</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataDir</span>: <span style="color:#ae81ff">/var/lib/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">k8s.gcr.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">v1.14.4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSubnet</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceSubnet</span>: <span style="color:#ae81ff">10.96.0.0</span><span style="color:#ae81ff">/12</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheduler</span>: {}
</span></span></code></pre></div><p>In this particular example, no additional SANs are listed. To add at least one SAN, add a <code>certSANs</code> list under the <code>apiServer</code> section. If you already had a <code>kubeadm</code> configuration file that you used when you bootstrapped the cluster, you may already have a <code>certSANs</code> list. If not, you&rsquo;ll need to add it; if so, you&rsquo;ll just add another entry to that list.</p>
<p>Here&rsquo;s an example (here I&rsquo;m showing <em>only</em> the <code>apiServer</code> section):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certSANs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;172.29.50.162&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;k8s.domain.com&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;other-k8s.domain.net&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization-mode</span>: <span style="color:#ae81ff">Node,RBAC</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeoutForControlPlane</span>: <span style="color:#ae81ff">4m0s</span>
</span></span></code></pre></div><p>This change to the <code>kubeadm</code> configuration file <em>adds</em> SANs for the IP address 172.29.50.162, the hostname &ldquo;k8s.domain.com&rdquo;, and the hostname &ldquo;other-k8s.domain.net&rdquo;. This would be <em>in addition to</em> the standard list of SANs that are included (which would be the local hostname, some names for the default Kubernetes Service object, the default IP address for the Kubernetes Service object, and the primary IP address of the node).</p>
<p>Once you&rsquo;ve updated the <code>kubeadm</code> configuration file&mdash;either the default one pulled from the ConfigMap or the custom one you used when you bootstrapped the cluster&mdash;then you&rsquo;re ready to update the certificate.</p>
<p>First, move the existing API server certificate and key (if <code>kubeadm</code> sees that they already exist in the designated location, it won&rsquo;t create new ones):</p>
<pre><code>mv /etc/kubernetes/pki/apiserver.{crt,key} ~
</code></pre>
<p>Then, use <code>kubeadm</code> to <em>just</em> generate a new certificate:</p>
<pre><code>kubeadm init phase certs apiserver --config kubeadm.yaml
</code></pre>
<p>This command will generate a new certificate and key for the API server, using the specified configuration file for guidance. Since the specified configuration file includes a <code>certSANs</code> list, then <code>kubeadm</code> will automatically add those SANs when creating the new certificate.</p>
<p>The final step is restarting the API server to pick up the new certificate. The easiest way to do this is to kill the API server container using <code>docker</code>:</p>
<ol>
<li>Run <code>docker ps | grep kube-apiserver | grep -v pause</code> to get the container ID for the container running the Kubernetes API server. (The container ID will be the very first field in the output.)</li>
<li>Run <code>docker kill &lt;containerID&gt;</code> to kill the container.</li>
</ol>
<p>If your nodes are running containerd as the container runtime, the commands are a bit different:</p>
<ol>
<li>Run <code>crictl pods | grep kube-apiserver | cut -d' ' -f1</code> to get the Pod ID for the Kubernetes API server Pod.</li>
<li>Run <code>crictl stopp &lt;pod-id&gt;</code> to stop the Pod.</li>
<li>Run <code>crictl rmp &lt;pod-id&gt;</code> to remove the Pod.</li>
</ol>
<p>The Kubelet will automatically restart the container, which will pick up the new certificate. As soon as the API server restarts, you will immediately be able to connect to it using one of the newly-added IP addresses or hostnames.</p>
<h2 id="verifying-the-change">Verifying the Change</h2>
<p>One way to verify the change is to edit the <code>server</code> line for that cluster in your Kubeconfig file to use one of the newly-added IP addresses or hostnames, and then run <code>kubectl</code> against the cluster. If <code>kubectl</code> doesn&rsquo;t work, then you can start troubleshooting from there.</p>
<p>Another way to verify the change&mdash;and a handy troubleshooting step as well&mdash;is to use <code>openssl</code> on the Kubernetes control plane node to decode the certificate and show the list of SANs on the certificate:</p>
<pre><code>openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text
</code></pre>
<p>Look for the &ldquo;X509v3 Subject Alternative Name&rdquo; line, after which will be a list of all the DNS names and IP addresses that are included on the certificate as SANs. After following this procedure, you <em>should</em> see the newly-added names and IP addresses you specified in the modified <code>kubeadm</code> configuration file. If you don&rsquo;t, then something went wrong along the way. Common mistakes in this process include forgetting to remove the previous certificate and key (<code>kubeadm</code> won&rsquo;t create new ones if they already exist), or failing to include the <code>--config kubeadm.yaml</code> on the <code>kubeadm init phase certs</code> command.</p>
<h2 id="updating-the-in-cluster-configuration">Updating the In-Cluster Configuration</h2>
<p>Assuming everything is working as expected, the final step is to update the <code>kubeadm</code> ConfigMap stored in the cluster. This is important so that when you use <code>kubeadm</code> to orchestrate a cluster upgrade later, the updated information will be present in the cluster. Thankfully, this is pretty straightforward:</p>
<pre><code>kubeadm config upload from-file --config kubeadm.yaml
</code></pre>
<p>(Newer versions of Kubernetes use the command <code>kubeadm init phase upload-config kubeadm --config kubeadm.yaml</code>. I <em>believe</em> this change takes effect around the Kubernetes 1.15 release, but I may be mistaken. Thanks Sarye Haddadi for the correction!)</p>
<p>You can verify the changes to the configuration were applied successfully with this command:</p>
<pre><code>kubectl -n kube-system get configmap kubeadm-config -o yaml
</code></pre>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>One other use case I wanted to mention briefly in addition to the ones mentioned earlier&mdash;adding a load balancer in front of the control plane node or adding a new DNS name or IP address used to reference the control plane endpoint&mdash;is enabling the use of SSH tunneling to access the control plane endpoint. In those cases, you&rsquo;ll want to add &ldquo;127.0.0.1&rdquo; as a SAN to the certificate. When using SSH tunneling, you&rsquo;ll be taking port 6443 (or whatever port you&rsquo;re using) on 127.0.0.1 and sending it across to the control plane node via your SSH connection. By including &ldquo;127.0.0.1&rdquo; as a SAN on the API server certificate, you&rsquo;ll enable this usage pattern.</p>
<p>That&rsquo;s it&mdash;I hope this is helpful in some fashion. If you have any questions, comments, suggestions, or corrections, <a href="https://twitter.com/scott_lowe">hit me up on Twitter</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/encryption">Encryption</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2019/07/23/vmworld-2019-prayer-time/">VMworld 2019 Prayer Time</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2019/07/31/decoding-a-kubernetes-service-account-token/">Decoding a Kubernetes Service Account Token</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f30%2fadding-a-name-to-kubernetes-api-server-certificate%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f30%2fadding-a-name-to-kubernetes-api-server-certificate%2f&text=Adding%20a%20Name%20to%20the%20Kubernetes%20API%20Server%20Certificate" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2019%2f07%2f30%2fadding-a-name-to-kubernetes-api-server-certificate%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2019/07/12/calculating-ca-certificate-hash-for-kubeadm/">Calculating the CA Certificate Hash for Kubeadm</a> <span class="post-date-list">129 May 121212</span></li><li><a href="/2018/11/09/technology-short-take-106/">Technology Short Take 106</a> <span class="post-date-list">99 May 9099</span></li><li><a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">More on Setting up etcd with Kubeadm</a> <span class="post-date-list">299 May 292929</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
