<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using pf on OS X Mountain Lion - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using pf on OS X Mountain Lion - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using pf on OS X Mountain Lion - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/05/15/using-pf-on-os-x-mountain-lion/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using pf on OS X Mountain Lion</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 159 May 151515 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1127 words (estimated 6 minutes to read)</span>
  <p>I&rsquo;ve <a href="/2012/04/05/setting-up-ipfw-on-mac-os-x/">written before</a> about adding an extra layer of network security to your Macintosh by leveraging the BSD-level <code>ipfw</code> firewall, in addition to the standard GUI firewall and additional third-party firewalls (like <a href="http://www.obdev.at/products/littlesnitch/index.html">Little Snitch</a>). In OS X Lion and OS X Mountain Lion, though, <code>ipfw</code> was deprecated in favor of <code>pf</code>, the powerful packet filter that I believe originated on OpenBSD. (OS X&rsquo;s version of <code>pf</code> is ported from FreeBSD.) In this article, I&rsquo;m going to show you how to use <code>pf</code> on OS X.</p>
<p>Note that this is just <em>one way</em> of leveraging <code>pf</code>, not necessarily the <em>only way</em> of doing it. I tested (and am currently using) this configuration on OS X Mountain Lion 10.8.3.</p>
<p>There are X basic pieces involved in getting <code>pf</code> up and running on OS X Mountain Lion:</p>
<ol>
<li>
<p>Putting <code>pf</code> configuration files in place.</p>
</li>
<li>
<p>Creating a launchd item for <code>pf</code>.</p>
</li>
</ol>
<p>Let&rsquo;s look at each of these pieces in a bit more detail. We&rsquo;ll start with the configuration files.</p>
<h2 id="putting-configuration-files-in-place">Putting Configuration Files in Place</h2>
<p>OS X Mountain Lion comes with a barebones <code>/etc/pf.conf</code> preinstalled. This barebones configuration file references a single anchor, found in <code>/etc/pf.anchors/com.apple</code>. This anchor, however, does not contain any actual <code>pf</code> rules; instead, it appears to be nothing more than a placeholder.</p>
<p>Since there is a configuration file already in place, you have two options ahead of you:</p>
<ol>
<li>
<p>You can overwrite the existing configuration file. The drawback of this approach is that a) Apple has been known to change this file during system updates, undoing your changes; and b) it could break future OS X functionality.</p>
</li>
<li>
<p>You can bypass the existing configuration file. This is the approach I took, partly due to the reasons listed above and partly because I found that <code>pfctl</code> (the program used to manage <code>pf</code>) wouldn&rsquo;t activate the filter rules when the existing configuration file was used. (It complained about improper order of lines in the existing configuration file.)</p>
</li>
</ol>
<p>Note that some tools (like <a href="http://www.hanynet.com/icefloor/index.html">IceFloor</a>) take the first approach and modify the existing configuration file.</p>
<p>I&rsquo;ll assume you&rsquo;re going to use option #2. What you&rsquo;ll need, then, are (at a minimum) two configuration files:</p>
<ol>
<li>
<p>The <code>pf</code> configuration file you want it to parse on startup</p>
</li>
<li>
<p>At least one anchor file that contains the various options and rules you want to pass to <code>pf</code> when it starts</p>
</li>
</ol>
<p>Since we&rsquo;re bypassing the existing configuration file, all you really need is an extremely simple configuration file that points to your anchor and loads it, like this:</p>
<pre><code>anchor &quot;org.scottlowe.pf&quot;
load anchor &quot;org.scottlowe.pf&quot; from &quot;/etc/pf.anchors/org.scottlowe.pf.rules&quot;
</code></pre>
<p>The other file you need has the actual options and rules that will be passed to <code>pf</code> when it starts. You can get fancy here and use a separate file to define macros and tables, or you can bundle the macros and tables in with the rules. Whatever approach you take, be <strong>sure</strong> that you have the commands in this file in the right order: options, normalization, queueing, translation, and filtering. Failure to put things in the right order will cause <code>pf</code> not to enable and will leave your system without this additional layer of network protection.</p>
<p>A <em>very</em> simple set of rules in an anchor might look something like this (click <a href="https://gist.github.com/scottslowe/5581710">here</a> for an option to download this code snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># Options
</span></span><span style="display:flex;"><span>set block-policy drop
</span></span><span style="display:flex;"><span>set fingerprints &#34;/etc/pf.os&#34;
</span></span><span style="display:flex;"><span>set ruleset-optimization basic
</span></span><span style="display:flex;"><span>set skip on lo0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Normalization
</span></span><span style="display:flex;"><span># Scrub incoming packets
</span></span><span style="display:flex;"><span>scrub in all no-df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Queueing
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Translation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Filtering
</span></span><span style="display:flex;"><span># Antispoof
</span></span><span style="display:flex;"><span>antispoof log quick for { lo0 en0 en2 }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Block by default
</span></span><span style="display:flex;"><span>block in log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Block to/from illegal destinations or sources
</span></span><span style="display:flex;"><span>block in log quick from no-route to any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Allow critical system traffic
</span></span><span style="display:flex;"><span>pass in quick inet proto udp from any port 67 to any port 68
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Allow ICMP from home LAN
</span></span><span style="display:flex;"><span>pass in log proto icmp from 192.168.254.0/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Allow outgoing traffic
</span></span><span style="display:flex;"><span>pass out inet proto tcp from any to any keep state
</span></span><span style="display:flex;"><span>pass out inet proto udp from any to any keep state
</span></span></code></pre></div><p>Naturally, you&rsquo;d want to customize these rules to fit your environment. At the end of this article I provide some additional resources that might help with this task.</p>
<p>Once you have the configuration file in place and at least one anchor defined with rules (in the right order!), then you&rsquo;re ready to move ahead with creating the launchd item for <code>pf</code> so that it starts automatically.</p>
<p><em>However</em>, there is one additional thing you might want to do first&mdash;test your rules to be sure everything is correct. Use this command in a terminal window while running as an administrative user:</p>
<pre><code>sudo pfctl -v -n -f &lt;path to configuration file&gt;
</code></pre>
<p>If this command reports errors, go back and fix them before proceeding.</p>
<h2 id="creating-the-launchd-item-for-pf">Creating the launchd Item for pf</h2>
<p>Creating the launchd item simply involves creating a properly-formatted XML file and placing it in <code>/Library/LaunchDaemons</code>. It must be owned by root, otherwise it won&rsquo;t be processed at all. If you aren&rsquo;t clear on how to make sure it&rsquo;s owned by root, go do a bit of reading on <code>sudo</code> and <code>chown</code>.</p>
<p>Here&rsquo;s a launchd item you might use for <code>pf</code> (click <a href="https://gist.github.com/scottslowe/5581726">here</a> for an option to download this code snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer/DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plist</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>Label<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>org.scottlowe.pf.plist<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>Program<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>/sbin/pfctl<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>ProgramArguments<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>/sbin/pfctl<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>-e<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>-f<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>/etc/pf.anchors/org.scottlowe.pf.conf<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>RunAtLoad<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>ServiceDescription<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>FreeBSD Packet Filter (pf) daemon<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;key&gt;</span>StandardErrorPath<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>/var/log/pf.log<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>StandardOutPath<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>/var/log/pf.log<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plist&gt;</span>
</span></span></code></pre></div><p>A few notes about this launchd item:</p>
<ul>
<li>
<p>You&rsquo;ll want to change the last <code>&lt;string&gt;</code> item under the ProgramArguments key to properly reflect the path and filename of the custom configuration file you created earlier. In my case, I&rsquo;m storing both the configuration file and the anchor in the <code>/etc/pf.anchors</code> directory.</p>
</li>
<li>
<p>As I stated earlier, you <em>must</em> ensure this file is owned by root once you put it into <code>/Library/LaunchDaemons</code>. It won&rsquo;t work otherwise.</p>
</li>
<li>
<p>If you have additional parameters you want/need to pass to <code>pfctl</code>, add them as separate lines in the ProgramArguments array. Each individual argument on the command line must be a separate item in the array.</p>
</li>
</ul>
<p>Once this file is in place with the right ownership, you can either use <code>launchctl</code> to load it or restart your computer. The robust <code>pf</code> firewall should now be running on your OS X Mountain Lion system. Enjoy!</p>
<h2 id="some-additional-resources">Some Additional Resources</h2>
<p>Finally, it&rsquo;s important to note that I found a few different web sites helpful during my experimentations with <code>pf</code> on OS X. <a href="http://krypted.com/mac-os-x/a-cheat-sheet-for-using-pf-in-os-x-lion-and-up/">This write-up</a> was written with Lion in mind, but applies equally well to Mountain Lion, and <a href="https://calomel.org/pf_config.html">this site</a>&ndash;while clearly focused on OpenBSD and FreeBSD&mdash;was nevertheless quite helpful as well.</p>
<p>It should go without saying, but I&rsquo;ll say it nevertheless: courteous comments are welcome! Feel free to add your thoughts, ideas, questions, or corrections below.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/bsd">BSD</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/macos">macOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/unix">UNIX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/05/14/joint-openstack-denver-and-infracoders-denver-meetup/">Joint OpenStack Denver and Infracoders Denver Meetup</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/05/15/examining-open-vswitch-traffic-patterns/">Examining Open vSwitch Traffic Patterns</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f15%2fusing-pf-on-os-x-mountain-lion%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f15%2fusing-pf-on-os-x-mountain-lion%2f&text=Using%20pf%20on%20OS%20X%20Mountain%20Lion" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f15%2fusing-pf-on-os-x-mountain-lion%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2012/04/05/setting-up-ipfw-on-mac-os-x/">Setting Up ipfw on Mac OS X</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2011/07/25/some-useful-unix-commands-on-your-mac/">Some Useful UNIX Commands on your Mac</a> <span class="post-date-list">259 May 252525</span></li><li><a href="/2011/06/23/using-gnu-screen-with-ssh/">Using GNU Screen with SSH</a> <span class="post-date-list">239 May 232323</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
