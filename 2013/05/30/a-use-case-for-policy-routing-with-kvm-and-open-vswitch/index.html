<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>A Use Case for Policy Routing with KVM and Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="A Use Case for Policy Routing with KVM and Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="A Use Case for Policy Routing with KVM and Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/05/30/a-use-case-for-policy-routing-with-kvm-and-open-vswitch/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">A Use Case for Policy Routing with KVM and Open vSwitch</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 309 May 303030 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;777 words (estimated 4 minutes to read)</span>
  <p>In an earlier post, I provided an <a href="/2013/05/29/a-quick-introduction-to-linux-policy-routing/">introduction to policy routing</a> as implemented in recent versions of Ubuntu Linux (and possibly other distributions as well), and I promised that in a future post I would provide a practical application of its usage. This post looks at that practical application: how&mdash;and why&mdash;you would use Linux policy routing in an environment running OVS and a Linux hypervisor (I&rsquo;ll assume KVM for the purposes of this post).</p>
<p>Before I get into the &ldquo;how,&rdquo; let&rsquo;s first discuss the &ldquo;why.&rdquo; Let&rsquo;s assume that you have a KVM+OVS environment and are leveraging tunnels (GRE or other) for some guest domain traffic. Recall from my post on <a href="/2013/05/15/examining-open-vswitch-traffic-patterns/">traffic patterns with Open vSwitch</a> that tunnel traffic is generated by the OVS process itself, and therefore is controlled by the Linux host&rsquo;s IP routing table with regard to which interfaces that tunnel traffic will use. But what if you need the tunnel traffic to be handled differently than the host&rsquo;s management traffic? What if you need a default route for tunnel traffic that uses one interface, but a different default route for your separate management network that uses its own interface? This is why you would use policy routing in this configuration. Using source routing (i.e., policy routing based on the source of the traffic), you could easily define a table for tunnel traffic that has its own default route while still allowing management traffic to use the host&rsquo;s default routing table.</p>
<p>Let&rsquo;s take a look at how it&rsquo;s done. In this example, I&rsquo;ll make the following assumptions:</p>
<ul>
<li>
<p>I&rsquo;ll assume that you&rsquo;re running host management traffic through OVS, as I outlined <a href="/2012/10/30/running-host-management-on-open-vswitch/">here</a>. I&rsquo;ll use the name <code>mgmt0</code> to refer to the management interface that&rsquo;s running through OVS for host management traffic. We&rsquo;ll use the IP address 192.168.100.10 for the <code>mgmt0</code> interface.</p>
</li>
<li>
<p>I&rsquo;ll assume that you&rsquo;re running tunnel traffic through an OVS interface interface named <code>tep0</code>. (This helps provide some consistency with my walk-through on <a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">using GRE tunnels with OVS</a>.) We&rsquo;ll use the IP address 192.168.200.10 for the <code>tep0</code> interface.</p>
</li>
<li>
<p>I&rsquo;ll assume that the default gateway on each subnet uses the .1 address on that subnet.</p>
</li>
</ul>
<p>With these assumptions out of the way, let&rsquo;s look at how you would set this up.</p>
<p>First, you&rsquo;ll create a custom policy routing table, as outlined <a href="/2013/05/29/a-quick-introduction-to-linux-policy-routing/">here</a>. I&rsquo;ll use the name &ldquo;tunnel&rdquo; for my new table:</p>
<pre><code>echo 200 tunnel &gt;&gt; /etc/iproute2/rt_tables
</code></pre>
<p>Next, you&rsquo;ll need to modify <code>/etc/network/interfaces</code> for the <code>tep0</code> interface so that a custom policy routing rule and custom route are installed whenever this interface is brought up. The new configuration stanza would look something like this:</p>
<pre tabindex="0"><code>auto tep0
iface tep0 inet static
  address 192.168.200.10
  netmask 255.255.255.0
  network 192.168.200.0
  broadcast 192.168.200.255
  post-up ip rule add from 192.168.200.10 lookup tunnel
  post-up ip route add default via 192.168.200.1 dev tep0 table tunnel
</code></pre><p>(Click <a href="https://gist.github.com/scottslowe/5665588">here</a> for the same information as a GitHub Gist.)</p>
<p>Finally, you&rsquo;ll want to ensure that <code>mgmt0</code> is properly configured in <code>/etc/network/interfaces</code>. No special configuration is required there, just the use of the <code>gateway</code> directive to install the default route. Ubuntu will install the default route into the main table automatically, making it a &ldquo;system-wide&rdquo; default route that will be used unless a policy routing rule dictates otherwise.</p>
<p>With this configuration in place, you now have a system that:</p>
<ul>
<li>
<p>Can communicate via <code>mgmt0</code> with other systems in other subnets via the default gateway of 192.168.100.1.</p>
</li>
<li>
<p>Can communicate via <code>tep0</code> to establish tunnels with other hypervisors in other subnets via the 192.168.200.1 gateway.</p>
</li>
</ul>
<p>This configuration requires only the initial configuration (which could, quite naturally, be automated via a tool like <a href="https://puppetlabs.com/">Puppet</a>) and does <em>not</em> require using additional routes as the environment scales to include new subnets for other hypervisors (either for management or tunnel traffic). Thus, organizations can use recommended practices for building scalable L3 networks with reasonably-sized L2 domains without sacrificing connectivity to/from the hypervisors in the environment.</p>
<p>(By the way, this is something that is not easily accomplished in the vSphere world today. ESXi has only a single routing table for all VMkernel interfaces, which means that management traffic, vMotion traffic, VXLAN traffic, etc., are all bound by that single routing table. To achieve full L3 connectivity, you&rsquo;d have to install specific routes into the VMkernel routing table on each ESXi host. When additional subnets are added for scale, each host would have to be touched to add the additional route.)</p>
<p>Hopefully this gives you an idea of how Linux policy routing could be effectively used in environments leveraging virtualization, OVS, and overlay protocols. Feel free to add your thoughts, idea, corrections, or questions in the comments below. Courteous comments are always welcome! (Please disclose vendor affiliations where applicable.)</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kvm">KVM</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ubuntu">Ubuntu</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/05/29/a-quick-introduction-to-linux-policy-routing/">A Quick Introduction to Linux Policy Routing</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/05/31/reducing-the-friction-bbedit-to-marsedit/">Reducing the Friction: BBEdit to MarsEdit</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f30%2fa-use-case-for-policy-routing-with-kvm-and-open-vswitch%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f30%2fa-use-case-for-policy-routing-with-kvm-and-open-vswitch%2f&text=A%20Use%20Case%20for%20Policy%20Routing%20with%20KVM%20and%20Open%20vSwitch" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f30%2fa-use-case-for-policy-routing-with-kvm-and-open-vswitch%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2012/10/29/technology-short-take-26/">Technology Short Take #26</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2012/08/17/installing-kvm-and-open-vswitch-on-ubuntu/">Installing KVM and Open vSwitch on Ubuntu</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">Using GRE Tunnels with Open vSwitch</a> <span class="post-date-list">79 May 7077</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
