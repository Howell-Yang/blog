<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>VLAN Trunking to Guest Domains with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="VLAN Trunking to Guest Domains with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="VLAN Trunking to Guest Domains with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/05/28/vlan-trunking-to-guest-domains-with-open-vswitch/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">VLAN Trunking to Guest Domains with Open vSwitch</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 289 May 282828 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1083 words (estimated 6 minutes to read)</span>
  <p>In other articles, I&rsquo;ve talked about how to use <a href="/2012/10/19/vlans-with-open-vswitch-fake-bridges/">Open vSwitch (OVS) with VLANs</a> to place guest domains (VMs) into a particular VLAN. In this article, I want to show you how to pass VLAN tags all the way into the guest domain&mdash;in other words, how to do VLAN trunking to guest domains using OVS. To do this, we&rsquo;re going to leverage the OVS-libvirt integration I referenced in this post on <a href="/2012/11/07/using-vlans-with-ovs-and-libvirt/">using VLANs with OVS and libvirt</a>.</p>
<p>For this to work, you must have an operating system in the guest domain that is capable of recognizing and using the VLAN tags that are being passed to it by OVS. In this article, I&rsquo;ll use Ubuntu 12.04 as the OS in the guest domain. For other operating systems, the commands and/or procedures to configure VLAN support appropriately will probably differ, so keep that in mind.</p>
<p>There are two parts to making this work:</p>
<ol>
<li>
<p>Configuring OVS (manually or via libvirt) to pass VLAN tags to the guest OS.</p>
</li>
<li>
<p>Configuring the guest domain&rsquo;s installed OS to take advantage of the VLAN tags being passed up by OVS.</p>
</li>
</ol>
<p>Let&rsquo;s look at each of these parts separately. We&rsquo;ll start with configuring OVS, either manually or via libvirt, to pass the VLAN tags up to the guest domain.</p>
<h2 id="configuring-ovs-to-pass-vlan-tags-to-the-guest-domain">Configuring OVS to Pass VLAN Tags to the Guest Domain</h2>
<p>There are two ways to accomplish this: you can do it manually, or you can do it via OVS integration with recent builds of libvirt.</p>
<h3 id="manually-configuring-ovs">Manually Configuring OVS</h3>
<p>To configure OVS manually, you would need to:</p>
<ol>
<li>
<p>Identify which vnet port you want to configure for VLAN trunking</p>
</li>
<li>
<p>Configure the vnet port to trunk the VLANs.</p>
</li>
</ol>
<p>To identify which vnet port needs to be modified, you&rsquo;ll want to figure out the guest domain interface(s) that is/are connected to the vnet port. You can do this by using this command (substitute the desired vnet port name in place of <code>vnet0</code> in the following command):</p>
<pre><code>ovs-vsctl list interface vnet0
</code></pre>
<p>In the output of the command, look for the <code>external_ids</code> line; it will contain an entry called &ldquo;attached-mac&rdquo;, and that represents the MAC address of the interface in the guest domain OS attached to this particular vnet port. You can compare this to the output of <code>ip addr list</code> or <code>ifconfig -a</code> in Ubuntu to find a matching MAC address in the guest domain. Correlating the two values allows you to determine which guest domain is attached to which vnet port, and then you can modify the correct vnet port appropriately.</p>
<p>You&rsquo;d modify the vnet port using this command:</p>
<pre><code>ovs-vsctl set port vnet0 trunks=20,30,40
</code></pre>
<p>You&rsquo;d want to substitute the appropriate values for <code>vnet0</code> and the VLAN IDs that you want passed up to the guest domain. Once you&rsquo;ve made the change, you can verify the changes using this command (replacing <code>vnet0</code> with the correct port):</p>
<pre><code>ovs-vsctl list port vnet0
</code></pre>
<p>Note that if you want the guest domain to receive both untagged (native VLAN) traffic as well as tagged (trunked) traffic, there is an additional setting you must set:</p>
<pre><code>ovs-vsctl set port vnet0 vlan_mode=native-untagged
</code></pre>
<p>With this setting in place, the OS installed into the guest domain will be able to communicate over the untagged (native) VLAN as well as using VLAN tags.</p>
<h3 id="using-libvirt-integration">Using libvirt Integration</h3>
<p>If the manual method of configuring OVS seems a bit cumbersome, using the libvirt integration makes it <em>much</em> easier.</p>
<p>Basically, you&rsquo;ll follow the configuration outlined in <a href="/2012/11/07/using-vlans-with-ovs-and-libvirt/">this blog post</a> to create a libvirt network that corresponds to an OVS bridge. Here&rsquo;s an example of the XML code to accomplish this task (click <a href="https://gist.github.com/scottslowe/4057683">here</a> for an option to download this code snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;network&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;name&gt;</span>ovs-network<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;forward</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;bridge&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;bridge</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;ovsbr0&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;virtualport</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;openvswitch&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;portgroup</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vlan-01&#39;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/portgroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;portgroup</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vlan-02&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;vlan&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/vlan&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/portgroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;portgroup</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vlan-03&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;vlan&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/vlan&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/portgroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;portgroup</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;vlan-all&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;vlan</span> <span style="color:#a6e22e">trunk=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/vlan&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/portgroup&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/network&gt;</span>
</span></span></code></pre></div><p>Of particular interest for what we&rsquo;re trying to accomplish here is the very last section, the portgroup named &ldquo;vlan-all.&rdquo; Note that for this specific portgroup, the <code>vlan</code> element has a property that specifies it is a trunk, and then there are multiple <code>tag</code> elements that list each VLAN ID that will be trunked across this network into the guest domain.</p>
<p>Using this configuration, when we create the guest domain and specify that it is attached to the network named &ldquo;vlan-all&rdquo; (matching the portgroup in the libvirt network definition), libvirt will automatically configure OVS appropriately (it will set the <code>trunks</code> value for that domain&rsquo;s OVS port).</p>
<p><strong>However,</strong> it will not configure the OVS port to allow untagged traffic as well (only tagged traffic will be passed). If you want the guest domain to receive untagged traffic also, you must set the <code>vlan_mode</code> value manually as outlined above.</p>
<h2 id="configuring-the-guest-domain-to-use-vlan-tags">Configuring the Guest Domain to Use VLAN Tags</h2>
<p>Once you&rsquo;ve followed the steps outlined above and have OVS configured correctly, then you&rsquo;re ready to configure the OS in the guest domain. Keep in mind that I&rsquo;m using Ubuntu 12.04 in this post, but you&rsquo;re welcome to use any operating system that supports VLAN tags.</p>
<p>Assuming that eth0 is the interface in the guest domain that is receiving tagged traffic from OVS, this snippet in <code>/etc/network/interfaces</code> will create and configure a VLAN interface (click <a href="https://gist.github.com/scottslowe/5658227">here</a> for an option to download this snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>auto eth0.20
</span></span><span style="display:flex;"><span>iface eth0.20 inet static
</span></span><span style="display:flex;"><span>  vlan-raw-device eth0
</span></span><span style="display:flex;"><span>  address 192.168.20.200
</span></span><span style="display:flex;"><span>  netmask 255.255.255.0
</span></span><span style="display:flex;"><span>  network 192.168.20.0
</span></span><span style="display:flex;"><span>  broadcast 192.168.20.255
</span></span></code></pre></div><p>Technically, the &ldquo;raw-vlan-device&rdquo; line isn&rsquo;t needed because the parent device name is in the name of the VLAN device, but I like to include it for completeness and ease of debugging. (Your mileage may vary, of course.) The number on the end of the eth0 (for example, eth0.20) corresponds to the VLAN ID (VLAN 20, in this case) being passed up by OVS.</p>
<p>You can repeat this configuration for multiple VLAN interfaces.</p>
<h2 id="use-case">Use Case</h2>
<p>I&rsquo;ll have to admit that I can&rsquo;t immediately think of some useful use cases for this sort of configuration. At first glance, you might think that it would be useful in situations where you need logical separation, but I think there are better ways than VLANs to accomplish this task (and those ways are probably simpler). I primarily set out to document this in order to better solidify my knowledge of how OVS works and is configured. However, I&rsquo;d be happy to hear from others on what they think might be interesting or useful use cases for this sort of configuration. Feel free to add your thoughts in the comments below. Courteous comments are always welcome!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ubuntu">Ubuntu</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vlan">VLAN</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/05/21/learning-nvp-part-1-high-level-architecture/">Learning NVP, Part 1: High-Level Architecture</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/05/29/a-quick-introduction-to-linux-policy-routing/">A Quick Introduction to Linux Policy Routing</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f28%2fvlan-trunking-to-guest-domains-with-open-vswitch%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f28%2fvlan-trunking-to-guest-domains-with-open-vswitch%2f&text=VLAN%20Trunking%20to%20Guest%20Domains%20with%20Open%20vSwitch" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f05%2f28%2fvlan-trunking-to-guest-domains-with-open-vswitch%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2012/11/07/using-vlans-with-ovs-and-libvirt/">Using VLANs with OVS and libvirt</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2012/10/29/technology-short-take-26/">Technology Short Take #26</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2012/08/17/installing-kvm-and-open-vswitch-on-ubuntu/">Installing KVM and Open vSwitch on Ubuntu</a> <span class="post-date-list">179 May 171717</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
