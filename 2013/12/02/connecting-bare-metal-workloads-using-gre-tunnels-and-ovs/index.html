<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Connecting Bare Metal Workloads Using GRE Tunnels and OVS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Connecting Bare Metal Workloads Using GRE Tunnels and OVS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Connecting Bare Metal Workloads Using GRE Tunnels and OVS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/12/02/connecting-bare-metal-workloads-using-gre-tunnels-and-ovs/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Connecting Bare Metal Workloads Using GRE Tunnels and OVS</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 29 May 2022 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1553 words (estimated 8 minutes to read)</span>
  <p>In this post, I&rsquo;ll discuss how you could use <a href="http://openvswitch.org/">Open vSwitch (OVS)</a> and GRE tunnels to connect bare metal workloads. While OVS is typically used in conjunction with a hypervisor such as KVM or Xen, you&rsquo;re certainly not restricted to <em>only</em> using it on hypervisors. Similarly, while GRE tunnels are commonly used to connect VMs or containers, you&rsquo;re definitely not restricted from using them with bare metal workloads as well. In this post, I&rsquo;ll explore how you would go about connecting bare metal workloads over GRE tunnels managed by OVS.</p>
<p>This post, by the way, was sparked in part by a comment on my article on <a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">using GRE tunnels with OVS</a>, in which the reader asked: &ldquo;Is there a way to configure bare Linux (Ubuntu)with OVS installed&hellip;to serve as a tunnel endpoint?&rdquo; Hopefully this post helps answer that question. (By the way, the key to understanding how this works is in understanding OVS traffic patterns. If you haven&rsquo;t yet read my post on <a href="/2013/05/15/examining-open-vswitch-traffic-patterns/">examining OVS traffic patterns</a>, I highly recommend you go have a look right now. Seriously.)</p>
<p>Once you have OVS installed (maybe <a href="/2013/10/14/installing-open-vswitch-on-ubuntu-with-puppet/">this is helpful</a>?), then you need to create the right OVS configuration. That configuration can be described, at a high level, like this:</p>
<ul>
<li>
<p>Assign an IP address to a physical interface. This interface will be considered the &ldquo;tunnel endpoint,&rdquo; and therefore should have an IP address that is correct for use on the transport network.</p>
</li>
<li>
<p>Create an OVS bridge that has no physical interfaces assigned.</p>
</li>
<li>
<p>Create an OVS internal interface on this OVS bridge, and assign it an IP address for use inside the GRE tunnel(s). This interface will be considered the primary interface for the OS instance.</p>
</li>
<li>
<p>Create the GRE tunnel for connecting to other tunnel endpoints.</p>
</li>
</ul>
<p>Each of these areas is described in a bit more detail in the following sections.</p>
<h2 id="setting-up-the-transport-interface">Setting Up the Transport Interface</h2>
<p>When setting up the physical interface&mdash;which I&rsquo;ll refer to as the transport interface moving forward, since it is responsible for transporting the GRE tunnel across to the other endpoints&mdash;you&rsquo;ll just need to use an IP address and routing entries that enable it to communicate with other tunnel endpoints.</p>
<p>Let&rsquo;s assume that we are going to have tunnel endpoints on the 192.168.1.0/24 subnet. On the bare metal OS instance, you&rsquo;d configure a physical interface (I&rsquo;ll assume <code>eth0</code>, but it could be any physical interface) to have an IP address on the 192.168.1.0/24 subnet. You could do this automatically via DHCP or manually; the choice is yours. Other than ensuring that the bare metal OS instance can communicate with other tunnel endpoints, <em>no additional configuration is required.</em> (I&rsquo;m using &ldquo;required&rdquo; as in &ldquo;necessary to make it work.&rdquo; You may want to increase the MTU on your physical interface and network equipment in order to accommodate the GRE headers in order to optimize performance, but that isn&rsquo;t required in order to make it work.)</p>
<p>Once you have the transport interface configured and operational, you can move on to configuring OVS.</p>
<h2 id="configuring-ovs">Configuring OVS</h2>
<p>If you&rsquo;ve been following along at home with all of my OVS-related posts (you can browse all posts using <a href="/tags/ovs/">the OVS tag</a>, you can probably guess what this will look like (hint: it will look a little bit like the configuration I described in my post on running <a href="/2012/10/30/running-host-management-on-open-vswitch/">host management through OVS</a>). Nevertheless, I&rsquo;ll walk through the configuration for the benefit of those who are new to OVS.</p>
<p>First, you&rsquo;ll need to create an OVS bridge that has no physical interfaces&mdash;the so-called &ldquo;isolated bridge&rdquo; because it is isolated from the physical network. You can call this bridge whatever you want. I&rsquo;ll use the name <code>br-int</code> (the &ldquo;integration bridge&rdquo;) because it&rsquo;s commonly used in other environments like OpenStack and NVP/NSX.</p>
<p>To create the isolated bridge, use <code>ovs-vsctl</code>:</p>
<pre><code>ovs-vsctl add-br br-int
</code></pre>
<p>Naturally, you would substitute whatever name you&rsquo;d like to use in the above command. Once you&rsquo;ve created the bridge, then add an OVS internal interface; this internal interface will become the bare metal workload&rsquo;s primary network interface:</p>
<pre><code>ovs-vsctl add-port br-int mgmt0 -- set interface mgmt0 type=internal
</code></pre>
<p>You can use a name other than <code>mgmt0</code> if you so desire. Next, configure this new OVS internal interface at the operating system level, assigning it an IP address. This IP address should be taken from a subnet &ldquo;inside&rdquo; the GRE tunnel, because it is only via the GRE tunnel that you&rsquo;ll want the workload to communicate.</p>
<p>The following commands will take care of this part for you:</p>
<pre><code>ip addr add 10.10.10.30/24 dev mgmt0
ip link set mgmt0 up
</code></pre>
<p>The process of ensuring that the <code>mgmt0</code> interface comes up automatically when the system boots is left as an exercise for the reader (hint: use <code>/etc/network/interfaces</code>).</p>
<p>At this point, the bare metal OS instance will have <strong>two</strong> network interfaces:</p>
<ul>
<li>
<p>A physical interface (we&rsquo;re assuming <code>eth0</code>) that is configured for use on the transport network. In other words, it has an IP address and routes necessary for communication with other tunnel endpoints.</p>
</li>
<li>
<p>An OVS internal interface (I&rsquo;m using <code>mgmt0</code>) that is configured for use inside the GRE tunnel. In other words, it has an IP address and routes necessary to communicate with other workloads (bare metal, containers, VMs) via the OVS-hosted GRE tunnel(s).</p>
</li>
</ul>
<p>Because the bare metal OS instance sees two interfaces (and therefore has visibility into the routes both &ldquo;inside&rdquo; and &ldquo;outside&rdquo; the tunnel), you may need to apply some policy routing configuration. See <a href="/2013/05/29/a-quick-introduction-to-linux-policy-routing/">my introductory post on Linux policy routing</a> if you need more information.</p>
<p>The final step is establishing the GRE tunnel.</p>
<h2 id="establishing-the-gre-tunnel">Establishing the GRE Tunnel</h2>
<p>The commands for establishing the GRE tunnel have been described numerous times, but once again I&rsquo;ll walk through the process just for the sake of completeness. I&rsquo;m assuming that you&rsquo;ve already completed the steps in the previous section, and that you are using an OVS bridge named <code>br-int</code>.</p>
<p>First, add the GRE port to the bridge:</p>
<pre><code>ovs-vsctl add-port br-int gre0
</code></pre>
<p>Next, configure the GRE interface on that port:</p>
<pre><code>ovs-vsctl set interface gre0 type=gre options:remote_ip=&lt;IP address of remote tunnel endpoint&gt;
</code></pre>
<p>Let&rsquo;s say that you&rsquo;ve assigned 192.168.1.10 to the transport interface on this system (the bare metal OS instance), and that the remote tunnel endpoint (which could be a host with multiple containers, or a hypervisor running VMs) has an IP address of 192.168.1.15. On the bare metal system, you&rsquo;d configure the GRE interface like this:</p>
<pre><code>ovs-vsctl set interface gre0 type=gre options:remote_ip=192.168.1.15
</code></pre>
<p>On the remote tunnel endpoint, you&rsquo;d configure the GRE interface like this:</p>
<pre><code>ovs-vsctl set interface gre0 type=gre options:remote_ip=192.168.1.10
</code></pre>
<p>In other words, each GRE interface points to the transport IP address on the <em>opposite</em> end of the tunnel.</p>
<p>Once the configuration on both ends is done, then you should be able to go into the bare metal OS instance and ping an IP address inside the GRE tunnel. For example, I used this configuration to connect a bare metal Ubuntu 12.04 instance, a container running on an Ubuntu host, and a KVM VM running on an Ubuntu host (I had a full mesh topology with STP enabled, as described here). I was able to successfully ping between the bare metal OS instance, the container, and the VM, all inside the GRE tunnel.</p>
<h2 id="summary-caveats-and-other-thoughts">Summary, Caveats, and Other Thoughts</h2>
<p>While this configuration is interesting as a &ldquo;proof of concept&rdquo; that OVS and GRE tunnels can be used to connect bare metal OS instances and workloads, there are a number of considerations and/or caveats that you&rsquo;ll want to think about before trying something like this in a production environment:</p>
<ul>
<li>
<p>The bare metal OS instance has visibility both &ldquo;inside&rdquo; and &ldquo;outside&rdquo; the tunnel, so there isn&rsquo;t an easy way to prevent the bare metal OS instance from communicating outside the tunnel to other entities. This might be OK&mdash;or it might not. It all depends on your requirements, and what you are trying to achieve. (In theory, you <em>might</em> be able to provide some isolation using network namespaces, but I haven&rsquo;t tested this at all.)</p>
</li>
<li>
<p>If you want to create a full mesh topology of GRE tunnels, you&rsquo;ll need to enable STP on OVS.</p>
</li>
<li>
<p>There&rsquo;s nothing preventing you from attaching an OpenFlow controller to the OVS instances (including the OVS instance on the bare metal OS) and pushing flow rules down. This would eliminate the need for STP, since OVS won&rsquo;t be in MAC learning mode. This means you could easily incorporate bare metal OS instances into a network virtualization-type environment. However</p>
</li>
<li>
<p>There&rsquo;s no easy way to provide a separation of OVS and the bare metal OS instance. This means that users who are legitimately allowed to make administrative changes to the bare metal OS instance could also make changes to OVS, which could easily &ldquo;break&rdquo; the configuration and cause problems. My personal view is that this is why you rarely see this sort of OVS configuration used in conjunction with bare metal workloads.</p>
</li>
</ul>
<p>I still see value in explaining how this works because it provides yet another example of how to configure OVS and how to use OVS to help provide advanced networking capabilities in a variety of environments and situations.</p>
<p>If you have any questions, I encourage you to add them in the comments below. Likewise, if I have overlooked something, made any mistakes, or if I&rsquo;m just plain wrong, please speak up below (courteously, of course!). I welcome all useful/pertinent feedback and interaction.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/gre">GRE</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kvm">KVM</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/lxc">LXC</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/11/28/happy-thanksgiving-2013/">Happy Thanksgiving 2013</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/12/02/weirdness-with-virtual-ethernet-interfaces-on-ubuntu/">Weirdness with Virtual Ethernet Interfaces on Ubuntu</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f02%2fconnecting-bare-metal-workloads-using-gre-tunnels-and-ovs%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f02%2fconnecting-bare-metal-workloads-using-gre-tunnels-and-ovs%2f&text=Connecting%20Bare%20Metal%20Workloads%20Using%20GRE%20Tunnels%20and%20OVS" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f02%2fconnecting-bare-metal-workloads-using-gre-tunnels-and-ovs%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2013/11/26/lxc-open-vswitch-and-gre-tunnels/">LXC, Open vSwitch, and GRE Tunnels</a> <span class="post-date-list">269 May 262626</span></li><li><a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">Using GRE Tunnels with Open vSwitch</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2013/11/27/linux-containers-via-lxc-and-libvirt/">Linux Containers via LXC and Libvirt</a> <span class="post-date-list">279 May 272727</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
