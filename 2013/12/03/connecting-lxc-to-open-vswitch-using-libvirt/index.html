<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Connecting LXC to Open vSwitch Using Libvirt - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Connecting LXC to Open vSwitch Using Libvirt - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Connecting LXC to Open vSwitch Using Libvirt - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/12/03/connecting-lxc-to-open-vswitch-using-libvirt/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Connecting LXC to Open vSwitch Using Libvirt</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 39 May 3033 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;658 words (estimated 4 minutes to read)</span>
  <p>In this post I&rsquo;m going to expand a little bit on using <a href="http://libvirt.org/">libvirt</a> to connect Linux containers (created using <a href="http://linuxcontainers.org/">LXC</a>) to <a href="http://openvswitch.org/">Open vSwitch (OVS)</a>. I made brief mention of this in my post on <a href="/2013/11/27/linux-containers-via-lxc-and-libvirt/">using LXC with libvirt</a>, but did not provide any details. This post aims to provide those details.</p>
<p>I&rsquo;m assuming that you&rsquo;re already familiar with LXC, OVS, and libvirt. If you aren&rsquo;t familiar with these projects, I suggest you have a look back at other articles I&rsquo;ve written about them in the past. One of the easiest ways to do that is to browse articles <a href="/tags/lxc/">tagged LXC</a>, <a href="/tags/ovs/">tagged OVS</a>, and/or <a href="/tags/libvirt/">tagged Libvirt</a>. Further, I&rsquo;m using Ubuntu 12.04 LTS in my environment, so if you&rsquo;re using another Linux distribution please note that some commands and/or package names might be different.</p>
<p>The basic process for connecting a Linux container to OVS using libvirt looks something like this:</p>
<ol>
<li>
<p>Create one or more virtual networks in libvirt to &ldquo;front-end&rdquo; OVS.</p>
</li>
<li>
<p>Create your container(s) using standard LXC user-space tools.</p>
</li>
<li>
<p>Create libvirt XML definitions for your container(s).</p>
</li>
<li>
<p>Start the container(s) using <code>virsh</code>.</p>
</li>
</ol>
<p>Steps 2, 3, and 4 were covered in my previous post on using LXC and libvirt, so I won&rsquo;t repeat them here. Step 1 is the focus here. (If you are a long-time reader and/or well-versed with libvirt and OVS, there isn&rsquo;t a great deal of new information here; I just wanted to present it in the context of LXC for the sake of completeness.)</p>
<p>To create a libvirt virtual network to front-end OVS, you need to create an XML definition that you can use with <code>virsh</code> to define the virtual network. Here&rsquo;s an example XML definition (click <a href="https://gist.github.com/scottslowe/7748398">here</a> for an option to download this snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;network&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;name&gt;</span>bridged<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;uuid&gt;</span>ff5f8075-31a7-4cc9-21bf-5c8d144f58f0<span style="color:#f92672">&lt;/uuid&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;forward</span> <span style="color:#a6e22e">mode=</span><span style="color:#e6db74">&#39;bridge&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;bridge</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;br-ex&#39;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;virtualport</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;openvswitch&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;portgroup</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;untagged&#39;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#39;yes&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/portgroup&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/network&gt;</span>
</span></span></code></pre></div><p>A few notes about this XML definition:</p>
<ul>
<li>
<p>You normally wouldn&rsquo;t include the UUID, as that is generated automatically by libvirt. If you were using this XML to create the virtual network from scratch, I would recommend just deleting the UUID line.</p>
</li>
<li>
<p>The network is named &ldquo;bridged&rdquo;, and points to the OVS bridge named <code>br-ex</code>. In this particular case, <code>br-ex</code> is a simple OVS bridge that contains a single physical interface.</p>
</li>
<li>
<p>This particular virtual network only has a single portgroup configured for untagged traffic. If you wanted to provide a virtual network that supported multiple VLANs, you could add more portgroups with the VLAN tags as I describe in my post on <a href="/2012/11/07/using-vlans-with-ovs-and-libvirt/">using VLANs with OVS and libvirt</a>. You&rsquo;d then modify the container&rsquo;s XML definition to point to the appropriate portgroup, and in this way you could easily support running multiple containers across multiple VLANs on a single host.</p>
</li>
<li>
<p>A libvirt virtual network can only point to a single bridge, so if you wanted to support both bridged (as shown here) as well as tunneled connectivity (perhaps as described in <a href="/2013/11/26/lxc-open-vswitch-and-gre-tunnels/">my post on LXC, OVS, and GRE tunnels</a>), you would need to create a second XML definition that creates a separate virtual network. You could then modify the container&rsquo;s XML definition to point to the new network you just created.</p>
</li>
</ul>
<p>In the bullets above, I mentioned modifying the container&rsquo;s XML definition. In particular, I&rsquo;m referring to the <code>&lt;interface type='network'&gt;</code> portion of the container&rsquo;s XML definition. To use a libvirt network for a container&rsquo;s network connectivity, you&rsquo;d specify <code>&lt;source network='bridged'/&gt;</code> (replacing &ldquo;bridged&rdquo; with whatever the name of your virtual network is; I&rsquo;m using the name provided in the sample XML code above). For multiple interfaces in the container, simply supply multiple <code>&lt;interface type='network'&gt;</code> entries in the container&rsquo;s XML definition, and configure the source network for each of them appropriately.</p>
<p>Hopefully this post provides some additional details and information on using libvirt to connect Linux containers to OVS. If you have any questions, or if you have more information to share on this topic, please feel free to speak up in the comments below. I encourage and welcome all courteous feedback!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/libvirt">Libvirt</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/lxc">LXC</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/12/02/weirdness-with-virtual-ethernet-interfaces-on-ubuntu/">Weirdness with Virtual Ethernet Interfaces on Ubuntu</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/12/04/divorcing-google/">Divorcing Google</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f03%2fconnecting-lxc-to-open-vswitch-using-libvirt%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f03%2fconnecting-lxc-to-open-vswitch-using-libvirt%2f&text=Connecting%20LXC%20to%20Open%20vSwitch%20Using%20Libvirt" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f12%2f03%2fconnecting-lxc-to-open-vswitch-using-libvirt%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2013/11/27/linux-containers-via-lxc-and-libvirt/">Linux Containers via LXC and Libvirt</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2013/12/02/connecting-bare-metal-workloads-using-gre-tunnels-and-ovs/">Connecting Bare Metal Workloads Using GRE Tunnels and OVS</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2013/11/26/lxc-open-vswitch-and-gre-tunnels/">LXC, Open vSwitch, and GRE Tunnels</a> <span class="post-date-list">269 May 262626</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
