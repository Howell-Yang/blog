<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Learning NVP, Part 4: Adding Hypervisors to NVP - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Learning NVP, Part 4: Adding Hypervisors to NVP - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Learning NVP, Part 4: Adding Hypervisors to NVP - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/08/22/learning-nvp-part-4-adding-hypervisors-to-nvp/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Learning NVP, Part 4: Adding Hypervisors to NVP</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 229 May 222222 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1627 words (estimated 8 minutes to read)</span>
  <p>This is part 4 of the Learning NVP blog series. Just to quickly recap what&rsquo;s happened so far, in <a href="/2013/05/21/learning-nvp-part-1-high-level-architecture/">part 1</a> I provided the high-level architecture of NVP and discussed the role of the components in broad terms. In <a href="/2013/08/16/learning-nvp-part-2-nvp-controllers/">part 2</a>, I focused on the NVP controllers, showing you how to build/configure the NVP controllers and establish a controller cluster. <a href="/2013/08/19/learning-nvp-part-3-nvp-manager/">Part 3</a> focused on NVP Manager, which allowed us to perform a few additional NVP configuration tasks. In this post, I&rsquo;ll show you how to add hypervisors to NVP so that you can turn up your first logical network.</p>
<h2 id="assumptions">Assumptions</h2>
<p>In this post, I&rsquo;m using Ubuntu 12.04.2 LTS with the KVM hypervisor. I&rsquo;m assuming that you&rsquo;ve already gone through the process of getting KVM installed on your Linux host; if you need help with that, a quick Google search should turn up plenty of &ldquo;how to&rdquo; articles (it&rsquo;s basically a <code>sudo apt-get install kvm</code> operation). If you are using a different Linux distribution or a different hypervisor, the commands you&rsquo;ll use as well as the names of the prerequisite packages you&rsquo;ll need to install will vary slightly. Please keep that in mind.</p>
<h2 id="installing-prerequisites">Installing Prerequisites</h2>
<p>To get a version of <a href="http://libvirt.org/">libvirt</a> that supports <a href="http://openvswitch.org/">Open vSwitch (OVS)</a>, you&rsquo;ll want to enable the Ubuntu Cloud Archive. The Ubuntu Cloud Archive is technically intended to allow users of Ubuntu LTS releases to install newer versions of OpenStack and its dependent packages (including libvirt). Instructions for enabling and using the Ubuntu Cloud Archive are found <a href="https://wiki.ubuntu.com/ServerTeam/CloudArchive">here</a>. However, I&rsquo;ve found using the Ubuntu Cloud Archive to be an easy way to get a newer version of libvirt (version 1.0.2) on Ubuntu 12.04 LTS.</p>
<p>Once you get the Ubuntu Cloud Archive working, go ahead and install libvirt:</p>
<pre><code>sudo apt-get install libvirt-bin
</code></pre>
<p>Next, go ahead and install some prerequisite packages you&rsquo;ll need to get OVS installed and working:</p>
<pre><code>sudo apt-get install dkms make libc6-dev
</code></pre>
<p>Now you&rsquo;re ready to install OVS.</p>
<h2 id="installing-ovs">Installing OVS</h2>
<p>Once your hypervisor node has the appropriate prerequisites installed, you&rsquo;ll need to install an NVP-specific build of OVS. This build of OVS is identical to the open source build in every way <em>except</em> that it includes the ability to create STT tunnels and includes some extra NVP-specific utilities for integrating OVS into NVP. For Ubuntu, this NVP-specific version of OVS is distributed as a compressed tar archive. First, you&rsquo;ll need to extract the files out like this:</p>
<pre><code>tar -xvzf &lt;file name&gt;
</code></pre>
<p>This will extract a set of Debian packages. For ease of use, I recommend moving these files into a separate directory. Once the files are in their own directory, you would install them like this:</p>
<pre><code>cd &lt;directory where the files are stored&gt;
sudo dpkg -i *.deb
</code></pre>
<p>Note that if you don&rsquo;t install the prerequisites listed above, the installation of the DKMS package (for the OVS kernel datapath) will fail. Trying to then run <code>apt-get install &lt;package list&gt;</code> at that point will also fail; you&rsquo;ll need to run <code>apt-get -f install</code>. This will &ldquo;fix&rdquo; the broken packages and allow the DKMS installation to proceed (which it will do automatically).</p>
<p>These particular OVS installation packages do a couple of different things:</p>
<ul>
<li>
<p>They install OVS (of course), including the kernel module.</p>
</li>
<li>
<p>They automatically create and configure something called the <em>integration bridge</em>, which I&rsquo;ll describe in more detail in a few moments.</p>
</li>
<li>
<p>They automatically generate some self-signed certificates you&rsquo;ll need later.</p>
</li>
</ul>
<p>Now that you have OVS installed, you&rsquo;re ready for the final step: to add the hypervisor to NVP.</p>
<h2 id="adding-the-hypervisor-to-nvp">Adding the Hypervisor to NVP</h2>
<p>For this process, you&rsquo;ll need access to NVP Manager as well as SSH access to the hypervisor. I strongly recommend using the same system for access to both NVP Manager and the hypervisor via SSH, as this will make things easier.</p>
<p>Adding the hypervisor to NVP is a two-step process. First, you&rsquo;ll configure the hypervisor; second, you&rsquo;ll configure NVP. Let&rsquo;s start with the hypervisor.</p>
<h3 id="verifying-the-hypervisor-configuration">Verifying the Hypervisor Configuration</h3>
<p>Before you can add the hypervisor to NVP, you&rsquo;ll need to be sure it&rsquo;s configured correctly so I&rsquo;ll walk you through a couple of verification steps. NVP expects there to be an <em>integration bridge</em>, an OVS bridge that it will control. This integration bridge will be separate from any other bridges configured on the system, so if you have a bridge that you&rsquo;re using (or will use) outside of NVP this will be separate. I&rsquo;ll probably expand upon this in more detail in a future post, but for now let&rsquo;s just verify that the integration bridge exists and is configured properly.</p>
<p>To verify the present of the integration bridge, use the command <code>ovs-vsctl show</code> (you might need to use <code>sudo</code> to get the appropriate permissions). The output of the command should look something like this:</p>
<p>Note the bridge named &ldquo;br-int&rdquo;&mdash;this is the default name for the integration bridge. As you can see by this output, the integration bridge does indeed exist. However, you must also verify that the integration bridge is configured appropriately. For that, you&rsquo;ll use the <code>ovs-vsctl list bridge br-int</code>, which will produce output that looks something like this:</p>
<p>Now there&rsquo;s a lot of goodness here (&ldquo;Hey, look&mdash;NetFlow support! Mirrors! sFlow! STP support even!&rdquo;), but try to stay focused. I want to draw your attention to the <code>external_ids</code> line, where the value &ldquo;bridge-id&rdquo; has been set to &ldquo;br-int&rdquo;. This is exactly what you want to see, and I&rsquo;ll explain why in just a moment.</p>
<p>One final verification step is needed. NVP uses self-signed certificates to authenticate hypervisors, so you&rsquo;ll need to be sure that the certificates have been generated (they should have been generated during the installation of OVS). You can verify by running <code>ls -la /etc/openvswitch</code> and looking for the file &ldquo;ovsclient-cert.pem&rdquo;. If it&rsquo;s there, you should be good to go.</p>
<p>Next, you&rsquo;ll need to do a couple of things in NVP Manager.</p>
<h3 id="create-a-transport-zone">Create a Transport Zone</h3>
<p>Before you can actually add the hypervisor to NVP, you first need to ensure that you have a transport zone defined. I&rsquo;ll assume that you don&rsquo;t and walk you through creating one.</p>
<ol>
<li>
<p>In NVP Manager (log in if you aren&rsquo;t already logged in), select Network Components &gt; Transport Zones.</p>
</li>
<li>
<p>In the Network Components Query Results, you&rsquo;ll probably see no transport zones listed. Click Add.</p>
</li>
<li>
<p>In the Create Transport Zone dialog, specify a name for the transport zone, and optionally add tags (tags are used for searching and sorting information in NVP Manager).</p>
</li>
<li>
<p>Click Save.</p>
</li>
</ol>
<p>That&rsquo;s it, but it&rsquo;s an important bit. I&rsquo;ll explain more in a moment.</p>
<h3 id="add-the-hypervisor">Add the Hypervisor</h3>
<p>Now that you&rsquo;ve verified the hypervisor configuration and created a transport zone, you&rsquo;re ready to add the hypervisor to NVP. Here&rsquo;s how.</p>
<ol>
<li>
<p>Log into NVP Manager, if you aren&rsquo;t already, and click on Dashboard in the upper left corner.</p>
</li>
<li>
<p>In the Summary of Transport Components section, click the Add button on the line for Hypervisors.</p>
</li>
<li>
<p>Ensure that Hypervisor is listed in the Transport Node Type drop-down list, then click Next.</p>
</li>
<li>
<p>Specify a display name (I use the hostname of the hypervisor itself), and&mdash;optionally&mdash;add one or more tags. (Tags are used for searching/sorting data in NVP Manager.) Click Next.</p>
</li>
<li>
<p>In the Integration Bridge ID text box, type &ldquo;br-int&rdquo;. (Do you know why? It&rsquo;s not because that&rsquo;s the name of the integration bridge. It&rsquo;s because that&rsquo;s the value set in the <code>external_ids</code> section of the integration bridge.) Be sure that Admin Status Enabled is checked, and optionally you can check Tunnel Keep-Alive Spray. Click Next to continue.</p>
</li>
<li>
<p>Next, you need to authenticate the hypervisor to NVP. This is a multi-step process. First, switch over to the SSH session with the hypervisor (you still have it open, right?) and run <code>cat /etc/openvswitch/ovsclient-cert.pem</code>. This will output the contents of the OVS client certificate to the screen. Copy everything between the <code>BEGIN CERTIFICATE</code> and the <code>END CERTIFICATE</code> lines, including those lines.</p>
</li>
<li>
<p>Flip back over to NVP Manager. Ensure that Security Certificate is listed, then paste the clipboard contents into the Security Certificate box. The red X on the left of the dialog box should change to a green check mark, and you can click Next to continue.</p>
</li>
<li>
<p>The final step is creating a transport connector. Click Add Connector.</p>
</li>
<li>
<p>In the Create Transport Connector dialog, select STT as the Transport Type.</p>
</li>
<li>
<p>Select the transport zone you created earlier, if it isn&rsquo;t already populated in the Transport Zone UUID drop-down.</p>
</li>
<li>
<p>Specify the IP address of the interface on the hypervisor that will be used as the source for all tunnel traffic. This is generally <em>not</em> the management interface. Click OK.</p>
</li>
<li>
<p>Click Save.</p>
</li>
</ol>
<p>This should return you to the NVP Manager Dashboard, where you&rsquo;ll see the Hypervisors line in the Summary of Transport Components go from 0 to 1 (both in the Registered and the Active columns). You can refresh the display of that section only by clicking the little circular arrow button. You should also see an entry appear in the Hypervisor Software Version Summary section. This screen shot shows you what the dashboard would look like after adding 3 hypervisors:</p>
<p><a href="/public/img/nvp-dash-with-hv-large.png"><img src="/public/img/nvp-dash-with-hv-small.png" alt="NVP Manager dashboard"></a></p>
<p>(Side note: This dashboard shows a gateway and service node also added, though I haven&rsquo;t discussed those yet. It also shows a logical switch and logical switch ports, though I haven&rsquo;t discussed those either. Be patient&mdash;they&rsquo;re coming. I can only write so fast.)</p>
<p>Congratulations&mdash;you&rsquo;ve added your first hypervisor to NVP! In the next part, I&rsquo;m going to take a moment to remind readers of a few concepts that I&rsquo;ve covered in the past, and show how those concepts relate to NVP. From there, we&rsquo;ll pick back up with adding our first logical network and establishing connectivity between VMs on different hypervisors.</p>
<p>Until that time, feel free to post any questions, thoughts, corrections, or clarifications in the comments below. Please disclose vendor affiliations, where appropriate, and&mdash;as always&mdash;I welcome all courteous comments.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kvm">KVM</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nicira">Nicira</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nvp">NVP</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ubuntu">Ubuntu</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/08/21/accessing-vnc-consoles-of-kvm-guests-via-ssh/">Accessing VNC Consoles of KVM Guests via SSH</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/08/26/vmworld-2013-day-1-keynote/">VMworld 2013 Day 1 Keynote</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f08%2f22%2flearning-nvp-part-4-adding-hypervisors-to-nvp%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f08%2f22%2flearning-nvp-part-4-adding-hypervisors-to-nvp%2f&text=Learning%20NVP%2c%20Part%204%3a%20Adding%20Hypervisors%20to%20NVP" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f08%2f22%2flearning-nvp-part-4-adding-hypervisors-to-nvp%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2013/05/30/a-use-case-for-policy-routing-with-kvm-and-open-vswitch/">A Use Case for Policy Routing with KVM and Open vSwitch</a> <span class="post-date-list">309 May 303030</span></li><li><a href="/2012/10/29/technology-short-take-26/">Technology Short Take #26</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2012/08/17/installing-kvm-and-open-vswitch-on-ubuntu/">Installing KVM and Open vSwitch on Ubuntu</a> <span class="post-date-list">179 May 171717</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
