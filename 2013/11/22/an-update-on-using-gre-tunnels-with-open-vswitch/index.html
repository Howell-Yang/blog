<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>An Update on Using GRE Tunnels with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="An Update on Using GRE Tunnels with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="An Update on Using GRE Tunnels with Open vSwitch - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2013/11/22/an-update-on-using-gre-tunnels-with-open-vswitch/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">An Update on Using GRE Tunnels with Open vSwitch</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 229 May 222222 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;556 words (estimated 3 minutes to read)</span>
  <p>In this post, I&rsquo;m going to provide an update on using GRE tunnels with Open vSwitch (OVS) to include more than 2 hosts. I previously showed you <a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">how to use GRE tunnels with OVS</a> to connect VMs on different hypervisor hosts, but in my testing I didn&rsquo;t use this technique with more than two hypervisors. A few readers posted comments to that article asking how to extend the solution to more than 2 hypervisors, but I hadn&rsquo;t had the time to test anything more.</p>
<p>Now, as a result of some related work I&rsquo;ve been doing, I have an update on using this technique for more than two hosts. If you didn&rsquo;t read the post on <a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">using GRE tunnels with OVS</a>, go back and read that now. Also, be sure to read my post on <a href="/2013/05/15/examining-open-vswitch-traffic-patterns/">examining OVS traffic patterns</a>, as this is also useful information. Finally, note that this information applies to any use of GRE tunnels with OVS, not just GRE tunnels with OVS on hypervisors.</p>
<p>Let&rsquo;s say you have three hosts:</p>
<ol>
<li>
<p>HostA, with an IP address of 10.1.1.1</p>
</li>
<li>
<p>HostB, with an IP address of 10.1.1.2</p>
</li>
<li>
<p>HostC, with an IP address of 10.1.1.3</p>
</li>
</ol>
<p>To connect entities (VMs, containers, etc.) on these hosts using GRE tunnels, you&rsquo;d need to manually configure OVS on each of hosts:</p>
<ul>
<li>
<p>On HostA, you&rsquo;d need a GRE tunnel to HostB (10.1.1.2) and a GRE tunnel to HostC (10.1.1.3)</p>
</li>
<li>
<p>On HostB, you&rsquo;d need a GRE tunnel to HostA (10.1.1.1) and one to HostC (10.1.1.3)</p>
</li>
<li>
<p>On HostC, you&rsquo;d need two GRE tunnels, one to HostA (10.1.1.1) and one to HostB (10.1.1.2)</p>
</li>
</ul>
<p>I won&rsquo;t repeat the specific commands to create those tunnels here, as it is well explained in my earlier article. What this creates is a virtual topology like this:</p>
<p><img src="/public/img/gre-full-mesh.png" alt="GRE tunnel full mesh"></p>
<p>What you&rsquo;ll find when you try this yourself is that everything works fine when there are just two hosts; this is what I also found when I first wrote the article. When you add the third host, though, you&rsquo;ll find&mdash;assuming you created a full mesh of GRE tunnels&mdash;is that everything stops working.</p>
<p>Here&rsquo;s how to fix that. Run this command on each of the hosts running OVS:</p>
<pre><code>ovs-vsctl set bridge &lt;bridge name&gt; stp_enable=true
</code></pre>
<p>Yes, that&rsquo;s right: looping is the culprit here. Look back at the topology figure above. In the physical world, a topology like that using switches (without STP) would take down your network because of a bridging loop. The same applies here as well. In both cases (physical or virtual) you have two choices: you can either not create a full mesh topology (you could use a star topology or something if you wanted) or you run STP. It&rsquo;s up to you.</p>
<p>Assuming you turn on STP, then you&rsquo;ll find after a few minutes that you&rsquo;ll be able to happily ping between VMs on these hypervisors.</p>
<p>I do want to share one final note before I wrap up. STP is needed in this instance because we are relying on OVS in MAC learning mode (just like a physical switch). If we were to add an OpenFlow controller to this mix and push flow rules down to OVS, OVS would stop using MAC learning, and we would no longer need STP in order to build full-mesh topologies of tunnels.</p>
<p>Feel free to post any questions or comments below. All courteous comments are welcome!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/gre">GRE</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2013/11/11/making-json-output-more-readable-with-bbedit/">Making JSON Output More Readable with BBEdit</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2013/11/25/a-brief-introduction-to-linux-containers-with-lxc/">A Brief Introduction to Linux Containers with LXC</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2013%2f11%2f22%2fan-update-on-using-gre-tunnels-with-open-vswitch%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f11%2f22%2fan-update-on-using-gre-tunnels-with-open-vswitch%2f&text=An%20Update%20on%20Using%20GRE%20Tunnels%20with%20Open%20vSwitch" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2013%2f11%2f22%2fan-update-on-using-gre-tunnels-with-open-vswitch%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2013/05/07/using-gre-tunnels-with-open-vswitch/">Using GRE Tunnels with Open vSwitch</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2013/09/09/namespaces-vlans-open-vswitch-and-gre-tunnels/">Namespaces, VLANs, Open vSwitch, and GRE Tunnels</a> <span class="post-date-list">99 May 9099</span></li><li><a href="/2013/08/30/thinking-out-loud-diy-network-virtualization/">Thinking Out Loud: DIY Network Virtualization?</a> <span class="post-date-list">309 May 303030</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
