<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>More on vSwitch Load Balancing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="More on vSwitch Load Balancing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="More on vSwitch Load Balancing - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2009/09/24/more-on-vswitch-load-balancing/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">More on vSwitch Load Balancing</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 249 May 242424 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;654 words (estimated 4 minutes to read)</span>
  <p>I had a customer contact me about scaling network throughput when using NFS datastores. Specifically, this customer was interested in knowing if it was possible to utilize more than 1 NIC with IP-based storage. The customer is currently using link aggregation (EtherChannel on a Cisco switch). I pointed the customer to <a href="/2008/07/16/understanding-nic-utilization-in-vmware-esx/">my post on NIC utilization</a>, in which I explain the prerequisites for utilizing more than 1 NIC in this sort of configuration. To refresh your memory, those prerequisites are:</p>
<ul>
<li>
<p>The vSwitch must be configured for &ldquo;Route based on IP hash&rdquo;</p>
</li>
<li>
<p>The physical NICs connected to the vSwitch as uplinks must all be configured as active in the failover order</p>
</li>
<li>
<p>The physical switch must be configured for link aggregation</p>
</li>
<li>
<p>There must be multiple, unique source-destination IP address pairs involved</p>
</li>
</ul>
<p>The customer responded with a question (which I&rsquo;m paraphrasing here): &ldquo;That&rsquo;s all? It will just automatically use more than one link?&rdquo;</p>
<p>Well&hellip;<em>sort of.</em></p>
<p>There is one little caveat. Cisco IOS uses a hashing algorithm to determine which link a particular traffic flow between a source and destination will use. This algorithm is controlled by the <code>port-channel load-balance</code> command. Assuming that you&rsquo;re using source-destination IP hashing, that means the Cisco switch will use a hash of the source IP address and the destination IP address to determine which link it will use. <a href="http://www.cisco.com/en/US/tech/tk389/tk213/technologies_tech_note09186a0080094714.shtml#catalyst">This page</a> has more detailed information.</p>
<p>It&rsquo;s theoretically possible, based on the number of links in the port channel, that some traffic flows between different pairs of source-destination IP addresses might end up on the same link. That means it&rsquo;s not necessarily just as simple as setting up multiple NFS exports or iSCSI targets on different IP addresses&mdash;you also need to know if the IP addresses you are using will <em>actually result in the traffic being distributed across the links</em>.</p>
<p>How does one tell? Good question, and one I&rsquo;m glad you asked. You can tell using this command (this command assumes you are using IP-based hashing):</p>
<pre><code>switch# test etherchannel load-balance interface &lt;Port channel interface&gt; ip &lt;Src IP Addr&gt; &lt;Dst IP Addr&gt;
</code></pre>
<p>So, let&rsquo;s say that you have an ESX/ESXi host with a VMkernel interface whose address is 172.16.5.10. Let&rsquo;s say that you have a storage array (NetApp FAS, EMC Celerra, etc.) that supports NFS and you want to mount two different NFS exports on two different IP addresses so that traffic from this ESX/ESXi host to the storage array. You could use the <code>test etherchannel load-balance</code> command to help you determine which address could help ensure traffic distribution across the links:</p>
<pre><code>switch# test etherchannel load-balance interface Po3 ip 172.16.5.10 172.16.5.100
</code></pre>
<p>For more examples of what the output would look like, take a look at <a href="/public/img/test-ethchannel-output.png">this image</a>. This was taken off a Cisco Catalyst 3560G running my test lab (and yes, the IP addresses have been changed to protect the innocent).</p>
<p>This would give you one way of testing whether your link aggregation configuration would actually use multiple links, or only a single link due to the IP hash calculation. Also, don&rsquo;t forget that <code>esxtop</code> can also show you NIC utilization; <a href="/public/img/esxtop-net-output-ethchannel.png">here&rsquo;s an example</a> of both uplinks being used in this sort of configuration.</p>
<p>Unfortunately, what I <em>can&rsquo;t</em> tell you right now is what algorithm the vSwitch itself uses to place traffic onto the uplinks. Does it follow the same sort of mechanism as the Cisco switch? I don&rsquo;t know. If anyone has any information on that, it would be tremendously helpful.</p>
<p>If anyone has any other pertinent information or resources on this topic, please add them to the comments below.</p>
<p><strong>UPDATE:</strong> Duncan Epping pointed out <a href="http://kensvirtualreality.wordpress.com/2009/04/05/the-great-vswitch-debatepart-3/">an article by Ken Cline from earlier this year</a> provides the mechanism VMware uses to determine which uplink on a vSwitch will be used. This algorithm performs an XOR operation on the Least Significant Byte (LSB) of the source and destination IP addresses, then finds the modulus of that result and the number of uplinks. Thanks, Duncan and Ken!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cisco">Cisco</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ios">IOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2009/09/22/vmfs-isnt-the-problem-here/">VMFS Isn&#39;t the Problem Here</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2009/09/24/im-a-bad-student/">I&#39;m a Bad Student</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2009%2f09%2f24%2fmore-on-vswitch-load-balancing%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2009%2f09%2f24%2fmore-on-vswitch-load-balancing%2f&text=More%20on%20vSwitch%20Load%20Balancing" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2009%2f09%2f24%2fmore-on-vswitch-load-balancing%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2009/05/18/summary-of-cdp-articles/">Summary of CDP Articles</a> <span class="post-date-list">189 May 181818</span></li><li><a href="/2009/03/24/viewing-cdp-data-on-vmware-esx/">Viewing CDP Data on VMware ESX</a> <span class="post-date-list">249 May 242424</span></li><li><a href="/2008/10/08/more-on-vmware-esx-nic-utilization/">More on VMware ESX NIC Utilization</a> <span class="post-date-list">89 May 8088</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
