<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Snapshot Issue with VMware Data Recovery - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Snapshot Issue with VMware Data Recovery - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Snapshot Issue with VMware Data Recovery - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2009/06/29/snapshot-issue-with-vmware-data-recovery/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Snapshot Issue with VMware Data Recovery</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 299 May 292929 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/information">Information</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;455 words (estimated 3 minutes to read)</span>
  <p>Reader Kyle Ross shared with me a potential issue with VMware&rsquo;s new backup product, VMware Data Recovery. Others within the VMware blogging scene have also covered this, but I wanted to mention it as well so that others didn&rsquo;t run into the problem. Here&rsquo;s Kyle&rsquo;s write-up:</p>
<blockquote>
<p>I was made aware of a serious (in my opinion) bug with VDR during a call with VMware support that I haven&rsquo;t seen discussed anywhere. This is an internally known issue that causes snapshots to build up on VM&rsquo;s that are members of VDR backup jobs.</p>
<p>During the backup process a new snapshot is created and VDR updates the snapshot descriptor file (<code>vm_name-000001.vmdk</code>) to mark the snapshot as un-removable. The bug is introduced when the backup process completes, it fails to mark the snapshot as removable causing them to remain.</p>
<p>The tricky part of the problem is that the snapshots are not visible through the vSphere Client, nor are they listed in apps like &lsquo;RVTools&rsquo; that use the VMware CLI to gather data. They could potentially be listed in the new datastore views but I didn&rsquo;t think to look there before I resolved it in my environment. I ran across them by logging into the service console and running the following command to list all the delta files on the datastores attached to the server.</p>
<p><code>find /vmfs/volumes/ -name \*delta\*</code></p>
<p>In my environment I noticed numerous VMs with multi-gigabyte delta files that I couldn&rsquo;t account for via snapshots listed in the GUI. Here is the solution I was given by VMware. Via the Service Console, browse to the location of the VMDK files for the affected VM. Run this command to identify the descriptors that need to be corrected, replacing &lsquo;virtual_machine_name&rsquo; with the actual name of the VM.</p>
<p><code>grep I ddb.dele *virtual_machine_name*-000???.vmdk</code></p>
<p>This command will quickly identify the delta files that are marked as non-deletable. The workaround is to edit the affected VMDK descriptor files and change &ldquo;ddb.deletable&rdquo; from &ldquo;false&rdquo; to &ldquo;true&rdquo;. You will probably also need to edit the root VMDK file and change this field as well, otherwise you may be left with one open snapshot. Note that due to a change in how ESX 4 performs file locking, you will probably need to SSH into the host that is currently running the VM to edit these files. Once you have edited all the files, create a new snapshot for the VM either via the GUI or command line. Then issue the &ldquo;Delete All&rdquo; snapshots command to force ESX to combine all the files and close all the visible and hidden snapshots.</p>
</blockquote>
<p>As soon as more information is available, I&rsquo;ll post it here. If any other readers have more information to share, please speak up in the comments.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/backup">Backup</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/snapshot">Snapshot</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2009/06/26/i-love-having-my-content-stolen/">I Love Having My Content Stolen</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2009/06/29/blades-wont-die-but-they-will-change/">Blades Won&#39;t Die, But They Will Change</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2009%2f06%2f29%2fsnapshot-issue-with-vmware-data-recovery%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2009%2f06%2f29%2fsnapshot-issue-with-vmware-data-recovery%2f&text=Snapshot%20Issue%20with%20VMware%20Data%20Recovery" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2009%2f06%2f29%2fsnapshot-issue-with-vmware-data-recovery%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2007/10/08/vm-file-level-recovery-with-netapp-snapshots/">VM File-Level Recovery with NetApp Snapshots</a> <span class="post-date-list">89 May 8088</span></li><li><a href="/2007/09/13/vmworld-2007-vcb-solutions-session/">VMworld 2007 VCB Solutions Session</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2007/08/07/strange-vcb-error/">Strange VCB Error</a> <span class="post-date-list">79 May 7077</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
