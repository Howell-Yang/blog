<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using Terraform to Build an etcd2 Cluster on OpenStack - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using Terraform to Build an etcd2 Cluster on OpenStack - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using Terraform to Build an etcd2 Cluster on OpenStack - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2016/05/06/using-terraform-etcd2-openstack/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using Terraform to Build an etcd2 Cluster on OpenStack</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 69 May 6066 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;935 words (estimated 5 minutes to read)</span>
  <p>In this post I&rsquo;ll build on <a href="/2015/11/25/intro-to-terraform/">my earlier introduction to Terraform</a> to show a practical example of using <a href="https://www.terraform.io/">Terraform</a> to build a <a href="https://coreos.com/">CoreOS</a>-based etcd2 cluster on <a href="http://www.openstack.org/">OpenStack</a>. This information is based upon a demo that I created for a session at the Austin OpenStack Summit in late April, so all the files I reference in this post are available in <a href="https://github.com/scottslowe/dev-tools-openstack/">the GitHub repo for that session</a>.</p>
<p>You may recall that Terraform is a platform-independent orchestration tool that allows you to create <em>configurations</em> (in either Terraform format or JSON format) specifying resources to be created/modified/deleted. This allows users to take an &ldquo;infrastructure as code&rdquo; approach where infrastructure configuration can be declaratively defined and managed via well-known version control mechanisms. In my previous post, I used JSON for the Terraform configurations; in this post, I&rsquo;ll use the &ldquo;standard&rdquo; Terraform format.</p>
<p>As in the <a href="/2015/11/25/intro-to-terraform/">intro to Terraform post</a>, I&rsquo;ll use three different files:</p>
<ul>
<li>The <code>vars.tf</code> file, which contains variables we&rsquo;ll reference later</li>
<li>The <code>main.tf</code> file, which has the actual resource definitions</li>
<li>The <code>output.tf</code> file, which will provide some feedback to the user on the resources being created by Terraform (in this case, IP addresses)</li>
</ul>
<p>Note that there&rsquo;s no provider configuration here; instead, it relies on the use of the appropriate OpenStack environment variables (<code>OS_PASSWORD</code>, <code>OS_AUTH_URL</code>, etc.) for connecting to OpenStack.</p>
<p>First up is the <code>vars.tf</code> file. I won&rsquo;t post the full file here (go see <a href="https://github.com/scottslowe/dev-tools-openstack/">the GitHub repo</a> for the full file), but here&rsquo;s a snippet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># Image ID for CoreOS Stable 899.13.0 image
</span></span><span style="display:flex;"><span>variable &#34;image&#34; {
</span></span><span style="display:flex;"><span>    default = &#34;6ebd5b1e-f5d5-4bf7-9ca8-713a2696307f&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this particular snippet, I&rsquo;m defining a variable that specifies the image ID for the CoreOS Stable 899.13.0 image in my OpenStack cloud. Also found in the <code>vars.tf</code> file but not shown here are definitions for the flavor the instances should use, the external gateway to which a newly-created router should be connected, the floating IP pool from which floating IP addresses should be allocated, and the SSH key pair that should be injected into new instances.</p>
<p>All these values are referenced by <code>main.tf</code>, which is the core part of the Terraform configuration. In <code>main.tf</code>, the following parts of OpenStack infrastructure are defined:</p>
<ul>
<li>A new tenant network, along with a corresponding subnet</li>
<li>A new tenant logical router, connected to the new tenant network and an external provider network</li>
<li>Floating IP addresses for each of the five instances to be launched</li>
<li>Five instances based on the CoreOS image, as defined in <code>vars.tf</code></li>
</ul>
<p>The contents of <code>main.tf</code> are pretty self-explanatory. For example, here&rsquo;s a snippet that attaches a tenant logical router to the newly-created subnet and an external provider network:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># Attach Swarm router to new Swarm network created earlier
</span></span><span style="display:flex;"><span>resource &#34;openstack_networking_router_interface_v2&#34; &#34;swarm-rtr-if&#34; {
</span></span><span style="display:flex;"><span>    router_id = &#34;${openstack_networking_router_v2.swarm-rtr.id}&#34;
</span></span><span style="display:flex;"><span>    subnet_id = &#34;${openstack_networking_subnet_v2.swarm-subnet.id}&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Not shown here but also included in <code>main.tf</code> and referenced here are the tenant logical router itself (as referenced by <code>openstack_networking_router_v2.swarm-rtr.id</code>) and the subnet associated with the new tenant network (referenced by <code>openstack_networking_subnet_v2.swarm-subnet.id</code>).</p>
<p>The code for defining the instances is fairly straightforward as well, with one new addition that you may not have seen before:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>resource &#34;openstack_compute_instance_v2&#34; &#34;node-01&#34; {
</span></span><span style="display:flex;"><span>    name = &#34;node-01&#34;
</span></span><span style="display:flex;"><span>    image_id = &#34;${var.image}&#34;
</span></span><span style="display:flex;"><span>    flavor_name = &#34;${var.flavor}&#34;
</span></span><span style="display:flex;"><span>    key_pair = &#34;${var.key_pair}&#34;
</span></span><span style="display:flex;"><span>    security_groups = [&#34;default&#34;,&#34;docker&#34;,&#34;basic-services&#34;,&#34;etcd2&#34;]
</span></span><span style="display:flex;"><span>    floating_ip = &#34;${openstack_compute_floatingip_v2.node-01-fip.address}&#34;
</span></span><span style="display:flex;"><span>    network {
</span></span><span style="display:flex;"><span>        uuid = &#34;${openstack_networking_network_v2.swarm-net.id}&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    user_data = &#34;${file(\&#34;cloud-config.yml\&#34;)}&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The new part that you may not have seen before is the <code>user_data</code> line, which allows you to provide a cloud-init configuration script to the instance being created. CoreOS has a rather robust implementation of cloud-init (it&rsquo;s one of the things I really like about CoreOS);the file listed there (<code>cloud-config.yml</code>) looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#cloud-config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">coreos</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">discovery</span>: <span style="color:#e6db74">&#34;https://discovery.etcd.io/2bc6f751df536e597a532221fe0c5bff&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">advertise-client-urls</span>: <span style="color:#e6db74">&#34;http://$public_ipv4:2379&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">initial-advertise-peer-urls</span>: <span style="color:#e6db74">&#34;http://$private_ipv4:2380&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen-client-urls</span>: <span style="color:#e6db74">&#34;http://0.0.0.0:2379,http://0.0.0.0:4001&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen-peer-urls</span>: <span style="color:#e6db74">&#34;http://$private_ipv4:2380,http://$private_ipv4:7001&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">update</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">reboot-strategy</span>: <span style="color:#e6db74">&#34;etcd-lock&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;stable&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">units</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;etcd2.service&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#e6db74">&#34;start&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;docker-tcp.socket&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#e6db74">&#34;start&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enable</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Description=TCP socket for the Docker API
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Socket]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ListenStream=2375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Service=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        BindIPv6Only=both
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        WantedBy=sockets.target</span>        
</span></span></code></pre></div><p>This cloud-init script does a couple of things:</p>
<ul>
<li>It establishes an etcd 2.x cluster. The value of the <code>discovery</code> key needs to change for every new cluster you create, so if you wanted to use this configuration for your own purposes be sure to generate your own, valid discovery URL.</li>
<li>It reconfigures the Docker daemon to also listen on a TCP socket (TCP port 2375). This is not the default on CoreOS.</li>
</ul>
<p>The last part is the <code>output.tf</code> file, which contains only enough information to have Terraform spit out the floating IP address for each instance launched, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>output &#34;addr-node-01&#34; {
</span></span><span style="display:flex;"><span>    value = &#34;${openstack_compute_floatingip_v2.node-01-fip.address}&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Putting it all together, what this Terraform configuration does is this:</p>
<ol>
<li>It creates an tenant network, including the necessary subnet for the tenant network.</li>
<li>It creates a tenant logical router.</li>
<li>It connects the tenant logical router to the newly-created tenant network and to an external provider network. This enables outbound network connectivity for any instances attached to the new tenant network.</li>
<li>It allocates 5 floating IP addresses from the supplied floating IP pool.</li>
<li>It spins up 5 instances of CoreOS Linux, attaching them to the new tenant network and associating a floating IP address with each instance.</li>
<li>It supplies the cloud-init data to the instances, which then reconfigure themselves to run etcd2 and enable network connectivity to the Docker daemon.</li>
<li>Finally, it spits out the floating IP address associated with each instance.</li>
</ol>
<p>Handy!</p>
<p>If you&rsquo;d like to give this a try in your own OpenStack environment, feel free to clone <a href="https://github.com/scottslowe/dev-tools-openstack/">the GitHub repo</a>, which also contains some <a href="http://www.vagrantup.com/">Vagrant</a>, <a href="http://www.ansible.com/">Ansible</a>, and <a href="https://www.docker.com/products/docker-machine">Docker Machine</a>-related content along with the Terraform configurations I&rsquo;ve described in this post. You can then modify them as needed with your own information. Have fun!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/openstack">OpenStack</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/coreos">CoreOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/terraform">Terraform</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/automation">Automation</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/oss">OSS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2016/05/04/building-vmw-cumulus-vx-box/">Building a VMware-Formatted Cumulus VX Vagrant Box</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2016/05/13/technology-short-take-66/">Technology Short Take #66</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2016%2f05%2f06%2fusing-terraform-etcd2-openstack%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2016%2f05%2f06%2fusing-terraform-etcd2-openstack%2f&text=Using%20Terraform%20to%20Build%20an%20etcd2%20Cluster%20on%20OpenStack" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2016%2f05%2f06%2fusing-terraform-etcd2-openstack%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2016/02/12/technology-short-take-61/">Technology Short Take #61</a> <span class="post-date-list">129 May 121212</span></li><li><a href="/2016/01/29/technology-short-take-60/">Technology Short Take #60</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2015/12/16/modifying-sec-groups-terraform/">Modifying OpenStack Security Groups with Terraform</a> <span class="post-date-list">169 May 161616</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
