<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>An Improved Way to use YAML with Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="An Improved Way to use YAML with Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="An Improved Way to use YAML with Vagrant - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2016/01/14/improved-way-yaml-vagrant/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">An Improved Way to use YAML with Vagrant</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 149 May 141414 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;555 words (estimated 3 minutes to read)</span>
  <p>In this post, I&rsquo;d like to share with you an improved way to use YAML with <a href="http://www.vagrantup.com/">Vagrant</a>. I first discussed the use of YAML with Vagrant in <a href="/2014/10/22/multi-machine-vagrant-with-yaml/">a post on simplifying multi-machine Vagrant environments</a>, where I simply factored out variable data into an external YAML file. The original approach I described had (at least) one significant drawback, though, which this new approach adddresses.</p>
<p>(By the way, this &ldquo;improved&rdquo; way is probably just a matter of better coding. I&rsquo;m not an expert with Ruby, so Ruby experts may look at this and find it to be quite obvious.)</p>
<p>Here&rsquo;s the <em>original</em> snippet of a <code>Vagrantfile</code> that I shared in that first Vagrant/YAML post:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Specify minimum Vagrant version and Vagrant API version</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>require_version <span style="color:#e6db74">&#34;&gt;= 1.6.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Require YAML module</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;yaml&#39;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read YAML file with box details</span>
</span></span><span style="display:flex;"><span>servers <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#e6db74">&#39;servers.yaml&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create boxes</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Iterate through entries in YAML file</span>
</span></span><span style="display:flex;"><span>  servers<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>servers<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>srv<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;box&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network <span style="color:#e6db74">&#34;private_network&#34;</span>, <span style="color:#e6db74">ip</span>: servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;ip&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">:virtualbox</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vb<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;ram&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>The &ldquo;magic,&rdquo; so to speak, comes from the <code>servers = YAML.load_file('servers.yml')</code> line, where Vagrant loads the information from the external YAML file named &ldquo;servers.yml&rdquo; into an array. The <code>servers.each</code> loop later iterates through the entries in the array, creating and configuring a VM for each record in the YAML file.</p>
<p>This works fabulously well, with one exception: <em>you can&rsquo;t use <code>vagrant</code> commands outside of the directory where the <code>Vagrantfile</code> and the YAML file are stored.</em></p>
<p>What do I mean by this? You may be aware that once a Vagrant environment has been created (you&rsquo;ve run <code>vagrant up</code> on the environment and haven&rsquo;t yet run <code>vagrant destroy</code>), then you can run this command <em>from any directory</em> to get a list of created Vagrant environments:</p>
<pre><code>vagrant global-status
</code></pre>
<p>The output of that command will look something like this (along with some other text after the listing):</p>
<pre><code>id       name    provider      state       directory
----------------------------------------------------------------------
8fa3dfc  trusty  vmware_fusion not running /home/slowe/vagrant/trusty
</code></pre>
<p>Using the value in the <code>id</code> column (<code>8fa3dfc</code>, in this example), you could run various Vagrant commands, like <code>vagrant up 8fa3dfc</code> or <code>vagrant halt 8fa3dfc</code>, even when you aren&rsquo;t in the directory where the Vagrant environment was defined. This is a pretty handy feature, but it <em>doesn&rsquo;t work</em> if you use the Vagrant + YAML approach listed above. It errors out, indicating that it can&rsquo;t find the referenced YAML file (<code>servers.yml</code>, for example).</p>
<p>The fix for this is to modify the line where Vagrant loads the data from the YAML file. This is the original line, which produces the inability to use global Vagrant commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>servers <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#e6db74">&#39;servers.yaml&#39;</span>)
</span></span></code></pre></div><p>The fixed/corrected/improved version looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>servers <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>join(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>dirname(__FILE__), <span style="color:#e6db74">&#39;servers.yml&#39;</span>))
</span></span></code></pre></div><p>The difference here is that the second command creates the full path to the referenced YAML file (by determining the directory name of the <code>Vagrantfile</code>, referred to by the special <code>__FILE__</code> variable, and then appending the name of the YAML file itself).</p>
<p>With this approach, you&rsquo;re now able to use global Vagrant commands from any directory without an error. I&rsquo;ve recently modified all the Vagrant environments in <a href="https://github.com/scottslowe/learning-tools">my GitHub &ldquo;learning-tools&rdquo; repository</a> to use this new approach, so that should make those environments a bit easier to use.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/yaml">YAML</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2016/01/11/upcoming-vmug-events/">Upcoming VMUG Events</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2016/01/15/technology-short-take-59/">Technology Short Take #59</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2016%2f01%2f14%2fimproved-way-yaml-vagrant%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2016%2f01%2f14%2fimproved-way-yaml-vagrant%2f&text=An%20Improved%20Way%20to%20use%20YAML%20with%20Vagrant" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2016%2f01%2f14%2fimproved-way-yaml-vagrant%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2015/08/04/using-vagrant-docker-machine-together/">Using Vagrant and Docker Machine Together</a> <span class="post-date-list">49 May 4044</span></li><li><a href="/2015/04/21/running-photon-fusion-vagrant/">Running Photon on Fusion via Vagrant</a> <span class="post-date-list">219 May 212121</span></li><li><a href="/2015/04/19/running-etcd-backed-docker-swarm-cluster/">Running an etcd-Backed Docker Swarm Cluster</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
