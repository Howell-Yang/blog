<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>VXLAN and Layer 3 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="VXLAN and Layer 3 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="VXLAN and Layer 3 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2011/11/30/vxlan-and-layer-3-connectivity/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">VXLAN and Layer 3 Connectivity</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 309 May 303030 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;978 words (estimated 5 minutes to read)</span>
  <p><strong>Note:</strong> I&rsquo;ve posted a follow-up to this article with some corrected information. Please <a href="/2011/12/07/revisiting-vxlan-and-layer-3-connectivity/">read here</a>.</p>
<p>I&rsquo;ve been doing quite a bit of networking-related reading over the last few weeks, and VXLAN has been a key topic of this networking-related reading (along with OTV, MPLS, and OpenFlow). Since VXLAN&rsquo;s announcement at VMworld US 2011, there have been some pretty good articles written and published about VXLAN. Here are a few, for example:</p>
<p><a href="http://blogs.cisco.com/datacenter/digging-deeper-into-vxlan/">Digging Deeper into VXLAN, Part 1</a></p>
<p><a href="http://blogs.cisco.com/datacenter/vxlan-deep-dive-part-2-looking-at-the-options/">VXLAN Deep Dive, Part 2: Looking at the Options</a></p>
<p><a href="http://blogs.cisco.com/datacenter/digging-deeper-in-vxlan-pt-3-more-faqs/">Digging Deeper in VXLAN, Pt 3, More FAQs</a></p>
<p><a href="http://codingrelic.geekhold.com/2011/09/care-and-feeding-of-vxlan.html">The Care and Feeding of VXLAN</a></p>
<p><a href="http://codingrelic.geekhold.com/2011/09/vxlan-part-deux.html">VXLAN Part Deux</a></p>
<p><a href="http://codingrelic.geekhold.com/2011/09/vxlan-conclusion.html">VXLAN Conclusion</a></p>
<p><a href="https://plus.google.com/102097377740741991073/posts/2tnVCHkeVyZ?hl=en">Google+ discussions on VXLAN</a></p>
<p><a href="http://www.borgcube.com/blogs/2011/11/vxlan-primer-part-1/">VXLAN Primer - Part 1, BORGcube Blogs</a></p>
<p>However, the one thing that I haven&rsquo;t seen a great discussion about is the impact of VXLAN on Layer 3 connectivity. I personally have fielded a number of questions about whether VXLAN will fix Layer 3 network connectivity problems with stretched clusters. So, I thought I&rsquo;d take a stab here. Networking gurus (you know who you are), feel free to straighten me out if I&rsquo;m wrong.</p>
<p>First, let&rsquo;s start with a few basic things that we know about VXLAN:</p>
<ul>
<li>
<p>We know that VXLAN encapsulates Layer 2 frames into Layer 3 packets (using UDP).</p>
</li>
<li>
<p>We know that VXLAN adds a 24-bit VXLAN Network Identifier (VNI) that allows for up to 16 million unique combinations.</p>
</li>
<li>
<p>We know that VXLAN Segments are built between VXLAN Tunnel End Points (VTEPs). In the initial implementation of VXLAN, the VTEP will be the Nexus 1000V VEM on an ESXi host.</p>
</li>
<li>
<p>We know that (for now) VXLAN is not understood by any physical networking devices (the transport that carries the encapsulated frames only needs to an IP-based network). (VXLAN encapsulation is a subset of OTV encapsulation, so in theory the Nexus 7000 hardware is capable of decoding VXLAN.)</p>
</li>
</ul>
<p>With that information in mind, I&rsquo;d like to use the following diagram to frame the discussion.</p>
<p><img src="/public/img/vxlan-l3-diagram-small.png" alt=""></p>
<p>In the diagram, there are two ESXi hosts acting as VTEPs. Between them exist two VXLAN segments with two different VNIs (VNI 738 and VNI 864). Because VXLAN works by encapsulating Layer 2 frames into Layer 3 packets and then routing these packets between VTEPs, VXLAN accomplishes one of its primary goals: it extends Layer 2 connectivity across Layer 3 networks.</p>
<p>But what does that mean, exactly?</p>
<p>Let&rsquo;s look a bit more closely. The brown shape loosely represents Layer 2 connectivity within VNI 738 (a given VXLAN segment) and its associated VLAN(s). The Windows-based VM on the ESXi host on the left can communicate via Layer 2 with the Linux-based VM on the ESXi host on the right, even though those ESXi hosts reside in completely different broadcast domains separated by a Layer 3 routed network. The key phrase here, in my mind, is that <strong>VXLAN extends Layer 2 connectivity <em>within</em> a given VXLAN segment</strong>.</p>
<p>This is <em>not</em>, however, the sort of &ldquo;extending Layer 2 connectivity across Layer 3 networks&rdquo; that people are expecting.</p>
<p>What people are expecting from this phrase is that you could migrate a VM from the ESXi host on the left to the ESXi host on the right (as indicated in the diagram by the large arrow pointing from left to right) and still have full IP connectivity.</p>
<p>In this case, the VM itself will be able to maintain the same IP address, and other VMs <em>in the same VXLAN segment</em> will continue to communicate with the migrated VM without any issues. But hold on a second</p>
<p>We know that VXLAN allows for duplicate IP addressing schemes across different VXLAN segments (but not in the same VXLAN segment), duplicate MAC addresses across different VXLAN segments (but not in the same VXLAN segment), and duplicate VLAN IDs across different VXLAN segments (but not in the same VXLAN segment). You could, for example, use the same IP addressing scheme, same MAC addresses, and same VLAN IDs in the brown (VNI 738) and blue (VNI 864) VXLAN segments. VXLAN wouldn&rsquo;t care, and the VMs inside those VXLAN segments would be unaware of this duplicity.</p>
<p>However, what VXLAN <em>doesn&rsquo;t</em> address is IP translation; that functionality is relegated to a network address translator. In this case, it&rsquo;s vShield Edge (VSE). So, in the instance where a VM is migrated between different Layer 3 networks, note that the only way to maintain IP connectivity from <strong>outside</strong> the VXLAN segment is to update the address translation tables and&mdash;here&rsquo;s the kicker&mdash;assign the VM a new (and different) externally-accessible IP address. That breaks IP connectivity&mdash;even with dynamic DNS updates, clients will still have cached DNS responses pointing them back to the (now inactive) old external IP address. Thus, <strong>VXLAN breaks Layer 2/3 connectivity to other systems outside the VXLAN segment.</strong></p>
<p>This issue, by the way, would be why various networking gurus have repeatedly stated that VXLAN does not replace OTV. To fix the issue described above, you&rsquo;d have to use OTV to stretch the external-to-VXLAN VLANs so that the NAT mappings could remain unchanged and the externally accessible IP address would remain the same.</p>
<p>Before you assume that I knocking VXLAN, let me reaffirm that I&rsquo;m not. I only felt that there hadn&rsquo;t been a good, solid, understandable explanation of what sorts of connectivity were and were not extended/affected by VXLAN. Hopefully, this message has helped bring some clarity to the topic.</p>
<p>If I have misrepresented anything, presented something incorrectly, or if you have questions/clarifications, please let me know in the comments. Thanks!</p>
<p><strong>UPDATE:</strong> As a couple of readers pointed out in the comments (thanks!), the Layer 3 connectivity isn&rsquo;t quite as dire as what I&rsquo;ve described. Instead of the VM&rsquo;s address having to change due to a change in NAT mappings on a VSE, instead the VM&rsquo;s traffic will &ldquo;trombone&rdquo; back to the original VSE that acts as the VXLAN segment&rsquo;s default gateway. Again, thanks for the clarification/correction all!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/otv">OTV</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vxlan">VXLAN</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2011/11/29/setting-up-software-fcoe-on-vsphere-5/">Setting up Software FCoE on vSphere 5</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2011/12/01/some-initial-mpls-reading/">Some Initial MPLS Reading</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2011%2f11%2f30%2fvxlan-and-layer-3-connectivity%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2011%2f11%2f30%2fvxlan-and-layer-3-connectivity%2f&text=VXLAN%20and%20Layer%203%20Connectivity" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2011%2f11%2f30%2fvxlan-and-layer-3-connectivity%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2011/10/03/technology-short-take-15/">Technology Short Take #15</a> <span class="post-date-list">39 May 3033</span></li><li><a href="/2011/11/28/technology-short-take-17/">Technology Short Take #17</a> <span class="post-date-list">289 May 282828</span></li><li><a href="/2011/11/07/technology-short-take-16/">Technology Short Take #16</a> <span class="post-date-list">79 May 7077</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
