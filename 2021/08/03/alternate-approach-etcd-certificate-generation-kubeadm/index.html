<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>An Alternate Approach to etcd Certificate Generation with Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="An Alternate Approach to etcd Certificate Generation with Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="An Alternate Approach to etcd Certificate Generation with Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2021/08/03/alternate-approach-etcd-certificate-generation-kubeadm/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">An Alternate Approach to etcd Certificate Generation with Kubeadm</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 39 May 3033 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;574 words (estimated 3 minutes to read)</span>
  <p>I&rsquo;ve written a fair amount about <code>kubeadm</code>, which was my preferred way of bootstrapping <a href="https://kubernetes.io">Kubernetes</a> clusters until <a href="https://cluster-api.sigs.k8s.io">Cluster API</a> arrived. Along the way, I&rsquo;ve also discussed using <code>kubeadm</code> to assist with setting up etcd, the distributed key-value store leveraged by the Kubernetes control plane (see <a href="/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">here</a>, <a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">here</a>, and <a href="/2020/04/02/setting-up-etcd-with-kubeadm-containerd-edition/">here</a>). In this post, I&rsquo;d like to revisit the topic of using <code>kubeadm</code> to set up an etcd cluster once again, this time taking a look at an alternate approach to generating the necessary TLS certificates than what the official documentation describes.</p>
<p>There is absolutely nothing wrong with the process the official documentation describes (I&rsquo;m referring to <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/">this page</a>, by the way); this process just creates slightly &ldquo;cleaner&rdquo; certificates. What do I mean by &ldquo;cleaner&rdquo; certificates? The official documentation uses a series of <code>kubeadm</code> configuration files, one for each etcd cluster member, to control how the utility creates the necessary certificates and configuration files. The user is instructed to use these configuration files <em>on a single system</em> to generate the certificates for all the cluster members. This works fine, with one caveat: each of the certificates will have an extra hostname&mdash;the hostname of the system being used to generate the certificates&mdash;encoded in the certificate.</p>
<p>Instead of generating all the certificates on a single host, I prefer to generate the certificates on each host. This does require distributing the CA certificate and key to all three hosts, but it avoids the extraneous hostname on the certificates that results from generating all the certificates on the same host. One could also remove the CA key from the hosts after the certificates are generated, if there were concerns about it being copied too widely.</p>
<p>Here&rsquo;s the <code>kubeadm</code> configuration file I use, which is only very lightly modified from the one in the official documentation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serverCertSANs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;FQDN&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peerCertSANs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;FQDN&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initial-cluster</span>: <span style="color:#ae81ff">ip-10-11-12-154=https://ip-10-11-12-154.us-west-2.compute.internal:2380,ip-10-11-48-148=https://ip-10-11-48-148.us-west-2.compute.internal:2380,ip-10-11-96-141=https://ip-10-11-96-141.us-west-2.compute.internal:2380</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initial-cluster-state</span>: <span style="color:#ae81ff">new</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">HOST</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">listen-peer-urls</span>: <span style="color:#ae81ff">https://IP:2380</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">listen-client-urls</span>: <span style="color:#ae81ff">https://IP:2379</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">advertise-client-urls</span>: <span style="color:#ae81ff">https://FQDN:2379</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initial-advertise-peer-urls</span>: <span style="color:#ae81ff">https://FQDN:2380</span>
</span></span></code></pre></div><p><em>(Note: the IP addresses above have been randomized and do not refer to actual instances in my account.)</em></p>
<p>This configuration file is lightly modified to use fully-qualified domain names (FQDNs) where possible/supported by etcd. The <code>listen-peer-urls</code> and <code>listen-client-urls</code> settings require an IP address, but the other settings support FQDNs.</p>
<p>Aside from populating the <code>initial-cluster</code> line&mdash;which has to list all the etcd cluster members&mdash;I copy this file unchanged to each host. On each host, I then customize the file using these commands:</p>
<pre><code>sed -i &quot;s/FQDN/$(hostname -f)/g&quot; kubeadm.yaml
sed -i &quot;s/IP/$(hostname -i)/g&quot; kubeadm.yaml
sed -i &quot;s/HOST/$(hostname -s)/g&quot; kubeadm.yaml
</code></pre>
<p>Once the configuration file is appropriately customized for that particular host, then it&rsquo;s just a matter of running the same commands as in the official documentation, just with slightly different parameters:</p>
<pre><code>kubeadm init phase certs etcd-server --config=kubeadm.yaml
kubeadm init phase certs etcd-peer --config=kubeadm.yaml
kubeadm init phase certs etcd-healthcheck-client --config=kubeadm.yaml
kubeadm init phase certs apiserver-etcd-client --config=kubeadm.yaml
kubeadm init phase etcd local --config=kubeadm.yaml
</code></pre>
<p>Run these commands on each node, and you should end up with a working three-node etcd cluster.</p>
<p>One other advantage of doing it this way is the potential for automation&mdash;the source config file is the same and can be distributed unchanged to each node, and the commands that are run on each host are the same and can be easily scripted (in fact, in some cases I&rsquo;ve put all these commands into a quick-and-dirty shell script).</p>
<p>Hit <a href="https://twitter.com/scott_lowe">me on Twitter</a> if you have any questions or any feedback. Thanks for reading!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubeadm">Kubeadm</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/07/16/technology-short-take-142/">Technology Short Take 142</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2021/08/04/starting-wireguard-interfaces-automatically-launchd-macos/">Starting WireGuard Interfaces Automatically with Launchd on macOS</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2021%2f08%2f03%2falternate-approach-etcd-certificate-generation-kubeadm%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f08%2f03%2falternate-approach-etcd-certificate-generation-kubeadm%2f&text=An%20Alternate%20Approach%20to%20etcd%20Certificate%20Generation%20with%20Kubeadm" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f08%2f03%2falternate-approach-etcd-certificate-generation-kubeadm%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/04/02/setting-up-etcd-with-kubeadm-containerd-edition/">Setting up etcd with Kubeadm, containerd Edition</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">More on Setting up etcd with Kubeadm</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2019/08/15/reconstructing-the-join-command-for-kubeadm/">Reconstructing the Join Command for Kubeadm</a> <span class="post-date-list">159 May 151515</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
