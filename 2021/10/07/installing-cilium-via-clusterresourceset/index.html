<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Installing Cilium via a ClusterResourceSet - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Installing Cilium via a ClusterResourceSet - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Installing Cilium via a ClusterResourceSet - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2021/10/07/installing-cilium-via-clusterresourceset/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Installing Cilium via a ClusterResourceSet</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 79 May 7077 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;691 words (estimated 4 minutes to read)</span>
  <p>In this post, I&rsquo;m going to walk you through how to install <a href="https://cilium.io/">Cilium</a> onto a <a href="https://cluster-api.sigs.k8s.io/">Cluster API</a>-managed workload cluster using a ClusterResourceSet. It&rsquo;s reasonable to consider this post a follow-up to my earlier post that walked you through <a href="/2021/03/02/deploying-a-cni-automatically-with-a-clusterresourceset/">using a ClusterResourceSet to install Calico</a>. There&rsquo;s no need to read the earlier post, though, as this post includes all the information (or links to the information) you need. Ready? Let&rsquo;s jump in!</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>If you aren&rsquo;t already familiar with Cluster API&mdash;hereafter just referred to as CAPI&mdash;then I would encourage you to read <a href="/2019/08/26/an-introduction-to-kubernetes-cluster-api/">my introduction to Cluster API post</a>. Although it is a bit dated (it was written in the very early days of the project, which <a href="https://www.cncf.io/blog/2021/10/06/kubernetes-cluster-api-reaches-production-readiness-with-version-1-0/">recently released version 1.0</a>). Some of the commands referenced in that post have changed, but the underlying concepts remain valid. If you&rsquo;re not familiar with Cilium, check out <a href="https://docs.cilium.io/en/v1.10/intro/">their introduction to the project</a> for more information. Finally, if you&rsquo;re not familiar at all with the idea of ClusterResourceSets, you can read my earlier post or check out <a href="https://github.com/kubernetes-sigs/cluster-api/blob/main/docs/proposals/20200220-cluster-resource-set.md">the ClusterResourceSet CAEP document</a>.</p>
<h2 id="installing-cilium-via-a-clusterresourceset">Installing Cilium via a ClusterResourceSet</h2>
<p>If you want to install Cilium via a ClusterResourceSet, the process looks something like this:</p>
<ol>
<li>Create a ConfigMap with the instructions for installing Cilium.</li>
<li>Create a ClusterResourceSet that references the ConfigMap.</li>
<li>Profit (when you deploy matching workload clusters).</li>
</ol>
<p>Let&rsquo;s look at these steps in a bit more detail.</p>
<h3 id="creating-the-installation-configmap">Creating the Installation ConfigMap</h3>
<p>The <a href="https://docs.cilium.io/en/v1.10/intro/">Cilium docs</a> generally recommend the use of the <code>cilium</code> CLI tool to install Cilium. The reasoning behind this is, as I understand it, that the <code>cilium</code> CLI tool can interrogate the Kubernetes cluster to gather information and then attempt to pick the best configuration options for you. Using <code>helm</code> is also another option recommended by the docs. For our purposes, however, neither of those approaches will work&mdash;using a ClusterResourceSet means you need to be able to supply YAML manifests.</p>
<p>Fortunately, the fact that Cilium supports <a href="https://twitter.com/scott_lowe">Helm</a> gives us a path forward via the use of <code>helm template</code> to render the templates locally. As per the docs on <code>helm template</code>, there are some caveats/considerations, but this was the only way I found to create YAML manifests for installing Cilium.</p>
<p>So, the first step to creating the ConfigMap you need is to set up the Helm repository:</p>
<pre><code>helm repo add cilium https://helm.cilium.io
</code></pre>
<p>Then render the templates locally:</p>
<pre><code>helm template cilium cilium/cilium --version 1.10.4 \
--namespace kube-system &gt; cilium-1.10.4.yaml
</code></pre>
<p>You may need to specify additional options/values as needed in the above command in order to accommodate your specific environment or requirements, of course.</p>
<p>Once you have the templates rendered, then create the ConfigMap that the ClusterResourceSet needs:</p>
<pre><code>kubectl create configmap cilium-crs-cm --from-file=cilium-1.10.4.yaml
</code></pre>
<p>This ConfigMap should be created on the appropriate CAPI management cluster, so ensure your Kubernetes context is set correctly.</p>
<h3 id="creating-the-clusterresourceset">Creating the ClusterResourceSet</h3>
<p>Now you&rsquo;re ready to create the ClusterResourceSet. Here&rsquo;s an example you could use as a starting point:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">addons.cluster.x-k8s.io/v1alpha4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterResourceSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cilium-crs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterSelector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cni</span>: <span style="color:#ae81ff">cilium </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cilium-crs-cm</span>
</span></span></code></pre></div><p>You can see that the ClusterResourceSet references the ConfigMap, which in turn contains the YAML to install Cilium (and that&rsquo;s the YAML applied against matching workload clusters).</p>
<h3 id="deploy-a-matching-workload-cluster">Deploy a Matching Workload Cluster</h3>
<p>What determines a matching workload cluster? The <code>clusterSelector</code> portion of the ClusterResourceSet. In the example above, the ClusterResourceSet&rsquo;s <code>clusterSelector</code> specifies that workload clusters should have the <code>cni: cilium</code> label attached.</p>
<p>The label should be part of CAPI&rsquo;s <code>Cluster</code> object, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cluster.x-k8s.io/v1alpha4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cilium-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">cilium-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cni</span>: <span style="color:#ae81ff">cilium</span>
</span></span></code></pre></div><p>When CAPI creates a workload cluster with that label and value, as shown in the example CAPI manifest above, then the ClusterResourceSet will automatically apply the contents of the ConfigMap against the cluster after it has been fully provisioned. The result: Cilium gets installed automatically on the new workload cluster!</p>
<p>I hope this post is useful. If you have any questions or any feedback, I&rsquo;d love to hear from you! Feel free to find <a href="https://twitter.com/scott_lowe">me on Twitter</a>, or connect with me on <a href="https://kubernetes.slack.com">the Kubernetes Slack instance</a>. For more Cilium information and assistance, I&rsquo;d encourage you to check out <a href="http://cilium.slack.com">the Cilium Slack community</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cilium">Cilium</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/09/24/technology-short-take-145/">Technology Short Take 145</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2021/10/08/technology-short-take-146/">Technology Short Take 146</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2021%2f10%2f07%2finstalling-cilium-via-clusterresourceset%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f10%2f07%2finstalling-cilium-via-clusterresourceset%2f&text=Installing%20Cilium%20via%20a%20ClusterResourceSet" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f10%2f07%2finstalling-cilium-via-clusterresourceset%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2021/06/18/technology-short-take-141/">Technology Short Take 141</a> <span class="post-date-list">189 May 181818</span></li><li><a href="/2021/08/06/technology-short-take-143/">Technology Short Take 143</a> <span class="post-date-list">69 May 6066</span></li><li><a href="/2021/07/16/technology-short-take-142/">Technology Short Take 142</a> <span class="post-date-list">169 May 161616</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
