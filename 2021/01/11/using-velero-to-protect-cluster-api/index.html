<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using Velero to Protect Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using Velero to Protect Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using Velero to Protect Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2021/01/11/using-velero-to-protect-cluster-api/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using Velero to Protect Cluster API</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 119 May 111111 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;703 words (estimated 4 minutes to read)</span>
  <p><a href="https://cluster-api.sigs.k8s.io/">Cluster API</a> (also known as CAPI) is, as you may already know, an effort within the upstream <a href="https://kubernetes.io/">Kubernetes</a> community to apply Kubernetes-style APIs to cluster lifecycle management&mdash;in short, to use Kubernetes to manage the lifecycle of Kubernetes clusters. If you&rsquo;re unfamiliar with CAPI, I&rsquo;d encourage you to check out <a href="/2019/08/26/an-introduction-to-kubernetes-cluster-api/">my introduction to Cluster API</a> before proceeding. In this post, I&rsquo;m going to show you how to use <a href="https://velero.io">Velero</a> (formerly Heptio Ark) to backup and restore Cluster API objects so as to protect your organization against an unrecoverable issue on your Cluster API management cluster.</p>
<p>To be honest, this process is so straightforward it almost doesn&rsquo;t need to be explained. In general, the process for backing up the CAPI management cluster looks like this:</p>
<ol>
<li>Pause CAPI reconciliation on the management cluster.</li>
<li>Back up the CAPI resources.</li>
<li>Resume CAPI reconciliation.</li>
</ol>
<p>In the event of catastrophic failure, the recovery process looks like this:</p>
<ol>
<li>Restore from backup onto another management cluster.</li>
<li>Resume CAPI reconciliation.</li>
</ol>
<p>Let&rsquo;s look at these steps in a bit more detail.</p>
<h2 id="pausing-and-resuming-reconciliation">Pausing and Resuming Reconciliation</h2>
<p>The process for pausing and resuming reconciliation of CAPI resources is outlined in <a href="/2020/11/25/pausing-cluster-api-reconciliation/">this separate blog post</a>. To summarize that post here for convenience, the Cluster API spec includes a <code>paused</code> field that causes the Cluster API controllers to stop reconciliation when the field is set to <code>true</code> (and resume reconciliation when the field is <code>false</code> or absent). Setting this field allows you, the cluster operator, to pause or resume reconciliation.</p>
<h2 id="backing-up-capi-resources">Backing up CAPI Resources</h2>
<p>Once you&rsquo;ve paused reconciliation for Cluster API, you can then run a backup using Velero. Based on my testing, I didn&rsquo;t see anything unusual or odd about running a backup; generally speaking, it looks to be as simple as <code>velero backup create</code> (with appropriate flags). Given the large number of custom resources used by Cluster API (Clusters, Machines, MachineDeployments, KubeadmConfigs, etc.) it may be challenging to include only Cluster API resources using Velero&rsquo;s <code>--include-resources</code> functionality. It&rsquo;s probably easier to either a) not use any of Velero&rsquo;s filtering functionality and catch everything, or b) make sure you are either using namespaces or labels comprehensively for CAPI objects and then use Velero&rsquo;s <code>--include-namespaces</code> and/or <code>--selector</code> filtering options for selecting things to be included in the backup. Refer to <a href="https://velero.io/docs/v1.5/resource-filtering/">Velero&rsquo;s resource filtering documentation</a> for more details.</p>
<h2 id="restoring-from-backup">Restoring from Backup</h2>
<p>As with creating the backup using Velero, restoring from the Velero backup follows the standard Velero procedures (i.e., run <code>velero restore create</code> with appropriate flags/options). Naturally, the cluster to which you are restoring should be an appropriately-configured Cluster API management cluster with the appropriate Cluster API components already installed.</p>
<p>Since this article is more focused on the &ldquo;Oh no my management cluster is dead&rdquo; scenario, <a href="https://velero.io/docs/v1.5/disaster-case/">all of the information on disaster recovery in the Velero docs</a> is appropriate.</p>
<p>After the restore is complete, you&rsquo;ll then want to resume reconciliation on the target/destination cluster, as outlined above.</p>
<h2 id="backup-and-restore-versus-moving">Backup and Restore Versus Moving</h2>
<p>The <code>clusterctl</code> utility used by CAPI for initializing management clusters (among other things) also has a <code>move</code> subcommand that can be used to move CAPI resources from one cluster to another cluster. Some readers may be wondering why we should bother with Velero, and if they could use <code>clusterctl move</code> instead.</p>
<p><code>clusterctl move</code> is a viable option for moving CAPI objects between two clusters <em>as long as both the source and target clusters are up and running</em>. Using Velero, on the other hand, only requires that the source cluster is up and running when a backup needs to be taken; users can then restore this backup to another cluster even if the source cluster has completely failed. I&rsquo;m also of the opinion that Velero will provide more fine-grained control over what can be backed up and restored, although I have yet to test that directly.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>Readers may find the following resources useful as well:</p>
<p><a href="https://velero.io/docs/v1.5/disaster-case/">Disaster recovery use case with Velero</a></p>
<p><a href="https://velero.io/docs/v1.5/migration-case">Cluster migration use case with Velero</a></p>
<p>I hope that readers find this article helpful. If there&rsquo;s anything I&rsquo;ve discussed here that you&rsquo;d like to see examined/explained in greater detail, feel free to let me know. You can find me on <a href="https://kubernetes.slack.com/">the Kubernetes Slack instance</a>, or find <a href="https://twitter.com/scott_lowe/">me on Twitter</a>. I&rsquo;d love to hear from you!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/backup">Backup</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/velero">Velero</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/01/04/details-on-new-desk-layout/">Details on the New Desk Layout</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2021/01/15/technology-short-take-136/">Technology Short Take 136</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2021%2f01%2f11%2fusing-velero-to-protect-cluster-api%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f01%2f11%2fusing-velero-to-protect-cluster-api%2f&text=Using%20Velero%20to%20Protect%20Cluster%20API" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f01%2f11%2fusing-velero-to-protect-cluster-api%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/10/08/considerations-for-using-iac-with-cluster-api/">Considerations for using IaC with Cluster API</a> <span class="post-date-list">89 May 8088</span></li><li><a href="/2020/09/02/updating-aws-credentials-in-cluster-api/">Updating AWS Credentials in Cluster API</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2020/08/31/behavior-changes-in-clusterawsadm-055/">Behavior Changes in clusterawsadm 0.5.5</a> <span class="post-date-list">319 May 313131</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
