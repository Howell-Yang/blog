<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using Kustomize Components with Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using Kustomize Components with Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using Kustomize Components with Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2021/11/01/using-kustomize-components-with-cluster-api/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using Kustomize Components with Cluster API</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 19 May 1011 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;725 words (estimated 4 minutes to read)</span>
  <p>I&rsquo;ve been using <a href="https://kustomize.io">Kustomize</a> with <a href="https://cluster-api.sigs.k8s.io">Cluster API</a> (CAPI) to manage my AWS-based <a href="https://kubernetes.io">Kubernetes</a> clusters for quite a while (along with <a href="https://www.pulumi.com">Pulumi</a> for managing the underlying AWS infrastructure). For all the time I&rsquo;ve been using this approach, I&rsquo;ve also been unhappy with the overlay-based approach that had evolved as a way of managing multiple workload clusters. With the recent release of CAPI 1.0 and the v1beta1 API, I took this opportunity to see if there was a better way. I found a different way&mdash;time will tell if it is a better way. In this post, I&rsquo;ll share how I&rsquo;m using Kustomize components to help streamline managing multiple CAPI workload clusters.</p>
<p>Before continuing, I feel it&rsquo;s important to point out that while the bulk of the Kustomize API is reasonably stable at v1beta1, the components portion of the API is still in early days (v1alpha1). So, if you adopt this functionality, be aware that it may change (or even get dropped).</p>
<p>More information on Kustomize components can be found in <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-cli/1802-kustomize-components/README.md">the Kustomize components KEP</a> or in <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/examples/components.md">this demo document</a>. The <a href="https://kubectl.docs.kubernetes.io/guides/config_management/components/">documentation on Kustomize components</a> is somewhat helpful as well. I won&rsquo;t try to rehash information found in those sources here, but instead build on that information with a CAPI-focused use case. Finally, if you&rsquo;re unfamiliar with using Kustomize with CAPI, start with <a href="/2019/11/12/using-kustomize-with-cluster-api-manifests/">this introduction</a> and then read the post on <a href="/2021/10/11/kustomize-transformer-configurations-for-cluster-api-v1beta1/">transformer configurations for v1beta1</a>.</p>
<p>So, what are Kustomize components? In the context of CAPI, let&rsquo;s say that you have a discrete change or configuration you&rsquo;d like to make to a base CAPI manifest. Perhaps it&rsquo;s changing the <code>imageLookupBaseOS</code> setting, as described in <a href="/2021/10/25/influencing-cluster-api-ami-selection/">this post</a>, to influence AMI selection. You could use a JSON 6902 patch, similar to this, to make that change:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;op&#34;</span>: <span style="color:#e6db74">&#34;add&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/spec/template/spec/imageLookupBaseOS&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;ubuntu-20.04&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>You could turn this into a Kustomize component using the following <code>kustomization.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Component</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">patchesJson6902</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec-template-spec-base-os.json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSMachineTemplate</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1beta1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec-template-spec-base-os.json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSMachine</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;.*&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1beta1</span>
</span></span></code></pre></div><p>Note the <code>kind: Component</code> and the v1alpha1 API version, which distinguish this file from a typical <code>kustomization.yaml</code>. This file references the JSON 6902 patch shared earlier and applies that patch to all AWSMachine and AWSMachineTemplate objects.</p>
<p>Congratulations, you&rsquo;ve defined your first component! Now, what do you do with it?</p>
<p>To use a component you&rsquo;ve defined, simply include it in a <code>kustomization.yaml</code> like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../base</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">components</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/ubuntu-20.04</span>
</span></span></code></pre></div><p>This is a more &ldquo;traditional&rdquo; <code>kustomization.yaml</code> that specifies a base resource, but then instead of referencing a list of transformers or generators or patches, it references the component you defined earlier. You are, of course, not limited to using just one component. Here&rsquo;s an example from my own lab configuration files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../capi-base</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">components</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/dev</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/us-west-2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/calico-cni</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/aws-ccm</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/aws-ebs-csi</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">../components/ubuntu-20.04</span>
</span></span></code></pre></div><p>In this configuration, I&rsquo;m referencing a number of different components:</p>
<ul>
<li>The &ldquo;dev&rdquo; component controls the number of MachineDeployments and how many replicas each MachineDeployment manages. If I need more MachineDeployments with more replicas, I can simply swap out this component for the &ldquo;prod&rdquo; component.</li>
<li>The &ldquo;calico-cni&rdquo; component adds labels that cause the workload cluster to match against a ClusterResourceSet, thereby automatically installing the Calico CNI plugin. (Curious about ClusterResourceSets? Read <a href="/2021/03/02/deploying-a-cni-automatically-with-a-clusterresourceset/">this</a> or <a href="/2021/10/07/installing-cilium-via-clusterresourceset/">this</a>.)</li>
<li>Similarly, the &ldquo;aws-ccm&rdquo; and &ldquo;aws-ebs-csi&rdquo; components add labels for ClusterResourceSets that install the external AWS cloud provider and EBS CSI driver, respectively. (See <a href="/2021/10/12/using-the-external-aws-cloud-provider-for-kubernetes/">this post</a> for more details on using the external AWS cloud provider.)</li>
<li>The &ldquo;ubuntu-20.04&rdquo; component sets the AMIs to Ubuntu 20.04.</li>
</ul>
<p>The awesome thing about using components is that I can define the change I want just once&mdash;as a component&mdash;and then reference it from multiple overlays. Each overlay becomes a list of references to components, instead of slightly-different copies of other overlays. This is a <em>huge</em> improvement over duplicating patches for multiple workload clusters.</p>
<p>Overall, I&rsquo;m far more pleased with using components to describe Kustomize overlays for CAPI workload clusters than previous approaches.</p>
<p>I hope this is helpful to others. If you have any questions, want to talk about it in more detail, or have suggestions for how I can improve, please don&rsquo;t hesitate to contact me. Reach out to <a href="https://twitter.com/scott_lowe">me on Twitter</a>, or find me on <a href="https://kubernetes.slack.com">the Kubernetes Slack</a> community.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kustomize">Kustomize</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/10/29/technology-short-take-147/">Technology Short Take 147</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2021/11/19/technology-short-take-148/">Technology Short Take 148</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2021%2f11%2f01%2fusing-kustomize-components-with-cluster-api%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f11%2f01%2fusing-kustomize-components-with-cluster-api%2f&text=Using%20Kustomize%20Components%20with%20Cluster%20API" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f11%2f01%2fusing-kustomize-components-with-cluster-api%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2021/10/11/kustomize-transformer-configurations-for-cluster-api-v1beta1/">Kustomize Transformer Configurations for Cluster API v1beta1</a> <span class="post-date-list">119 May 111111</span></li><li><a href="/2021/07/07/adding-multiple-items-using-kustomize-json-6902-patches/">Adding Multiple Items Using Kustomize JSON 6902 Patches</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2021/03/19/adding-a-machinehealthcheck-with-kustomize/">Adding a MachineHealthCheck using Kustomize</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
