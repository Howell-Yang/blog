<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using WireGuard on macOS via the CLI - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using WireGuard on macOS via the CLI - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using WireGuard on macOS via the CLI - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2021/06/28/using-wireguard-on-mac-via-cli/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using WireGuard on macOS via the CLI</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 289 May 282828 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;874 words (estimated 5 minutes to read)</span>
  <p>I&rsquo;ve written a few different posts on <a href="https://www.wireguard.com">WireGuard</a>, the &ldquo;simple yet fast and modern VPN&rdquo; (as described by the WireGuard web site) that aims to supplant tools like IPSec and OpenVPN. My <a href="/2021/02/22/setting-up-wireguard-for-aws-vpc-access/">first post on WireGuard</a> showed how to configure WireGuard on Linux, both on the client side as well as on the server side. After that, I followed it up with posts on <a href="/2021/04/01/using-wireguard-on-macos/">using the GUI WireGuard app to configure WireGuard on macOS</a> and&mdash;most recently&mdash;<a href="/2021/06/22/making-wireguard-from-homebrew-work-on-an-m1-mac/">making WireGuard from Homebrew work on an M1-based Mac</a>. In this post, I&rsquo;m going to take a look at using WireGuard on macOS again, but this time via the CLI.</p>
<p>Some of this information is also found in <a href="https://www.wireguard.com/quickstart/">this WireGuard quick start</a>. Here I&rsquo;ll focus only on using macOS as a WireGuard client, not as a server; refer to the WireGuard docs (or to <a href="/2021/02/22/setting-up-wireguard-for-aws-vpc-access/">my earlier post</a>) for information on setting up a WireGuard server. I&rsquo;ll also assume that you&rsquo;ve installed WireGuard via <a href="https://brew.sh">Homebrew</a>.</p>
<h2 id="generating-keys">Generating Keys</h2>
<p>The first step is to generate the public/private keys you&rsquo;ll need. If the <code>/usr/local/etc/wireguard</code> (or the <code>/opt/homebrew/etc/wireguard</code> for users on an M1-based Mac) directory doesn&rsquo;t exist, you&rsquo;ll need to first create that directory. (It didn&rsquo;t exist on my system.) Then, from that directory, run these commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>umask <span style="color:#ae81ff">077</span>
</span></span><span style="display:flex;"><span>wg genkey | tee privatekey | wg pubkey &gt; publickey
</span></span></code></pre></div><p>This generates files named <code>privatekey</code> and <code>publickey</code>, the contents of which you&rsquo;ll use in the configuration of WireGuard. Some tutorials indicate the need to become root or use <code>sudo</code>, but my configuration seems to work fine without either of those.</p>
<h2 id="setting-up-a-wireguard-interface">Setting up a WireGuard Interface</h2>
<p>Once you have public/private keys, you&rsquo;re ready to set up the interface configuration. Note that you&rsquo;ll also need the public key of the server (peer) system to which you&rsquo;re connecting.</p>
<p>Create a file named <code>wg0.conf</code> in <code>/usr/local/etc/wireguard</code> (that would be in <code>/opt/homebrew/etc/wireguard</code> for M1-based Macs). The contents of the file should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">Interface</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PrivateKey</span> = <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">private-key-generated-earlier</span><span style="color:#960050;background-color:#1e0010">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Address</span> = <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">vpn-ip-address-for-this-interface</span><span style="color:#960050;background-color:#1e0010">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Peer</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PublicKey</span> = <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">public-key-for-peer-system</span><span style="color:#960050;background-color:#1e0010">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Endpoint</span> = <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">public-ip-address</span><span style="color:#960050;background-color:#1e0010">&gt;:</span><span style="color:#ae81ff">51280</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AllowedIPs</span> = <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">vpn-ip-address-for-peer-interface</span><span style="color:#960050;background-color:#1e0010">&gt;</span>, <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">additional-cidrs</span><span style="color:#960050;background-color:#1e0010">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PersistentKeepalive</span> = <span style="color:#ae81ff">25</span>
</span></span></code></pre></div><p>Most of this configuration file is pretty straightforward:</p>
<ul>
<li>You&rsquo;ll need to specify the private key for the local system plus the public key of the peer system.</li>
<li>Each system will need &ldquo;VPN IP addresses&rdquo; that are routable/reachable from each other (I use a /29 CIDR from which I assign peer VPN IP addresses). The VPN IP addresses do not have to be publicly routable (they can be RFC 1918 ranges), but they should not overlap other IP address ranges&mdash;otherwise you&rsquo;ll run into routing table issues.</li>
<li>For the <code>AllowedIPs</code> setting, you need to specify the VPN IP address of the peer <em>plus</em> any additional networks that are reachable via the peer. In my case, I use WireGuard to access private EC2 instances in an AWS VPC, so I specify the VPC CIDR here.</li>
</ul>
<p>The peer system will have/need a similar configuration. As described <a href="/2021/02/22/setting-up-wireguard-for-aws-vpc-access/">here</a>, my primary use case is enabling connectivity to EC2 instances with private IP addresses inside a VPC, so the peer system for me is a Linux instance with WireGuard installed and configured.</p>
<h2 id="activating-the-vpn">Activating the VPN</h2>
<p>Once you have the WireGuard interface configuration finished, you can activate the VPN connection using <code>wg-quick up wg0</code> (if you called your configuration file from the previous section something <em>other</em> than <code>wg0.conf</code>, then change the command accordingly). If the peer system is already configured and its interface is up, then the VPN connection should establish automatically and you <em>should</em> be able to start routing traffic through the peer (assuming you specified some additional networks to be routed through the peer).</p>
<p>Use <code>wg-quick down wg0</code> to take the VPN connection down.</p>
<p>I did see some references to being able to use <code>launchd</code> on macOS to automatically start the WireGuard interface. It took a bit of testing and exploration, but I eventually settled on <a href="/2021/08/04/starting-wireguard-interfaces-automatically-launchd-macos/">this configuration</a>.</p>
<h2 id="troubleshooting-the-connection">Troubleshooting the Connection</h2>
<p>If you run into problems getting the connection up and working, here are a few things you can check:</p>
<ul>
<li>When specifying <code>AllowedIPs</code>, make sure to include the VPN interface IP address as well as any additional networks. Failing to include the VPN interface IP address can cause the connection to fail.</li>
<li>Double-check that you&rsquo;ve specified public and private keys correctly. It&rsquo;s easy to get these mixed up. Each system&rsquo;s configuration should reference its own private key and the peer&rsquo;s public key.</li>
<li>Make sure you&rsquo;ve specified the peer&rsquo;s endpoint correctly.</li>
<li>Make sure that the traffic is being allowed to reach each system. Double-check firewalls, network access control lists, host-based firewalls, and security groups.</li>
<li>Make sure the WireGuard interface is up and active on both systems. When troubleshooting connections, it can be easy to forget whether the interface is active or not.</li>
</ul>
<p>Aside from the location of the configuration files, configuring WireGuard via the CLI using configuration files is very, very similar across systems. The interface configuration shown above is&mdash;as far as I&rsquo;ve been able to tell so far&mdash;identical across both macOS and Linux.</p>
<p>I hope this article is helpful. If you have any questions, comments, or corrections, please feel free to contact me. You can reach <a href="https://twitter.com/scott_lowe">me on Twitter</a> (DMs are open), or hit me up on one of a variety of Slack communities. I&rsquo;d be happy to chat with you.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/encryption">Encryption</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/macos">macOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vpn">VPN</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2021/06/25/installing-older-versions-of-kumactl-on-an-m1-mac/">Installing Older Versions of Kumactl on an M1 Mac</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2021/07/07/adding-multiple-items-using-kustomize-json-6902-patches/">Adding Multiple Items Using Kustomize JSON 6902 Patches</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2021%2f06%2f28%2fusing-wireguard-on-mac-via-cli%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f06%2f28%2fusing-wireguard-on-mac-via-cli%2f&text=Using%20WireGuard%20on%20macOS%20via%20the%20CLI" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2021%2f06%2f28%2fusing-wireguard-on-mac-via-cli%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2021/06/22/making-wireguard-from-homebrew-work-on-an-m1-mac/">Making WireGuard from Homebrew Work on an M1 Mac</a> <span class="post-date-list">229 May 222222</span></li><li><a href="/2021/04/01/using-wireguard-on-macos/">Using WireGuard on macOS</a> <span class="post-date-list">19 May 1011</span></li><li><a href="/2021/01/15/technology-short-take-136/">Technology Short Take 136</a> <span class="post-date-list">159 May 151515</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
