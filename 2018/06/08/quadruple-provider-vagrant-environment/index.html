<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>A Quadruple-Provider Vagrant Environment - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="A Quadruple-Provider Vagrant Environment - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="A Quadruple-Provider Vagrant Environment - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2018/06/08/quadruple-provider-vagrant-environment/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">A Quadruple-Provider Vagrant Environment</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 89 May 8088 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1050 words (estimated 5 minutes to read)</span>
  <p>In October 2016 <a href="/2016/10/05/triple-provider-vagrant-environment/">I wrote about</a> a triple-provider <a href="https://www.vagrantup.com/">Vagrant</a> environment I&rsquo;d created that worked with <a href="https://www.virtualbox.org/">VirtualBox</a>, <a href="https://aws.amazon.com/">AWS</a>, and the VMware provider (tested with <a href="http://www.vmware.com/products/fusion.html">VMware Fusion</a>). Since that time, I&rsquo;ve incorporated Linux (<a href="https://getfedora.org/">Fedora</a>, specifically) into my computing landscape, and I started using the Libvirt provider for Vagrant (see my write-up <a href="/2017/12/06/using-vagrant-with-libvirt-on-fedora/">here</a>). With that in mind, I updated the triple-provider environment to add support for Libvirt and make it a quadruple-provider environment.</p>
<p>To set expectations, I&rsquo;ll start out by saying there isn&rsquo;t a whole lot here that is dramatically different than the triple-provider setup that I shared back in October 2016. Obviously, it supports more providers, and I&rsquo;ve improved the setup so that <em>no</em> changes to the Vagrantfile are needed (everything is parameterized).</p>
<p>With that in mind, let&rsquo;s take a closer look. First, let&rsquo;s look at the <code>Vagrantfile</code> itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Specify minimum Vagrant version and Vagrant API version</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>require_version <span style="color:#e6db74">&#39;&gt;= 1.6.0&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Require &#39;yaml&#39; module</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;yaml&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read YAML file with VM details (box, CPU, and RAM)</span>
</span></span><span style="display:flex;"><span>machines <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>join(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>dirname(__FILE__), <span style="color:#e6db74">&#39;machines.yml&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create and configure the VMs</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Always use Vagrant&#39;s default insecure key</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>ssh<span style="color:#f92672">.</span>insert_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Iterate through entries in YAML file to create VMs</span>
</span></span><span style="display:flex;"><span>  machines<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>machine<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Configure the AWS provider</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;aws&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>aws<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Specify default AWS key pair</span>
</span></span><span style="display:flex;"><span>      aws<span style="color:#f92672">.</span>keypair_name <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;keypair&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Specify default region</span>
</span></span><span style="display:flex;"><span>      aws<span style="color:#f92672">.</span>region <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;region&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#75715e"># config.vm.provider &#39;aws&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;name&#39;</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>srv<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Don&#39;t check for box updates</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box_check_update <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Set machine&#39;s hostname</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>hostname <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;name&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Use dummy AWS box by default (override per-provider)</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;aws-dummy&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure default synced folder (disable by default)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;sync_disabled&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>synced_folder <span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;/vagrant&#39;</span>, <span style="color:#e6db74">disabled</span>: machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;sync_disabled&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>synced_folder <span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;/vagrant&#39;</span>, <span style="color:#e6db74">disabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e">#if machine[&#39;sync_disabled&#39;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Iterate through networks as per settings in machines.yml</span>
</span></span><span style="display:flex;"><span>      machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;nics&#39;</span><span style="color:#f92672">].</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>net<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> net<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ip_addr&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;dhcp&#39;</span>
</span></span><span style="display:flex;"><span>          srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network net<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">type</span>: net<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ip_addr&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network net<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">ip</span>: net<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ip_addr&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#75715e"># if net[&#39;ip_addr&#39;]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e"># machine[&#39;nics&#39;].each</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure CPU &amp; RAM per settings in machines.yml (Fusion)</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;vmware_fusion&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vmw, override<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        vmw<span style="color:#f92672">.</span>vmx<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;memsize&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ram&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vmw<span style="color:#f92672">.</span>vmx<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;numvcpus&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;vcpu&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        override<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;box&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;vmw&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;nested&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          vmw<span style="color:#f92672">.</span>vmx<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;vhv.enable&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TRUE&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#75715e">#if machine[&#39;nested&#39;]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e"># srv.vm.provider &#39;vmware_fusion&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure CPU &amp; RAM per settings in machines.yml (VirtualBox)</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;virtualbox&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vb, override<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ram&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>cpus <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;vcpu&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        override<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;box&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;vb&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>customize <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;modifyvm&#39;</span>, <span style="color:#e6db74">:id</span>, <span style="color:#e6db74">&#39;--nictype1&#39;</span>, <span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>customize <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;modifyvm&#39;</span>, <span style="color:#e6db74">:id</span>, <span style="color:#e6db74">&#39;--nictype2&#39;</span>, <span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e"># srv.vm.provider &#39;virtualbox&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure CPU &amp; RAM per settings in machines.yml (Libvirt)</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;libvirt&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>lv,override<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        lv<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;ram&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        lv<span style="color:#f92672">.</span>cpus <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;vcpu&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        override<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;box&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;lv&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;nested&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          lv<span style="color:#f92672">.</span>nested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#75715e"># if machine[&#39;nested&#39;]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e"># srv.vm.provider &#39;libvirt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Configure per-machine AWS provider/instance overrides</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;aws&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>aws, override<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        override<span style="color:#f92672">.</span>ssh<span style="color:#f92672">.</span>private_key_path <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;key_path&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        override<span style="color:#f92672">.</span>ssh<span style="color:#f92672">.</span>username <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;user&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        aws<span style="color:#f92672">.</span>instance_type <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        aws<span style="color:#f92672">.</span>ami <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;box&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        aws<span style="color:#f92672">.</span>security_groups <span style="color:#f92672">=</span> machine<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;aws&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;security_groups&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span> <span style="color:#75715e"># srv.vm.provider &#39;aws&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#75715e"># config.vm.define</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span> <span style="color:#75715e"># machines.each</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span> <span style="color:#75715e"># Vagrant.configure</span>
</span></span></code></pre></div><p>A couple of notes about the above <code>Vagrantfile</code>:</p>
<ul>
<li>All the data is pulled from an external YAML file named <code>machines.yml</code>; more information on that shortly.</li>
<li>The &ldquo;magic,&rdquo; if you will, is in the provider overrides. HashiCorp recommends <em>against</em> provider overrides, but in my experience they&rsquo;re a necessity when working with multi-provider setups. Within each provider override block, we set provider-specific details and adjust the box needed (because finding boxes that support multiple platforms is downright impossible in many cases).</li>
<li>The <code>machine[nics].each do |net|</code> section works for the local virtualization providers (VirtualBox, VMware, and Libvirt), but is silently ignored for AWS. That made making the <code>Vagrantfile</code> much easier, in my opinion. Note that last time I <em>really</em> tested the Libvirt provider there was some weirdness with the network configuration; the configuration shown above works as expected. Other configurations may not.</li>
</ul>
<p>Now, let&rsquo;s look at the external YAML data file that feeds Vagrant the information it needs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">aws</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;t2.medium&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#e6db74">&#34;ubuntu&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key_path</span>: <span style="color:#e6db74">&#34;~/.ssh/id_rsa&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">security_groups</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keypair</span>: <span style="color:#e6db74">&#34;ssh_keypair&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">region</span>: <span style="color:#e6db74">&#34;us-west-2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">aws</span>: <span style="color:#e6db74">&#34;ami-db710fa3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lv</span>: <span style="color:#e6db74">&#34;generic/ubuntu1604&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vb</span>: <span style="color:#e6db74">&#34;ubuntu/xenial64&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vmw</span>: <span style="color:#e6db74">&#34;bento/ubuntu-16.04&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;xenial-01&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nested</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nics</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;private_network&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ip_addr</span>: <span style="color:#e6db74">&#34;dhcp&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ram</span>: <span style="color:#e6db74">&#34;512&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sync_disabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vcpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span></code></pre></div><p>This is pretty straightforward YAML. This configuration does support multiple VMs/instances, with one interesting twist. When working with multiple AWS instances, you only need to specify the AWS keypair and AWS region on the <strong>last</strong> instance defined in the YAML file. You can include it for all instances, if you like, but only the values on the last instance will actually apply. I may toy around with supporting multi-region configurations, but that is kind of far down my priority list. The other AWS-specific values (type, user, and path to private key) need to be specified for all instances in the YAML file.</p>
<p>To use this environment, you only need to edit the external YAML file with the appropriate values and make sure authentication against AWS is working as expected. I recommend installing and configuring the AWS CLI to ensure that authentication against AWS is working as expected. Alternately, you could use something like <a href="https://github.com/99designs/aws-vault"><code>aws-vault</code></a>.</p>
<p>Then it&rsquo;s just a matter of running the appropriate command for your particular environment:</p>
<p><code>vagrant up --provider=aws</code> (to spin up instances on AWS)<br>
<code>vagrant up --provider=virtualbox</code> (to spin up VirtualBox VMs locally)<br>
<code>vagrant up --provider=vmware_fusion</code> (to use Fusion to create local VMs)<br>
<code>vagrant up --provider=libvirt</code> (to create Libvirt guest domains locally)</p>
<p>Using this sort of technique to support multiple providers in a single Vagrant environment provides a clean, consistent workflow regardless of backend provider. Naturally, this could be extended to include other providers using the same basic techniques I&rsquo;ve used here. I&rsquo;ll leave that as an exercise to the readers.</p>
<h2 id="my-use-case">My Use Case</h2>
<p>You might be wondering, &ldquo;Why did you put effort into this?&rdquo; It&rsquo;s pretty simple, really. I&rsquo;m working on a project where I needed to be able to quickly and easily spin up a few instances on AWS. I felt like <a href="https://www.terraform.io/">Terraform</a> was a bit too &ldquo;heavy&rdquo; for this, as all I really needed was the ability to launch an instance or two, interact with the instances, then tear them down. Yes, I <em>could</em> have done this with the AWS CLI, but&hellip;really? I knew that Vagrant worked with AWS, and I already use Vagrant for other purposes. It seemed pretty natural to incorporate the AWS support in Vagrant into my existing environments, and this quadruple-provider environment was the result. Enjoy!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/fusion">Fusion</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualbox">VirtualBox</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/libvirt">Libvirt</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2018/06/08/technology-short-take-101/">Technology Short Take 101</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2018/06/11/using-variables-in-aws-tags-with-terraform/">Using Variables in AWS Tags with Terraform</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2018%2f06%2f08%2fquadruple-provider-vagrant-environment%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f06%2f08%2fquadruple-provider-vagrant-environment%2f&text=A%20Quadruple-Provider%20Vagrant%20Environment" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f06%2f08%2fquadruple-provider-vagrant-environment%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2016/10/05/triple-provider-vagrant-environment/">A Triple-Provider Vagrant Environment</a> <span class="post-date-list">59 May 5055</span></li><li><a href="/2017/08/11/technology-short-take-85/">Technology Short Take 85</a> <span class="post-date-list">119 May 111111</span></li><li><a href="/2018/03/30/technology-short-take-97/">Technology Short Take 97</a> <span class="post-date-list">309 May 303030</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
