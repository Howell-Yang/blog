<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Bootstrapping an etcd Cluster with TLS using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Bootstrapping an etcd Cluster with TLS using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Bootstrapping an etcd Cluster with TLS using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Bootstrapping an etcd Cluster with TLS using Kubeadm</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 219 May 212121 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1213 words (estimated 6 minutes to read)</span>
  <p>The <a href="https://github.com/coreos/etcd/">etcd distributed key-value store</a> is an integral part of <a href="https://kubernetes.io/">Kubernetes</a>. I first wrote about etcd back in 2014 in <a href="/2014/08/18/coreos-continued-etcd/">this post</a>, but haven&rsquo;t really discussed it in any great detail since then. However, as part of my recent efforts to dive <em>much</em> deeper into Kubernetes, I needed to revisit etcd. In this post, I wanted to share how to boostrap a new etcd cluster with TLS certificates using <code>kubeadm</code>.</p>
<p>Before I go on, I feel compelled to state that this is certainly not the <em>only</em> way to bootstrap an etcd cluster with TLS certificates. I feel I must also state that nothing in what I&rsquo;m about to share is new, novel, revolutionary, or unusual. In fact, a fair amount of it is based on <a href="https://kubernetes.io/docs/setup/independent/setup-ha-etcd-with-kubeadm/">these instructions</a>, although this post will focus on using systemd unit files instead of static pods under Kubernetes. I&rsquo;m simply documenting it here in the hopes of getting the information more broadly disseminated, and to help document my own journey of learning.</p>
<h2 id="preparing-the-systems">Preparing the Systems</h2>
<p>Before you bootstrap the etcd cluster, you&rsquo;ll first need to prepare the nodes for the process. Although I&rsquo;ll list the steps manually below, in practice you&rsquo;ll want to build some automation tooling to help with this process. (My <a href="https://github.com/scottslowe/learning-tools/">&ldquo;learning-tools&rdquo; GitHub repository</a> has <a href="https://github.com/scottslowe/learning-tools/tree/master/etcd/etcdv3-ansible-aws-tf">an example</a> that you could use as a starting point for your own tooling.)</p>
<ol>
<li>
<p>You&rsquo;ll need to download an etcd release from GitHub.</p>
</li>
<li>
<p>Unpack the release tarball and copy the <code>etcd</code> and <code>etcdctl</code> binaries to somewhere in your path, like <code>/usr/local/bin</code>. (Those two binaries are all you need.)</p>
</li>
<li>
<p>Create a data directory for etcd to use, like <code>/var/lib/etcd</code>.</p>
</li>
<li>
<p>Download the <code>kubeadm</code> binary and place it somewhere in your path, like <code>/usr/local/bin</code>. I prefer downloading the <code>kubeadm</code> binary as opposed to using package management, as package management also installs some other packages that aren&rsquo;t needed in this case. Use <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl">this page</a> to see how to download <code>kubeadm</code> (just substitute <code>kubeadm</code> for <code>kubectl</code>). Note that this procedure was tested with <code>kubeadm</code> version 1.11.2; other versions <em>should</em> work fine but I can&rsquo;t guarantee it.</p>
</li>
</ol>
<p>You&rsquo;ll need to repeat this process for each system that will participate in the etcd cluster.</p>
<p>Once you&rsquo;ve completed these steps, then you&rsquo;re ready to proceed with boostrapping the etcd cluster with TLS encryption and TLS client authentication.</p>
<h2 id="bootstrapping-the-etcd-cluster">Bootstrapping the etcd Cluster</h2>
<p>With all the binaries in place, you&rsquo;ll start by generating all the certificates that are needed. This is where you&rsquo;ll leverage <code>kubeadm</code>; specifically, the <code>kubeadm alpha phase certs</code> command.</p>
<p>First, create a self-signed CA for etcd:</p>
<pre><code>kubeadm alpha phase certs etcd-ca
</code></pre>
<p>This will create a CA certificate and key in <code>/etc/kubernetes/pki/etcd</code>. The files will be named <code>ca.crt</code> and <code>ca.key</code>. Copy these files to the same location on the other etcd nodes (you may need to create the directory structure first with <code>mkdir -p</code>).</p>
<p>Before you can continue with the next steps&mdash;generating server and peer certificates&mdash;you&rsquo;ll need to first create a configuration file for <code>kubeadm</code> that provides some additional instructions on how to create those certificates. Specifically, this configuration file will instruct <code>kubeadm</code> on which Subject Alternative Names (SANs) should be included on the certificates.</p>
<p>Here&rsquo;s the configuration file (this is for an EC2 instance in the &ldquo;us-west-2&rdquo; region with the private IP address 192.168.1.100, substitute your correct values here):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#e6db74">&#34;kubeadm.k8s.io/v1alpha2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MasterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serverCertSANs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;ip-192-168-1-100.us-west-2.compute.internal&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;192.168.1.100&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">peerCertSANs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;ip-192-168-1-100.us-west-2.compute.internal&#34;</span>
</span></span></code></pre></div><p>This configuration file syntax is specific to 1.11 (and possibly newer); it won&rsquo;t work for 1.10. Also, play close attention to capitalization and spacing (<code>kubeadm</code> is very particular).</p>
<p>With the <code>kubeadm</code> configuration in place, you can create the etcd server certificate (assuming the configuration file is stored as <code>etcd.yaml</code>):</p>
<pre><code>kubeadm alpha phase certs etcd-server --config etc.yaml
</code></pre>
<p>This will create a <code>server.crt</code> and <code>server.key</code> in <code>/etc/kubernetes/pki/etcd</code>. Repeat this process on the other etcd nodes&mdash;don&rsquo;t copy certificates across nodes as the hostnames on the certificate won&rsquo;t match up. Make sure you appropriately customize the <code>etcd.yaml</code> configuration file for each host so that the hostnames and IP addresses assigned to the certificates are correct.</p>
<p>Next, create the etcd peer certificates:</p>
<pre><code>kubeadm alpha phase certs etcd-peer --config etcd.yaml
</code></pre>
<p>This creates two files (<code>peer.crt</code> and <code>peer.key</code>) in the same directory as the previous steps (<code>/etc/kubernetes/pki/etcd</code>). As with the previous step, repeat this command on the other etcd nodes; don&rsquo;t copy certificates around.</p>
<p>You now have the etcd binaries in place and have all the necessary certificates for securing etcd. The next step is to create the systemd unit file that will start etcd. It should look something like this:</p>
<pre tabindex="0"><code>[Unit]
Description=etcd
Documentation=https://github.com/coreos/etcd
Conflicts=etcd2.service
Wants=network-online.target network.target
After=network-online.target

[Service]
Type=notify
Restart=always
RestartSec=5s
LimitNOFILE=40000
TimeoutStartSec=0
EnvironmentFile=/etc/etcd/etcd.conf
ExecStart=/usr/local/bin/etcd

[Install]
WantedBy=multi-user.target
</code></pre><p>The systemd unit references an environment file to keep the systemd unit file as simple and straightforward as possible. Here&rsquo;s the environment file that would go along with this systemd unit file:</p>
<pre tabindex="0"><code>ETCD_NAME=&#34;node1&#34;
ETCD_DATA_DIR=&#34;/var/lib/etcd&#34;
ETCD_LISTEN_CLIENT_URLS=&#34;https://0.0.0.0:2379&#34;
ETCD_LISTEN_PEER_URLS=&#34;https://0.0.0.0:2380&#34;
ETCD_ADVERTISE_CLIENT_URLS=&#34;https://192.168.1.100:2379&#34;
ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;https://192.168.1.100:2380&#34;
ETCD_INITIAL_CLUSTER=&#34;node1=https://192.168.1.100:2380,\
node2=https://192.168.1.101:2380,\
node3=https://192.168.1.102:2380
ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
ETCD_INITIAL_CLUSTER_TOKEN=&#34;new-cluster&#34;
ETCD_TRUSTED_CA_FILE=&#34;/etc/kubernetes/pki/etcd/ca.crt&#34;
ETCD_CERT_FILE=&#34;/etc/kubernetes/pki/etcd/server.crt&#34;
ETCD_KEY_FILE=&#34;/etc/kubernetes/pki/etcd/server.key&#34;
ETCD_CLIENT_CERT_AUTH=&#34;true&#34;
ETCD_PEER_TRUSTED_CA_FILE=&#34;/etc/kubernetes/pki/etcd/ca.crt&#34;
ETCD_PEER_CERT_FILE=&#34;/etc/kubernetes/pki/etcd/peer.crt&#34;
ETCD_PEER_KEY_FILE=&#34;/etc/kubernetes/pki/etcd/peer.key&#34;
ETCD_PEER_CLIENT_CERT_AUTH=&#34;true&#34;
</code></pre><p>Note that you <strong>must</strong> customize this environment file for each system in the cluster! Be sure to set the <code>ETCD_NAME</code>, <code>ETCD_ADVERTISE_CLIENT_URLS</code>, and <code>ETCD_INITIAL_ADVERTISE_PEER_URLS</code> values to the correct values for each system. Also be sure that the names and IP addresses referenced in <code>ETCD_INITIAL_CLUSTER</code> correctly match the names (as specified by <code>ETCD_NAME</code>) and IP addresses of the systems in the cluster.</p>
<p>Because you&rsquo;ve modified systemd&rsquo;s configuration by adding a new unit file, you&rsquo;ll need to run <code>systemctl daemon-reload</code>, and then you can enable and start etcd:</p>
<pre><code>systemctl enable etcd
systemctl start etcd
</code></pre>
<p>Use <code>systemctl status etcd</code> and/or <code>journalctl -u etcd</code> to make sure that the cluster formed, a leader was elected, and that etcd is serving client requests.</p>
<p>The final step is just to verify that etcd is working as expected. You can use <code>etcdctl</code> to perform this test:</p>
<pre><code>ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt \
--cert=/etc/kubernetes/pki/etcd/peer.crt \
--key=/etc/kubernetes/pki/etcd/peer.key \
--endpoints=https://192.168.1.100:2379,https://192.168.1.101:2379,\
https://192.168.1.102:2379
endpoint health
</code></pre>
<p>It may be obvious but it&rsquo;s worth pointing out/reminding readers that you&rsquo;ll need to customize the <code>--endpoints=</code> parameter to reflect the correct IP addresses of the systems in your cluster.</p>
<p>This <code>etcdctl</code> command looks complicated, but it&rsquo;s necessary for a couple reasons (see <a href="https://github.com/coreos/etcd/tree/master/etcdctl">here</a> for more details on this command):</p>
<ul>
<li>This is an etcd version 3 cluster, so you have to explicitly tell <code>etcdctl</code> to use the version 3 API.</li>
<li>Because client certification authentication is enabled, you can&rsquo;t make a connection to the etcd cluster without a client certificate. Hence, you need to specify all the various certificate-related flags.</li>
</ul>
<p>Assuming the <code>etcdctl</code> command worked correctly and reported no errors (all cluster endpoints healthy), then you&rsquo;re all set!</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>Virtually everyone who does content creation stands on the shoulders of those who have gone before them, and I&rsquo;m no exception. Refer to these resources for more information or additional perspectives on this topic:</p>
<p><a href="https://coreos.com/etcd/docs/latest/op-guide/security.html">etcd Security Model</a><br>
<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/07-bootstrapping-etcd.md">The &ldquo;Bootstrapping the etcd Cluster&rdquo; portion of Kelsey Hightower&rsquo;s Kubernetes the Hard Way repository</a></p>
<p><a href="https://github.com/mauilion/wardroom-nc/">This GitHub repository</a> by my colleague Duffie Cooley also provided some inspiration and guidance for some portions of this process.</p>
<p><strong>UPDATE 2020-01-31:</strong> Note that the <code>kubeadm alpha phase</code> command was replaced by the <code>kubeadm init phase</code> command in the Kubernetes 1.13 release. Since readers are pretty likely to be running a release later than 1.13, please replace all instances of <code>kubeadm alpha phase</code> above with <code>kubeadm init phase</code>. The commands remain otherwise identical.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/encryption">Encryption</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubeadm">Kubeadm</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2018/08/20/troubleshooting-tls-certificates/">Troubleshooting TLS Certificates</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2018/08/21/a-simple-kubernetes-context-switcher/">A Simple Kubernetes Context Switcher</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2018%2f08%2f21%2fbootstrapping-etcd-cluster-with-tls-using-kubeadm%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f08%2f21%2fbootstrapping-etcd-cluster-with-tls-using-kubeadm%2f&text=Bootstrapping%20an%20etcd%20Cluster%20with%20TLS%20using%20Kubeadm" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f08%2f21%2fbootstrapping-etcd-cluster-with-tls-using-kubeadm%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2013/02/04/technology-short-take-29/">Technology Short Take #29</a> <span class="post-date-list">49 May 4044</span></li><li><a href="/2018/07/13/technology-short-take-102/">Technology Short Take 102</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2018/04/30/updated-look-at-multi-platform-toolbelt/">An Updated Look at My Multi-Platform Toolbelt</a> <span class="post-date-list">309 May 303030</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
