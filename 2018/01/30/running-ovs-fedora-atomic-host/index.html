<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Running OVS on Fedora Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Running OVS on Fedora Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Running OVS on Fedora Atomic Host - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2018/01/30/running-ovs-fedora-atomic-host/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Running OVS on Fedora Atomic Host</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 309 May 303030 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;703 words (estimated 4 minutes to read)</span>
  <p>In this post, I&rsquo;d like to share the results of some testing I&rsquo;ve been doing to run <a href="http://openvswitch.org/">Open vSwitch</a> (OVS) in containers on a container-optimized Linux distribution such as <a href="https://www.projectatomic.io/">Atomic Host</a> (Fedora Atomic Host, specifically). I&rsquo;m still relatively early in my exploration of this topic, but I felt like sharing what I&rsquo;ve found so far might be helpful to others, and might help spark conversations within the relevant communities about how this experience might be improved.</p>
<p>The reason for the use of Docker containers in this approach is twofold:</p>
<ol>
<li>Many of the newer container-optimized Linux distributions&mdash;CoreOS Container Linux (soon to be part of Red Hat in some fashion), Project Atomic, etc.&mdash;eschew &ldquo;traditional&rdquo; package management solutions in favor of containers.</li>
<li>Part of the reason behind my testing was to help the OVS community better understand what it would look like to run OVS in containers so as to help make OVS a better citizen on container-optimized Linux distributions.</li>
</ol>
<p>In this post, I&rsquo;ll be using Fedora 27 Atomic Host (via <a href="https://www.vagrantup.com/">Vagrant</a> with <a href="https://virtualbox.org/">VirtualBox</a>). If you use a different version or release of Atomic Host, your results may differ somewhat. For the OVS containers, I&rsquo;m using the excellent <a href="https://hub.docker.com/r/keldaio/ovs/">keldaio/ovs</a> Docker containers.</p>
<p>As it turns out, running OVS on Fedora Atomic Host using the Kelda Docker images is really straightforward. As stated in <a href="https://github.com/kelda/kelda/tree/master/ovs">Kelda&rsquo;s README for the OVS Docker images</a>, you just have to launch a couple of containers. First, you&rsquo;d launch a container for the OVSDB server:</p>
<pre><code>docker run -itd --net=host --name=ovsdb-server keldaio/ovs ovsdb-server
</code></pre>
<p>Next, you&rsquo;d run a container for the ovs-vswitchd daemon:</p>
<pre><code>docker run -itd --net=host --name=ovs-vswitchd --volumes-from=ovsdb-server --privileged keldaio/ovs ovs-vswitchd
</code></pre>
<p>That gets the core, essential parts of OVS up and running, but you&rsquo;re not fully functional yet. The final ingredient is to load the OVS kernel module, which is part of the upstream Linux kernel. Normally, starting OVS-related daemons would initiate loading the kernel module, but with OVS encapsulated in Docker containers it won&rsquo;t happen automatically. However, a quick <code>sudo modprobe openvswitch</code> will easily remedy that and get the OVS kernel module loaded.</p>
<p>From this point, running <code>ovs-vsctl</code> to configure OVS involves appending your command to a <code>docker exec</code> command, like this:</p>
<pre><code>docker exec -it ovs-vswitchd ovs-vsctl show
</code></pre>
<p>This will run <code>ovs-vsctl show</code> in the &ldquo;ovs-vswitchd&rdquo; container, which is where the ovs-vswitchd daemon is running. All the standard <code>ovs-vsctl</code> commands should work here, such as adding a bridge (<code>add-br</code>), adding a port (<code>add-port</code>), deleting a port (<code>del-port</code>), and deleting a bridge (<code>del-br</code>).</p>
<p>This is all pretty cool, but there&rsquo;s a problem. OVS&rsquo; configuration is stored in the OVSDB database, which is itself found in the &ldquo;ovsdb-server&rdquo; container (hence why the vswitchd container needs to mount the same volumes as the &ldquo;ovsdb-server&rdquo; container via <code>--volumes-from</code>). What if the &ldquo;ovsdb-server&rdquo; container goes away? <strong>The OVS configuration goes away, too.</strong> (Don&rsquo;t believe me? Stop, remove, and relaunch the &ldquo;ovsdb-server&rdquo; container using the command line above and see for yourself.)</p>
<p>Obviously, that&rsquo;s not ideal. One possible solution is to use Docker volumes to store the data that OVSDB needs <em>separate</em> from the actual OVSDB server container.</p>
<p>Here&rsquo;s how you&rsquo;d make this work. First, you&rsquo;d create some Docker volumes:</p>
<pre><code>docker volume create var-lib-ovs
docker volume create var-log-ovs
docker volume create var-run-ovs
docker volume create etc-ovs
</code></pre>
<p>Then, you&rsquo;d amend the command line for launching the &ldquo;ovsdb-server&rdquo; container to look like this instead:</p>
<pre><code>docker run -itd --net=host --name=ovsdb-server -v var-lib-ovs:/var/lib/openvswitch -v var-log-ovs:/var/log/openvswitch -v var-run-ovs:/var/run/openvswitch -v etc-ovs:/etc/openvswitch keldaio/ovs ovsdb-server
</code></pre>
<p>The command line for launching the ovs-vswitchd container remains unchanged, since it just mounts the same volumes as the OVSDB server container.</p>
<p>With this approach, the OVS configuration is now stored separate from the containers where the OVSDB server and ovs-vswitchd processes run, which means we can easily kill and restart those containers <em>without</em> negatively impacting OVS configuration. This configuration also brings us one step closer to using systemd to manage the OVS containers since we can now persist data across container instances.</p>
<p>I&rsquo;m still exploring this sort of configuration, so I&rsquo;ll share additional information I uncover in future blog posts. In the meantime, if I&rsquo;ve made an error in this post or if there is a suggestion you&rsquo;d like to make to improve the post, feel free to <a href="https://twitter.com/scott_lowe">contact me on Twitter</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ovs">OVS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/fedora">Fedora</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2018/01/25/using-docker-machine-with-azure/">Using Docker Machine with Azure</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2018/02/09/technology-short-take-94/">Technology Short Take 94</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2018%2f01%2f30%2frunning-ovs-fedora-atomic-host%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f01%2f30%2frunning-ovs-fedora-atomic-host%2f&text=Running%20OVS%20on%20Fedora%20Atomic%20Host" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f01%2f30%2frunning-ovs-fedora-atomic-host%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2017/10/27/technology-short-take-89/">Technology Short Take 89</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2017/10/14/technology-short-take-88/">Technology Short Take 88</a> <span class="post-date-list">149 May 141414</span></li><li><a href="/2017/08/25/technology-short-take-86/">Technology Short Take 86</a> <span class="post-date-list">259 May 252525</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
