<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Kubernetes with Cilium and Containerd using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Kubernetes with Cilium and Containerd using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Kubernetes with Cilium and Containerd using Kubeadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2018/09/06/kubernetes-cilium-containerd-using-kubeadm/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Kubernetes with Cilium and Containerd using Kubeadm</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 69 May 6066 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1050 words (estimated 5 minutes to read)</span>
  <p>Now, if that isn&rsquo;t a title jam-packed with buzzwords, I don&rsquo;t know what is! In seriousness, though, I wanted to share how to use <code>kubeadm</code> to turn up a <a href="https://kubernetes.io/">Kubernetes</a> cluster using <a href="https://github.com/containerd/containerd">containerd</a> (instead of Docker) and <a href="https://cilium.io/">Cilium</a> as the CNI plugin. I&rsquo;m posting this because I wasn&rsquo;t able to find a reasonable article that combined <em>all</em> the different threads&mdash;some posts talked about using containerd, others talked about using Cilium, and the official Kubernetes docs have examples for using <code>kubeadm</code>. The purpose of this post is to try to pull those threads together.</p>
<p>For structure and context, I&rsquo;ll build upon the official Kubernetes document outlining <a href="https://kubernetes.io/docs/setup/independent/high-availability/">creating highly available clusters with <code>kubeadm</code></a>. You may find it helpful to pull up that article next to this one, as I won&rsquo;t be duplicating that content here. Instead, I&rsquo;ll just reference additions/changes to the process in order to accommodate containerd and Cilium.</p>
<p>Before getting started, make sure that your systems will meet the <a href="https://cilium.readthedocs.io/en/v1.2/install/system_requirements/">minimum requirements for Cilium</a>. For my testing, I used Ubuntu 16.04 with the latest HWE kernel (4.15.0-33-generic). I used a private fork of <a href="https://github.com/heptiolabs/wardroom">Wardroom</a> to build the AWS AMIs with containerd and all the Kubernetes 1.11.2 packages installed, and wrote a custom Ansible script to update the AMIs with the latest HWE kernel. (Side note: I do hope to get my containerd-related changes into Wardroom at some point in the future, so others will be able to leverage Wardroom as well.) Obviously, you can choose to manually build your own images; see the &ldquo;Additional Resources&rdquo; section for a link on how to install containerd. You&rsquo;ll want to do that before trying to turn up the Kubernetes cluster.</p>
<p>Ready? Let&rsquo;s go! I&rsquo;ll organize the content below according to the section headings from the official Kubernetes procedure for <a href="https://kubernetes.io/docs/setup/independent/high-availability/">creating highly available clusters using <code>kubeadm</code></a>.</p>
<h2 id="bootstrap-the-first-stacked-control-plane-node">Bootstrap the First Stacked Control Plane Node</h2>
<p>Up until this point, everything remains the same (no changes are needed to accommodate an alternate container runtime or a specific CNI plugin). Once you get to this point and you&rsquo;re ready to bootstrap the first control plane node, some additional changes are needed. Specifically, you need to add the following content to the <code>kubeadm</code> configuration file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">/var/run/containerd/containerd.sock</span>
</span></span></code></pre></div><p>This assumes, naturally, that you&rsquo;re using the default location for the runtime endpoint. Modify as needed.</p>
<p>I also had to do the following on my Ubuntu 16.04 nodes, but I take this as more of an issue with my images (you may not need these commands):</p>
<pre><code>modprobe br_netfilter
sysctl -w net.ipv4.ip_forward=1
</code></pre>
<p>With this content added, you&rsquo;re good to go to run <code>kubeadm init --config &lt;config-file-name&gt;</code> to bootstrap the first master. <code>kubectl get nodes</code> will report it as NotReady until you install the CNI, but that&rsquo;s OK. You can proceed with the next steps in the procedure.</p>
<h2 id="add-the-second-stacked-control-plane-node">Add the Second Stacked Control Plane Node</h2>
<p>The only change here is to (again) add this content to the <code>kubeadm</code> config file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">/var/run/containerd/containerd.sock</span>
</span></span></code></pre></div><p>You may also need to run the <code>modprobe</code> and <code>sysctl</code> commands outlined in the previous section. I suspect the need to run those commands reflects a problem in my custom AMIs.</p>
<p>Run the rest of the commands in this section as outlined, and your second control plane node should come online.</p>
<h2 id="add-the-third-stacked-control-plane-node">Add the Third Stacked Control Plane Node</h2>
<p>The same change to the <code>kubeadm</code> configuration file is needed here, along with (maybe) the <code>modprobe</code> and <code>sysctl</code> commands.</p>
<p>Once this step is complete, you&rsquo;ll have a three-node control plane up and running, although they&rsquo;ll all report NotReady in <code>kubectl get nodes</code> until you install a networking plugin. Fortunately, you&rsquo;ll tackle that next.</p>
<h2 id="install-a-pod-network">Install a Pod Network</h2>
<p>Now you&rsquo;ll start getting into some Cilium-specific stuff. For the most part, this is pretty straightforward. You can follow the instructions found <a href="https://cilium.readthedocs.io/en/v1.2/kubernetes/install/standard/">here</a>, with a few changes. I recommend downloading the Cilium-CRIO YAML file instead of the one linked in the instructions (you can find it <a href="https://github.com/cilium/cilium/blob/v1.2/examples/kubernetes/1.11/cilium-crio.yaml">here</a>). Then follow the instructions for configuring the ConfigMap for etcd and creating the TLS secrets.</p>
<p>However, before proceeding with deploying Cilium, there are a few additional changes to make to the YAML file (these notes assume you are using v1.2 of the Cilium-CRIO YAML file):</p>
<ul>
<li>On line 120, change <code>--container-runtime=crio</code> to <code>--container-runtime=containerd</code>.</li>
<li>Add a line immediately after line 120 with the contents <code>--container-runtime-endpoint=containerd=/var/run/containerd/containerd.sock</code> (follow the formatting/indentation of the previous line). Adjust the location of the runtime endpoint as needed.</li>
<li>Change line 221 from <code>crio-socket</code> to <code>containerd-socket</code>.</li>
<li>Change line 222 to <code>/var/run/containerd/containerd.sock</code>.</li>
<li>Change line 249 from <code>crio-socket</code> to <code>containerd-socket</code>.</li>
<li>Change line 251 to <code>/var/run/containerd/containerd.sock</code>.</li>
</ul>
<p>Once you have these changes in place, you can proceed with the instructions in the &ldquo;Deploying&rdquo; section of the <a href="https://cilium.readthedocs.io/en/v1.2/kubernetes/install/standard/">standard install guide</a>.</p>
<p>Assuming that Cilium deploys properly, your control plane nodes should switch from NotReady to Ready in <code>kubectl get nodes</code>, and you should see some Cilium pods scheduled and running when you run <code>kubectl -n kube-system get pods</code>.</p>
<h2 id="install-workers">Install Workers</h2>
<p>Once the control plane nodes are reporting Ready (and perhaps you&rsquo;ve done some troubleshooting with Cilium to ensure that it&rsquo;s working as expected), then you&rsquo;re ready to add worker nodes.</p>
<p>When you run <code>kubeadm init...</code> on the first stacked control plane node, it will spit out a command line you can use to join worker nodes to the Kubernetes cluster. You can use this command, but you must add one small piece. At the end of the command, add <code>--cri-socket /var/run/containerd/containerd.sock</code>. This tells <code>kubeadm</code> that this node is using containerd as the container runtime, and will enable the join operation to succeed.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p>The information is this post was based on a number of other articles along with my direct hands-on experience. Readers may want to review these other documents for additional information:</p>
<ul>
<li><a href="https://cilium.readthedocs.io/en/v1.2/gettingstarted/cilium_install_crio/">Cilium, Kubernetes, and CRI-O</a>: Although this document is focused on CRI-O, comparing the YAML manifests referenced by this document with the YAML manifests compared in the standard install guide (found <a href="https://cilium.readthedocs.io/en/v1.2/kubernetes/install/standard/">here</a>) helped me understand the differences that would be necessary for containerd.</li>
<li>The <a href="https://cilium.readthedocs.io/en/v1.2/cmdref/cilium-agent/">command reference for <code>cilium-agent</code></a></li>
<li>The <a href="https://github.com/containerd/cri/tree/master/contrib/ansible">Ansible+<code>kubeadm</code> instructions in the containerd GitHub repository</a> provided insight on how to install containerd, although the <code>kubeadm</code> instructions aren&rsquo;t complete enough (need to be combined with the official Kubernetes docs as I describe above).</li>
</ul>
<p>I hope this information is useful. If you have questions (or corrections!), please <a href="https://twitter.com/scott_lowe">hit me up on Twitter</a>. Thanks!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cilium">Cilium</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubeadm">Kubeadm</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2018/09/04/book-review-rest-api-design-rulebook/">Book Review: REST API Design Rulebook</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2018/09/07/technology-short-take-104/">Technology Short Take 104</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2018%2f09%2f06%2fkubernetes-cilium-containerd-using-kubeadm%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f09%2f06%2fkubernetes-cilium-containerd-using-kubeadm%2f&text=Kubernetes%20with%20Cilium%20and%20Containerd%20using%20Kubeadm" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f09%2f06%2fkubernetes-cilium-containerd-using-kubeadm%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2018/07/13/technology-short-take-102/">Technology Short Take 102</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2018/02/24/technology-short-take-95/">Technology Short Take 95</a> <span class="post-date-list">249 May 242424</span></li><li><a href="/2018/02/09/technology-short-take-94/">Technology Short Take 94</a> <span class="post-date-list">99 May 9099</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
