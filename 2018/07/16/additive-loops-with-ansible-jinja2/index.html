<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Additive Loops with Ansible and Jinja2 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Additive Loops with Ansible and Jinja2 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Additive Loops with Ansible and Jinja2 - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2018/07/16/additive-loops-with-ansible-jinja2/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Additive Loops with Ansible and Jinja2</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 169 May 161616 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;851 words (estimated 4 minutes to read)</span>
  <p>I don&rsquo;t know if &ldquo;additive&rdquo; is the right word, but it was the best word I could come up with to describe the sort of configuration I recently needed to address in <a href="https://www.ansible.com/">Ansible</a>. In retrospect, the solution seems pretty straightforward, but I&rsquo;ll include it here just in case it proves useful to someone else. If nothing else, it will at least show some interesting things that can be done with Ansible and Jinja2 templates.</p>
<p>First, allow me to explain the problem I was trying to solve. As you may know, Kubernetes 1.11 was recently released, and along with it a new version of <code>kubeadm</code>, the tool for bootstrapping Kubernetes clusters. As part of the new release, the Kubernetes community released <a href="https://kubernetes.io/docs/setup/independent/high-availability/">a new setup guide for using <code>kubeadm</code> to create a highly available cluster</a>. This setup guide uses new functionality in <code>kubeadm</code> to allow you to create &ldquo;stacked masters&rdquo; (control plane nodes running both the Kubernetes components as well as the etcd key-value store). Because of the way etcd clusters work, and because of the way you create HA control plane members, the process requires that you start with a single etcd node, then add the second node, and finally add the third node. If you start out with all three, then the cluster won&rsquo;t establish quorum and establishing a functional Kubernetes control plane node will fail.</p>
<p>As a result, this means the <code>kubeadm</code> configuration file used on the first Kubernetes control plane node must be written to boot a new single-node cluster. However, the <code>kubeadm</code> configuration file on the second control plane node specifies the first node and <em>adds</em> the second node. Likewise, the <code>kubeadm</code> configuration file for the third control plane node has the first and second nodes and <em>adds</em> the third node (hence my use of &ldquo;additive loops&rdquo; in the blog post title).</p>
<p>So, when I set out to automate this process using Ansible, I knew this wasn&rsquo;t going to be your standard &ldquo;run-of-the-mill&rdquo; inventory loop in a Jinja2 template&mdash;at least, that wasn&rsquo;t <em>all</em> it was going to be.</p>
<p>I arrived at a solution with three templates (one for each of the stacked masters). In the first template, the section for configuring etcd specifies the &ldquo;initial-cluster&rdquo; in the following way:</p>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">initial-cluster: &#34;{%- for host in groups[&#39;masters&#39;] -%}
{%- if loop.first -%}
{{ hostvars[host][&#39;ansible_fqdn&#39;] }}=https://{{ hostvars[host][&#39;ansible_&#39; + primary_interface][&#39;ipv4&#39;][&#39;address&#39;] }}:2380{%- endif -%}
{%- endfor -%}&#34;
</code></pre><p>The result, as you can probably determine, is that the first item in the loop&mdash;the first server in that inventory group&mdash;is the only item rendered in the template.</p>
<p>The second server was a bit more challenging, mostly because of a stupid error on my part. After accounting for my stupid error (if you must know, I was using <code>hostvars[inventory_hostname]</code> instead of <code>hostvars[host]</code>), this is where I ended:</p>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">initial-cluster: &#34;{%- for host in groups[&#39;masters&#39;] -%}
{%- if loop.first -%}
{{ hostvars[host][&#39;ansible_fqdn&#39;] }}=https://{{ hostvars[host][&#39;ansible_&#39; + primary_interface][&#39;ipv4&#39;][&#39;address&#39;] }}:2380,{%- endif -%}
{%- if (not loop.last and not loop.first) -%}
{{ hostvars[host][&#39;ansible_fqdn&#39;] }}=https://{{ hostvars[host][&#39;ansible_&#39; + primary_interface][&#39;ipv4&#39;][&#39;address&#39;] }}:2380{%- endif %}
{%- endfor -%}&#34;
</code></pre><p>This adds to the previous template by including the <code>if (not loop.last and not loop.first)</code> conditional, which&mdash;for a group of three&mdash;ends up meaning the second host in the group. Great; now we have a template for the first host which has only the first host, and a template for the second host which has both the first and second hosts listed.</p>
<p>The third and final template is, after all, a standard &ldquo;run-of-the-mill&rdquo; inventory loop:</p>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">initial-cluster: &#34;{%- for host in groups[&#39;masters&#39;] -%}
{%- if loop.last -%}
{{ hostvars[host][&#39;ansible_fqdn&#39;] }}=https://{{ hostvars[host][&#39;ansible_&#39; + primary_interface][&#39;ipv4&#39;][&#39;address&#39;] }}:2380
{%- else -%}
{{ hostvars[host][&#39;ansible_fqdn&#39;] }}=https://{{ hostvars[host][&#39;ansible_&#39; + primary_interface][&#39;ipv4&#39;][&#39;address&#39;] }}:2380,
{%- endif -%}{%- endfor -%}&#34;
</code></pre><p>This one probably requires no explanation; it simply iterates through the inventory group. The only &ldquo;special&rdquo; thing about it is knowing whether it should include a comma after the rendered text or not by testing for <code>loop.last</code>.</p>
<p>I <em>should</em> probably explain, though, the use of the <code>['ansible_' + primary_interface]</code> syntax. I needed a way to get the IP address of an interface on the target system, but the names of interfaces change depending on platform. For example, on one platform the first Ethernet interface may be called &ldquo;eth0&rdquo;; on another, it may be called &ldquo;ens0p0&rdquo; or similar. Using the &ldquo;primary_interface&rdquo; variable allows me to use the same Ansible playbooks across platforms, only needing to adjust the variable when interface names change between platforms. (This was an Ansible trick I picked up from <a href="https://twitter.com/craig_tracey/">my colleague Craig</a>.) Ansible substitutes the value of the variable when pulling the host variable to render the template. If I specify &ldquo;eth0&rdquo; as the value for &ldquo;primary_interface&rdquo;, Ansible will treat that as <code>ansible_eth0</code> and thus pull the IPv4 address for eth0 when rendering the template. Handy! (Thanks Craig!)</p>
<p>As I said, looking back on the solution now it seems simple and straightforward. There&rsquo;s probably a more elegant solution out there somewhere, but for now this will suffice. Oh, and if you&rsquo;re interested in seeing the full template or the Ansible playbook used to render the template, have a look at the <code>ansible/kubeadm-etcd-template</code> directory in <a href="https://github.com/scottslowe/learning-tools/">my GitHub &ldquo;learning-tools&rdquo; repository</a>. Enjoy!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ansible">Ansible</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/jinja2">Jinja2</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2018/07/13/technology-short-take-102/">Technology Short Take 102</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2018/07/18/spousetivities-at-vmworld-2018/">Spousevitivities at VMworld 2018</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2018%2f07%2f16%2fadditive-loops-with-ansible-jinja2%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f07%2f16%2fadditive-loops-with-ansible-jinja2%2f&text=Additive%20Loops%20with%20Ansible%20and%20Jinja2" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2018%2f07%2f16%2fadditive-loops-with-ansible-jinja2%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2018/07/13/technology-short-take-102/">Technology Short Take 102</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2018/04/27/technology-short-take-98/">Technology Short Take 98</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2018/01/05/technology-short-take-92/">Technology Short Take 92</a> <span class="post-date-list">59 May 5055</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
