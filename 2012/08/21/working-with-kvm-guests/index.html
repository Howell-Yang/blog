<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Working with KVM Guests - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Working with KVM Guests - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Working with KVM Guests - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2012/08/21/working-with-kvm-guests/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Working with KVM Guests</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 219 May 212121 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1166 words (estimated 6 minutes to read)</span>
  <p>As you may already know, my new role at EMC has me spending more time on open source projects like KVM, OpenStack, and others. Over the past few days, I&rsquo;ve been working with KVM for a bit, and I wanted to share a few things I&rsquo;ve learned along the way. Readers who are very familiar with KVM won&rsquo;t likely find anything new here (although I do encourage you to share any additional information or insight in the comments).</p>
<p>The information presented here is based on working with KVM using <a href="http://libvirt.org/index.html">libvirt</a>. For those unfamiliar with libvirt, it is an open source framework/API that can help manage multiple hypervisors and virtual machines. If you use a different management layer&mdash;such as <a href="http://www.ovirt.org/">oVirt</a>&ndash;then things might look a bit different, so keep that in mind. (My use of libvirt vs. oVirt is not an endorsement one way or another; I just happened to start with libvirt.) Also, I&rsquo;m only focusing on command-line tools here; there are a number of graphical user interfaces (GUIs) available as well, which I may investigate further at some point in the future.</p>
<h2 id="the-components-of-a-kvm-guest">The Components of a KVM Guest</h2>
<p>Let&rsquo;s start with looking at the different components of a KVM guest. If you are familiar with VMware virtualization, you know that a VMware-based VM has essentially two components:</p>
<ul>
<li>
<p>The VM definition, stored in a .VMX file</p>
</li>
<li>
<p>The VM&rsquo;s storage, typically stored in one or more .VMDK files</p>
</li>
</ul>
<p>From what I&rsquo;ve been able to determine so far, KVM guests also have essentially two components:</p>
<ul>
<li>
<p>The VM definition, defined in XML format</p>
</li>
<li>
<p>The VM&rsquo;s storage, stored either as a volume managed by an LVM or as a file stored in a file system</p>
</li>
</ul>
<p>You can look at the XML configuration of a KVM guest (more properly referred to as a domain) in a couple of different ways. Both involve the use of <code>virsh</code>, the command-line tool that is part of libvirt:</p>
<ul>
<li>
<p>To edit the configuration of a guest, use <code>virsh edit &lt;Name of guest VM&gt;</code> and the system will open the XML configuration in your default editor.</p>
</li>
<li>
<p>To export the configuration of a guest, use <code>virsh dumpxml &lt;Name of guest VM&gt;</code>. This dumps the XML configuration to STDOUT; you can redirect the output to a file if you like.</p>
</li>
</ul>
<p>Here&rsquo;s a snippet of the XML configuration for a KVM guest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;devices&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;emulator&gt;</span>/usr/bin/kvm<span style="color:#f92672">&lt;/emulator&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;disk</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#a6e22e">device=</span><span style="color:#e6db74">&#39;disk&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;driver</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#39;qemu&#39;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;raw&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">file=</span><span style="color:#e6db74">&#39;/var/lib/libvirt/images/vm01.img&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;target</span> <span style="color:#a6e22e">dev=</span><span style="color:#e6db74">&#39;hda&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;ide&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;drive&#39;</span> <span style="color:#a6e22e">controller=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">bus=</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#a6e22e">unit=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/disk&gt;</span>
</span></span></code></pre></div><p>The second component of a KVM guest is the storage; as I mentioned earlier, this can be a file on a file system or it can be a volume managed by a logical volume manager (LVM). The XML snippet above shows the configuration for a disk image stored as a file on a file system. This particular disk image is in QEMU raw format.</p>
<p>With that (very brief) overview complete, here is how you perform some common tasks with KVM guests.</p>
<h2 id="creating-a-kvm-guest">Creating a KVM Guest</h2>
<p>There are a couple of different ways to create a KVM guest:</p>
<ul>
<li>
<p>Manually create the XML definition of the guest, then use <code>virsh define &lt;Name of XML file&gt;</code> to import the definition. You could, naturally, create a new XML definition based on an existing definition and just change a few parameters.</p>
</li>
<li>
<p>Use a libvirt-compatible tool, like <code>virt-install</code>, to create the guest definition.</p>
</li>
</ul>
<p>Here&rsquo;s a quick example of creating a KVM guest using <code>virt-install</code> (I&rsquo;ve inserted backslashes and line breaks for readability):</p>
<pre><code>virt-install --name vmname --ram 1024 --vcpus=1 \
--disk path=/var/lib/libvirt/images/vmname.img,size=20 \
--network bridge=br0 \
--cdrom /var/lib/libvirt/images/os-install.iso \
--graphics vnc --noautoconsole --hvm \
--os-variant win2k3
</code></pre>
<p>This command creates a KVM guest named &ldquo;vmname&rdquo;, with 1024 MB of RAM, a single vCPU, a 20 GB virtual disk (in the default QEMU raw format, thin provisioned so that not all 20 GB are allocated up front), connected to an OS installation ISO at the path specified and using hardware virtualization. The network connection is to a bridge called <code>br0</code>, which might be a fake bridge on Open vSwitch (which in my case it is). Access to the console is handled via VNC.</p>
<p>Full details on the various parameters for <code>virt-install</code> are available via the man page (or you can look <a href="http://linux.die.net/man/1/virt-install">here</a>).</p>
<h2 id="starting-and-stopping-kvm-guests">Starting and Stopping KVM Guests</h2>
<p>This one is easy:</p>
<ul>
<li>
<p>To start a VM, just run <code>virsh start &lt;Name of guest VM&gt;</code> and you&rsquo;re off to the races.</p>
</li>
<li>
<p>To stop a VM, run <code>virsh shutdown &lt;Name of guest VM&gt;</code> and the guest will start an orderly shutdown. (BTW, I know that the orderly shutdown works for Ubuntu and Windows guests, but I haven&rsquo;t figured out the exact mechanism yet. Any insight there?)</p>
</li>
</ul>
<h2 id="changing-guest-configuration">Changing Guest Configuration</h2>
<p>If the VM is shut down, you can use the <code>virsh edit &lt;Name of guest VM&gt;</code> command to edit the XML definition directly.</p>
<p>If the VM is running, then only certain things can be done. You are supposed to be able to swap floppy or CD/DVD images using the <code>virsh qemu-monitor-command</code> command. In practice I found that it ejected CD/DVD images fine, but wouldn&rsquo;t load a new CD/DVD ISO image. I&rsquo;m still working on a fix for that one (tips are welcome).</p>
<h2 id="using-paravirtualized-drivers">Using Paravirtualized Drivers</h2>
<p>For improved performance, you can also use paravirtualized drivers. (This is the equivalent of using VMXNET3 or PVSCSI in a VMware world.) So far I&rsquo;ve only tested the network drivers on Ubuntu and Windows, but they seem to work just fine. (These paravirtualized drivers are referred to as the virtio drivers.)</p>
<p>To use virtio drivers for networking, edit the guest configuration like this (the <code>model</code> line is the line that needs to be added):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#f92672">&lt;interface</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;bridge&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;mac</span> <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#39;52:54:00:a0:55:ef&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;source</span> <span style="color:#a6e22e">bridge=</span><span style="color:#e6db74">&#39;br0&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;model</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#39;virtio&#39;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/interface&gt;</span>
</span></span></code></pre></div><p>I found <a href="https://help.ubuntu.com/community/KVM/Networking">this page</a> to be quite helpful in determining exactly how to enable the virtio network drivers. This part is the same for both Ubuntu and Windows guests; for Windows guests, you also have to install the virtio drivers into Windows. That can be a bit more problematic; I&rsquo;d recommend copying them across the network <em>before</em> making the change above.</p>
<p>This change must be made while the guest is shut down, by the way.</p>
<h2 id="cold-migrations-of-kvm-guests">Cold Migrations of KVM Guests</h2>
<p>You can probably figure out how this one works by now:</p>
<ol>
<li>
<p>Shut down the guest using <code>virsh shutdown &lt;Name of guest VM&gt;</code>.</p>
</li>
<li>
<p>Export the XML configuration using <code>virsh dumpxml &lt;Name of guest VM&gt; &gt; &lt;Name of XML file&gt;</code>.</p>
</li>
<li>
<p>Copy the XML definition you just created and the guest&rsquo;s disk image (specified in the XML configuration) to the target node.</p>
</li>
<li>
<p>Edit the XML configuration (as needed) to reflect any changes in paths.</p>
</li>
<li>
<p>Define the guest on the new node using <code>virsh define &lt;Name of XML file&gt;</code>.</p>
</li>
</ol>
<p>Obviously, this assumes an image-based disk, not a LVM-backed disk.</p>
<p>While hardly a comprehensive list of all the various operations that might need to be done with a KVM guest, hopefully this will at least get you started. I&rsquo;ll post more as I learn more, and readers are encouraged to share tips, tricks, or other information in the comments below.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kvm">KVM</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/libvirt">Libvirt</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ubuntu">Ubuntu</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/windows">Windows</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2012/08/21/my-vmworld-2012-schedule/">My VMworld 2012 Schedule</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2012/08/27/vmworld-2012-keynote-day-1/">VMworld 2012 Keynote, Day 1</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2012%2f08%2f21%2fworking-with-kvm-guests%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2012%2f08%2f21%2fworking-with-kvm-guests%2f&text=Working%20with%20KVM%20Guests" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2012%2f08%2f21%2fworking-with-kvm-guests%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2012/08/17/installing-kvm-and-open-vswitch-on-ubuntu/">Installing KVM and Open vSwitch on Ubuntu</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2012/07/06/open-source-tools-and-projects-i-should-learn/">Open Source Tools and Projects I Should Learn</a> <span class="post-date-list">69 May 6066</span></li><li><a href="/2012/06/28/installing-xcp-xapi-on-ubuntu-server-12-04-lts/">Installing XCP-XAPI on Ubuntu Server 12.04 LTS</a> <span class="post-date-list">289 May 282828</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
