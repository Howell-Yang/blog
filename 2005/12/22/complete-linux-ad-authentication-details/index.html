<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Complete Linux-AD Authentication Details - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Complete Linux-AD Authentication Details - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Complete Linux-AD Authentication Details - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2005/12/22/complete-linux-ad-authentication-details/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Complete Linux-AD Authentication Details</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 229 May 222222 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;887 words (estimated 5 minutes to read)</span>
  <p><strong>UPDATE:</strong> These instructions are for Windows 2000 Server and Windows Server 2003 pre-R2. For the R2 release, please see <a href="/2007/01/15/linux-ad-integration-version-4/">these updated instructions</a>.</p>
<p>There are several articles posted here that discuss, in general terms, how to authenticate Linux against Active Directory. For example, see this brief article on the <a href="/2005/07/13/linux-ad-integration-direction/">broad direction</a> of the integration, or this posting on <a href="/2005/07/18/minor-linux-ad-hiccup-fixed-hopefully/">using computer accounts</a> for Linux servers (most how-to documents I&rsquo;ve seen discuss the use of a user account for this purpose).</p>
<p>Over the last week or so, I&rsquo;ve been having to rebuild one Linux server a number of times in an effort to fix a separate problem (see this article on <a href="/2005/08/16/strange-ntpd-problem-on-centos-41/">NTPd problems with CentOS 4.1</a> and the <a href="/2005/12/19/ntpd-on-centos-42/">recurrence of the problem</a> with CentOS 4.2). As a result, I&rsquo;ve had to go through the process of configuring this Linux server (and preparing Active Directory) for authentication several times, and I found that I kept having to go back to my scattered and dispersed notes to remember what had to be done. In the hopes of correcting that, I am collecting all the pertinent information I have here in this article.</p>
<h3 id="preparing-active-directory-one-time">Preparing Active Directory (One-Time)</h3>
<p>There is a one-time preparation of Active Directory that is required. In order to authenticate Linux logins against Active Directory, Active Directory&rsquo;s schema must be extended to include Linux-specific attributes such as home directory, UID, GID, and default shell. There are a couple of different ways to do this; I chose to use Microsoft&rsquo;s Services for Unix (SFU) to extend the schema. There are two reasons I chose SFU: 1) it&rsquo;s free; and 2) the SFU schema is being included by default in Windows Server 2003 R2.</p>
<p>Once SFU has been installed and the schema has been extended, then the specific Active Directory accounts that are allowed to authenticate via Linux must be configured with a UID and other UNIX attributes. This is accomplished via the new &ldquo;UNIX Attributes&rdquo; tab on the properties dialog box of a user account.</p>
<p>You&rsquo;ll also need to create an account in Active Directory that will be used to bind to Active Directory for LDAP queries. This account does <em>not</em> need any special privileges; in fact, making the account a member of Domain Guests and <em>not</em> a member of Domain Users is perfectly fine.</p>
<p>After all the user accounts have been configured, then we are ready to perform the additional tasks within Active Directory and on the Linux server that will enable the authentication.</p>
<h3 id="preparing-active-directory-each-server">Preparing Active Directory (Each Server)</h3>
<p>For each server that will be authenticating against Active Directory, follow the steps below.</p>
<ol>
<li>
<p>Create a computer account in Active Directory. When creating the computer account, be sure to specify that this account may be used by a pre-Windows 2000-based computer.</p>
</li>
<li>
<p>Use the following command at a command prompt to configure the new computer account:</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ktpass -princ host/fqdn@REALM -mapuser DOMAIN\name$  
</span></span><span style="display:flex;"><span>-crypto DES-CBC-MD5 -pass password -ptype KRB5_NT_PRINCIPAL  
</span></span><span style="display:flex;"><span>-out filename
</span></span></code></pre></div><p>Of course, you&rsquo;ll need to substitute the appropriate values for &ldquo;fqdn&rdquo; (the fully-qualified domain name of the computer), &ldquo;REALM&rdquo; (the DNS name of your Active Directory domain in UPPERCASE), &ldquo;DOMAIN&rdquo; (the NetBIOS name of your Active Directory domain), &ldquo;password&rdquo; (the password that will be set for the new computer account), and &ldquo;filename&rdquo; (the keytab that will be generated and must be copied over to the Linux computer).</p>
<p>If you need to rebuild the Linux server for whatever reason, you&rsquo;ll need to delete the computer account you created and repeat this process.</p>
<h3 id="preparing-the-linux-server">Preparing the Linux Server</h3>
<p>Follow the steps below to configure the Linux server for authentication against Active Directory.</p>
<ol>
<li>
<p>Make sure that the appropriate Kerberos libraries, OpenLDAP, pam_krb5, and nss_ldap are installed. If they are not installed, install them.</p>
</li>
<li>
<p>Be sure that time is being properly synchronized between Active Directory and the Linux server in question. Kerberos requires time synchronization.</p>
</li>
<li>
<p>Edit the <code>krb5.conf</code> file to look something like <a href="https://gist.github.com/scottslowe/67a3f8c36270c7e6376b">this</a>, substituting your actual host names and domain names where appropriate.</p>
</li>
<li>
<p>Edit the <code>/etc/ldap.conf</code> file to look something like <a href="https://gist.github.com/scottslowe/722dc11cd7967c6ea12b">this</a>, substituting the appropriate host names, domain names, account names, and distinguished names (DNs) where appropriate.</p>
</li>
<li>
<p>Securely copy the file created using the <code>ktpass.exe</code> utility above to the Linux server in question, placing it in the <code>/etc</code> directory as <code>krb5.keytab</code>. (SFTP or SCP are excellent candidates for this.)</p>
</li>
<li>
<p>Configure PAM (this varies according to Linux distributions) to use pam_krb5 for authentication. Many modern distributions use a stacking mechanism whereby one file can be modified and those changes will applied to all the various PAM-aware services. For example, in Red Hat-based distributions, the system-auth file is referenced by most other PAM-aware services.</p>
</li>
<li>
<p>Edit the <code>/etc/nsswitch.conf</code> file to include &ldquo;ldap&rdquo; as a lookup source for passwd, shadow, and groups.</p>
</li>
</ol>
<p>That should be it. Once you do that, you should be able to use <code>kinit</code> from a Linux shell prompt (for example, <code>kinit aduser</code>) and generate a valid Kerberos ticket for the specified Active Directory account.</p>
<p>At this point, any PAM-aware service that is configured to use the stacked system file (such as the system-auth configuration on Red Hat-based distributions) will use Active Directory for authentication. Note, however, that unless you also add the pam_mkhomedir.so module in the PAM configuration, home directories will have to be created manually for any Active Directory account that may log on to that server. (I generally recommend the use of pam_mkhomedir.so in this situation.)</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/interoperability">Interoperability</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/activedirectory">ActiveDirectory</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kerberos">Kerberos</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ldap">LDAP</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/microsoft">Microsoft</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/oss">OSS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/windows">Windows</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2005/12/19/ntpd-on-centos-42/">NTPd on CentOS 4.2</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2005/12/23/centos-ntpd-problem-mostly-resolved/">CentOS NTPd Problem (Mostly) Resolved</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2005%2f12%2f22%2fcomplete-linux-ad-authentication-details%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2005%2f12%2f22%2fcomplete-linux-ad-authentication-details%2f&text=Complete%20Linux-AD%20Authentication%20Details" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2005%2f12%2f22%2fcomplete-linux-ad-authentication-details%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2005/07/22/linux-ad-integration-wrap-up/">Linux-AD Integration Wrap-Up</a> <span class="post-date-list">229 May 222222</span></li><li><a href="/2005/07/17/linux-ad-integration-success/">Linux-AD Integration Success!</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2005/07/09/a-new-effort/">A New Effort</a> <span class="post-date-list">99 May 9099</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
