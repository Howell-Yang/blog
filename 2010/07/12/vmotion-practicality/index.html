<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>vMotion Practicality - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="vMotion Practicality - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="vMotion Practicality - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2010/07/12/vmotion-practicality/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">vMotion Practicality</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 129 May 121212 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1263 words (estimated 6 minutes to read)</span>
  <p>About a month ago I posted an article titled <a href="/2010/06/13/the-vmotion-reality/">The vMotion Reality</a>. In that article, I challenged the assertion that vMotion was a myth, not widely implemented in data centers today due to networking complexity and networking limitations.</p>
<p>In a recent comment to that article, a reader again mentions networking limitations&mdash;in this instance, the realistic limits of a large Layer 2 broadcast domain&mdash;as a gating factor for vMotion and limiting its &ldquo;practical use&rdquo; in today&rsquo;s data centers. Based on the original article&rsquo;s assertions and the arguments found in this comment, I&rsquo;m beginning to believe that a lot of people have a basic misunderstanding of the Layer 2 adjacency requirements for vMotion and what that <em>really</em> means. In this post, I&rsquo;m going to discuss vMotion&rsquo;s Layer 2 requirements and how they interact (and don&rsquo;t interact) with other VMware networking functionality. My hope is that this article will provide a greater understanding of this topic.</p>
<p>First, I&rsquo;d like to use a diagram to help explain what we&rsquo;re discussing here. In the diagram below, there is a single ESX/ESXi host with a management interface, a vMotion interface, and a couple of network interfaces dedicated to virtual machine (VM) traffic.</p>
<p><img src="/public/img/vmotion-l2-adjacency.jpg" alt="VLAN Behaviors with VMware ESX/ESXi"></p>
<p>As you can see from this highly-simplified diagram, there are three basic types of network interfaces that ESX/ESXi uses: management interfaces, VMkernel interfaces, and VM networking interfaces. Each of them is configured separately and, in many configurations, quite differently.</p>
<p>For example, the management interface (in VMware ESX this is the Service Console interface, in VMware ESXi this is a separate instance of a VMkernel interface) is typically configured to connect to an access port with access to a single VLAN. In Cisco switch configurations, the interface configuration would look something like this:</p>
<pre><code>interface GigabitEthernet 1/1  
switchport mode access  
switchport access vlan 27  
spanning-tree portfast
</code></pre>
<p>There might be other commands present, but these are the basic recommended settings. This makes the management interfaces on an ESX/ESXi host act, look, feel, and behave just exactly like the network interfaces on pretty much every other system in the data center. Although VMware HA/DRS cluster design considerations might lead you toward certain Layer 2 boundaries, there&rsquo;s nothing stopping you from putting management interfaces from different VMware ESX/ESXi hosts in different Layer 3 VLANs and still conducting vMotion operations between them.</p>
<p>So, if it&rsquo;s not the management interfaces that are gating the practicality of vMotion in today&rsquo;s data centers, it must be the VM networking interfaces, right? Not exactly. Although the voices speaking up against vMotion in this online discussion often cite Layer 3 VLAN concerns as the primary problem with vMotion&mdash;stating, rightfully so, that the IP address of a migrated virtual machine cannot and should not change&mdash;these individuals are overlooking the recommended configuration for VM networking interfaces in a VMware ESX/ESXi environment.</p>
<p>Physical network interfaces in a VMware ESX/ESXi host that will be used for VM networking traffic are most commonly configured to act as 802.1Q VLAN trunks. For example, the Cisco switch configuration for a port connected to a network interface being used for VM networking traffic would look something like this:</p>
<pre><code>interface GigabitEthernet1/10  
switchport trunk encapsulation dot1q  
switchport mode trunk  
switchport trunk allowed vlan 1-499  
switchport trunk native vlan 499  
spanning-tree portfast trunk
</code></pre>
<p>As before, some commands might be missing or some additional commands might be present, but this gives you the basic configuration. In this configuration, the VM networking interfaces are actually capable of supporting multiple VLANs simultaneously. (More information on the configuration of VLANs with VMware ESX/ESXi can be found in <a href="/2006/12/04/esx-server-nic-teaming-and-vlan-trunking/">this aging but still very applicable article</a>.)</p>
<p>In practical use what this means is that any given VMware ESX/ESXi host could have VMs running on it that exist on a completely different and separate VLAN than the management interface. In fact, any given VMware ESX/ESXi host might have multiple VMs running across multiple separate and distinct VLANs. And as long as the ESX/ESXi hosts are properly configured to support the same VLANs, you can easily vMotion VMs between ESX/ESXi hosts when those VMs are in different VLANs. So, the net effect is that ESX/ESXi can easily support multiple VLANs at the same time for VM networking traffic, and this means that vMotion&rsquo;s practical use isn&rsquo;t gated by some inherent limitation of the VM networking interfaces themselves.</p>
<p>Where in the world, then, does this Layer 2 adjacency thing keep coming from? If it&rsquo;s not management interfaces (it isn&rsquo;t), and it&rsquo;s not VM networking interfaces (it isn&rsquo;t), then what is it? It&rsquo;s the VMkernel interface that is configured to support vMotion. In order to vMotion a VM from one ESX/ESXi host to another, each host&rsquo;s vMotion-enabled VMkernel interface has to be in the same IP subnet (i.e., in the same Layer 2 VLAN or broadcast domain). Going back to Cisco switch configurations, a vMotion-enabled VMkernel port will be configured very much like a management interface:</p>
<pre><code>interface GigabitEthernet 1/5  
switchport mode access  
switchport access vlan 37  
spanning-tree portfast
</code></pre>
<p>This means that the vMotion-enabled VMkernel port is just an access port (no 802.1Q trunking) in a single VLAN.</p>
<p>Is this really a limitation on the practical use of vMotion? Hardly. In <a href="/2010/06/13/the-vmotion-reality/">my initial rebuttal</a> of the claims against vMotion, I pointed out that because it is <em>only the VMkernel interface</em> that must share Layer 2 adjacency, all this really means is that a vMotion domain is limited to the number of vMotion-enabled VMkernel interfaces you can put into a single Layer 2 VLAN/broadcast domain. VMs are unaffected, as you saw earlier, as long as the VM networking interfaces are correctly configured to support the appropriate VLAN tags, and the management interfaces do not, generally speaking, have any significant impact.</p>
<p>Factoring in the consolidation ratio, as I did in my earlier post, and you&rsquo;ll see that it&rsquo;s possible to support very large numbers of VMs spread across as many different VLANs as you want with a small number of ESX/ESXi hosts. Consider 200 ESX/ESXi hosts&mdash;whose vMotion-enabled VMkernel interfaces would have to share a broadcast domain&mdash;with a consolidation ratio of 12:1. That&rsquo;s 2,400 VMs that can be supported across as many different VLANs simultaneously as we care to configure. Do you want 400 of those VMs in one VLAN while 300 are in a different VLAN? No problem, you only need to configure the physical switches and the virtual switches appropriately.</p>
<p>Let&rsquo;s summarize the key points here:</p>
<ol>
<li>
<p>Only the vMotion-enabled VMkernel interface needs to have Layer 2 adjacency within a data center.</p>
</li>
<li>
<p>Neither management interfaces nor VM networking interfaces require Layer 2 adjacency.</p>
</li>
<li>
<p>VM networking interfaces are easily capable of supporting multiple VLANs at the same time.</p>
</li>
<li>
<p>When the VM networking interfaces on multiple ESX/ESXi hosts are identically configured, VMs on different VLANs can be migrated with no network disruption even though the ESX/ESXi hosts themselves might all be in the same VLAN.</p>
</li>
<li>
<p>Consolidation ratios multiply the number of VMs that can be supported with Layer 2-adjacent vMotion interfaces.</p>
</li>
</ol>
<p>Based on this information, I hope it&rsquo;s clearer that vMotion is, in fact, quite practical for today&rsquo;s data centers. Yes, there are design considerations that come into play, especially when it comes to long-distance vMotion (which requires stretched VLANs between multiple sites). However, this is still an emerging use case; the far broader use case is within a single data center. Within a single data center, all the key points I provided to you apply, and there is no practical restriction to leveraging vMotion.</p>
<p>If you still disagree (or even if you agree!), feel free to speak up in the comments. Courteous and professional comments (with full disclosure, where applicable) are always welcome.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cisco">Cisco</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vlan">VLAN</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmotion">VMotion</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2010/06/28/how-to-configure-npv-on-a-nexus-5000/">How to Configure NPV on a Nexus 5000</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2010/07/12/spouse-activities-back-for-another-year/">Spouse Activities: Back for Another Year!</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2010%2f07%2f12%2fvmotion-practicality%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2010%2f07%2f12%2fvmotion-practicality%2f&text=vMotion%20Practicality" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2010%2f07%2f12%2fvmotion-practicality%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2008/03/07/configuration-for-protecting-vmotion/">Configuration for Protecting VMotion</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2010/06/13/the-vmotion-reality/">The vMotion Reality</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2008/12/19/vmware-esx-networking-articles/">VMware ESX Networking Articles</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
