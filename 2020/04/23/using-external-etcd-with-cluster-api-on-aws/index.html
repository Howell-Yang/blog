<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using External Etcd with Cluster API on AWS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using External Etcd with Cluster API on AWS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using External Etcd with Cluster API on AWS - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/04/23/using-external-etcd-with-cluster-api-on-aws/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using External Etcd with Cluster API on AWS</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 239 May 232323 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1221 words (estimated 6 minutes to read)</span>
  <p>If you&rsquo;ve used <a href="https://cluster-api.sigs.k8s.io/">Cluster API (CAPI)</a>, you may have noticed that workload clusters created by CAPI use, by default, a &ldquo;stacked master&rdquo; configuration&mdash;that is, the etcd cluster is running co-located on the control plane node(s) alongside the Kubernetes control plane components. This is a very common configuration and is well-suited for most deployments, so it makes perfect sense that this is the default. There may be cases, however, where you&rsquo;ll want to use a dedicated, external etcd cluster for your Kubernetes clusters. In this post, I&rsquo;ll show you how to use an external etcd cluster with CAPI on AWS.</p>
<p>The information in this blog post is based on <a href="https://github.com/kubernetes-sigs/cluster-api/blob/master/bootstrap/kubeadm/docs/external-etcd.md">this upstream document</a>. I&rsquo;ll be adding a little bit of AWS-specific information, since I primarily use the AWS provider for CAPI. This post is written with CAPI v1alpha3 in mind.</p>
<p>The key to this solution is building upon the fact that CAPI leverages <code>kubeadm</code> for bootstrapping cluster nodes. This puts the full power of the <code>kubeadm</code> API at your fingertips&mdash;which in turn means you have a great deal of flexibility. This is the mechanism whereby you can tell CAPI to use an external etcd cluster instead of creating a co-located etcd cluster.</p>
<p>I should note that I am referring to using CAPI to create a <em>workload cluster</em> with an external etcd environment. If you&rsquo;re not familiar with some of the CAPI terminology, check out <a href="/2019/08/26/an-introduction-to-kubernetes-cluster-api/">my introductory post</a>.</p>
<p>At a high level, the steps involved are:</p>
<ol>
<li>Create the required Secrets in the management cluster.</li>
<li>Modify the CAPI manifests to reference the external etcd cluster.</li>
<li>Profit!</li>
</ol>
<p>Let&rsquo;s take a look at these two steps in more detail. (I&rsquo;ll omit step 3.) Note that I&rsquo;m not going to cover the process of establishing the etcd cluster, as that&rsquo;s something I&rsquo;ve covered sufficiently elsewhere (like <a href="/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">here</a>, <a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">here</a>, or <a href="/2020/04/02/setting-up-etcd-with-kubeadm-containerd-edition/">here</a>).</p>
<h2 id="creating-the-required-secrets">Creating the Required Secrets</h2>
<p>When bootstrapping a typical workload cluster with a stacked master configuration, <code>kubeadm</code> typically generates all the necessary public key infrastructure (certificate authority and associated certificates). In the case of an external etcd cluster, though, some of these certificates already exist, and you need a mechanism to provide those to CAPI.</p>
<p><a href="https://cluster-api.sigs.k8s.io/tasks/certs/using-custom-certificates.html">This page</a> gave me the first hint on how it should be handled, and <a href="https://github.com/kubernetes-sigs/cluster-api/blob/master/bootstrap/kubeadm/docs/external-etcd.md">this upstream document</a> finishes it out. Using Kubernetes Secrets, you can provide the certificates necessary to CAPI.</p>
<p>To create the required Secrets, you&rsquo;ll need four files from the etcd cluster:</p>
<ol>
<li>The etcd certificate authority (CA) certificate</li>
<li>The etcd CA&rsquo;s private key</li>
<li>The API server etcd client certificate</li>
<li>The API server etcd client private key</li>
</ol>
<p>Files #1 and #2 are, in the event of a typical <code>kubeadm</code>-bootstrapped etcd cluster, found at <code>/etc/kubernetes/pki/etcd/ca.{crt,key}</code>. Files #3 and #4 are typically found at <code>/etc/kubernetes/pki/apiserver-etcd-client.{crt,key}</code>. (Keep in mind these paths may change depending on how the etcd cluster was created.)</p>
<p>Once you have this files, create the first Secret using this command:</p>
<pre><code>kubectl create secret tls &lt;cluster-name&gt;-apiserver-etcd-client \
--cert /path/to/apiserver-etcd-client.crt \
--key /path/to/apiserver-etcd-client.key
</code></pre>
<p>Next, create the second Secret with this command:</p>
<pre><code>kubectl create secret tls &lt;cluster-name&gt;-etcd \
--cert /path/to/etcd/ca.crt --key /path/to/etcd/ca.key
</code></pre>
<p>In both of these commands, you&rsquo;ll need to replace <code>&lt;cluster-name&gt;</code> with the name of the workload cluster you&rsquo;re going to create with CAPI.</p>
<p>If you are going to create your workload cluster in a specific namespace on the management cluster, you&rsquo;ll want to be sure you create these Secrets in the same namespace.</p>
<p>Once the Secrets are in place, the next step is to modify the CAPI manifests.</p>
<h2 id="updating-the-capi-manifests">Updating the CAPI Manifests</h2>
<p>The first change is configuring the CAPI manifests to use an external etcd cluster. CAPI v1alpha3 introduces the KubeadmControlPlane object, and the KubeadmControlPlane object has a KubeadmConfigSpec that contains the equivalent of a valid <code>kubeadm</code> configuration file. This is the section you&rsquo;ll need to modify to instruct CAPI to create a workload cluster with an external etcd cluster.</p>
<p>Here&rsquo;s a snippet (unrelated entries have been removed for the sake of brevity) of YAML to add to the KubeadmControlPlane object in order to use an external etcd cluster:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeadmConfigSpec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterConfiguration</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">external</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">https://ip-10-11-12-13.us-west-2.compute.internal:2379</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">https://ip-10-11-14-15.us-west-2.compute.internal:2379</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">https://ip-10-11-16-17.us-west-2.compute.internal:2379</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">caFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">certFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-etcd-client.crt</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">keyFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/apiserver-etcd-client.key</span>
</span></span></code></pre></div><p>Obviously, you&rsquo;d want to use the correct hostnames for the nodes in the external etcd cluster (the names above have been randomized). The certificate files referenced here will be created by CAPI using the Secrets created in the previous section.</p>
<p>The second change is to instruct CAPI to use the existing VPC where the etcd cluster resides. (Technically, this isn&rsquo;t required, but this sidesteps the need for VPC peering and similar configurations). For that, you can refer to <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/master/docs/existing-aws-infrastructure.md">the upstream documentation for using existing AWS infrastructure</a>, which indicates you need to add the following to your CAPI workload manifest (this is in the spec field for the AWSCluster object):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">networkSpec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vpc</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">id</span>: <span style="color:#ae81ff">vpc-0123456789abcdef0</span>
</span></span></code></pre></div><p>You will want to ensure that your existing AWS infrastructure is appropriately configured for use with CAPI; again, refer to <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/master/docs/existing-aws-infrastructure.md">the upstream documentation</a> for full details.</p>
<p>The third and final step is to ensure the new CAPI workload cluster is able to communicate with the existing external etcd cluster. On AWS, that means configuring security groups appropriately to ensure access to the etcd cluster. As I explained in <a href="/2020/04/22/using-existing-aws-security-groups-with-cluster-api/">this post on using existing AWS security groups with CAPI</a>, you&rsquo;ll want to configure your CAPI manifest to reference the existing AWS security group that permits access to your etcd cluster. That would look something like this in the AWSMachineTemplate that&rsquo;s referenced by the KubeadmControlPlane object:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">additionalSecurityGroups</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">&lt;etcd_security_group_id&gt;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">&lt;any_other_needed_security_group_id&gt;</span>
</span></span></code></pre></div><p>Once you&rsquo;ve modified the manifests for the CAPI workload cluster&mdash;adding the etcd section to the KubeadmConfigSpec, specifying the existing VPC, and adding any necessary security group IDs in the AWSMachineTemplate for the KubeadmControlPlane object&mdash;then you can create the CAPI cluster by applying the modified manifest with <code>kubectl apply -f manifest.yaml</code> when your <code>kubectl</code> context is set to your CAPI management cluster.</p>
<p>Everything <em>should</em> work fine, but in the event you run into issues be sure to check the CAPI and CAPI provider logs (using <code>kubectl logs</code>) in the management cluster for entries that will point you in the right direction to help resolve the problem.</p>
<h2 id="caveatsdisclaimer">Caveats/Disclaimer</h2>
<p>Although this is a supported configuration with CAPI, you should be aware that you are giving up etcd management/upgrades via CAPI with this arrangement. It will fall on you, the cluster operator, to manage etcd upgrades and the lifecycle of the etcd cluster. Because you&rsquo;re also leveraging existing AWS infrastructure, you&rsquo;re also giving up CAPI management of that infrastructure. These may be acceptable trade-offs for your specific use case, but be sure to take that into consideration.</p>
<h2 id="how-i-tested">How I Tested</h2>
<p>To test this procedure, I used <a href="https://www.pulumi.com/">Pulumi</a> to create some existing AWS infrastructure, in according with <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/master/docs/existing-aws-infrastructure.md">the upstream project&rsquo;s guidelines for using existing AWS infrastructure</a>. In that existing infrastructure, the Pulumi code created three instances that I then set up as an etcd cluster using <code>kubeadm</code> (using a variation of <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/">these instructions</a>). Once the external etcd cluster had been established, then I proceeded with testing the configuration and procedure outlined above.</p>
<p>Please don&rsquo;t hesitate to contact me if you have any questions, or if you spot an error in this post. All constructive feedback is welcome! You can contact <a href="https://twitter.com/scott_lowe">me on Twitter</a>, or feel free to contact me via <a href="https://kubernetes.slack.com">the Kubernetes Slack instance</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/pulumi">Pulumi</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/04/22/using-existing-aws-security-groups-with-cluster-api/">Using Existing AWS Security Groups with Cluster API</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/04/23/setting-up-etcd-with-etcdadm/">Setting up etcd with etcdadm</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fusing-external-etcd-with-cluster-api-on-aws%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fusing-external-etcd-with-cluster-api-on-aws%2f&text=Using%20External%20Etcd%20with%20Cluster%20API%20on%20AWS" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fusing-external-etcd-with-cluster-api-on-aws%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2019/09/09/consuming-preexisting-aws-infrastructure-with-cluster-api/">Consuming Pre-Existing AWS Infrastructure with Cluster API</a> <span class="post-date-list">99 May 9099</span></li><li><a href="/2020/04/22/using-existing-aws-security-groups-with-cluster-api/">Using Existing AWS Security Groups with Cluster API</a> <span class="post-date-list">229 May 222222</span></li><li><a href="/2020/03/26/ha-kubernetes-clusters-on-aws-with-cluster-api-v1alpha3/">HA Kubernetes Clusters on AWS with Cluster API v1alpha3</a> <span class="post-date-list">269 May 262626</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
