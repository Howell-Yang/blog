<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Setting up etcd with etcdadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Setting up etcd with etcdadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Setting up etcd with etcdadm - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/04/23/setting-up-etcd-with-etcdadm/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Setting up etcd with etcdadm</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 239 May 232323 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;662 words (estimated 4 minutes to read)</span>
  <p>I&rsquo;ve written a few different posts on setting up <a href="https://etcd.io/">etcd</a>. There&rsquo;s this one on <a href="/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">bootstrapping a TLS-secured etcd cluster with <code>kubeadm</code></a>, and there&rsquo;s this one about <a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">using <code>kubeadm</code> to run an etcd cluster as static Pods</a>. There&rsquo;s also this one about <a href="/2020/04/02/setting-up-etcd-with-kubeadm-containerd-edition/">using <code>kubeadm</code> to run etcd with containerd</a>. In this article, I&rsquo;ll provide yet another way of setting up a &ldquo;best practices&rdquo; etcd cluster, this time using a tool named <code>etcdadm</code>.</p>
<p><code>etcdadm</code> is <a href="https://github.com/kubernetes-sigs/etcdadm/">an open source project</a>, originally started by Platform9 (here&rsquo;s <a href="https://platform9.com/blog/were-open-sourcing-etcdadm-heres-what-it-means-for-kubernetes-in-production/">the blog post</a> announcing the project being open sourced). As the README in the GitHub repository mentions, the user experience for <code>etcdadm</code> &ldquo;is inspired by <code>kubeadm</code>.&rdquo;</p>
<h2 id="getting-etcdadm">Getting <code>etcdadm</code></h2>
<p>The instructions in the repository indicate that you can use <code>go get -u sigs.k8s.io/etcdadm</code>, but I ran into problems with that approach (using Go 1.14). At the suggestion of the one of the maintainers, I also tried Go 1.12, but it failed both on my main Ubuntu laptop as well as on a clean Ubuntu VM. However, running <code>make etcdadm</code> in a clone of the repository worked, and one of the maintainers indicated the documentation will be updated to reflect this approach instead. So, for now, it would appear that cloning the GitHub repository and running <code>make etcdadm</code> is your best approach for obtaining a binary build of the tool.</p>
<h2 id="setting-up-an-etcd-cluster">Setting up an Etcd Cluster</h2>
<p>Once you have a binary build of <code>etcdadm</code>, the process for setting up an etcd cluster is&mdash;as the documentation in the repository indicates&mdash;pretty straightforward.</p>
<ol>
<li>
<p>First, copy the <code>etcdadm</code> binary to the system(s) that will comprise the cluster.</p>
</li>
<li>
<p>On the system that will be the first node in the cluster, run <code>etcdadm init</code>. This will create a certificate authority (CA) for the TLS certs, then use that CA to create TLS certificates for the etcd node. Finally, it will bootstrap the etcd cluster with one only member, itself, and then will output a command to run on subsequent nodes. The command will look something like <code>etcdadm join https://10.11.12.13:2379</code>.</p>
<p>As part of the bootstrapping process, <code>etcdadm</code> will install the <code>etcd</code> and <code>etcdctl</code> binaries (the default location is into <code>/opt/bin</code>), and will create a systemd unit to run etcd as a service. You can use <code>systemctl</code> to check the status of the etcd unit, and you can use <code>etcdctl</code> to check the health of the cluster (among other things).</p>
</li>
<li>
<p>Copy the CA certificate and key from the first node to the next node you&rsquo;re going to add to the cluster. The CA certificate and key are found as <code>/etc/etcd/pki/ca.crt</code> and <code>/etc/etcd/pki/ca.key</code>, respectively. Place these files in the same location on the next node, then run the command output by <code>etcdadm init</code> in the previous step.</p>
</li>
<li>
<p>Repeat step 3 for each additional node you add to the cluster, keeping in mind you should use odd numbers of nodes in the cluster. Generally speaking, a cluster of 3 nodes will work just fine in the vast majority of cases.</p>
</li>
</ol>
<p>Once you&rsquo;ve added the desired number of nodes to the etcd cluster, you can use this <code>etcdctl</code> command to check the health of the cluster:</p>
<pre><code>ETCDCTL_API=3 /opt/bin/etcdctl --cert /etc/etcd/pki/peer.crt \
--key /etc/etcd/pki/peer.key --cacert /etc/etcd/pki/ca.crt \
--endpoints https://10.45.88.87:2379 endpoint health --cluster
</code></pre>
<p>Assuming you get healthy responses to the above command, you&rsquo;re good to go. Pretty easy, right? This is why I tweeted earlier today that I think there is real promise in this tool.</p>
<h2 id="how-i-tested">How I Tested</h2>
<p>To test <code>etcdadm</code>, I first used <a href="https://www.vagrantup.com">Vagrant</a> to spin up an Ubuntu 18.04 VM for building the <code>etcdadm</code> binary. After I had the binary, I used <a href="https://www.pulumi.com/">Pulumi</a> to launch three AWS EC2 instances in their own VPC. I then used these instances to test the process of bootstrapping the etcd cluster using <code>etcdadm</code>.</p>
<p>While <code>etcdadm</code> is still an early project, I would recommend keeping an eye on its development. In the meantime, I&rsquo;d love to hear any feedback from you, so feel free to find <a href="https://twitter.com/scott_lowe">me on Twitter</a> or hit me up on <a href="https://kubernetes.slack.com">the Kubernetes Slack instance</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/04/23/using-external-etcd-with-cluster-api-on-aws/">Using External Etcd with Cluster API on AWS</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/04/24/technology-short-take-126/">Technology Short Take 126</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fsetting-up-etcd-with-etcdadm%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fsetting-up-etcd-with-etcdadm%2f&text=Setting%20up%20etcd%20with%20etcdadm" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f04%2f23%2fsetting-up-etcd-with-etcdadm%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/04/02/setting-up-etcd-with-kubeadm-containerd-edition/">Setting up etcd with Kubeadm, containerd Edition</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2018/10/29/more-on-setting-up-etcd-with-kubeadm/">More on Setting up etcd with Kubeadm</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2018/08/21/bootstrapping-etcd-cluster-with-tls-using-kubeadm/">Bootstrapping an etcd Cluster with TLS using Kubeadm</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
