<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Setting up K8s on AWS with Kubeadm and Manual Certificate Distribution - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Setting up K8s on AWS with Kubeadm and Manual Certificate Distribution - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Setting up K8s on AWS with Kubeadm and Manual Certificate Distribution - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/02/18/setting-up-k8s-on-aws-kubeadm-manual-certificate-distribution/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Setting up K8s on AWS with Kubeadm and Manual Certificate Distribution</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 189 May 181818 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1243 words (estimated 6 minutes to read)</span>
  <p><em>Credit for this post goes to Christian Del Pino, who created this content and was willing to let me publish it here.</em></p>
<p>The topic of setting up Kubernetes on AWS (including the use of the AWS cloud provider) is a topic I&rsquo;ve tackled a few different times here on this site (see <a href="/2018/09/28/setting-up-the-kubernetes-aws-cloud-provider/">here</a>, <a href="/2019/02/18/kubernetes-kubeadm-and-the-aws-cloud-provider/">here</a>, and <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">here</a> for other posts on this subject). In this post, I&rsquo;ll share information provided to me by a reader, Christian Del Pino, about setting up Kubernetes on AWS with <code>kubeadm</code> but using manual certificate distribution (in other words, not allowing <code>kubeadm</code> to distribute certificates among multiple control plane nodes). As I pointed out above, all this content came from Christian Del Pino; I&rsquo;m merely sharing it here with his permission.</p>
<p>This post specifically builds upon <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">this post on setting up an AWS-integrated Kubernetes 1.15 cluster</a>, but is written for Kubernetes 1.17. As mentioned above, this post will also show you how to manually distribute the certificates that <code>kubeadm</code> generates to other control plane nodes.</p>
<p>What this post <em>won&rsquo;t</em> cover are the details on some of the prerequisites for making the AWS cloud provider function properly; specifically, this post won&rsquo;t discuss:</p>
<ul>
<li>Setting node hotnames to match EC2&rsquo;s Private DNS entry</li>
<li>Creating and assigning the IAM instance profile to allow access to the AWS APIs</li>
<li>Assigning the correct tags to AWS resources as required by the AWS cloud provider</li>
</ul>
<p>I encourage you to refer to the link above for details on these specific areas.</p>
<p>Now, let&rsquo;s take a look at the process that Christian tested and shared with me.</p>
<h2 id="bootstrapping-the-first-control-plane-node">Bootstrapping the First Control Plane Node</h2>
<p>To build the first control plane node, you need to setup a configuration file that will be used by <code>kubeadm</code> to perform an initialization. (Again, this assumes all necessary prerequisites described above have been satisfied.) Here is a sample configuration file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterName</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlaneEndpoint</span>: <span style="color:#ae81ff">cp-nlb.elb.us-east-2.amazonaws.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controllerManager</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configure-cloud-routes</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">v1.17.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSubnet</span>: <span style="color:#ae81ff">192.168.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">InitConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeletExtraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span></code></pre></div><p>The explanation of this configuration file is already pretty well-covered <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">in this earlier post</a>.</p>
<p>Once you have the configuration file set to your liking, run the
following command to setup your first control plane:</p>
<pre><code>kubeadm init --config=init.yaml
</code></pre>
<p>(Replace <code>init.yaml</code> with the correct filename, of course.)</p>
<p>Assuming the process of initializing the first control plane node works as expected, then the next step is to install a CNI plugin, as documented <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">here</a>.</p>
<p>To confirm that your first control plane is up and ready, just run this command:</p>
<pre><code>kubectl get nodes
</code></pre>
<p>If this command completes successfully and shows the first control plane node as &ldquo;Ready,&rdquo; then you are now ready to add more control plane nodes. However, since the <code>--upload-certs</code> flag was not specified during the <code>kubeadm init</code> command, the certificates generated on the first control plane node will not be shared across all the control plane nodes automatically. The next section explains how to manually copy the appropriate files across to additional control plane nodes.</p>
<h2 id="manually-distributing-certificates">Manually Distributing Certificates</h2>
<p>There are a couple different reasons why a user might prefer to manually distribute certificates. First, the encryption key used by the <code>--upload-certs</code> flag expires after two hours. Therefore, it has been more than two hours, you need to <em>either</em> run <code>kubeadm init phase upload-certs</code> <em>or</em> manually copy the certificates across to other nodes. Second, you may want to use automation tools to deploy your cluster. One way to copy the certificates is to use <code>ssh</code> and <code>scp</code>, as described in the <code>kubeadm</code> documentation <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/#manual-certs">here</a>.</p>
<p>You could also use S3 as a means of distributing certificates (more on that shortly).</p>
<p>Regardless of the method, here is the exact list of certificates that need to be copied over from the first control plane node:</p>
<pre><code>/etc/kubernetes/pki/etcd/ca.key
/etc/kubernetes/pki/etcd/ca.crt
/etc/kubernetes/pki/sa.key
/etc/kubernetes/pki/sa.pub
/etc/kubernetes/pki/front-proxy-ca.crt
/etc/kubernetes/pki/front-proxy-ca.key
/etc/kubernetes/pki/ca.crt
/etc/kubernetes/pki/ca.key
</code></pre>
<p>If you&rsquo;d like to use <code>scp</code>, then simply copy these files across to the EC2 instance(s) you&rsquo;d like to use as additional control plane nodes.</p>
<p>Since this cluster will be using the AWS cloud provider, EC2 instances have to be booted with an IAM instance profile that enables access to the AWS APIs. If that IAM instance profile includes S3 permissions, and if you can install the AWS CLI tools on the EC2 instances, you can use the <code>aws s3 cp</code> command to upload the certificates to a bucket of your choice (just ensure the bucket permissions are appropriately secured). Once the certificates are uploaded to S3 (or copied over), you can proceed to add more control plane nodes.</p>
<h2 id="adding-additional-control-plane-nodes">Adding Additional Control Plane Nodes</h2>
<p>Before adding more control planes, it is necessary to pull down the
certificates from the S3 bucket using the <code>aws s3 cp</code> command into the
/etc/kubernetes/pki directory (if you didn&rsquo;t copy them across directly using <code>scp</code>). You must keep the same structure as in the first control plane:</p>
<pre><code>/etc/kubernetes/pki/etcd/ca.key
/etc/kubernetes/pki/etcd/ca.crt
/etc/kubernetes/pki/sa.key
/etc/kubernetes/pki/sa.pub
/etc/kubernetes/pki/front-proxy-ca.crt
/etc/kubernetes/pki/front-proxy-ca.key
/etc/kubernetes/pki/ca.crt
/etc/kubernetes/pki/ca.key
</code></pre>
<p>Once the certificates are in place, you can build the configuration
file for your joining control planes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">JoinConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bootstrapToken</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">token</span>: <span style="color:#ae81ff">123456.</span><span style="color:#ae81ff">i2v5ub39hrvf51j3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiServerEndpoint</span>: <span style="color:#ae81ff">cp-nlb.elb.us-east-2.amazonaws.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">caCertHashes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;sha256:082feed98fb5fd2b497472fb7d9553414e27ff7eeb7b919c82ff3a08fdf5782f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ip-10-10-100-155.us-east-2.compute.internal</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeletExtraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlane</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">localAPIEndpoint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">advertiseAddress</span>: <span style="color:#ae81ff">10.10.100.155</span>
</span></span></code></pre></div><p>Refer back to <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">the earlier post</a> for information on the parameters in this configuration file. The key difference here is that the configuration file does not include the <code>certificateKey</code> parameter since the original <code>kubeadm init</code> command did not include the <code>--upload-certs</code> flag.</p>
<p>Once the file is complete, proceed to run the following to join your
additional control plane nodes:</p>
<pre><code>kubeadm join --config=cp-join.yaml
</code></pre>
<p>(Replace <code>cp-join.yaml</code> with the correct filename you used.)</p>
<p>Once run, the new control plane node should join the cluster. You can confirm that the additional control planes have joined the cluster by running <code>kubectl get nodes</code> and make sure the additional nodes are reporting as &ldquo;Ready&rdquo;.</p>
<h2 id="adding-worker-nodes">Adding Worker Nodes</h2>
<p>Adding worker nodes is simple. There are no certificates to copy and the
<code>kubeadm</code> configuration to join the cluster is similar to that of the
joining control plane nodes. Here is a sample:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">JoinConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bootstrapToken</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">token</span>: <span style="color:#ae81ff">123456.</span><span style="color:#ae81ff">i2v5ub39hrvf51j3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiServerEndpoint</span>: <span style="color:#e6db74">&#34;cp-nlb.elb.us-east-2.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">caCertHashes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;sha256:082feed98fb5fd2b497472fb7d9553414e27ff7eeb7b919c82ff3a08fdf5782f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ip-10-10-100-133.us-east-2.compute.internal</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeletExtraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span></code></pre></div><p>As outlined here, you&rsquo;ll need to be sure your version of this file uses the correct bootstrap token, the correct API server endpoint, the correct CA certificate hash, and the correct node name. Once the file is complete, you will run the following to join your worker nodes:</p>
<pre><code>kubeadm join --config=worker-join.yaml
</code></pre>
<p>(Substitute the filename you used for <code>worker-join.yaml</code> in the above command.)</p>
<p>Upon running this command, the worker node should join the cluster. Once again, you can use <code>kubectl get nodes</code> to verify that the node(s) have joined the cluster.</p>
<h2 id="summary">Summary</h2>
<p>As you can see above, the process that Christian shared with me is extremely similar to what I shared <a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">here</a>, with the exception of manually distributing the certificates (and Christian mentions a couple very good reasons above why manual certificate distribution may be preferred). This post also shows that the process for establishing an AWS-integrated Kubernetes cluster is consistent for versions 1.15, 1.16, and 1.17 (you just need to change the <code>kubernetesVersion</code> value in the configuration file you use to bootstrap the first control plane node).</p>
<p>I hope this information is helpful. Thanks to Christian for sharing this information with me and allowing me to publish it here. If you have any questions, feel free to <a href="https://twitter.com/scott_lowe">hit me on Twitter</a> or find me on <a href="https://kubernetes.slack.com">the Kubernetes Slack instance</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubeadm">Kubeadm</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/02/05/building-an-isolated-kubernetes-cluster-on-aws/">Building an Isolated Kubernetes Cluster on AWS</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/02/19/retrieving-kubeconfig-cluster-api-workload-cluster/">Retrieving the Kubeconfig for a Cluster API Workload Cluster</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f02%2f18%2fsetting-up-k8s-on-aws-kubeadm-manual-certificate-distribution%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f02%2f18%2fsetting-up-k8s-on-aws-kubeadm-manual-certificate-distribution%2f&text=Setting%20up%20K8s%20on%20AWS%20with%20Kubeadm%20and%20Manual%20Certificate%20Distribution" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f02%2f18%2fsetting-up-k8s-on-aws-kubeadm-manual-certificate-distribution%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2019/08/14/setting-up-aws-integrated-kubernetes-115-cluster-kubeadm/">Setting up an AWS-Integrated Kubernetes 1.15 Cluster with Kubeadm</a> <span class="post-date-list">149 May 141414</span></li><li><a href="/2019/04/16/using-kubeadm-add-new-control-plane-nodes-aws-integration/">Using Kubeadm to Add New Control Plane Nodes with AWS Integration</a> <span class="post-date-list">169 May 161616</span></li><li><a href="/2019/02/18/kubernetes-kubeadm-and-the-aws-cloud-provider/">Kubernetes, Kubeadm, and the AWS Cloud Provider</a> <span class="post-date-list">189 May 181818</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
