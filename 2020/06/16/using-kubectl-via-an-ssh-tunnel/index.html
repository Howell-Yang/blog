<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Using kubectl via an SSH Tunnel - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Using kubectl via an SSH Tunnel - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Using kubectl via an SSH Tunnel - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/06/16/using-kubectl-via-an-ssh-tunnel/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Using kubectl via an SSH Tunnel</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 169 May 161616 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;700 words (estimated 4 minutes to read)</span>
  <p>In this post, I&rsquo;d like to share one way (not the only way!) to use <code>kubectl</code> to access your <a href="https://kubernetes.io/">Kubernetes</a> cluster via an SSH tunnel. In the future, I may explore some other ways (hit <a href="https://twitter.com/scott_lowe">me on Twitter</a> if you&rsquo;re interested). I&rsquo;m sharing this information because I suspect it is not uncommon for folks deploying Kubernetes on the public cloud to want to deploy them in a way that does not expose them to the Internet. Given that the use of SSH bastion hosts is not uncommon, it seemed reasonable to show how one could use an SSH tunnel to reach a Kubernetes cluster behind an SSH bastion host.</p>
<p>If you&rsquo;re unfamiliar with SSH bastion hosts, see <a href="/2015/11/21/using-ssh-bastion-host/">this post</a> for an overview.</p>
<p>To use <code>kubectl</code> via an SSH tunnel through a bastion host to a Kubernetes cluster, there are two steps required:</p>
<ol>
<li>The Kubernetes API server needs an appropriate Subject Alternative Name (SAN) on its certificate.</li>
<li>The Kubeconfig file needs to be updated to reflect the tunnel details.</li>
</ol>
<h2 id="ensuring-an-appropriate-san-for-the-api-server">Ensuring an Appropriate SAN for the API Server</h2>
<p>As is the case with just about any TLS-secured connection, if the destination to which you&rsquo;re connecting with <code>kubectl</code> doesn&rsquo;t match any of the SANs on the API server&rsquo;s certificate, the <code>kubectl</code> commands will fail with an error (server name mismatch or similar). In the case of wanting to use an SSH tunnel with <code>kubectl</code>, this means that the API server certificate is going to need a SAN entry for <code>127.0.0.1</code>. Why <code>127.0.0.1</code>? Although there are several different ways to use SSH tunnels, in this instance you&rsquo;re going to take a local port and forward that local port across the tunnel to a remote system and remote port. Thus, <code>kubectl</code> will be talking to a local port (a port listening on <code>127.0.0.1</code>)&mdash;and now you see why this SAN is needed on the API server.</p>
<p>For existing clusters, this means you&rsquo;ll have to go back and <a href="/2019/07/30/adding-a-name-to-kubernetes-api-server-certificate/">add a name to the Kubernetes API server certificate</a>.</p>
<p>For new clusters, you can &ldquo;bake&rdquo; the extra SAN in easily with a <code>kubeadm</code> configuration file. This YAML snippet shows how:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certSANs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span></code></pre></div><p>(See <a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2">here</a> for the full reference of the <code>kubeadm</code> v1beta2 API.)</p>
<p>For new workload clusters spawned by <a href="https://cluster-api.sigs.k8s.io/">Cluster API</a>, you can add the SAN via the KubeadmConfigSpec, part of the KubeadmControlPlane object, as shown in this YAML (this is for CAPI v1alpha3):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">controlplane.cluster.x-k8s.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeadmControlPlane</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeadmConfigSpec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clusterConfiguration</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">certSANs</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span></code></pre></div><p>Regardless of the method you use, the commands outlined in <a href="/2018/08/20/troubleshooting-tls-certificates/">this article</a> and <a href="/2018/06/12/examining-x509-certificates-embedded-in-kubeconfig-files/">this article</a> can be re-purposed to help you verify that <code>127.0.0.1</code> is indeed listed as a SAN on the API server&rsquo;s certificate.</p>
<p>One the API server&rsquo;s certificate is correctly configured, then you&rsquo;re ready for step 2&mdash;updating the Kubeconfig.</p>
<h2 id="updating-the-kubeconfig-with-ssh-tunnel-information">Updating the Kubeconfig with SSH Tunnel Information</h2>
<p>The change to the Kubeconfig file for your cluster is pretty straightforward:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusters</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">certificate-authority-data</span>: <span style="color:#ae81ff">&lt;redacted&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#server: https://api.server.address:6443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">https://127.0.0.1:12345</span>
</span></span></code></pre></div><p>Substitute the <code>12345</code> in the command above for whatever local port you&rsquo;re going to forward across the SSH tunnel. Don&rsquo;t worry; you can change this later without any major ramifications (the API server certificate doesn&rsquo;t have any port information, so this is easily changed as needed). I prefer to leave the original <code>server</code> line in the file but commented out, just in case I need that information later.</p>
<p>Once the SAN entry for <code>127.0.0.1</code> is on the API server certificate and your local Kubeconfig file has been updated, then it is just a matter of opening the SSH tunnel:</p>
<pre><code>ssh -fNT -L 12345:api.server.address:6443 user@ssh-bastion-host
</code></pre>
<p><em>(Your <code>ssh</code> parameters may be slightly different, depending on your SSH version and OS.)</em></p>
<p>Again, change <code>12345</code> to match whatever you specified in the Kubeconfig file. After you&rsquo;ve established the tunnel, then running <code>kubectl</code> commands should work without any issues. Voila!</p>
<p>As I mentioned at the start of this post, this is just one way of using SSH to help access a Kubernetes cluster that isn&rsquo;t otherwise directly accessible. There are other ways! If you&rsquo;re interested in having me explore some of those other ways in future posts, let me know&mdash;either find <a href="https://twitter.com/scott_lowe">me on Twitter</a> or on <a href="https://cluster-api.sigs.k8s.io/">the Kubernetes Slack community</a>.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ssh">SSH</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/06/10/making-it-easier-to-get-started-with-cluster-api-on-aws/">Making it Easier to Get Started with Cluster API on AWS</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/06/19/technology-short-take-128/">Technology Short Take 128</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f16%2fusing-kubectl-via-an-ssh-tunnel%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f16%2fusing-kubectl-via-an-ssh-tunnel%2f&text=Using%20kubectl%20via%20an%20SSH%20Tunnel" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f16%2fusing-kubectl-via-an-ssh-tunnel%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/04/24/technology-short-take-126/">Technology Short Take 126</a> <span class="post-date-list">249 May 242424</span></li><li><a href="/2020/03/02/technology-short-take-124/">Technology Short Take 124</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2019/12/27/technology-short-take-122/">Technology Short Take 122</a> <span class="post-date-list">279 May 272727</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
