<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Creating a Multi-AZ NAT Gateway with Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Creating a Multi-AZ NAT Gateway with Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Creating a Multi-AZ NAT Gateway with Pulumi - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/06/09/creating-multi-az-nat-gateway-with-pulumi/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Creating a Multi-AZ NAT Gateway with Pulumi</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 99 May 9099 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;565 words (estimated 3 minutes to read)</span>
  <p>I recently had a need to test a configuration involving the use of a single NAT Gateway servicing multiple private subnets across multiple availability zones (AZs) within a single VPC. While there are notable caveats with such a design (see the &ldquo;Caveats&rdquo; section at the bottom of this article), it could make sense in some use cases. In this post, I&rsquo;ll show you how I used <a href="https://www.typescriptlang.org/">TypeScript</a> with <a href="https://www.pulumi.com/">Pulumi</a> to automate the creation of this design.</p>
<p>For the most part, if you&rsquo;re familiar with Pulumi and using TypeScript with Pulumi, this will be pretty straightforward. The code I&rsquo;ll show you makes a couple assumptions:</p>
<ol>
<li>It assumes you&rsquo;ve already created the VPC and the subnets earlier in the code. I&rsquo;ll reference the VPC object as <code>vpc</code>.</li>
<li>I&rsquo;ll assume you&rsquo;ve already created subnets in said VPC, and that the subnet-to-AZ ratio is 1:1 (exactly one subnet of each type&mdash;public or private&mdash;in each AZ). The code will reference the subnet IDs as <code>pubSubnetIds</code> (for public subnets) or <code>privSubnetIds</code> (for private subnets). (How to create the subnets and capture the list of IDs is left as an exercise for the reader. If you&rsquo;d be interested in seeing how I do it, let me know.)</li>
</ol>
<p>The first step is creating an Elastic IP to assign to the NAT Gateway:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">natGwEip</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">Eip</span>(<span style="color:#e6db74">&#34;natgw-eip&#34;</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpc</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Next, create the NAT Gateway itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">natGw</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">NatGateway</span>(<span style="color:#e6db74">&#34;natgw&#34;</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">allocationId</span>: <span style="color:#66d9ef">natGwEip.id</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">subnetId</span>: <span style="color:#66d9ef">pubSubnetIds</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This creates the NAT Gateway and attaches it to the first public subnet in the list of public subnet IDs stored in <code>pubSubnetIds</code>. You could, obviously, attach it to a different public subnet as needed.</p>
<p>Next, create a route table that will provide Internet access via the NAT Gateway:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">natGwRoute</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">RouteTable</span>(<span style="color:#e6db74">&#34;natgw-route&#34;</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vpcId</span>: <span style="color:#66d9ef">vpc.id</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">routes</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>        { <span style="color:#a6e22e">cidrBlock</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>, <span style="color:#a6e22e">natGatewayId</span>: <span style="color:#66d9ef">natGw.id</span> },
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Finally, associate this route table with the private subnets. The code below iterates across the number of AZs in the specified region (again, I&rsquo;ll leave exactly how to gather that information as an exercise for readers; let me know if you are interested in seeing that portion of code) and make a route table association for each subnet/AZ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">privRtAssoc</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numberOfAZs</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">privRtAssoc</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">RouteTableAssociation</span>(<span style="color:#e6db74">`priv-rta-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">routeTableId</span>: <span style="color:#66d9ef">natGwRoute.id</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">subnetId</span>: <span style="color:#66d9ef">privSubnetIds</span>[<span style="color:#a6e22e">i</span>],
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>When you run <code>pulumi up</code> to create this infrastructure, you&rsquo;ll end up with a single NAT Gateway, attached to one public subnet and multiple private subnets. Instances in each private subnet will be able to access Internet-based resources via the single NAT Gateway.</p>
<h2 id="caveats">Caveats</h2>
<p>It&rsquo;s important to note that outbound traffic will have to cross AZ boundaries in order to egress onto the Internet, and therefore will be subject to cross-AZ data transfer fees (see <a href="https://www.lastweekinaws.com/blog/aws-cross-az-data-transfer-costs-more-than-aws-says/">this article</a> by Corey Quinn for more details). Be sure to understand your traffic patterns and understand the impact of this sort of design on your traffic patterns and your billing before going down this path. (Of course, that&rsquo;s good advice for <em>any</em> design.) <a href="https://aws.amazon.com/premiumsupport/knowledge-center/vpc-reduce-nat-gateway-transfer-costs/">This article</a> also has some good information on reducing data transfer charges for your NAT Gateway(s) (thanks to reader Amey Bhide for the link!).</p>
<p>Feel free to connect with <a href="https://twitter.com/scott_lowe">me on Twitter</a>, or find me in any one of a number of Slack communities (including <a href="https://pulumi-community.slack.com">the Pulumi Slack community</a>), if you have questions, comments, or suggestions for improvement.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/pulumi">Pulumi</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/automation">Automation</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/typescript">TypeScript</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/06/08/review-magic-mouse-2-and-magic-trackpad-2-on-fedora/">Review: Magic Mouse 2 and Magic Trackpad 2 on Fedora</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/06/10/making-it-easier-to-get-started-with-cluster-api-on-aws/">Making it Easier to Get Started with Cluster API on AWS</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f09%2fcreating-multi-az-nat-gateway-with-pulumi%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f09%2fcreating-multi-az-nat-gateway-with-pulumi%2f&text=Creating%20a%20Multi-AZ%20NAT%20Gateway%20with%20Pulumi" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f06%2f09%2fcreating-multi-az-nat-gateway-with-pulumi%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/04/24/technology-short-take-126/">Technology Short Take 126</a> <span class="post-date-list">249 May 242424</span></li><li><a href="/2020/01/25/creating-aws-vpc-endpoint-with-pulumi/">Creating an AWS VPC Endpoint with Pulumi</a> <span class="post-date-list">259 May 252525</span></li><li><a href="/2019/06/21/technology-short-take-115/">Technology Short Take 115</a> <span class="post-date-list">219 May 212121</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
