<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Configuring Kustomize Transformers for Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Configuring Kustomize Transformers for Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Configuring Kustomize Transformers for Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/03/13/configuring-kustomize-transformers-for-cluster-api/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Configuring Kustomize Transformers for Cluster API</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 139 May 131313 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;931 words (estimated 5 minutes to read)</span>
  <p>In November 2019 I wrote an article on <a href="/2019/11/12/using-kustomize-with-cluster-api-manifests/">using <code>kustomize</code> with Cluster API (CAPI) manifests</a>. The idea was to use <code>kustomize</code> to simplify the management of CAPI manifests for clusters that are generally similar but have minor differences (like the AWS region in which they are running, or the number of Machines in a MachineDeployment). In this post, I&rsquo;d like to show a slightly different way of using <code>kustomize</code> with Cluster API that involves configuring the <code>kustomize</code> transformers.</p>
<p>If you aren&rsquo;t familiar with <code>kustomize</code>, I&rsquo;d recommend having a look at <a href="https://kustomize.io/">the <code>kustomize</code> web site</a> and/or reading <a href="/2019/09/13/an-introduction-to-kustomize/">my introductory post</a>. A <em>transformer</em> in <code>kustomize</code> is the part that is responsible for modifying a resource, or gathering information about a resource over the course of a <code>kustomize build</code> process. This page has some useful <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md">terminology definitions</a>.</p>
<p>Looking back at <a href="/2019/11/12/using-kustomize-with-cluster-api-manifests/">the earlier article</a> on using <code>kustomize</code> with CAPI, you can see that&mdash;due to the links/references between objects&mdash;modifying the name of the AWSCluster object also means modifying the reference to the AWSCluster object from the Cluster object. The same goes for the KubeadmConfigTemplate and AWSMachineTemplate objects referenced from a MachineDeployment. Out of the box, the <code>namePrefix</code> transformer <em>will</em> change the names of these objects (because they all have a <code>metadata.name</code> field), but it <em>will not</em> change the references to these objects. Thus, modifying the names of all the objects becomes an exercise in writing multiple patch files (somewhere around 15-20 patch files).</p>
<p>As it turns out, though, there&rsquo;s a way to fix this by configuring the transformers within <code>kustomize</code> (more information <a href="https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs">here</a>).</p>
<p>The <code>nameReference</code> transformer within <code>kustomize</code> is used to track references between objects like this, so that when the name of an object is changed&mdash;say, using the <code>namePrefix</code> transformer&mdash;then <code>kustomize</code> knows all the other places it needs to change as well. By default, this transformer isn&rsquo;t aware of CAPI objects, and thus doesn&rsquo;t know how (or that it should) update references to other objects. By configuring this transformer, users can change that behavior.</p>
<p>Here&rsquo;s how you can give the <code>nameReference</code> transformer a bit more awareness of CAPI objects so it does know how to update references to objects.</p>
<p>First, get the default transformer configurations by saving them with the <code>kustomize config save -d &lt;directory&gt;</code> command. The specific file you need is the <code>namereference.yaml</code> file created by that command. You can discard the others, unless you plan to make modifications to other transformers. There is one other configuration change I&rsquo;ll recommend, so don&rsquo;t ditch all the files just yet.</p>
<p>Second, edit the <code>namereference.yaml</code> file to include this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSCluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1alpha2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fieldSpecs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/infrastructureRef/name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSMachine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1alpha2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fieldSpecs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/infrastructureRef/name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Machine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeadmConfig</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">bootstrap.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1alpha2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fieldSpecs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/bootstrap/configRef/name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Machine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSMachineTemplate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1alpha2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fieldSpecs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/template/spec/infrastructureRef/name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MachineDeployment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeadmConfigTemplate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">bootstrap.cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1alpha2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">fieldSpecs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/template/spec/bootstrap/configRef/name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MachineDeployment</span>
</span></span></code></pre></div><p>Third, add this line to your <code>kustomization.yaml</code> file (see <a href="https://kubectl.docs.kubernetes.io/pages/reference/kustomize.html#configurations">here</a> for more information on using configurations):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">configurations</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">/path/to/customized/namereference.yaml</span>
</span></span></code></pre></div><p>Now, when you use something like <code>namePrefix</code> in your <code>kustomization.yaml</code> file for an overlay, not only will the <code>metadata.name</code> fields of all objects get transformed, but the <em>references</em> to those objects will also be updated. So, the reference from the Cluster object to the AWSCluster object will be updated. The reference from the MachineDeployment object to the KubeadmConfigTemplate and AWSMachineTemplate objects will be updated. The reference from a Machine object to the KubeadmConfig object will be updated.</p>
<p>With this one change to the <code>nameReference</code> transformer, you can go from individually patching objects to using a single <code>namePrefix</code> or <code>nameSuffix</code> transformer and having all objects appropriately updated. This greatly simplifies the use of <code>kustomize</code> with CAPI.</p>
<p>There&rsquo;s a second change I&rsquo;d also recommend you consider. The <code>commonLabels</code> transformer is used to add labels to objects. By default, this transformer doesn&rsquo;t know how to add labels to a MachineDeployment, and this means that you can&rsquo;t use the <code>commonLabels</code> transformer to modify the labels used by a MachineDeployment in your CAPI manifest. Instead, you&rsquo;d have to manually patch these objects. (This is necessary because CAPI uses labels to provide cluster membership information. Change the name of the cluster, and you have to change the labels as well.)</p>
<p>To fix this, edit the <code>commonlabels.yaml</code> file generated by <code>kustomize config save</code> to add this content:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/selector/matchLabels</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MachineDeployment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">path</span>: <span style="color:#ae81ff">spec/template/metadata/labels</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cluster.x-k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">MachineDeployment</span>
</span></span></code></pre></div><p>Now the <code>commonLabels</code> transformer knows that labels have to be added to the <code>spec.selector.matchLabels</code> and <code>spec.template.metadata.labels</code> fields for MachineDeployment objects. This keeps you from having to patch individual objects; instead, you can use a single <code>commonLabels</code> entry in your <code>kustomization.yaml</code> file (you also have to reference the customized configuration using a <code>configurations</code> line as shown above). Sweet!</p>
<p>I&rsquo;m still exploring what other changes may be beneficial, but these are the two I&rsquo;ve found (so far) that have had the most impact on the usability of <code>kustomize</code> with CAPI. If I find more, I&rsquo;ll either update this post or publish a follow-up post.</p>
<p>The information shared above is for Cluster API v1alpha2; for information on configuring <code>kustomize</code> transfomers for use with Cluster API v1alpha3, see <a href="/2020/03/17/kustomize-transformer-configuration-cluster-api-v1alpha3/">this follow-up post</a>. For information on configuring <code>kustomize</code> transformers for use with Cluster API v1beta1, see <a href="/2021/10/11/kustomize-transformer-configurations-for-cluster-api-v1beta1/">this post</a>.</p>
<p>If you have questions, comments, suggestions for improvement, or corrections, please let me know. Feel free to <a href="https://twitter.com/scott_lowe">contact me on Twitter</a>, reach out to me on <a href="https://kubernetes.slack.com">the Kubernetes Slack instance</a>, or hit me up via e-mail (my address isn&rsquo;t too hard to find/figure out).</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kustomize">Kustomize</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/yaml">YAML</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/03/12/updating-vscode-kubernetes-api-awareness/">Updating Visual Studio Code&#39;s Kubernetes API Awareness</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/03/17/kustomize-transformer-configuration-cluster-api-v1alpha3/">Kustomize Transformer Configurations for Cluster API v1alpha3</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f03%2f13%2fconfiguring-kustomize-transformers-for-cluster-api%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f03%2f13%2fconfiguring-kustomize-transformers-for-cluster-api%2f&text=Configuring%20Kustomize%20Transformers%20for%20Cluster%20API" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f03%2f13%2fconfiguring-kustomize-transformers-for-cluster-api%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2019/11/12/using-kustomize-with-cluster-api-manifests/">Using Kustomize with Cluster API Manifests</a> <span class="post-date-list">129 May 121212</span></li><li><a href="/2019/10/16/using-kustomize-with-kubeadm-configuration-files/">Using Kustomize with Kubeadm Configuration Files</a> <span class="post-date-list">169 May 161616</span></li><li><a href="/2019/09/13/an-introduction-to-kustomize/">An Introduction to Kustomize</a> <span class="post-date-list">139 May 131313</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
