<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Assigning Node Labels During Kubernetes Cluster Bootstrapping - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Assigning Node Labels During Kubernetes Cluster Bootstrapping - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Assigning Node Labels During Kubernetes Cluster Bootstrapping - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/11/30/assigning-node-labels-during-kubernetes-cluster-bootstrapping/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Assigning Node Labels During Kubernetes Cluster Bootstrapping</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 309 May 303030 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;758 words (estimated 4 minutes to read)</span>
  <p>Given that <a href="https://kubernetes.io/">Kubernetes</a> is a primary focus of my day-to-day work, I spend a fair amount of time in <a href="https://kubernetes.slack.com/">the Kubernetes Slack community</a>, trying to answer questions from users and generally be helpful. Recently, someone asked about assigning node labels while bootstrapping a cluster with <code>kubeadm</code>. I answered the question, but afterward started thinking that it might be a good idea to also share that same information via a blog post&mdash;my thinking being that others who also had the same question aren&rsquo;t likely to be able to find my answer on Slack, but would be more likely to find a published blog post. So, in this post, I&rsquo;ll show how to assign node labels while bootstrapping a Kubernetes cluster.</p>
<p>The &ldquo;TL;DR&rdquo; is that you can use the <code>kubeletExtraArgs</code> field in a <code>kubeadm</code> configuration file to pass the <code>node-labels</code> command to the Kubelet, which would allow you to assign node labels when <code>kubeadm</code> bootstraps the node. Read on for more details.</p>
<h2 id="testing-with-kind">Testing with Kind</h2>
<p><code>kind</code> is a great tool for testing this sort of configuration, since <code>kind</code> uses <code>kubeadm</code> to bootstrap its nodes. If you aren&rsquo;t familiar with <code>kind</code>, I encourage you to visit <a href="https://kind.sigs.k8s.io/">the <code>kind</code> website</a>; in particular, check out <a href="https://kind.sigs.k8s.io/docs/user/configuration/">the &ldquo;Configuration&rdquo; page</a>, which provides examples of how to use a configuration file to customize how <code>kind</code> works.</p>
<p>The &ldquo;Kubeadm Config Patches&rdquo; section actually provides the answer to the original question&mdash;how does one assign node labels during the bootstrapping process&mdash;in one of its examples (the examples shows the use of <code>kubeletExtraArgs</code> to assign node labels).</p>
<p>To test it, you could create a YAML file (I called mine <code>kind-node-labels.yaml</code>) with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kind.x-k8s.io/v1alpha4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">label-test</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">control-plane</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">role</span>: <span style="color:#ae81ff">worker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubeadmConfigPatches</span>:
</span></span><span style="display:flex;"><span>      - |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kind: JoinConfiguration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nodeRegistration:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          kubeletExtraArgs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            node-labels: &#34;org.scottlowe.workload-type/pci-dss=true&#34;</span>        
</span></span></code></pre></div><p>(The full reference for the configuration file API is available <a href="https://godoc.org/sigs.k8s.io/kind/pkg/apis/config/v1alpha4">here</a> and is another excellent resource for working with <code>kind</code>.)</p>
<p>This configuration file specifies a single control plane and a single worker, and uses the <code>kubeadmConfigPatches</code> section to show the use of a <code>JoinConfiguration</code> (which is what worker nodes would use when joining a cluster) to assign the node label &ldquo;org.scottlowe.workload-type/pci-dss=true&rdquo;. This is the sort of label one might use to help influence workload placement only on specified nodes.</p>
<p>To test this, just run <code>kind create cluster --config kind-node-labels.yaml</code> (or whatever filename you used). It will take a few minutes for <code>kind</code> to do its thing, but when its done you can run <code>kubectl get nodes --show-labels</code> and you should see your new node label(s) present.</p>
<p>Use <code>kind destroy cluster --name label-test</code> (or whatever name you specified in the configuration file) to destroy the cluster, update the node labels being assigned, and test again until you&rsquo;re happy with the result.</p>
<h2 id="using-in-a-real-environment">Using in a Real Environment</h2>
<p>Once you&rsquo;ve used <code>kind</code> to verify the configuration you want to use, then you&rsquo;re ready to use it in a real environment with <code>kubeadm</code> and an associated configuration file.</p>
<p>Because <code>kind</code> uses <code>kubeadm</code>, then the changes you tested above are largely lifted intact from the <code>kind</code> configuration file and put into a <code>kubeadm</code> configuration file. For example, after you&rsquo;ve already bootstrapped a control plane node using <code>kubeadm init</code>, then you could use this configuration file to join a worker node and assign a node label at the same time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">JoinConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bootstrapToken</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">token</span>: <span style="color:#ae81ff">vulq9h.gu12345678906l74</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiServerEndpoint</span>: <span style="color:#e6db74">&#34;control-plane-elb.us-west-2.elb.amazonaws.com:6443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">caCertHashes</span>: [<span style="color:#e6db74">&#34;sha256:123456789012345678901234567890564b934be406f13e28f118b32cc0b6e6db&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ip-10-11-12-13.us-west-2.compute.internal</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubeletExtraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud-provider</span>: <span style="color:#ae81ff">aws</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">node-labels</span>: <span style="color:#e6db74">&#34;org.scottlowe.workload-type/pci-dss=true&#34;</span>
</span></span></code></pre></div><p>As you can see in the above example, you can combine arguments for <code>kubeletExtraArgs</code>; the example above shows enabling the in-tree AWS cloud provider <em>and</em> assigning a node label.</p>
<p>Join the worker node to the cluster using <code>kubeadm join --config kubeadm.yaml</code> (or whatever you named the file), and after it&rsquo;s joined the cluster you should again be able to use <code>kubectl get nodes --show-labels</code> to see the new node and its node labels.</p>
<h2 id="additional-information">Additional Information</h2>
<p>Keep in mind that, per <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">this page on the <code>kubelet</code> command line reference</a>, assigning node labels is an alpha feature. Also, there some restrictions on what labels can and can&rsquo;t be assigned. For example, if you want to assign something in the <code>kubernetes.io</code> namespace, there are only certain labels that are permitted and the rest are restricted. You can&rsquo;t, for example, assign the <code>node-role.kubernetes.io</code> label (it&rsquo;s restricted). (Hat tip to both Duffie Cooley and Lubomir Ivanov for pointing out these restrictions.)</p>
<p>I hope this information is helpful to folks. If you have any questions, you&rsquo;re welcome to contact <a href="https://twitter.com/scott_lowe">me on Twitter</a> or find me on <a href="https://kubernetes.slack.com/">the Kubernetes Slack community</a>. I&rsquo;m happy to help if I&rsquo;m able.</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/docker">Docker</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/11/25/pausing-cluster-api-reconciliation/">Pausing Cluster API Reconciliation</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/12/01/some-site-updates/">Some Site Updates</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f30%2fassigning-node-labels-during-kubernetes-cluster-bootstrapping%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f30%2fassigning-node-labels-during-kubernetes-cluster-bootstrapping%2f&text=Assigning%20Node%20Labels%20During%20Kubernetes%20Cluster%20Bootstrapping" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f30%2fassigning-node-labels-during-kubernetes-cluster-bootstrapping%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/11/25/technology-short-take-134/">Technology Short Take 134</a> <span class="post-date-list">259 May 252525</span></li><li><a href="/2020/11/06/technology-short-take-133/">Technology Short Take 133</a> <span class="post-date-list">69 May 6066</span></li><li><a href="/2020/10/23/technology-short-take-132/">Technology Short Take 132</a> <span class="post-date-list">239 May 232323</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
