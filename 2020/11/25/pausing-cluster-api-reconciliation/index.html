<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Pausing Cluster API Reconciliation - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Pausing Cluster API Reconciliation - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Pausing Cluster API Reconciliation - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/11/25/pausing-cluster-api-reconciliation/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Pausing Cluster API Reconciliation</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 259 May 252525 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;559 words (estimated 3 minutes to read)</span>
  <p>Cluster API is a topic I&rsquo;ve discussed here in a number of posts. If you&rsquo;re not already familiar with Cluster API (also known as CAPI), I&rsquo;d encourage you to check out <a href="/2019/08/26/an-introduction-to-kubernetes-cluster-api/">my introductory post on Cluster API</a> first; you can also visit <a href="https://cluster-api.sigs.k8s.io/">the official Cluster API site</a> for more details. In this short post, I&rsquo;m going to show you how to pause the reconciliation of Cluster API cluster objects, a task that may be necessary for a variety of reasons (including backing up the Cluster API objects in your management cluster).</p>
<p>Since CAPI leverages <a href="https://kubernetes.io/">Kubernetes</a>-style APIs to manage Kubernetes cluster lifecycle, the idea of <em>reconciliation</em> is very important&mdash;it&rsquo;s a core Kubernetes concept that isn&rsquo;t at all specific to CAPI. <a href="https://hackernoon.com/level-triggering-and-reconciliation-in-kubernetes-1f17fe30333d">This article on level triggering and reconciliation in Kubernetes</a> is a great article that helps explain reconciliation, as well as a lot of other key concepts about how Kubernetes works.</p>
<p>When reconciliation is active, the controllers involved in CAPI are constantly evaluating desired state and actual state, and then reconciling differences between the two. There may be times when you need to pause this reconciliation loop. Fortunately, CAPI makes this pretty easy: there is a <code>paused</code> field that allows users to pause the reconciliation loop (see <a href="https://godoc.org/sigs.k8s.io/cluster-api/api/v1alpha3#ClusterSpec">here in the v1alpha3 CAPI reference</a>).</p>
<p>This field is optional, which you can observe using <code>kubectl</code> with an existing workload cluster. For example, here is the relevant output from <code>kubectl get cluster workload1</code> against a CAPI management cluster; note the <code>paused</code> field is not present (i.e., reconciliation is currently active):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterNetwork</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pods</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cidrBlocks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controlPlaneEndpoint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">workload1-apiserver-1234567890.us-east-2.elb.amazonaws.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controlPlaneRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">controlplane.cluster.x-k8s.io/v1alpha3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeadmControlPlane</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">workload1-control-plane</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">workload1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">infrastructureRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io/v1alpha3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSCluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">workload1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">workload1</span>
</span></span></code></pre></div><p>Reconcilation is active when the field isn&rsquo;t present; setting the field to false is essentially the same as removing the field. To pause reconciliation, set it to true. One way of doing this is using <code>kubectl patch</code>, like this:</p>
<pre tabindex="0"><code>kubectl patch cluster workload1 --type merge \
-p &#39;{&#34;spec&#34;:{&#34;paused&#34;: true}}&#39;
</code></pre><p>Naturally, you&rsquo;d want to change <code>workload1</code> to the name of the workload cluster for which you want reconciliation paused. After running the command, you can then run <code>kubectl get cluster &lt;cluster-name&gt; -o yaml</code> and verify the <code>paused</code> field is present:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterNetwork</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pods</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cidrBlocks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">192.168.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controlPlaneEndpoint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">workload1-apiserver-1234567890.us-east-2.elb.amazonaws.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controlPlaneRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">controlplane.cluster.x-k8s.io/v1alpha3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeadmControlPlane</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">workload1-control-plane</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">workload1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">infrastructureRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">infrastructure.cluster.x-k8s.io/v1alpha3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AWSCluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">workload1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">workload1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>If you check the logs for the CAPI controllers, you&rsquo;ll see messages like this:</p>
<pre tabindex="0"><code>I1125 17:31:40.287717       1 machine_controller.go:170] controllers/Machine &#34;msg&#34;=&#34;Reconciliation is paused for this object&#34; &#34;machine&#34;=&#34;workload1-md-0-58c6df55bc-cqt86&#34; &#34;namespace&#34;=&#34;workload1&#34;
</code></pre><p>When reconciliation is paused, the CAPI controllers <strong>will not</strong> make changes to the workload cluster in order to reconcile differences between actual state and desired state.</p>
<p>When you&rsquo;re ready to resume reconciliation again, just change the field to false:</p>
<pre tabindex="0"><code>kubectl patch cluster workload1 --type merge \
-p &#39;{&#34;spec&#34;:{&#34;paused&#34;: false}}&#39;
</code></pre><p>This will remove the field from the spec, allowing the CAPI controllers to resume reconciliation of the CAPI-related objects (like Clusters, Machines, and MachineDeployments).</p>
<p>As I mentioned at the start of this post, pausing CAPI reconciliation may be necessary in a few different situations. (Backing up Cluster API is one situation.)</p>
<p>If anyone has any questions, or if you spot an error in this post, please let me know. Hit <a href="https://twitter.com/scott_lowe">me on Twitter</a>; I&rsquo;d love to hear from you!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/11/25/technology-short-take-134/">Technology Short Take 134</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/11/30/assigning-node-labels-during-kubernetes-cluster-bootstrapping/">Assigning Node Labels During Kubernetes Cluster Bootstrapping</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f25%2fpausing-cluster-api-reconciliation%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f25%2fpausing-cluster-api-reconciliation%2f&text=Pausing%20Cluster%20API%20Reconciliation" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f11%2f25%2fpausing-cluster-api-reconciliation%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/03/17/kustomize-transformer-configuration-cluster-api-v1alpha3/">Kustomize Transformer Configurations for Cluster API v1alpha3</a> <span class="post-date-list">179 May 171717</span></li><li><a href="/2020/03/13/configuring-kustomize-transformers-for-cluster-api/">Configuring Kustomize Transformers for Cluster API</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2020/02/19/retrieving-kubeconfig-cluster-api-workload-cluster/">Retrieving the Kubeconfig for a Cluster API Workload Cluster</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
