<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Updating AWS Credentials in Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Updating AWS Credentials in Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Updating AWS Credentials in Cluster API - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2020/09/02/updating-aws-credentials-in-cluster-api/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Updating AWS Credentials in Cluster API</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 29 May 2022 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;537 words (estimated 3 minutes to read)</span>
  <p>I&rsquo;ve written a bit here and there about <a href="https://cluster-api.sigs.k8s.io/">Cluster API</a> (aka CAPI), mostly focusing on the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/">Cluster API Provider for AWS</a> (CAPA). If you&rsquo;re not yet familiar with CAPI, have a look at <a href="/2019/08/26/an-introduction-to-kubernetes-cluster-api/">my CAPI introduction</a> or check <a href="https://cluster-api.sigs.k8s.io/introduction.html">the Introduction section of the CAPI site</a>. Because CAPI interacts directly with infrastructure providers, it typically has to have some way of authenticating to those infrastructure providers. The AWS provider for Cluster API is no exception. In this post, I&rsquo;ll show how to update the AWS credentials used by CAPA.</p>
<p>Why might you need to update the credentials being used by CAPA? Security professionals recommend that users rotate credentials on a regular basis, and when those credentials get rotated you&rsquo;ll need to update what CAPA is using. There are other reasons, too; perhaps you started with one set of credentials but now want to move to a different set of credentials. Fortunately, the process for updating the CAPA credentials isn&rsquo;t too terribly tedious.</p>
<p>CAPA stores the credentials it uses as a Secret in the &ldquo;capa-system&rdquo; namespace. You can use <code>kubectl -n capa-system get secrets</code> and you&rsquo;ll see the &ldquo;capa-manager-bootstrap-credentials&rdquo; Secret. The credentials themselves are stored as a key named <code>credentials</code>; you can use this command to retrieve the credentials and decode them (if you&rsquo;re using macOS, change the <code>-d</code> to <code>-D</code>):</p>
<pre><code>kubectl -n capa-system get secret capa-manager-bootstrap-credentials \
-o jsonpath=&quot;{.data.credentials}&quot; | base64 -d
</code></pre>
<p>The command will return something like this (but with valid access key ID, secret access key, and region values, obviously):</p>
<pre><code>[default]
aws_access_key_id = &lt;access-key-id-value-here&gt;
aws_secret_access_key = &lt;secret-access-key-value-here&gt;
region = &lt;aws-region-here&gt;
</code></pre>
<p>There&rsquo;s a couple different ways to update this information. What I&rsquo;ll describe below is <em>one way</em> to do it.</p>
<p>First, you&rsquo;ll need to encode a correct/working set of credentials into a Base64-encoded string. Fortunately, the <code>clusterawsadm</code> command can do this for you. Before running <code>clusterawsadm</code>, be sure to set&mdash;as needed&mdash;the AWS_PROFILE, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and the AWS_REGION environment variables. If you&rsquo;re using version 0.5.4 or earlier of <code>clusterawsadm</code>, you can use this <code>clusterawsadm</code> command to generate the necessary Secret materials:</p>
<pre><code>clusterawsadm alpha bootstrap encode-aws-credentials
</code></pre>
<p>If you&rsquo;re using <code>clusterawsadm</code> 0.5.5 or later, the command changes to this:</p>
<pre><code>clusterawsadm bootstrap credentials encode-as-profile
</code></pre>
<p>Keep the output of this command handy; you&rsquo;ll need it shortly.</p>
<p>Next, use <code>kubectl -n capa-system edit secret capa-manager-bootstrap-credentials</code> to edit the Secret. Replace the existing value of the <code>data.credentials</code> field with the new value created above using <code>clusterawsadm</code>. Save your changes.</p>
<p>For the CAPA controller manager to pick up the new credentials in the Secret, restart it with this command:</p>
<pre><code>kubectl -n capa-manager rollout restart \
deployment capa-controller-manager
</code></pre>
<p>The AWS infrastructure provider in your CAPI management cluster should now be good to go with the updated credentials.</p>
<p>It also appears that if you need to upgrade the CAPI components on your management cluster (using <code>clusterctl upgrade plan</code> and <code>clusterctl upgrade apply</code>), that operation will <em>also</em> ensure that updated credentials are embedded into the &ldquo;capa-manager-bootstrap-credentials&rdquo; Secret.</p>
<p>If you have any questions about this process, if I&rsquo;ve explained something incorrectly, or if you have any suggestions for how I can improve this article, please feel free to reach out to <a href="https://twitter.com/scott_lowe">me on Twitter</a> or find me on <a href="https://kubernetes.slack.com">the Kubernetes Slack community</a>. All constructive comments and feedback are welcome!</p>

  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/aws">AWS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/capi">CAPI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/kubernetes">Kubernetes</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2020/08/31/behavior-changes-in-clusterawsadm-055/">Behavior Changes in clusterawsadm 0.5.5</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2020/10/02/technology-short-take-131/">Technology Short Take 131</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2020%2f09%2f02%2fupdating-aws-credentials-in-cluster-api%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f09%2f02%2fupdating-aws-credentials-in-cluster-api%2f&text=Updating%20AWS%20Credentials%20in%20Cluster%20API" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2020%2f09%2f02%2fupdating-aws-credentials-in-cluster-api%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2020/05/29/technology-short-take-127/">Technology Short Take 127</a> <span class="post-date-list">299 May 292929</span></li><li><a href="/2020/04/24/technology-short-take-126/">Technology Short Take 126</a> <span class="post-date-list">249 May 242424</span></li><li><a href="/2020/04/22/using-existing-aws-security-groups-with-cluster-api/">Using Existing AWS Security Groups with Cluster API</a> <span class="post-date-list">229 May 222222</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
