<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Learning NSX, Part 17: Adding External L2 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Learning NSX, Part 17: Adding External L2 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Learning NSX, Part 17: Adding External L2 Connectivity - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2014/10/27/learning-nsx-part-17-adding-external-l2-connectivity/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Learning NSX, Part 17: Adding External L2 Connectivity</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 279 May 272727 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1956 words (estimated 10 minutes to read)</span>
  <p>This is part 17 of the Learning NSX blog series. In this post, I&rsquo;ll show you how to add layer 2 (L2) connectivity to your NSX environment, and how to leverage that L2 connectivity in an NSX-powered OpenStack implementation. This will allow you, as an operator of an NSX-powered OpenStack cloud, to offer L2/bridged connectivity to your tenants as an additional option.</p>
<p>As you might expect, this post does build on content from previous posts in the series. Links to all the posts in the series are available on <a href="/learning-nvp-nsx/">the Learning NVP/NSX page</a>; in particular, this post will leverage content from <a href="/2013/10/28/learning-nvp-part-6-adding-an-nvp-gateway/">part 6</a>. Additionally, I&rsquo;ll be discussing using NSX in the context of OpenStack, so reviewing <a href="/2014/03/12/learning-nsx-part-11-reviewing-openstack-integration-basics/">part 11</a> and <a href="/2014/04/25/learning-nsx-part-12-integrating-vmware-nsx-with-openstack/">part 12</a> might also be helpful.</p>
<p>There are 4 basic steps to adding L2 connectivity to your NSX-powered OpenStack environment:</p>
<ol>
<li>
<p>Add at least one NSX gateway appliance to your NSX implementation. (Ideally, you would add two NSX gateway appliances for redundancy.)</p>
</li>
<li>
<p>Create an NSX L2 gateway service.</p>
</li>
<li>
<p>Configure OpenStack for L2 connectivity by configuring Neutron to use the L2 gateway service you just created.</p>
</li>
<li>
<p>Add L2 connectivity to a Neutron logical network by attaching to the L2 gateway service.</p>
</li>
</ol>
<p>Let&rsquo;s take a look at each of these steps. (By the way, if the concept of &ldquo;L2 connectivity&rdquo; doesn&rsquo;t make sense to you, please review <a href="/2013/08/12/introduction-to-networking-part-1-the-basics/">part 1 of my &ldquo;Introduction to Networking&rdquo;</a> series.)</p>
<h2 id="adding-an-nsx-gateway-appliance">Adding an NSX Gateway Appliance</h2>
<p>I described the process for adding an NSX gateway appliance in <a href="/2013/10/28/learning-nvp-part-6-adding-an-nvp-gateway/">part 6</a> of the series, so refer back to that article for details on how to add an NSX gateway appliance. The process for adding a gateway appliance is the same regardless of whether you&rsquo;ll use that gateway appliance for L2 (bridged) or L3 (routed) connectivity.</p>
<p>A few things to note:</p>
<ul>
<li>
<p>Generally, your gateway appliance will have at least three (3) network interfaces. One of those interfaces will be used for management traffic, one for transport (overlay) traffic, and one for external traffic. You&rsquo;ll need to assign IP addresses to the management and transport interfaces, but the external interface does <em>not</em> require an IP address.</p>
</li>
<li>
<p>If you are going to use the gateway appliance to provide L2 connectivity to multiple VLANs, you&rsquo;ll want to ensure that all appropriate VLANs are trunked to the external interface of the gateway appliances. If you are deploying redundant gateway appliances, make sure all the VLANs are trunked to all appliances.</p>
</li>
</ul>
<p>Once you have the gateway appliance built and added to NSX using the instructions in <a href="/2013/10/28/learning-nvp-part-6-adding-an-nvp-gateway/">part 6</a>, you&rsquo;re ready to proceed to the next step.</p>
<h2 id="creating-an-nsx-l2-gateway-service">Creating an NSX L2 Gateway Service</h2>
<p>After your gateway appliances (I&rsquo;ll assume you&rsquo;re using two appliances for redundancy) are built and added to NSX, you&rsquo;re ready to create the L2 gateway service that will provide the L2 connectivity in and out of a NSX-backed logical network. This process is similar to the process described in <a href="/2014/02/26/learning-nsx-part-9-adding-a-gateway-service/">part 9</a> of the series, which showed you how to add an L3 gateway service to NSX. (If you&rsquo;re unclear on the difference between a gateway appliance and a gateway service, check out <a href="/2014/07/16/learning-nsx-part-15-nsx-gateways-gateway-services-and-logical-routers/">part 15</a> for a more detailed explanation.)</p>
<p>Before we walk through creating an L2 gateway service, keep in mind that you may connect <em>either</em> an L3 gateway service <em>or</em> an L2 gateway service to a single broadcast domain on the physical network. Let&rsquo;s say you connect an L3 gateway service to VLAN 100 (perhaps using multiple VLANs as described in <a href="/2014/10/13/learning-nsx-part-16-routing-to-multiple-external-vlans/">part 16</a>). You can&rsquo;t also connect an L2 gateway service to VLAN 100 as well; you&rsquo;d need to use a different VLAN on the outside of the L2 gateway service. Be sure to take this fact into account in your designs.</p>
<p>To create an L2 gateway service, follow these steps from within NSX Manager:</p>
<ol>
<li>
<p>From the menu across the top of the NSX Manager page, select Network Components &gt; Services &gt; Gateway Services. This will take you to a page titled &ldquo;Network Components Query Results,&rdquo; where NSX Manager has precreated and executed a query for the list of gateway services. Your list may or may not be empty, depending on whether you&rsquo;ve created other gateway services. Any gateway services that you&rsquo;ve already created will be listed here.</p>
</li>
<li>
<p>Click the Add button. This will open the Create Gateway Service dialog.</p>
</li>
<li>
<p>Select &ldquo;L2 Gateway Service&rdquo; from the list. Other options in this list include &ldquo;L3 Gateway Service&rdquo; (you saw this in <a href="/2014/02/26/learning-nsx-part-9-adding-a-gateway-service/">part 9</a>) and &ldquo;VTEP L2 Gateway Service&rdquo; (to integrate a third-party top-of-rack [ToR] switch into NSX; you&rsquo;ll use this in a future post). Click Next, or click on the &ldquo;2. Basics&rdquo; button on the left.</p>
</li>
<li>
<p>Provide a display name for the new L2 gateway service, then click Next (or click on &ldquo;3. Transport Nodes&rdquo; on the left). You can optionally add tags here as well, in case you wanted to associate additional metadata with this logical object in NSX.</p>
</li>
<li>
<p>On the Transport Nodes screen, click Add Gateway to select a gateway appliance (which is classified as a transport node within NSX; hypervisors are also transport nodes) to host this L2 gateway service.</p>
</li>
<li>
<p>From the Edit Gateway dialog box that pops up, you&rsquo;ll need to select a transport node and a device ID. The first option, the transport node, is pretty straightforward; this is a gateway appliance on which to host this gateway service. The device ID is the bridge (recall that NSX gateway appliances, by default, create OVS bridges to map to their interfaces) connected to the external network.</p>
</li>
<li>
<p>Once you&rsquo;ve added two (2) gateway appliances as transport nodes for your gateway service, click Save to create the gateway service and return to NSX Manager. You can create a gateway service with only a single gateway appliance, but it won&rsquo;t be redundant and protected against the failure of the gateway appliance.</p>
</li>
</ol>
<p>NSX is now ready to provide L2 (bridged) connectivity between NSX-backed logical networks and external networks connected to the gateway appliances in the L2 gateway service. Before we can leverage this option inside OpenStack, though, we&rsquo;ll need to first configure OpenStack to recognize and use this new L2 gateway service.</p>
<h2 id="configure-openstack-for-l2-connectivity">Configure OpenStack for L2 Connectivity</h2>
<p>Configuring OpenStack for L2 connectivity using NSX builds upon the specific details presented in <a href="/2014/04/25/learning-nsx-part-12-integrating-vmware-nsx-with-openstack/">part 12</a> of this series. I highly recommend reviewing that post if you haven&rsquo;t already read it.</p>
<p>To configure OpenStack to recognize the L2 gateway service you just created, you&rsquo;ll need to edit the configuration file for the NSX plugin on the Neutron server. In earlier versions of the plugin, this file was called <code>nvp.ini</code> and was found in the <code>/etc/neutron/plugins/nicira</code> directory. (In fact, this is the information I shared with you in part 12.) Newer versions of the plugin, however, use a configuration file named <code>nsx.ini</code> located in the <code>/etc/neutron/plugins/vmware</code> directory. I&rsquo;ll assume you are using a newer version of the plugin.</p>
<p>Only a single change is needed to <code>nsx.ini</code> in order to configure OpenStack to recognize/use the new L2 gateway service. Simply add the UUID of the L2 gateway service (easily obtained via NSX Manager) to the <code>nsx.ini</code> file as the value for the <code>default_l2_gw_service_uuid</code> setting. (You followed a similar procedure in part 12 as part of the OpenStack integration, but for L3 connectivity that time.) Then restart the Neutron server, and you should be ready to go!</p>
<p>Neutron recognizes L2 gateway services as <em>network gateways</em>, so all the related Neutron commands use the term <code>net-gateway</code>. You can verify that the L2 gateway service is recognized by OpenStack Neutron by running the following command with admin permissions:</p>
<pre><code>neutron net-gateway-list
</code></pre>
<p>You should see a single entry in the list, with a description that reads something like &ldquo;default L2 gateway service&rdquo; or similar. As long as you see that entry, you&rsquo;re ready to proceed! If you don&rsquo;t see that entry, it&rsquo;s time to check in NSX Manager and/or double-check your typing.</p>
<h2 id="adding-l2-connectivity-to-a-neutron-logical-network">Adding L2 Connectivity to a Neutron Logical Network</h2>
<p>With the NSX gateway appliances installed, the L2 gateway service created, and OpenStack Neutron configured appropriately, you&rsquo;re now in a position to add L2 connectivity to a Neutron logical network. However, there are a few limitations that you&rsquo;ll want to consider:</p>
<ul>
<li>
<p>A given Neutron logical network may be connected to <em>either</em> a logical router (hosted on gateway appliances that are part of an L3 gateway service) <em>or</em> a network gateway (an L2 gateway service), but not both. In other words, you can provide L3 (routed) <em>or</em> L2 (bridged) connectivity into and out of logical networks, but not both simultaneously.</p>
</li>
<li>
<p>Each Neutron logical network may be associated with exactly one broadcast domain on the physical network. Similarly, each broadcast domain on the physical network may be associated with exactly one Neutron logical network. For example, you can&rsquo;t associate VLAN 100 with both logical network A as well as logical network B.</p>
</li>
<li>
<p>Finally, by default network gateway operations are restricted to users with administrative credentials only. There is a model whereby tenants can have their own network gateways, but for the purposes of this article we&rsquo;ll assume the default model of provider-supplied gateways.</p>
</li>
</ul>
<p>With these considerations in mind, let&rsquo;s walk through what&rsquo;s required to add L2 connectivity to a Neutron logical network.</p>
<ol>
<li>
<p>If you don&rsquo;t already have a logical network, create one using the <code>neutron net-create</code> command. This can be done with standard tenant credentials.</p>
</li>
<li>
<p>If you had to create the logical network, create a subnet as well using the <code>neutron subnet-create</code> command. You can leave DHCP enabled on this Neutron subnet, as the Neutron DHCP server (which is an instance of <code>dnsmasq</code> running in a network namespace on a Neutron network node) won&rsquo;t provide addresses to systems on the physical network. However, the logical network and the physical network are going to be sharing an IP address space, so it would probably be a good idea to control the range of addresses using the <code>--allocation-pool</code> parameter when creating the subnet. As with creating the network, standard tenant credentials are all that are needed here.</p>
</li>
<li>
<p>You&rsquo;ll need to get the UUID of the network gateway, which you can do with this command: <code>neutron net-gateway-list | awk '/\ default\ / {print $2}'</code>. (You can also assign this to an environment variable for use later, if that helps you.) You&rsquo;ll also need the the UUID of the logical network, which you can also store into an environment variable. This command and all subsequent commands require administrative credentials.</p>
</li>
<li>
<p>Attach the logical network to the network gateway using the <code>neutron net-gateway-connect</code> command. Assuming that you&rsquo;ve stored the UUID of the network gateway in <code>$GWID</code> and the UUID for the logical network in <code>$NID</code>, then the command you&rsquo;d use would be <code>neutron net-gateway-connect $GWID $NID --segmentation_type=flat</code>. This command <em>must</em> be done by someone with administrative credentials.</p>
</li>
<li>
<p>If you are using multiple VLANs on the outside of the network gateway, then you&rsquo;d replace <code>--segmentation_type=flat</code> with <code>--segmentation_type=vlan</code> and adding another parameter, <code>--segmentation_id=</code> and the appropriate VLAN ID. For example, if you wanted to bridge the logical network to VLAN 200, then you&rsquo;d use <code>segmentation_type=vlan</code> and <code>segmentation_id=200</code>.</p>
</li>
<li>
<p>That&rsquo;s it! You now have your Neutron logical network bridged out to a broadcast domain on the physical network.</p>
</li>
</ol>
<p>If you need to change the mapping between a broadcast domain on the physical network and a Neutron logical network, simply use <code>neutron net-gateway-disconnect</code> to disconnect the existing logical network, and then use <code>neutron net-gateway-connect</code> to connect a different logical network to the physical network segment.</p>
<p>I hope you&rsquo;ve found this post to be useful. The use of L2 gateways offers administrators and operators a new option for network connectivity for tenants in addition to L3 routing. I&rsquo;ll explore additional options for network connectivity in future posts, so stay tuned. In the meantime, feel free to share any comments, thoughts, or corrections in the comments below.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/neutron">Neutron</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nsx">NSX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/openstack">OpenStack</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2014/10/22/multi-machine-vagrant-with-yaml/">Multi-Machine Vagrant with YAML</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2014/11/03/learning-nsx-part-18-routing-without-network-address-translation/">Learning NSX, Part 18: Routing Without Network Address Translation</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f27%2flearning-nsx-part-17-adding-external-l2-connectivity%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f27%2flearning-nsx-part-17-adding-external-l2-connectivity%2f&text=Learning%20NSX%2c%20Part%2017%3a%20Adding%20External%20L2%20Connectivity" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f27%2flearning-nsx-part-17-adding-external-l2-connectivity%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2014/06/11/technology-short-take-42/">Technology Short Take #42</a> <span class="post-date-list">119 May 111111</span></li><li><a href="/2014/10/13/learning-nsx-part-16-routing-to-multiple-external-vlans/">Learning NSX, Part 16: Routing to Multiple External VLANs</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2014/08/08/technology-short-take-43/">Technology Short Take #43</a> <span class="post-date-list">89 May 8088</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
