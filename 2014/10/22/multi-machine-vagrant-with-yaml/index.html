<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Multi-Machine Vagrant with YAML - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Multi-Machine Vagrant with YAML - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Multi-Machine Vagrant with YAML - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2014/10/22/multi-machine-vagrant-with-yaml/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Multi-Machine Vagrant with YAML</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 229 May 222222 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;506 words (estimated 3 minutes to read)</span>
  <p>In this post, I&rsquo;ll describe a technique I found for simplifying the use of multi-machine Vagrantfiles by extracting configuration data into a separate YAML file. This technique is by no means something that I invented or created, so I can&rsquo;t take any credit whatsoever; this is an idea I first saw <a href="http://liquidat.wordpress.com/2014/03/03/howto-vagrant-libvirt-multi-multi-machine-ansible-and-puppet/">here</a>. I wanted to share it here in the hopes that it might prove useful to a larger audience.</p>
<p>If you aren&rsquo;t familiar with Vagrant and Vagrantfiles, you might start with <a href="/2014/09/12/a-quick-introduction-to-vagrant/">my quick introduction to Vagrant</a>.</p>
<p>I found this technique after trying to find a way to simplify the creation of multiple machines using Vagrant. Specifically, I was trying to create multiple instances of <a href="https://coreos.com">CoreOS</a> along with an Ubuntu instance for testing things like etcd, fleet, Docker, etc. The Vagrantfile was getting more and more complex, and making changes (to add another CoreOS node, for example) wasn&rsquo;t as straightforward as I would have liked.</p>
<p>So what&rsquo;s the fix? As with other DSLs (domain-specific languages) such as Puppet, the fix was found in separating the data from the code. In Puppet, that means parameterizing the module or class, and I needed to use a similar technique here with Vagrant. So, based on the example provided <a href="http://liquidat.wordpress.com/2014/03/03/howto-vagrant-libvirt-multi-multi-machine-ansible-and-puppet/">here</a>, I came up with this Vagrantfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Specify minimum Vagrant version and Vagrant API version</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>require_version <span style="color:#e6db74">&#34;&gt;= 1.6.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Require YAML module</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;yaml&#39;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read YAML file with box details</span>
</span></span><span style="display:flex;"><span>servers <span style="color:#f92672">=</span> <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load_file(<span style="color:#e6db74">&#39;servers.yaml&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create boxes</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Iterate through entries in YAML file</span>
</span></span><span style="display:flex;"><span>  servers<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>servers<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>srv<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;box&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network <span style="color:#e6db74">&#34;private_network&#34;</span>, <span style="color:#e6db74">ip</span>: servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;ip&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      srv<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">:virtualbox</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vb<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        vb<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> servers<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;ram&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>(click <a href="https://gist.github.com/scottslowe/eae23022db8cc95508c6">here</a> to get this as a GitHub Gist you can download.)</p>
<p>You&rsquo;ll note that there is no specific data in this Vagrantfile; all the pertinent configuration data is found in an external YAML file, named <code>servers.yaml</code> (the name is obviously configurable within the Vagrantfile). The Vagrantfile simply retrieves the data from the YAML file and iterates over it.</p>
<p>Here&rsquo;s a sample <code>servers.yaml</code> you could use with this Vagrantfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coreos-01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box</span>: <span style="color:#ae81ff">coreos-alpha</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ram</span>: <span style="color:#ae81ff">512</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">172.17.8.101</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coreos-02</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box</span>: <span style="color:#ae81ff">coreos-alpha</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ram</span>: <span style="color:#ae81ff">512</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">172.17.8.102</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coreos-03</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box</span>: <span style="color:#ae81ff">coreos-alpha</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ram</span>: <span style="color:#ae81ff">512</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ip</span>: <span style="color:#ae81ff">172.17.8.103</span>
</span></span></code></pre></div><p>(Click <a href="https://gist.github.com/scottslowe/4ca1e0c960bbd450ea0e">here</a> for a downloadable GitHub Gist.)</p>
<p>Using the sample <code>servers.yaml</code> file shown above, the Vagrantfile would create three VMs, using the CoreOS Alpha Vagrant box, each with 512MB of RAM and the corresponding IP address. To add more systems to the configuration, simply add lines to the YAML file and you&rsquo;re done. It&rsquo;s as simple as that.</p>
<p>Clearly, there&rsquo;s a lot more that could be done with this sort of approach, but I think this bare-bones example should give you an idea of how flexible something like this can be.</p>
<p>For an even more supercharged approach, check out <a href="https://ttboj.wordpress.com/2014/09/03/introducing-oh-my-vagrant/">Oh My Vagrant!</a>. It takes the approach I&rsquo;ve described here to an entirely new level.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/automation">Automation</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vagrant">Vagrant</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/yaml">YAML</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2014/10/20/questions-for-photography-enthusiasts/">Questions for Photography Enthusiasts</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2014/10/27/learning-nsx-part-17-adding-external-l2-connectivity/">Learning NSX, Part 17: Adding External L2 Connectivity</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f22%2fmulti-machine-vagrant-with-yaml%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f22%2fmulti-machine-vagrant-with-yaml%2f&text=Multi-Machine%20Vagrant%20with%20YAML" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f22%2fmulti-machine-vagrant-with-yaml%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2014/05/02/another-look-at-an-openstack-heat-template/">Another Look at an OpenStack Heat Template</a> <span class="post-date-list">29 May 2022</span></li><li><a href="/2014/09/12/a-quick-introduction-to-vagrant/">A Quick Introduction to Vagrant</a> <span class="post-date-list">129 May 121212</span></li><li><a href="/2014/09/03/technology-short-take-44/">Technology Short Take #44</a> <span class="post-date-list">39 May 3033</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
