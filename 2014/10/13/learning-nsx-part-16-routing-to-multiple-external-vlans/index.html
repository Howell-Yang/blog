<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Learning NSX, Part 16: Routing to Multiple External VLANs - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Learning NSX, Part 16: Routing to Multiple External VLANs - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Learning NSX, Part 16: Routing to Multiple External VLANs - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2014/10/13/learning-nsx-part-16-routing-to-multiple-external-vlans/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Learning NSX, Part 16: Routing to Multiple External VLANs</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 139 May 131313 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1160 words (estimated 6 minutes to read)</span>
  <p>This is part 16 of the Learning NSX series, in which I will show you how to configure VMware NSX to route to multiple external VLANs. This configuration will allow you to have logical routers that could be uplinked to any of the external VLANs, providing additional flexibility for consumers of NSX logical networks.</p>
<p>Naturally, this post builds on all the previous entries in this series, so I encourage you to visit <a href="/learning-nvp-nsx/">the Learning NVP/NSX page</a> for links to previous posts. Because I&rsquo;ll specifically be discussing NSX gateways and routing, there are some posts that are more applicable than others; specifically, I strongly recommend reviewing <a href="/2013/10/28/learning-nvp-part-6-adding-an-nvp-gateway/">part 6</a>, <a href="/2014/02/26/learning-nsx-part-9-adding-a-gateway-service/">part 9</a>, <a href="/2014/06/20/learning-nsx-part-14-using-logical-routing/">part 14</a>, and <a href="/2014/07/16/learning-nsx-part-15-nsx-gateways-gateway-services-and-logical-routers/">part 15</a>. Additionally, I&rsquo;ll assume you&rsquo;re using VMware NSX with OpenStack, so reviewing <a href="/2014/03/12/learning-nsx-part-11-reviewing-openstack-integration-basics/">part 11</a> and <a href="/2014/04/25/learning-nsx-part-12-integrating-vmware-nsx-with-openstack/">part 12</a> might also be helpful.</p>
<p>Ready? Let&rsquo;s start with a very quick review.</p>
<h2 id="review-of-nsx-gateway-connectivity">Review of NSX Gateway Connectivity</h2>
<p>You may recall from <a href="/2013/10/28/learning-nvp-part-6-adding-an-nvp-gateway/">part 6</a> that the NSX gateway appliance is the piece of VMware NSX that handles traffic into or out of logical networks. As such, the NSX gateway appliance is something of a &ldquo;three-legged&rdquo; appliance:</p>
<ul>
<li>
<p>One &ldquo;leg&rdquo; (network interface) provides management connectivity among the gateway appliance and the nodes in the NSX controller cluster</p>
</li>
<li>
<p>One &ldquo;leg&rdquo; provides connectivity to the transport network, which carries the encapsulated logical network traffic</p>
</li>
<li>
<p>One &ldquo;leg&rdquo; is the uplink and provides connectivity to physical networks</p>
</li>
</ul>
<p>That&rsquo;s the physical architecture. From a more logical architecture, you may recall from <a href="/2014/07/16/learning-nsx-part-15-nsx-gateways-gateway-services-and-logical-routers/">part 15</a> that NSX gateway appliances are combined into an NSX gateway service, and the NSX gateway service hosts one or more logical routers. Neither the NSX gateway appliance nor the NSX gateway service are visible to the consumers of the environment; they are only visible to the operators and/or administrators. Consumers only see logical routers, which also serve as the default gateway/default route/IP gateway to/from their logical networks.</p>
<p>The configurations I&rsquo;ve shown you/discussed so far have assumed the presence of only a single uplink. NSX is not constrained to having only a single uplink, nor is it constrained to having only a single physical network on an uplink. If you need multiple networks on the outside of an NSX gateway appliance, you can either use multiple uplinks, or you can use multiple VLANs on an uplink. In this post I&rsquo;ll show you how to use multiple VLANs on the outside. This diagram provides a graphical representation of what the configuration will look like.</p>
<p><img src="/public/img/part-16-nsx-gw-multi-vlan-small.png" alt="Multiple VLANs with NSX Gateways"></p>
<p>(Click <a href="/public/img/part-16-nsx-gw-multi-vlan.png">here</a> for a larger version.)</p>
<p>Setting up this configuration will involve three steps:</p>
<ol>
<li>
<p>Configuring the uplink to carry multiple VLANs.</p>
</li>
<li>
<p>Verifying the gateway configuration.</p>
</li>
<li>
<p>Setting up the external networks in OpenStack.</p>
</li>
</ol>
<p>Let&rsquo;s take a look at each of these sections.</p>
<h2 id="configuring-multiple-vlans-on-the-gateway-uplink">Configuring Multiple VLANs on the Gateway Uplink</h2>
<p>The process for this step will vary, mostly because it involves configuring your physical network to pass the appropriate VLANs to the NSX gateway appliance. I&rsquo;ve written a few articles in the past that might be helpful here:</p>
<ul>
<li>
<p><a href="/2006/12/04/esx-server-nic-teaming-and-vlan-trunking/">ESX Server, NIC Teaming, and VLAN Trunking</a> (for Cisco environments)</p>
</li>
<li>
<p><a href="/2012/10/26/link-aggregation-and-vlan-trunking-with-brocade-fastiron-switches/">Link Aggregation and VLAN Trunking with Brocade FastIron Switches</a> (for Brocade/Foundry environments)</p>
</li>
<li>
<p><a href="/2008/09/05/vmware-esx-nic-teaming-and-vlan-trunking-with-hp-procurve/">VMware ESX, NIC Teaming, and VLAN Trunking with HP ProCurve</a> (for HP environments)</p>
</li>
</ul>
<p>Although the titles of some of these articles seem to imply they are VMware-specific, they aren&rsquo;t&mdash;the physical switch configuration is absolutely applicable here.</p>
<h2 id="verifying-the-gateway-configuration">Verifying the Gateway Configuration</h2>
<p>No special configuration is required on the NSX gateway appliance. As you probably already know, the NSX gateway appliance leverages Open vSwitch (OVS). OVS ports are, by default, trunk ports, and therefore will carry the VLAN tags passed by a properly configured physical switch. Further, the OVS bridge for the external uplink (typically <code>breth1</code> or <code>breth2</code>) doesn&rsquo;t need an IP address assigned to it. This is because the IP address(es) for logical routing are assigned to the logical routers, not the NSX gateway appliance&rsquo;s interface. If you do have IP addresses assigned to the external uplink interface, you can safely remove it. If you prefer to leave it, that&rsquo;s fine too.</p>
<p>As a side note, the NSX gateway appliances do support configuring VLAN sub-interfaces using a command like this:</p>
<pre><code>add network interface &lt;physical interface&gt; vlan &lt;VLAN ID&gt;
</code></pre>
<p>Thus far, I haven&rsquo;t found a need to use VLAN sub-interfaces when using multiple VLANs on the outside of an NSX gateway appliance, but I did want to point out that this functionality does indeed exist.</p>
<h2 id="setting-up-the-external-networks">Setting up the External Networks</h2>
<p>This is the only moderately tricky part of the configuration. In this step, you&rsquo;ll prepare multiple external networks that can be used as uplinks for logical routers.</p>
<p>The command you&rsquo;ll want to use (yes, you <em>have</em> to use the CLI&mdash;this functionality isn&rsquo;t exposed in the OpenStack Dashboard web interface) looks like this:</p>
<pre><code>neutron net-create &lt;network name&gt; -- 
--router:external=True --provider:network_type l3_ext 
--provider:segmentation_id &lt;VLAN ID&gt; 
--provider:physical_network=&lt;NSX gateway service UUID&gt; --shared=True
</code></pre>
<p>For the most part, this command is pretty straightforward, but let&rsquo;s break it down nevertheless:</p>
<ul>
<li>
<p>The <code>router:external=True</code> tells Neutron this network can be used as the external (uplink) connection on a logical router.</p>
</li>
<li>
<p>The <code>provider:network_type l3_ext</code> is an NSX-specific extension that enables Neutron to work with the layer 3 (routing) functionality of the NSX gateway appliances.</p>
</li>
<li>
<p>The <code>provider:segmentation_id</code> portion provides the VLAN ID that should be associated with this particular external network. This VLAN ID should be one of the VLAN IDs that is trunked across the connection from the physical switch to the NSX gateway appliance.</p>
</li>
<li>
<p>The <code>provider:physical_network</code> portion tells OpenStack which specific NSX gateway service to use. This is important to note: this command references an NSX gateway service, <em>not an NSX gateway appliance</em>. Refer to <a href="/2014/07/16/learning-nsx-part-15-nsx-gateways-gateway-services-and-logical-routers/">part 15</a> if you&rsquo;re unclear on the difference.</p>
</li>
</ul>
<p>You&rsquo;d repeat this command for each external network (VLAN) you want connected to NSX and usable inside OpenStack.</p>
<p>For each Neutron network, you&rsquo;ll also need a Neutron subnet. The command to create a subnet on one of these external networks looks like this:</p>
<pre><code>neutron subnet-create &lt;network name&gt; &lt;CIDR&gt;
--name &lt;subnet name&gt; --enable_dhcp=False 
--allocation-pool start=&lt;starting IP address&gt;,end=&lt;ending IP address&gt;
</code></pre>
<p>The range of IP addresses specified in the <code>allocation_pool</code> portion of the command becomes the range of addresses from this particular subnet that can be assigned as floating IPs. It is also the pool of addresses from which logical routers will pull an address when they are connected to this particular external network.</p>
<p>When you&rsquo;re done creating an external network and subnet for each VLAN on the outside of the NSX gateway appliance, then your users (consumers) can simply create logical routers as usual, and then select from one of the external networks as an uplink for their logical routers. This assumes you included the <code>shared=True</code> portion of the command when creating the network; if desired, you can omit that and instead specify a tenant ID, which would assign the external network to a specific tenant only.</p>
<p>I hope you find this post to be useful. If you have any questions, corrections, or clarifications, please speak up in the comments. All courteous comments are welcome!</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/networking">Networking</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/neutron">Neutron</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/nsx">NSX</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/openstack">OpenStack</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vlan">VLAN</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2014/10/08/technology-short-take-45/">Technology Short Take #45</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2014/10/20/questions-for-photography-enthusiasts/">Questions for Photography Enthusiasts</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f13%2flearning-nsx-part-16-routing-to-multiple-external-vlans%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f13%2flearning-nsx-part-16-routing-to-multiple-external-vlans%2f&text=Learning%20NSX%2c%20Part%2016%3a%20Routing%20to%20Multiple%20External%20VLANs" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f10%2f13%2flearning-nsx-part-16-routing-to-multiple-external-vlans%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2014/07/16/learning-nsx-part-15-nsx-gateways-gateway-services-and-logical-routers/">Learning NSX, Part 15: NSX Gateways, Gateway Services, and Logical Routers</a> <span class="post-date-list">169 May 161616</span></li><li><a href="/2014/06/20/learning-nsx-part-14-using-logical-routing/">Learning NSX, Part 14: Using Logical Routing</a> <span class="post-date-list">209 May 202020</span></li><li><a href="/2014/06/11/technology-short-take-42/">Technology Short Take #42</a> <span class="post-date-list">119 May 111111</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
