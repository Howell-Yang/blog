<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>CoreOS Continued: etcd - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="CoreOS Continued: etcd - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="CoreOS Continued: etcd - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2014/08/18/coreos-continued-etcd/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">CoreOS Continued: etcd</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 189 May 181818 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/education">Education</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;1102 words (estimated 6 minutes to read)</span>
  <p>In this post, I&rsquo;m going to build on <a href="/2014/08/01/a-quick-introduction-to-coreos/">my earlier introduction to CoreOS</a> by taking a slightly more detailed look at <a href="https://github.com/coreos/etcd/">etcd</a>. etcd is a distributed key-value store (more on that in a moment) and is one of the key technologies that I feel distinguishes <a href="http://coreos.com/">CoreOS</a> from other Linux distributions.</p>
<p>etcd is not, of course, the only distributed key-value store in town. <a href="http://zookeeper.apache.org">Zookeeper</a> is another very well-known distributed information store. I&rsquo;m focusing on etcd here for two reasons. First, it&rsquo;s distributed as part of CoreOS, which means that it isn&rsquo;t necessarily a separate piece of software that you have to install and configure (although some configuration is needed, as I&rsquo;ll attempt to show). Second, future blog posts will talk about tools like <a href="https://github.com/coreos/fleet/">fleet</a> and others that are being built to leverage etcd, so I want to provide this overview here as a foundation for later posts.</p>
<h2 id="data-organization-in-etcd">Data Organization in etcd</h2>
<p>As I&rsquo;ve mentioned already, etcd is a distributed key-value store. The data within etcd is organized hierarchically, somewhat like a file system. The top of the hierarchy is &ldquo;/&rdquo; (root), and from there users can create paths and keys (with values). Later in this post, I&rsquo;ll show you how that&rsquo;s done using both the RESTful etcd API as well as using the <code>etcdctl</code> command-line client.</p>
<p>First, though, let&rsquo;s look at an example. Let&rsquo;s say that you wanted to store information about IP endpoints that were running a particular service. You could organize the data within etcd like this:</p>
<p>/ (root, already exists when etcd starts)</p>
<p>/svclocation (path or directory within etcd)</p>
<p>/svclocation/instance1 = 10.1.1.20 (a key in etcd and it&rsquo;s associated value)</p>
<p>/svclocation/instance2 = 10.1.1.21 (another key and associated value)</p>
<p>Because etcd is a distributed key-value store, both the organization of the information as well as the actual information is distributed across all the members of an etcd cluster. If you&rsquo;re interested in more details on exactly how the data is propagated within an etcd cluster, see <a href="https://github.com/coreos/etcd/blob/master/Documentation/optimal-cluster-size.md">here</a>.</p>
<h2 id="configuration-of-etcd">Configuration of etcd</h2>
<p>etcd can be configured via command-line flags, environment variables, or configuration file. By default, etcd on CoreOS uses a configuration file generated by cloud-init to set environment variables that affect how etcd operates. My earlier post on <a href="/2014/08/13/deploying-coreos-on-openstack-using-heat/">deploying CoreOS on OpenStack with Heat</a> provides a brief example of using cloud-init to configure etcd on CoreOS during deployment.</p>
<p>For example, when you configure the <code>addr</code>, <code>peer-addr</code>, or <code>discovery</code> properties via cloud-init, CoreOS puts those values into a file named <code>20-cloudinit.conf</code> in the <code>/run/systemd/system/etcd.service.d/</code> directory. That file takes those values and assigns them to the ETCD_ADDR, ETCD_PEER_ADDR, and ETCD_DISCOVERY environment variables, respectively. etcd will read those environment variables when it starts, thus controlling the configuration of etcd. (By the way, the use of the <code>etcd.service.d</code> directory for configuration files is a systemd thing.)</p>
<h2 id="interacting-with-etcd">Interacting with etcd</h2>
<p>Like most projects these days, etcd provides a RESTful API by which you can interact with it. You can use the command-line utility <code>curl</code> to interact with etcd, using some of the techniques I outlined in this post on <a href="/2014/02/19/using-curl-to-interact-with-a-restful-api/">interacting with RESTful APIs</a>. Here&rsquo;s a very simple example: using <code>curl</code> to recursively list the keys and values in a path within etcd:</p>
<pre><code>curl -X GET http://10.1.1.7:4001/v2/keys/?consistent=true&amp;recursive;=true&amp;sorted;=false
</code></pre>
<p>If you want to store some data in etcd (let&rsquo;s say you wanted to store the value &ldquo;10.1.1.20:80&rdquo; at the key &ldquo;/svclocation&rdquo;), then you&rsquo;d do something like this:</p>
<pre><code>curl -L http://10.1.1.7:4001/v2/keys/svclocation -X PUT -d value=&quot;10.1.1.20:80&quot;
</code></pre>
<p>The JSON response (read <a href="/2013/11/08/a-non-programmers-introduction-to-json/">this</a> if you&rsquo;re unfamiliar with JSON) will provide confirmation that the key and value were set, along with some additional information.</p>
<p>To read this value back, you&rsquo;d use <code>curl</code> like this:</p>
<pre><code>curl -L http://10.1.1.7:4001/v2/keys/svclocation
</code></pre>
<p>etcd would respond with a JSON-formatted response that provides the current value of the specified key.</p>
<p>However, to make it easier, there is a command-line client called <code>etcdctl</code> that you can use to interact with etcd. There are both Linux and OS X versions available from <a href="https://github.com/coreos/etcd/">the etcd GitHub page</a>; just make sure you download the version that corresponds to the version of etcd that&rsquo;s running on your CoreOS instance(s). (To determine the version of etcd running on a CoreOS instance, log into the CoreOS instance via SSH and run <code>etcd --version</code>.)</p>
<p>Then, to perform the same listing of keys action as the <code>curl</code> command I provided earlier, you would run this command:</p>
<pre><code>etcdctl --peers 10.1.1.7:4001 ls / --recursive
</code></pre>
<p>Similarly, to set a value at a particular key within etcd:</p>
<pre><code>etcdctl --peers 10.1.1.7:4001 mk /svclocation 10.1.1.20:80
</code></pre>
<p>And to get a value:</p>
<pre><code>etcdctl --peers 10.1.1.7:4001 get /svclocation
</code></pre>
<p>A couple of points to note:</p>
<ul>
<li>
<p>By default, <code>etcdctl</code> works against a local instance of etcd. In other words, it defaults to connecting to 127.0.0.1:4001. You&rsquo;ll have to use the <code>--peers</code> flag if you&rsquo;re running it external to a CoreOS instance. However, if you&rsquo;re running it directly from a CoreOS instance, you can omit the <code>--peers</code> flag.</p>
</li>
<li>
<p>You can point <code>etcdctl</code> against <em>any</em> CoreOS instance in an etcd cluster, because the information stored in etcd is shared and distributed across all the members of the cluster. (That&rsquo;s kind of the whole point behind it.) Note that the <code>--peers</code> option supports listing multiple peers in an etcd cluster.</p>
</li>
</ul>
<p>By now, you might be thinking, &ldquo;OK, this is interesting, but what does it really do for me?&rdquo; By itself, not necessarily a whole lot. Where etcd starts to become quite useful is when there are other systems that start to leverage information stored in etcd. A couple of examples come to mind:</p>
<ol>
<li>
<p>Distributed micro-service architectures&mdash;where applications are made up of a group of containerized services distributed across a compute farm&mdash;need mechanisms for service registration (registering that a particular service is available) and service discovery (finding out where a particular service is running). etcd could be helpful in assisting with both of these tasks (writing key-value pairs into etcd for registration, reading them back for discovery).</p>
</li>
<li>
<p>&ldquo;Converting&rdquo; etcd information into traditional configuration files allows applications that are not etcd-aware to still take advantage of etcd&rsquo;s distributed architecture. For example, there is a project called <a href="https://github.com/kelseyhightower/confd">confd</a> that takes information stored in etcd and turns it into &ldquo;standard&rdquo; configuration files. This means, for example, that you could store dynamic configuration details in etcd, and then use confd to update static configuration files. (A common example of using this is updating an HAProxy configuration file via confd as back-end web server containers start up and shut down. Astute readers will recognize this as a form of service registration and service discovery.)</p>
</li>
</ol>
<p>I&rsquo;ll be building on some of these concepts in future posts. In the meantime, feel free to post any questions, clarifications, or corrections in the comments below.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/cli">CLI</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/json">JSON</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/linux">Linux</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/oss">OSS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/coreos">CoreOS</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/etcd">etcd</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2014/08/15/vmworld-2014-prayer-time/">VMworld 2014 Prayer Time</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2014/08/20/coreos-continued-fleet-and-docker/">CoreOS Continued: Fleet and Docker</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2014%2f08%2f18%2fcoreos-continued-etcd%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f08%2f18%2fcoreos-continued-etcd%2f&text=CoreOS%20Continued%3a%20etcd" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2014%2f08%2f18%2fcoreos-continued-etcd%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2014/08/13/deploying-coreos-on-openstack-using-heat/">Deploying CoreOS on OpenStack Using Heat</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2014/05/01/an-introduction-to-openstack-heat/">An Introduction to OpenStack Heat</a> <span class="post-date-list">19 May 1011</span></li><li><a href="/2014/02/19/using-curl-to-interact-with-a-restful-api/">Using Curl to Interact with a RESTful API</a> <span class="post-date-list">199 May 191919</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
