<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>VMotion Compatibility - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="VMotion Compatibility - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="VMotion Compatibility - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2006/11/23/vmotion-compatibility/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">VMotion Compatibility</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 239 May 232323 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/explanation">Explanation</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;804 words (estimated 4 minutes to read)</span>
  <p>Richard Garsthagen of <a href="http://www.run-virtual.com">www.run-virtual.com</a> has published an application (I believe he&rsquo;s calling it <a href="http://www.run-virtual.com/?page_id=155">VMotion Info</a>) that clearly identifies the differences between CPUs across servers in a farm of ESX servers. This application talks to the VirtualCenter server and then gather information from all the ESX servers represented in VirtualCenter. After gathering all the information, it will then graphically present the differences and actually decode the raw bits to tell you exactly what the differences are (i.e., NX/XD supported/not supported, SSE2/SSE3, etc.).</p>
<p>This is <em>extremely</em> useful information. The missing piece, unfortunately, is the conversion to the binary bits that are necessary to actually mask that information from the virtual machine. I provided some of that information in my earlier article, but for completeness&rsquo; sake thought I might present it here again. Hopefully, this will prove helpful to someone.</p>
<p>For example, here are the raw binary values I obtained on two servers in my server farm:</p>
<pre><code>ID1ECX 0x0000641d (server one)  
ID1ECX 0x00004400 (server two)
</code></pre>
<p>Converted to binary, that becomes:</p>
<pre><code>0000 0000 0000 0000 0110 0100 0001 1101 (server one)  
0000 0000 0000 0000 0100 0100 0000 0000 (server two)
</code></pre>
<p>Observing the binary values, we can easily see the differences between the two CPU families and why (by default) VMotion won&rsquo;t work across them. But what do these values mean? And how does this information play into Richard&rsquo;s VMotion Info tool? Good questions.</p>
<p>Taken from <a href="http://www.intel.com/design/xeon/applnots/241618.htm">this Intel document</a>, here are the meanings of those binary values (bit 0 would be the rightmost bit in the binary values above):</p>
<p>0 - SSE3<br>
1 and 2 - Reserved<br>
3 - MONITOR<br>
4 - DS-CPL<br>
5 - VMX (Intel Virtualization Technology)<br>
6 - Reserved<br>
7 - EST (Enhanced Intel SpeedStep Technology)<br>
8 - TM2<br>
9 - SSSE3 (Supplemental SSE3)<br>
10 - CID<br>
11 and 12 - Reserved<br>
13 - CX16<br>
14 - xTPR<br>
15 through 17 - Reserved<br>
18 - DCA (Direct Cache Access)<br>
19 through 31 - Reserved</p>
<p>In the example provided above, the differences between the CPUs were in bits 0, 2, 3, 4, 10, and 13.  That translates into differences in SSE3, MONITOR, DS-CPL, CID, and CX16 support between the two CPUs.</p>
<p>However, not all those features are necessarily significant to VMotion. In order to know what features are significant to VMotion, we&rsquo;ll need to review the default CPU mask that&rsquo;s provided by VirtualCenter to new virtual machines. Based on my research, the default mask provided to a new Windows Server 2003-based virtual machine is this:</p>
<pre><code>RRRR RRRR RRRR RRR0 00XR R0H0 000H 0RRH
</code></pre>
<p>According to the legend from VirtualCenter, any bit marked R or H must match for successful VMotion. This means that although bits 0, 2, 3, 4, 10, and 13 are different, only bits 0, 2, 4, and 10 are actually significant to VMotion (bits 3 and 13 are already marked 0 [Hide feature from guest software] or X [Unused by guest software]). In order to get VMotion working, we&rsquo;ll need to mask those bits that are different <em>and</em> are significant to VMotion compatibility.</p>
<p>In addition, there are multiple registers&mdash;ECX and EDX&mdash;and different values (0, 1, 80000000h, and 80000001h).</p>
<p>I&rsquo;m assuming that Richard&rsquo;s tool only identifies those flags that actually impair VMotion compatibility. Those flags, and their corresponding register bits are listed below:</p>
<p>NX/XD - Level 80000001 EDX bit 20<br>
FFXSR - (unknown)<br>
RDTSCP - (unknown)<br>
SSE - Level 1 EDX bit 25<br>
SSE2 - Level 1 EDX bit 26<br>
SSE3 - Level 1 ECX bit 0<br>
SSSE3 - Level 1 ECX bit 9<br>
CMPXCHG16B - Level 1 ECX bit 13</p>
<p>I couldn&rsquo;t find the feature flag values for FFXSR and RDTSCP in the Intel documentation. Not shown above (as far as I can tell) is the flag for the Intel 64-bit extensions, which is found at Level 80000001 EDX bit 29.</p>
<p>So, if after running the Virtual Info tool you find differences in NX/XD and Intel 64 support, then you can create a custom CPU mask that hides (using 0 in the mask) level 80000001 EDX bit 20 and level 80000001 EDX bit 29. By placing a zero in the mask, then these values are hidden from the VM and therefore won&rsquo;t affect VMotion compatibility.</p>
<p>Using the Virtual Info tool, you can now easily and clearly identify the differences in your CPUs. Then, using the breakdown listed above, you can easily create the necessary CPU masks to hide those differences and increase VMotion compatibility across hosts. Keep in mind, though, that most of the CPU masks are currently <strong><em>unsupported</em></strong> by VMware. (I just noticed that the supported vs. unsupported &ldquo;relaxations,&rdquo; or masks, are listed at the bottom of Richard&rsquo;s tool.)</p>
<p>Also, there&rsquo;s an ongoing VMTN forum discussion occurring about CPU compatibility and VMotion; Mike Laverick (of <a href="http://www.rtfm-ed.co.uk/">RTFM Education</a>) also <a href="http://www.rtfm-ed.co.uk/?p=314">mentioned it on his weblog</a> as well (see the section marked &ldquo;New Community Initiatives&rdquo;).</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/hardware">Hardware</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/virtualization">Virtualization</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmotion">VMotion</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/vmware">VMware</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2006/11/21/greater-ad-integration-via-nfs-and-automounts/">Greater AD Integration via NFS and Automounts</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2006/11/24/virtualcenter-patch-released/">VirtualCenter Patch Released</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2006%2f11%2f23%2fvmotion-compatibility%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f11%2f23%2fvmotion-compatibility%2f&text=VMotion%20Compatibility" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f11%2f23%2fvmotion-compatibility%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2006/09/25/sneaking-around-vmotion-limitations/">Sneaking Around VMotion Limitations</a> <span class="post-date-list">259 May 252525</span></li><li><a href="/2006/06/27/netapp-ontap-simulator-and-esx-server/">NetApp ONTAP Simulator and ESX Server</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2006/11/20/virtual-consoles-inside-virtual-machines/">Virtual Consoles Inside Virtual Machines</a> <span class="post-date-list">209 May 202020</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
