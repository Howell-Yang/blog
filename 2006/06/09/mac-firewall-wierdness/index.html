<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Mac Firewall Wierdness - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Mac Firewall Wierdness - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Mac Firewall Wierdness - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2006/06/09/mac-firewall-wierdness/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Mac Firewall Wierdness</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 99 May 9099 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/musing">Musing</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;526 words (estimated 3 minutes to read)</span>
  <p>Over the last few days, I&rsquo;ve been trying to fine-tune the settings for the firewall on my <a href="http://www.apple.com/powerbook/">PowerBook</a>. To configure the built-in ipfw firewall in <a href="http://www.apple.com/macosx/">Mac OS X</a>, I use a shareware utility called <a href="http://personalpages.tds.net/~brian_hill/flyingbuttress.html">Flying Buttress</a> (formerly BrickHouse). Every time I think I have the rules configured the way they should work, something is messed up. There&rsquo;s some kind of wierdness going on.</p>
<p>For example, I had the following rules defined in the Expert mode interface of Flying Buttress (rule numbers have been randomized):</p>
<pre><code>add 11350 check-state
add 11351 allow tcp from any to any in established
add 11352 allow tcp from any to any out keep-state
add 11353 allow udp from any to any out keep-state
...
add 65000 deny log ip from any to any
</code></pre>
<p>I did <em>not</em> have any rules to specifically allow DHCP/BootP or DNS, since it was my understanding that those rules would be covered by the stateful outbound rule 11353 above. What I found, though, was that DHCP and DNS information was being blocked and logged in Console.app.</p>
<p>I could kind of/sort of understand the DHCP thing, since my computer was apparently sending out a unicast UDP packet but the DHCP server was responding with a broadcast, and the broadcast didn&rsquo;t &ldquo;match&rdquo; the dynamic stateful rule created by ipfw. So, I added one rule:</p>
<pre><code>...
add 11450 allow udp from any 67 to any 68 in
...
</code></pre>
<p>That solved the DHCP/BootP issue. But what about DNS? My laptop was configured for a specific DNS IP address, and I could see the responses from the configured DNS server being blocked by rule 65000 above (the default &ldquo;deny everything else&rdquo; rule). What was up with that?</p>
<p>I understand the UDP is not a session-oriented protocol, and there isn&rsquo;t the same idea of &ldquo;state&rdquo; as with TCP sessions. However, all the research I performed (as well as my own experience with the pf firewall on OpenBSD) indicated that ipfw could maintain state for UDP conversations. So why was the return DNS traffic being blocked? I still don&rsquo;t know why even now, but eventually I had to do the same thing with DNS as I did with DHCP:</p>
<pre><code>...
add 11550 allow udp from any 53 to me 49152-65535 in
...
</code></pre>
<p>That finally allowed the return DNS traffic to be admitted. I also experimented at various points with changing rule 11351 (the &ldquo;tcp established&rdquo; rule) to <em>deny</em> instead of allow, under the guise that the previous &ldquo;check-state&rdquo; rule would match a dynamic rule first, and that any traffic that didn&rsquo;t match the dynamic rule probably wasn&rsquo;t valid and should therefore be dropped anyway. However, that didn&rsquo;t work out so well, I think primarily because the lifetime for ipfw&rsquo;s dynamic rules was shorter than the communication windows of some of my applications, and so the dynamic rules were expiring before traffic could renew the rule. This particularly affected IM client traffic from my <a href="http://www.adiumx.com/">Adium</a> client to MSN, AIM, Yahoo, and Google Talk.</p>
<p>If anyone has any insight on why exactly the rules weren&rsquo;t behaving as I expected, please let me know. Post in the comments for this post or even send me an <a href="mailto:scott.lowe@scottlowe.org">e-mail</a> directly.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/apple">Apple</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/macintosh">Macintosh</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/security">Security</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2006/06/09/extending-group-policy/">Extending Group Policy</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2006/06/12/site-search-tags/">Site Search Tags</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f09%2fmac-firewall-wierdness%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f09%2fmac-firewall-wierdness%2f&text=Mac%20Firewall%20Wierdness" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f09%2fmac-firewall-wierdness%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2006/03/13/new-apple-security-update/">New Apple Security Update</a> <span class="post-date-list">139 May 131313</span></li><li><a href="/2006/03/07/mac-os-security-flaw-persists/">Mac OS Security Flaw Persists</a> <span class="post-date-list">79 May 7077</span></li><li><a href="/2006/02/16/mac-os-x-malware-uncovered/">Mac OS X Malware Uncovered</a> <span class="post-date-list">169 May 161616</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
