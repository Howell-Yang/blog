<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Mass Changes in Active Directory - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</title>

  
  <meta name="author" content="Howell Yang">
  <meta property="og:site_name" content="Scott&#39;s Weblog">
  
  <meta property="og:description" content="Mass Changes in Active Directory - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  <meta property="og:title" content="Mass Changes in Active Directory - Howell Yang&#39;s Weblog - 我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。">
  
  <meta property="og:type" content="article">
  <meta name="keywords" content="Cloud, Containers, Kubernetes, K8s, Docker, CNI, CRI-O, OCI, Linux, CLI, Networking, AWS, Security, DevOps">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">

  
  <link rel="canonical" href="https://www.howellyang.com/2006/06/20/mass-changes-in-active-directory/">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  </head>
<body class="theme-base-0d">
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="/public/img/orbits-thumb.gif" alt="Orbits" width="128" height="128" /></p>
    <p>Original, technical content centered around cloud computing, Kubernetes, Linux, and networking</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item" href="/about/">About</a>
    <a class="sidebar-nav-item" href="/archives/">Site Archives</a>
    <a class="sidebar-nav-item" href="/categories/">Post Categories</a>
    <a class="sidebar-nav-item" href="/tags/">Content Tags</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://github.com/howellyang"><i class="fa fa-github fa-3x"></i></a>
      <a href="https://twitter.com/None"><i class="fa fa-twitter fa-3x"></i></a>
      <a href="https://www.linkedin.com/in/None"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="http://feeds.scottlowe.org/slowe/content/feed/"><i class="fa fa-rss fa-3x"></i></a>
    </p>
  </div>

  <div class="sidebar-item">
    <p>&copy; 2005-2022. All rights reserved.</p>
  </div>
</div>

    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Howell Yang&#39;s Weblog</a>
            <small>我是杨豪，专注于深度学习模型的训练、剪枝、量化、部署以及工程效率优化。欢迎来到我的博客。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="post">
  <h1 class="post-title">Mass Changes in Active Directory</h1>
  <span class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>&#160;Published on 209 May 202020 &middot;
    <i class="fa fa-folder-open-o" aria-hidden="true"></i>&#160;Filed in <a href="/categories/tutorial">Tutorial</a> &middot;
    <i class="fa fa-pencil" aria-hidden="true"></i>&#160;914 words (estimated 5 minutes to read)</span>
  <p>I&rsquo;d previously published information on making bulk changes in Active Directory, but those changes previously involved changing one attribute to the same value for all the accounts. For example, earlier I described <a href="/2006/05/16/mass-password-changes-in-ad-revisited/">how to make mass password changes</a> using <code>dsquery</code> and <code>dsmod</code>. But what about those situations where simple piping of output doesn&rsquo;t work, like when multiple attributes need to be changed? Here&rsquo;s one technique.</p>
<p>I needed to create this process for a project I was working on. In this project, we needed to be able to set the User Principal Name (UPN) in Active Directory. We couldn&rsquo;t just use <code>dsquery</code> and <code>dsmod</code> here, since <code>dsmod</code> can only accept a DN on standard input; how would we get the UPN value into the command? There was no way to pipe both values from <code>dsquery</code> to dsmod. A more elegant solution was going to be required.</p>
<p>After a fair amount of trial and error, I finally found this solution. Hopefully, it will prove useful to someone.</p>
<h3 id="exporting-the-data-from-active-directory">Exporting the Data from Active Directory</h3>
<p>First, we need to get some raw data to work with. In this scenario, we&rsquo;re going to set the UPN for a group of user accounts in the same OU to match their primary e-mail address.</p>
<p>To get the information we need to accomplish that, we&rsquo;ll first use <code>csvde</code> to export information from Active Directory in CSV (comma-separated values) format:</p>
<pre><code>csvde -f c:\output.csv
-d &quot;ou=Users,ou=Atlanta,ou=Locations,dc=example,dc=net&quot;
-r &quot;(objectclass=user)&quot; -l dn,mail
</code></pre>
<p>Be sure to type this command all on a single line, not wrapped as it is displayed here. This exports only the DN and mail attributes (as specified by the <code>-l</code> switch) for users in the Locations/Atlanta/Users OU to a file named <code>output.csv</code>.</p>
<p>Now we have the raw data we need, so we move on to the next step.</p>
<h3 id="manipulating-the-data">Manipulating the Data</h3>
<p>The problem we face is that we can only use <code>csvde</code> to add new objects, not to modify existing objects. That&rsquo;s not what we need, so we need to convert the CSV data we have into something else. I experimented with a number of CSV-to-LDIF converters, especially <a href="http://www.novell.com/coolsolutions/tools/13658.html">this one from Novell</a>, but couldn&rsquo;t get them to work correctly. Finally, I found <a href="http://www.microsoft.com/technet/scriptcenter/tools/logparser/default.mspx">Log Parser</a>.</p>
<p>If you&rsquo;ve never heard of Log Parser, take a break right now and visit the <a href="http://www.logparser.com/">unofficial Log Parser support site</a> to find out more about the program and what it can do.</p>
<p>Done now? OK, good. We&rsquo;re going to use Log Parser to read in our CSV output and place the fields into a template file that we will create. That template file can then be fed to <code>ldifde</code> for import into Active Directory.</p>
<p>Here&rsquo;s the template file that I used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;LPBODY&gt;  
</span></span><span style="display:flex;"><span>dn: %FIELD_3%  
</span></span><span style="display:flex;"><span>changetype: modify  
</span></span><span style="display:flex;"><span>replace: userPrincipalName  
</span></span><span style="display:flex;"><span>userPrincipalName: %FIELD_4%  
</span></span><span style="display:flex;"><span>-  
</span></span><span style="display:flex;"><span>&lt;/LPBODY&gt;`
</span></span></code></pre></div><p>In this template, <code>%FIELD_3%</code> and <code>%FIELD_4%</code> represent the third and fourth fields in the CSV file. This confused me at first, since the CSV output has only two fields, but the difference is in how Log Parser generates the output. Save this file (make note of the filename!) and then we&rsquo;re ready to proceed. For the purposes of this article, I&rsquo;ll assume we used the name <code>template.tpl</code>. By the way, if you leave the header line in the CSVDE output, you can use the &ldquo;friendly&rdquo; field name in the template instead of the more generic <code>%FIELD_3%</code>.</p>
<p>Use this command to convert our CSV output into LDIF format for modifying Active Directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>type c:\output.csv |
</span></span><span style="display:flex;"><span>logparser &#34;SELECT * FROM STDIN&#34;
</span></span><span style="display:flex;"><span>-i:CSV -o:tpl -tpl:c:\template.tpl -q:on -stats:off &gt;
</span></span><span style="display:flex;"><span>c:\output.ldf
</span></span></code></pre></div><p>This command selects all fields from standard input (which is being piped to Log Parser by the type command) and places them into the template file (using the placeholders described earlier), then redirecting the output to a file named <code>output.ldf</code>.</p>
<p>The results of the file will look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>dn: CN=Bob Smith,OU=Users,OU=Atlanta,OU=Locations,DC=example,DC=net  
</span></span><span style="display:flex;"><span>changetype: modify  
</span></span><span style="display:flex;"><span>replace: userPrincipalName  
</span></span><span style="display:flex;"><span>userPrincipalName: Bob.Smith@atlanta.example.net  
</span></span><span style="display:flex;"><span>-
</span></span></code></pre></div><p>The dash is important, by the way. Refer to <a href="http://www.microsoft.com/technet/prodtechnol/windows2000serv/technologies/activedirectory/howto/bulkstep.mspx">this Microsoft article</a> for more information and examples on using <code>ldifde</code> to modify Active Directory.</p>
<h3 id="importing-the-data-back-into-active-directory">Importing the Data Back Into Active Directory</h3>
<p>Now, with our freshly created <code>output.ldf</code> file ready, we can import the data back into Active Directory to make the desired changes:</p>
<pre><code>ldifde -i -f c:\output.ldf
</code></pre>
<p>This will import the LDIF file back into Active Directory and make the requested changes. Be sure to use the <code>-j</code> switch if logs of the changes are needed; otherwise, no logging is performed.</p>
<p>While this is a fairly simple example, the procedure easily lends itself to making multiple changes to large numbers of user accounts. In this procedure, Log Parser is the key; this is what allows us to take information from Active Directory (obtained using <code>dsquery</code>, <code>csvde</code>, or other utilities) and manipulate it so as to be importable back into Active Directory.</p>
<p>Now that I&rsquo;ve discovered Log Parser, I hope to be able to find more ways to use this extremely powerful tool. Look for more Log Parser-related articles soon.</p>
<p><strong>UPDATE:</strong> I modified the article to properly render the percent signs above, as well as removing the reference to delete the header line (leaving the header line in the <code>csvde</code> output allows you to specify friendly field names in the Log Parser template file). In addition, I added the switches to Log Parser to use quiet output and not display statistics; this keeps us from having to edit the Log Parser output before importing it back into Active Directory. Finally, I published a <a href="/2006/07/25/mass-changes-in-active-directory-take-2/">follow-up article</a> that provides some additional information as well.</p>


  <h3>Metadata and Navigation</h3>
  <span class="post-meta">
  <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/activedirectory">ActiveDirectory</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/ldap">LDAP</a> <i class="fa fa-tag" aria-hidden="true"></i>&#160;<a href="/tags/microsoft">Microsoft</a> 

  <br />
  <i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous Post: <a href="https://www.howellyang.com/2006/06/19/zero-day-excel-exploit/">Zero-Day Excel Exploit</a>
  
  <br />
   <i class="fa fa-arrow-circle-right" aria-hidden="true"></i> Next Post: <a href="https://www.howellyang.com/2006/06/22/enumerating-universal-group-membership/">Enumerating Universal Group Membership</a>
  </span>

  <span class="post-sharing">
  <p>Be social and share this post!<br />

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f20%2fmass-changes-in-active-directory%2f" title="Share on Facebook"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f20%2fmass-changes-in-active-directory%2f&text=Mass%20Changes%20in%20Active%20Directory" title="Share on Twitter"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://plus.google.com/share?url=https%3a%2f%2fwww.howellyang.com%2f2006%2f06%2f20%2fmass-changes-in-active-directory%2f" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-2x"></i></a></p>
  </span>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
  <li><a href="/2006/05/19/semi-automatic-security-groups/">Semi-Automatic Security Groups</a> <span class="post-date-list">199 May 191919</span></li><li><a href="/2006/04/27/linux-ad-integration-with-windows-server-2003-r2/">Linux-AD Integration With Windows Server 2003 R2</a> <span class="post-date-list">279 May 272727</span></li><li><a href="/2005/12/22/complete-linux-ad-authentication-details/">Complete Linux-AD Authentication Details</a> <span class="post-date-list">229 May 222222</span></li>
  </ul>
</div>      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
